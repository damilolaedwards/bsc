<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Building Secure Contracts</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="This repository, brought to you by Trail of Bits, outlines our guidelines and best practices to write secure smart contracts.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="static/custom.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <div class="sidebar-book-logo">
                    <img src="static/TOB_Black.svg">
                </div>
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Introduction</a></li><li class="chapter-item expanded "><a href="development-guidelines/index.html">Development-guidelines</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="development-guidelines/guidelines.html">High-level best practices</a></li><li class="chapter-item "><a href="development-guidelines/token_integration.html">Token integration checklist</a></li><li class="chapter-item "><a href="development-guidelines/incident_response.html">Incident Response Recommendations</a></li><li class="chapter-item "><a href="development-guidelines/workflow.html">Secure development workflow</a></li></ol></li><li class="chapter-item expanded "><a href="learn_evm/index.html">Learn EVM</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="learn_evm/evm_opcodes.html">EVM Opcode Reference</a></li><li class="chapter-item "><a href="learn_evm/tracing.html">Transaction Tracing</a></li><li class="chapter-item "><a href="learn_evm/yellow-paper.html">Yellow Paper Guidance</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="learn_evm/eips_forks.html">Forks &lt;&gt; EIPs</a></li><li class="chapter-item "><a href="learn_evm/cips_forks.html">Forks &lt;&gt; CIPs</a></li><li class="chapter-item "><a href="learn_evm/tips_upgrades.html">Upgrades &lt;&gt; TIPs</a></li><li class="chapter-item "><a href="learn_evm/beps_forks.html">Forks &lt;&gt; BEPs</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="not-so-smart-contracts/index.html">Not so smart contracts</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="not-so-smart-contracts/algorand/index.html">Algorand</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="not-so-smart-contracts/algorand/rekeying/index.html">Rekeying</a></li><li class="chapter-item "><a href="not-so-smart-contracts/algorand/unchecked_transaction_fee/index.html">Unchecked Transaction Fees</a></li><li class="chapter-item "><a href="not-so-smart-contracts/algorand/closing_account/index.html">Closing Account</a></li><li class="chapter-item "><a href="not-so-smart-contracts/algorand/closing_asset/index.html">Closing Asset</a></li><li class="chapter-item "><a href="not-so-smart-contracts/algorand/group_size_check/index.html">Group Size Check</a></li><li class="chapter-item "><a href="not-so-smart-contracts/algorand/time_based_replay_attack/index.html">Time-based Replay Attack</a></li><li class="chapter-item "><a href="not-so-smart-contracts/algorand/access_controls/index.html">Access Controls</a></li><li class="chapter-item "><a href="not-so-smart-contracts/algorand/asset_id_check/index.html">Asset Id Check</a></li><li class="chapter-item "><a href="not-so-smart-contracts/algorand/denial_of_service/index.html">Denial of Service</a></li></ol></li><li class="chapter-item "><a href="not-so-smart-contracts/cairo/index.html">Cairo</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="not-so-smart-contracts/cairo/access_controls/index.html">Improper access controls</a></li><li class="chapter-item "><a href="not-so-smart-contracts/cairo/integer_division/index.html">Integer division errors</a></li><li class="chapter-item "><a href="not-so-smart-contracts/cairo/view_state/index.html">View state modifications</a></li><li class="chapter-item "><a href="not-so-smart-contracts/cairo/arithmetic_overflow/index.html">Arithmetic overflow</a></li><li class="chapter-item "><a href="not-so-smart-contracts/cairo/replay_protection/index.html">Signature replays</a></li><li class="chapter-item "><a href="not-so-smart-contracts/cairo/L1_to_L2_address_conversion/index.html">L1 to L2 Address Conversion</a></li><li class="chapter-item "><a href="not-so-smart-contracts/cairo/incorrect_felt_comparison/index.html">Incorrect Felt Comparison</a></li><li class="chapter-item "><a href="not-so-smart-contracts/cairo/namespace_storage_var_collision/index.html">Namespace Storage Var Collision</a></li><li class="chapter-item "><a href="not-so-smart-contracts/cairo/dangerous_public_imports_in_libraries/index.html">Dangerous Public Imports in Libraries</a></li></ol></li><li class="chapter-item "><a href="not-so-smart-contracts/cosmos/index.html">Cosmos</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="not-so-smart-contracts/cosmos/incorrect_getsigners/index.html">Incorrect signers</a></li><li class="chapter-item "><a href="not-so-smart-contracts/cosmos/non_determinism/index.html">Non-determinism</a></li><li class="chapter-item "><a href="not-so-smart-contracts/cosmos/messages_priority/index.html">Not prioritized messages</a></li><li class="chapter-item "><a href="not-so-smart-contracts/cosmos/abci_fast/index.html">Slow ABCI methods</a></li><li class="chapter-item "><a href="not-so-smart-contracts/cosmos/abci_panic/index.html">ABCI methods panic</a></li><li class="chapter-item "><a href="not-so-smart-contracts/cosmos/broken_bookkeeping/index.html">Broken bookkeeping</a></li><li class="chapter-item "><a href="not-so-smart-contracts/cosmos/rounding_errors/index.html">Rounding errors</a></li><li class="chapter-item "><a href="not-so-smart-contracts/cosmos/unregistered_msg_handler/index.html">Unregistered message handler</a></li><li class="chapter-item "><a href="not-so-smart-contracts/cosmos/missing_error_handler/index.html">Missing error handler</a></li></ol></li><li class="chapter-item "><a href="not-so-smart-contracts/solana/index.html">Solana</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="not-so-smart-contracts/solana/arbitrary_cpi/index.html">Arbitrary CPI</a></li><li class="chapter-item "><a href="not-so-smart-contracts/solana/improper_pda_validation/index.html">Improper PDA Validation</a></li><li class="chapter-item "><a href="not-so-smart-contracts/solana/ownership_check/index.html">Ownership Check</a></li><li class="chapter-item "><a href="not-so-smart-contracts/solana/signer_check/index.html">Signer Check</a></li><li class="chapter-item "><a href="not-so-smart-contracts/solana/sysvar_account_check/index.html">Sysvar Account Check</a></li></ol></li><li class="chapter-item "><a href="not-so-smart-contracts/substrate/index.html">Substrate</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="not-so-smart-contracts/substrate/arithmetic_overflow/index.html">Arithmetic overflow</a></li><li class="chapter-item "><a href="not-so-smart-contracts/substrate/dont_panic/index.html">Don't panic!</a></li><li class="chapter-item "><a href="not-so-smart-contracts/substrate/weights_and_fees/index.html">Weights and fees</a></li><li class="chapter-item "><a href="not-so-smart-contracts/substrate/verify_first/index.html">Verify first</a></li><li class="chapter-item "><a href="not-so-smart-contracts/substrate/validate_unsigned/index.html">Unsigned transaction validation</a></li><li class="chapter-item "><a href="not-so-smart-contracts/substrate/randomness/index.html">Bad randomness</a></li><li class="chapter-item "><a href="not-so-smart-contracts/substrate/origins/index.html">Bad origin</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="program-analysis/index.html">Program Analysis</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="program-analysis/echidna/index.html">Echidna</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="program-analysis/echidna/introduction/index.html">Introduction</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="program-analysis/echidna/introduction/fuzzing-introduction.html">Introduction to fuzzing</a></li><li class="chapter-item "><a href="program-analysis/echidna/introduction/how-to-test-a-property.html">How to test a property</a></li></ol></li><li class="chapter-item "><a href="program-analysis/echidna/basic/index.html">Basic</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="program-analysis/echidna/basic/testing-modes.html">How to select the most suitable testing mode</a></li><li class="chapter-item "><a href="program-analysis/echidna/basic/common-testing-approaches.html">How to select the best testing approach</a></li><li class="chapter-item "><a href="program-analysis/echidna/basic/filtering-functions.html">How to filter functions</a></li><li class="chapter-item "><a href="program-analysis/echidna/basic/assertion-checking.html">How to test assertions</a></li><li class="chapter-item "><a href="program-analysis/echidna/basic/property-creation.html">How to write good properties step by step</a></li></ol></li><li class="chapter-item "><a href="program-analysis/echidna/advanced/index.html">Advanced</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="program-analysis/echidna/advanced/collecting-a-corpus.html">How to collect a corpus</a></li><li class="chapter-item "><a href="program-analysis/echidna/advanced/optimization_mode.html">How to use optimization mode</a></li><li class="chapter-item "><a href="program-analysis/echidna/advanced/finding-transactions-with-high-gas-consumption.html">How to detect high gas consumption</a></li><li class="chapter-item "><a href="program-analysis/echidna/advanced/smart-contract-fuzzing-at-scale.html">How to perform smart contract fuzzing at a large scale</a></li><li class="chapter-item "><a href="program-analysis/echidna/advanced/testing-bytecode.html">How to test bytecode-only contracts</a></li><li class="chapter-item "><a href="program-analysis/echidna/advanced/hevm-cheats-to-test-permit.html">How to use hevm cheats to test permit</a></li><li class="chapter-item "><a href="program-analysis/echidna/advanced/end-to-end-testing.html">How to seed Echidna with unit tests</a></li><li class="chapter-item "><a href="program-analysis/echidna/advanced/using-multi-abi.html">Understanding and using multi-abi</a></li></ol></li><li class="chapter-item "><a href="program-analysis/echidna/fuzzing_tips.html">Fuzzing tips</a></li><li class="chapter-item "><a href="program-analysis/echidna/frequently_asked_questions.html">Frequently Asked Questions</a></li><li class="chapter-item "><a href="program-analysis/echidna/exercises/index.html">Exercises</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="program-analysis/echidna/exercises/Exercise-1.html">Exercise 1</a></li><li class="chapter-item "><a href="program-analysis/echidna/exercises/Exercise-2.html">Exercise 2</a></li><li class="chapter-item "><a href="program-analysis/echidna/exercises/Exercise-3.html">Exercise 3</a></li><li class="chapter-item "><a href="program-analysis/echidna/exercises/Exercise-4.html">Exercise 4</a></li><li class="chapter-item "><a href="program-analysis/echidna/exercises/Exercise-5.html">Exercise 5</a></li><li class="chapter-item "><a href="program-analysis/echidna/exercises/Exercise-6.html">Exercise 6</a></li><li class="chapter-item "><a href="program-analysis/echidna/exercises/Exercise-7.html">Exercise 7</a></li><li class="chapter-item "><a href="program-analysis/echidna/exercises/Exercise-8.html">Exercise 8</a></li></ol></li></ol></li><li class="chapter-item "><a href="program-analysis/manticore/index.html">Manticore</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="program-analysis/manticore/symbolic-execution-introduction.html">Introduction to symbolic execution</a></li><li class="chapter-item "><a href="program-analysis/manticore/running-under-manticore.html">Running under Manticore</a></li><li class="chapter-item "><a href="program-analysis/manticore/getting-throwing-paths.html">Getting throwing paths</a></li><li class="chapter-item "><a href="program-analysis/manticore/adding-constraints.html">Adding constraints</a></li><li class="chapter-item "><a href="program-analysis/manticore/exercises/index.html">Exercises</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="program-analysis/manticore/exercises/example.html">Example</a></li><li class="chapter-item "><a href="program-analysis/manticore/exercises/exercise1.html">Exercise 1</a></li><li class="chapter-item "><a href="program-analysis/manticore/exercises/exercise2.html">Exercise 2</a></li></ol></li></ol></li><li class="chapter-item "><a href="program-analysis/slither/index.html">Slither</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="program-analysis/slither/static_analysis.html">Static Analysis</a></li><li class="chapter-item "><a href="program-analysis/slither/api.html">API</a></li><li class="chapter-item "><a href="program-analysis/slither/exercise1.html">Exercise 1</a></li><li class="chapter-item "><a href="program-analysis/slither/exercise2.html">Exercise 2</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="resources/tob_blogposts.html">Resources</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Building Secure Contracts</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/crytic/building-secure-contracts" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="building-secure-smart-contracts"><a class="header" href="#building-secure-smart-contracts">Building Secure Smart Contracts</a></h1>
<p><img src="https://github.com/crytic/building-secure-contracts/workflows/CI/badge.svg" alt="" /> <img src="https://github.com/crytic/building-secure-contracts/workflows/Echidna/badge.svg" alt="" /></p>
<p>This repository, brought to you by <a href="https://www.trailofbits.com/">Trail of Bits</a>, outlines guidelines and best practices to write secure smart contracts.</p>
<p>We welcome contributions, and you can contribute by following our <a href="https://github.com/crytic/building-secure-contracts/blob/master/CONTRIBUTING.md">contributing guidelines</a>.</p>
<p><strong>Table of contents:</strong></p>
<ul>
<li><a href="./development-guidelines">Development guidelines</a>
<ul>
<li><a href="./development-guidelines/guidelines.html">High-level best practices</a>: High-level best-practices for all smart contracts</li>
<li><a href="./development-guidelines/incident_response.html">Incident Response Recommendations</a>: Guidelines on how to formulate an incident response plan</li>
<li><a href="./development-guidelines/workflow.html">Secure development workflow</a>: A rough, high-level process to follow while you write code</li>
<li><a href="./development-guidelines/token_integration.html">Token integration checklist</a>: What to check when interacting with arbitrary token</li>
</ul>
</li>
<li><a href="./learn_evm">Learn EVM</a>: EVM technical knowledge
<ul>
<li><a href="./learn_evm/evm_opcodes.html">EVM Opcodes</a>: Details on all EVM opcodes</li>
<li><a href="./learn_evm/tracing.html">Transaction Tracing</a>: Helper scripts and guidance for generating and navigating transaction traces</li>
<li><a href="./learn_evm/yellow-paper.html">Yellow Paper Guidance</a>: Symbol reference for more easily reading the Ethereum yellow paper</li>
<li><a href="./learn_evm/eips_forks.html">Forks &lt;&gt; EIPs</a>: Summarize the EIPs included in each Ethereum fork
<ul>
<li><a href="./learn_evm/cips_forks.html">Forks &lt;&gt; CIPs</a>: Summarize the CIPs and EIPs included in each Celo fork <em>(EVM-compatible chain)</em></li>
<li><a href="./learn_evm/tips_upgrades.html">Upgrades &lt;&gt; TIPs</a>: Summarize the TIPs included in each TRON upgrade <em>(EVM-compatible chain)</em></li>
<li><a href="./learn_evm/beps_forks.html">Forks &lt;&gt; BEPs</a>: Summarize the BEPs included in each BSC fork <em>(EVM-compatible chain)</em></li>
</ul>
</li>
</ul>
</li>
<li><a href="./not-so-smart-contracts">Not so smart contracts</a>: Examples of smart contract common issues. Each issue contains a description, an example and recommendations
<ul>
<li><a href="./not-so-smart-contracts/algorand">Algorand</a></li>
<li><a href="./not-so-smart-contracts/cairo">Cairo</a></li>
<li><a href="./not-so-smart-contracts/cosmos">Cosmos</a></li>
<li><a href="./not-so-smart-contracts/substrate">Substrate</a></li>
<li><a href="./not-so-smart-contracts/solana">Solana</a></li>
</ul>
</li>
<li><a href="./program-analysis">Program analysis</a>: How to use automated tools to secure contracts
<ul>
<li><a href="./program-analysis/echidna">Echidna</a>: a fuzzer that will check your contract's properties.</li>
<li><a href="./program-analysis/slither">Slither</a>: a static analyzer available through a CLI and scriptable interface.</li>
<li><a href="./program-analysis/manticore">Manticore</a>: a symbolic execution engine that can prove the correctness properties.</li>
<li>For each tool, this training material will provide:
<ul>
<li>a theoretical introduction, a walkthrough of its API, and a set of exercises.</li>
<li>exercises expected to require ~two hours to practically learn its operation.</li>
</ul>
</li>
</ul>
</li>
<li><a href="./resources">Resources</a>: Various online resources
<ul>
<li><a href="./resources/tob_blogposts.html">Trail of Bits blogposts</a>: List of blockchain related blogposts made by Trail of Bits</li>
</ul>
</li>
</ul>
<h1 id="license"><a class="header" href="#license">License</a></h1>
<p>secure-contracts and building-secure-contracts are licensed and distributed under the <a href="https://github.com/crytic/building-secure-contracts/blob/master/LICENSE">AGPLv3 license</a>. Contact us if you're looking for an exception to the terms.</p>
<h1 id="license-1"><a class="header" href="#license-1">License</a></h1>
<p>secure-contracts and building-secure-contracts are licensed and distributed under the <a href="https://github.com/crytic/building-secure-contracts/blob/master/LICENSE">AGPLv3 license</a>. Contact us if you're looking for an exception to the terms.</p>
<h1 id="license-2"><a class="header" href="#license-2">License</a></h1>
<p>secure-contracts and building-secure-contracts are licensed and distributed under the <a href="https://github.com/crytic/building-secure-contracts/blob/master/LICENSE">AGPLv3 license</a>. Contact us if you're looking for an exception to the terms.</p>
<h1 id="license-3"><a class="header" href="#license-3">License</a></h1>
<p>secure-contracts and building-secure-contracts are licensed and distributed under the <a href="https://github.com/crytic/building-secure-contracts/blob/master/LICENSE">AGPLv3 license</a>. Contact us if you're looking for an exception to the terms.</p>
<h1 id="license-4"><a class="header" href="#license-4">License</a></h1>
<p>secure-contracts and building-secure-contracts are licensed and distributed under the <a href="https://github.com/crytic/building-secure-contracts/blob/master/LICENSE">AGPLv3 license</a>. Contact us if you're looking for an exception to the terms.</p>
<h1 id="license-5"><a class="header" href="#license-5">License</a></h1>
<p>secure-contracts and building-secure-contracts are licensed and distributed under the <a href="https://github.com/crytic/building-secure-contracts/blob/master/LICENSE">AGPLv3 license</a>. Contact us if you're looking for an exception to the terms.</p>
<h1 id="license-6"><a class="header" href="#license-6">License</a></h1>
<p>secure-contracts and building-secure-contracts are licensed and distributed under the <a href="https://github.com/crytic/building-secure-contracts/blob/master/LICENSE">AGPLv3 license</a>. Contact us if you're looking for an exception to the terms.</p>
<h1 id="license-7"><a class="header" href="#license-7">License</a></h1>
<p>secure-contracts and building-secure-contracts are licensed and distributed under the <a href="https://github.com/crytic/building-secure-contracts/blob/master/LICENSE">AGPLv3 license</a>. Contact us if you're looking for an exception to the terms.</p>
<div style="break-before: page; page-break-before: always;"></div><p>List of smart contract development best practices</p>
<ul>
<li><a href="development-guidelines/./guidelines.html">High-level best practices</a>: High-level best-practices for all smart contracts</li>
<li><a href="development-guidelines/./token_integration.html">Token integration checklist</a>: What to check when interacting with arbitrary tokens</li>
<li><a href="development-guidelines/./incident_response.html">Incident Response Recommendations</a>: Guidelines on how to formulate an incident response plan</li>
<li><a href="development-guidelines/./workflow.html">Secure development workflow</a>: A rough, high-level process to follow while you write code</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="development-guidelines"><a class="header" href="#development-guidelines">Development Guidelines</a></h1>
<p>Follow these high-level recommendations to build more secure smart contracts.</p>
<ul>
<li><a href="development-guidelines/guidelines.html#development-guidelines">Development Guidelines</a>
<ul>
<li><a href="development-guidelines/guidelines.html#design-guidelines">Design guidelines</a>
<ul>
<li><a href="development-guidelines/guidelines.html#documentation-and-specifications">Documentation and specifications</a></li>
<li><a href="development-guidelines/guidelines.html#on-chain-vs-off-chain-computation">On-chain vs off-chain computation</a></li>
<li><a href="development-guidelines/guidelines.html#upgradeability">Upgradeability</a>
<ul>
<li><a href="development-guidelines/guidelines.html#delegatecall-proxy-pattern">Delegatecall Proxy</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="development-guidelines/guidelines.html#implementation-guidelines">Implementation guidelines</a>
<ul>
<li><a href="development-guidelines/guidelines.html#function-composition">Function composition</a></li>
<li><a href="development-guidelines/guidelines.html#inheritance">Inheritance</a></li>
<li><a href="development-guidelines/guidelines.html#events">Events</a></li>
<li><a href="development-guidelines/guidelines.html#avoid-known-pitfalls">Avoid known pitfalls</a></li>
<li><a href="development-guidelines/guidelines.html#dependencies">Dependencies</a></li>
<li><a href="development-guidelines/guidelines.html#testing-and-verification">Testing and verification</a></li>
<li><a href="development-guidelines/guidelines.html#solidity">Solidity</a></li>
</ul>
</li>
<li><a href="development-guidelines/guidelines.html#deployment-guidelines">Deployment guidelines</a></li>
</ul>
</li>
</ul>
<h2 id="design-guidelines"><a class="header" href="#design-guidelines">Design guidelines</a></h2>
<p>The design of the contract should be discussed ahead of time, prior writing any line of code.</p>
<h3 id="documentation-and-specifications"><a class="header" href="#documentation-and-specifications">Documentation and specifications</a></h3>
<p>Documentation can be written at different levels, and should be updated while implementing the contracts:</p>
<ul>
<li><strong>A plain English description of the system</strong>, describing what the contracts do and any assumptions on the codebase.</li>
<li><strong>Schema and architectural diagrams</strong>, including the contract interactions and the state machine of the system. <a href="https://github.com/crytic/slither/wiki/Printer-documentation">Slither printers</a> can help to generate these schemas.</li>
<li><strong>Thorough code documentation</strong>, the <a href="https://solidity.readthedocs.io/en/develop/natspec-format.html">Natspec format</a> can be used for Solidity.</li>
</ul>
<h3 id="on-chain-vs-off-chain-computation"><a class="header" href="#on-chain-vs-off-chain-computation">On-chain vs off-chain computation</a></h3>
<ul>
<li><strong>Keep as much code as you can off-chain.</strong> Keep the on-chain layer small. Pre-process data with code off-chain in such a way that verification on-chain is simple. Do you need an ordered list? Sort the list off-chain, then only check its order onchain.</li>
</ul>
<h3 id="upgradeability"><a class="header" href="#upgradeability">Upgradeability</a></h3>
<p>We discussed the different upgradeability solutions in <a href="https://blog.trailofbits.com/2018/09/05/contract-upgrade-anti-patterns/">our blog post</a>. In particular, if you are using delegatecall to achieve upgradability, carefully review all items of the above delegatecall proxy guidance. Make a deliberate choice to support upgradeability or not prior to writing any code. The decision will influence how you structure our code. In general, we recommend:</p>
<ul>
<li><strong>Favoring <a href="https://blog.trailofbits.com/2018/10/29/how-contract-migration-works/">contract migration</a> over upgradeability.</strong> Migration system have many of the same advantages than upgradeable, without their drawbacks.</li>
<li><strong>Using the data separation pattern over the delegatecall proxy one.</strong> If your project has a clear abstraction separation, upgradeability using data separation will necessitate only a few adjustments. The delegatecall proxy requires EVM expertise and is highly error-prone.</li>
<li><strong>Document the migration/upgrade procedure before the deployment.</strong> If you have to react under stress without any guidelines, you will make mistakes. Write the procedure to follow ahead of time. It should include:
<ul>
<li>The calls that initiate the new contracts</li>
<li>Where are stored the keys and how to access them</li>
<li>How to check the deployment! Develop and test a post-deployment script.</li>
</ul>
</li>
</ul>
<h4 id="delegatecall-proxy-pattern"><a class="header" href="#delegatecall-proxy-pattern">Delegatecall Proxy Pattern</a></h4>
<p>The delegatecall opcode is a very sharp tool that must be used carefully. Many high-profile exploits utilize little-known edge cases and counter-intuitive aspects of the delegatecall proxy pattern. This section aims to outline the most important risks to keep in mind while developing such smart contract systems. Trail of Bits developed the <a href="https://github.com/crytic/slither/wiki/Upgradeability-Checks">slither-check-upgradability</a> tool to aid in the development of secure delegatecall proxies, it performs safety checks relevant to both upgradable and immutable delegatecall proxies.</p>
<ul>
<li><strong>Storage layout</strong>: The storage layout of the proxy and implementation must be the same. Do not try to define the same state variables on each contract. Instead, both contracts should inherit all of their state variables from one shared base contract.</li>
<li><strong>Inheritance</strong>: If the base storage contract is split up, beware that the order of inheritance impacts the final storage layout. For example, <code>contract A is B,C</code> and <code>contract A is C,B</code> will not yield the same storage layout if both B and C define state variables.</li>
<li><strong>Initialization</strong>: Make sure that the implementation is immediately initialized. Well-known disasters (and near disasters) have featured an uninitialized implementation contract. A factory pattern can help ensure that contracts are deployed &amp; initialized correctly while also mitigating front-running risks that might otherwise open up between contract deployment &amp; initialization.</li>
<li><strong>Function shadowing</strong>: If the same method is defined on the proxy and the implementation, then the proxy’s function will not be called. Be aware of <code>setOwner</code> and other administration functions that commonly exist on proxies.</li>
<li><strong>Direct implementation usage</strong>: Consider configuring the implementation’s state variables with values that prevent it from being used directly, such as by setting a flag during construction that disables the implementation and causes all methods to revert. This is particularly important if the implementation also performs delegatecall operations because this opens up the possibility of unintended self destruction of the implementation.</li>
<li><strong>Immutable and constant variables</strong>: These are embedded into the bytecode and can therefore get out of sync between the proxy and implementation. If the implementation has an incorrect immutable variable, this value may still be used even if the same variables are correctly set in the proxy’s bytecode.</li>
<li><strong>Contract Existence Checks</strong>: All <a href="https://docs.soliditylang.org/en/latest/control-structures.html?highlight=existence#error-handling-assert-require-revert-and-exceptions">low-level calls</a>, not just delegatecall, will return true against an address with empty bytecode. This might cause callers to be misled to think that a call performed a meaningful operation when it did not or it might result in important safety checks being silently skipped. Be aware that while a contract’s constructor is running, its bytecode remains empty until the end of constructor execution. We recommend that you rigorously verify that all low-level calls are properly protected against nonexistent contracts, keeping in mind that most proxy libraries (such as the one written by Openzeppelin) do not perform contract existence checks automatically.</li>
</ul>
<p>For more information regarding delegatecall proxies in general, reference our blog posts and presentations:</p>
<ul>
<li><a href="https://blog.trailofbits.com/2018/09/05/contract-upgrade-anti-patterns/">Contract Upgradability Anti-Patterns</a>: Describes the difference between a downstream data contract and delegatecall proxies which use an upstream data contract and how these patterns impact upgradability.</li>
<li><a href="https://blog.trailofbits.com/2020/10/30/good-idea-bad-design-how-the-diamond-standard-falls-short/">How the Diamond standard falls short</a>: This post dives deep into delegatecall risks which apply to all contracts, not just those that follow the diamond standard.</li>
<li><a href="https://blog.trailofbits.com/2020/12/16/breaking-aave-upgradeability/">Breaking Aave Upgradeability</a>: A write-up describing a subtle problem that we discovered in Aave <code>AToken</code> contracts that resulted from the interplay between delegatecall proxies, contact existence checks, and unsafe initialization.</li>
<li><a href="https://youtu.be/mebA5Qz9zeQ?t=353">Contract Upgrade Risks and Recommendations</a>: A talk by Trail of Bits describing best-practices for developing upgradable delegatecall proxies. The section starting at 5:49 describes some general risks that also apply to non-upgradable proxies.</li>
</ul>
<h2 id="implementation-guidelines"><a class="header" href="#implementation-guidelines">Implementation guidelines</a></h2>
<p><strong>Strive for simplicity.</strong> Always use the simplest solution that fits your purpose. Any member of your team should be able to understand your solution.</p>
<h3 id="function-composition"><a class="header" href="#function-composition">Function composition</a></h3>
<p>The architecture of your codebase should make your code easy to review. Avoid architectural choices that decrease the ability to reason about its correctness.</p>
<ul>
<li><strong>Split the logic of your system</strong>, either through multiple contracts or by grouping similar functions together (for example, authentication, arithmetic, ...).</li>
<li><strong>Write small functions, with a clear purpose.</strong> This will facilitate easier review and allow the testing of individual components.</li>
</ul>
<h3 id="inheritance"><a class="header" href="#inheritance">Inheritance</a></h3>
<ul>
<li><strong>Keep the inheritance manageable.</strong> Inheritance should be used to divide the logic, however, your project should aim to minimize the depth and width of the inheritance tree.</li>
<li><strong>Use Slither’s <a href="https://github.com/crytic/slither/wiki/Printer-documentation#inheritance-graph">inheritance printer</a> to check the contracts’ hierarchy.</strong> The inheritance printer will help you review the size of the hierarchy.</li>
</ul>
<h3 id="events"><a class="header" href="#events">Events</a></h3>
<ul>
<li><strong>Log all crucial operations.</strong> Events will help to debug the contract during the development, and monitor it after deployment.</li>
</ul>
<h3 id="avoid-known-pitfalls"><a class="header" href="#avoid-known-pitfalls">Avoid known pitfalls</a></h3>
<ul>
<li><strong>Be aware of the most common security issues.</strong> There are many online resources to learn about common issues, such as <a href="https://ethernaut.openzeppelin.com/">Ethernaut CTF</a>, <a href="https://capturetheether.com/">Capture the Ether</a>, or <a href="https://github.com/crytic/not-so-smart-contracts/">Not so smart contracts</a>.</li>
<li><strong>Be aware of the warnings sections in the <a href="https://solidity.readthedocs.io/en/latest/">Solidity documentation</a>.</strong> The warnings sections will inform you about non-obvious behavior of the language.</li>
</ul>
<h3 id="dependencies"><a class="header" href="#dependencies">Dependencies</a></h3>
<ul>
<li><strong>Use well-tested libraries.</strong> Importing code from well-tested libraries will reduce the likelihood that you write buggy code. If you want to write an ERC20 contract, use <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/tree/master/contracts/token/ERC20">OpenZeppelin</a>.</li>
<li><strong>Use a dependency manager; avoid copy-pasting code.</strong> If you rely on an external source, then you must keep it up-to-date with the original source.</li>
</ul>
<h3 id="testing-and-verification"><a class="header" href="#testing-and-verification">Testing and verification</a></h3>
<ul>
<li><strong>Write thorough unit-tests.</strong> An extensive test suite is crucial to build high-quality software. </li>
<li><strong>Write <a href="https://github.com/crytic/slither">Slither</a> and <a href="https://github.com/crytic/echidna">Echidna</a> custom checks and properties.</strong> Automated tools will help ensure your contract is secure. Review the rest of this guide to learn how to write efficient checks and properties.</li>
</ul>
<h3 id="solidity"><a class="header" href="#solidity">Solidity</a></h3>
<ul>
<li><strong>Favor Solidity versions outlined in our <a href="https://github.com/crytic/slither/wiki/Detector-Documentation#incorrect-versions-of-solidity">Slither Recommendations</a></strong> In our opinion, older Solidity are more secure and have better built-in practices. Newer Solidity versions may be too young to be used in production and require additional time to mature.</li>
<li><strong>Use a stable release to compile; use the latest release to check for warnings.</strong> Check that your code has no reported issues with the latest compiler version. However, Solidity has a fast release cycle and has a history of compiler bugs, so we do not recommend the latest version for deployment (see Slither’s <a href="https://github.com/crytic/slither/wiki/Detector-Documentation#incorrect-versions-of-solidity">solc version recommendation</a>).</li>
<li><strong>Do not use inline assembly.</strong> Assembly requires EVM expertise. Do not write EVM code if you have not <em>mastered</em> the yellow paper.</li>
</ul>
<h2 id="deployment-guidelines"><a class="header" href="#deployment-guidelines">Deployment guidelines</a></h2>
<p>Once the contract has been developed and deployed:</p>
<ul>
<li><strong>Monitor your contracts.</strong> Watch the logs, and be ready to react in case of contract or wallet compromise.</li>
<li><strong>Add your contact info to <a href="https://github.com/crytic/blockchain-security-contacts">blockchain-security-contacts</a>.</strong> This list helps third-parties contact you if a security flaw is discovered.</li>
<li><strong>Secure the wallets of privileged users.</strong> Follow our <a href="https://blog.trailofbits.com/2018/11/27/10-rules-for-the-secure-use-of-cryptocurrency-hardware-wallets/">best practices</a> if you store keys in hardware wallets.</li>
<li><strong>Have a response to incident plan.</strong> Consider that your smart contracts can be compromised. Even if your contracts are free of bugs, an attacker may take control of the contract owner's keys.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="token-integration-checklist"><a class="header" href="#token-integration-checklist">Token integration checklist</a></h1>
<p>The following checklist provides recommendations for interactions with arbitrary tokens. Every unchecked item should be justified, and its associated risks, understood.</p>
<p>For convenience, all Slither <a href="https://github.com/crytic/slither#tools">utilities</a> can be run directly on a token address, such as the following:</p>
<pre><code class="language-bash">slither-check-erc 0xdac17f958d2ee523a2206206994597c13d831ec7 TetherToken --erc erc20
slither-check-erc 0x06012c8cf97BEaD5deAe237070F9587f8E7A266d KittyCore --erc erc721
</code></pre>
<p>To follow this checklist, use the below output from Slither for the token:</p>
<pre><code class="language-bash">- slither-check-erc [target] [contractName] [optional: --erc ERC_NUMBER]
- slither [target] --print human-summary
- slither [target] --print contract-summary
- slither-prop . --contract ContractName # requires configuration, and use of Echidna and Manticore
</code></pre>
<h2 id="general-considerations"><a class="header" href="#general-considerations">General considerations</a></h2>
<ul>
<li><input disabled="" type="checkbox"/>
<strong>The contract has a security review.</strong> Avoid interacting with contracts that lack a security review. Check the length of the assessment (i.e., the level of effort), the reputation of the security firm, and the number and severity of the findings.</li>
<li><input disabled="" type="checkbox"/>
<strong>You have contacted the developers.</strong> You may need to alert their team to an incident. Look for appropriate contacts on <a href="https://github.com/crytic/blockchain-security-contacts">blockchain-security-contacts</a>.</li>
<li><input disabled="" type="checkbox"/>
<strong>They have a security mailing list for critical announcements.</strong> Their team should advise users (like you!) when critical issues are found or when upgrades occur.</li>
</ul>
<h2 id="contract-composition"><a class="header" href="#contract-composition">Contract composition</a></h2>
<ul>
<li><input disabled="" type="checkbox"/>
<strong>The contract avoids unneeded complexity.</strong> The token should be a simple contract; a token with complex code requires a higher standard of review. Use Slither’s <a href="https://github.com/crytic/slither/wiki/Printer-documentation#human-summary"><code>human-summary</code> printer</a> to identify complex code.</li>
<li><input disabled="" type="checkbox"/>
<strong>The contract uses <code>SafeMath</code>.</strong> Contracts that do not use <code>SafeMath</code> require a higher standard of review. Inspect the contract by hand for <code>SafeMath</code> usage.</li>
<li><input disabled="" type="checkbox"/>
<strong>The contract has only a few non–token-related functions.</strong> Non-token-related functions increase the likelihood of an issue in the contract. Use Slither’s <a href="https://github.com/crytic/slither/wiki/Printer-documentation#contract-summary"><code>contract-summary</code> printer</a> to broadly review the code used in the contract.</li>
<li><input disabled="" type="checkbox"/>
<strong>The token only has one address.</strong> Tokens with multiple entry points for balance updates can break internal bookkeeping based on the address (e.g., <code>balances[token_address][msg.sender]</code> may not reflect the actual balance).</li>
</ul>
<h2 id="owner-privileges"><a class="header" href="#owner-privileges">Owner privileges</a></h2>
<ul>
<li><input disabled="" type="checkbox"/>
<strong>The token is not upgradeable.</strong> Upgradeable contracts may change their rules over time. Use Slither’s <a href="https://github.com/crytic/slither/wiki/Printer-documentation#contract-summary"><code>human-summary</code> printer</a> to determine whether the contract is upgradeable.</li>
<li><input disabled="" type="checkbox"/>
<strong>The owner has limited minting capabilities.</strong> Malicious or compromised owners can abuse minting capabilities. Use Slither’s <a href="https://github.com/crytic/slither/wiki/Printer-documentation#contract-summary"><code>human-summary</code> printer</a> to review minting capabilities, and consider manually reviewing the code.</li>
<li><input disabled="" type="checkbox"/>
<strong>The token is not pausable.</strong> Malicious or compromised owners can trap contracts relying on pausable tokens. Identify pausable code by hand.</li>
<li><input disabled="" type="checkbox"/>
<strong>The owner cannot blacklist the contract.</strong> Malicious or compromised owners can trap contracts relying on tokens with a blacklist. Identify blacklisting features by hand.</li>
<li><input disabled="" type="checkbox"/>
<strong>The team behind the token is known and can be held responsible for abuse.</strong> Contracts with anonymous development teams or teams that reside in legal shelters require a higher standard of review.</li>
</ul>
<h2 id="erc20-tokens"><a class="header" href="#erc20-tokens">ERC20 tokens</a></h2>
<h3 id="erc20-conformity-checks"><a class="header" href="#erc20-conformity-checks">ERC20 conformity checks</a></h3>
<p>Slither includes a utility, <a href="https://github.com/crytic/slither/wiki/ERC-Conformance"><code>slither-check-erc</code></a>, that reviews the conformance of a token to many related ERC standards. Use <code>slither-check-erc</code> to review the following:</p>
<ul>
<li><input disabled="" type="checkbox"/>
<strong><code>Transfer</code> and <code>transferFrom</code> return a boolean.</strong> Several tokens do not return a boolean on these functions. As a result, their calls in the contract might fail.</li>
<li><input disabled="" type="checkbox"/>
<strong>The <code>name</code>, <code>decimals</code>, and <code>symbol</code> functions are present if used.</strong> These functions are optional in the ERC20 standard and may not be present.</li>
<li><input disabled="" type="checkbox"/>
<strong><code>Decimals</code> returns a <code>uint8</code>.</strong> Several tokens incorrectly return a <code>uint256</code>. In such cases, ensure that the value returned is below 255.</li>
<li><input disabled="" type="checkbox"/>
<strong>The token mitigates the known <a href="https://github.com/ethereum/EIPs/issues/20#issuecomment-263524729">ERC20 race condition</a>.</strong> The ERC20 standard has a known ERC20 race condition that must be mitigated to prevent attackers from stealing tokens.</li>
</ul>
<p>Slither includes a utility, <a href="https://github.com/crytic/slither/wiki/Property-generation"><code>slither-prop</code></a>, that generates unit tests and security properties that can discover many common ERC flaws. Use slither-prop to review the following:</p>
<ul>
<li><input disabled="" type="checkbox"/>
<strong>The contract passes all unit tests and security properties from <code>slither-prop</code>.</strong> Run the generated unit tests and then check the properties with <a href="https://github.com/crytic/echidna">Echidna</a> and <a href="https://manticore.readthedocs.io/en/latest/verifier.html">Manticore</a>.</li>
</ul>
<h3 id="risks-of-erc20-extensions"><a class="header" href="#risks-of-erc20-extensions">Risks of ERC20 Extensions</a></h3>
<p>The behavior of certain contracts may differ from the original ERC specification. Conduct a manual review of the following conditions:</p>
<ul>
<li><input disabled="" type="checkbox"/>
<strong>The token is not an ERC777 token and has no external function call in <code>transfer</code> or <code>transferFrom</code>.</strong> External calls in the transfer functions can lead to reentrancies.</li>
<li><input disabled="" type="checkbox"/>
<strong><code>Transfer</code> and <code>transferFrom</code> should not take a fee.</strong> Deflationary tokens can lead to unexpected behavior.</li>
<li><input disabled="" type="checkbox"/>
<strong>Potential interest earned from the token is taken into account.</strong> Some tokens distribute interest to token holders. This interest may be trapped in the contract if not taken into account.</li>
</ul>
<h3 id="token-scarcity"><a class="header" href="#token-scarcity">Token scarcity</a></h3>
<p>Reviews of token scarcity issues must be executed manually. Check for the following conditions:</p>
<ul>
<li><input disabled="" type="checkbox"/>
<strong>The supply is owned by more than a few users.</strong> If a few users own most of the tokens, they can influence operations based on the tokens’ repartition.</li>
<li><input disabled="" type="checkbox"/>
<strong>The total supply is sufficient.</strong> Tokens with a low total supply can be easily manipulated.</li>
<li><input disabled="" type="checkbox"/>
<strong>The tokens are located in more than a few exchanges.</strong> If all the tokens are in one exchange, a compromise of the exchange could compromise the contract relying on the token.</li>
<li><input disabled="" type="checkbox"/>
<strong>Users understand the risks associated with a large amount of funds or flash loans.</strong> Contracts relying on the token balance must account for attackers with a large amount of funds or attacks executed through flash loans.</li>
<li><input disabled="" type="checkbox"/>
<strong>The token does not allow flash minting.</strong> Flash minting can lead to substantial swings in the balance and the total supply, which necessitate strict and comprehensive overflow checks in the operation of the token.</li>
</ul>
<h2 id="erc721-tokens"><a class="header" href="#erc721-tokens">ERC721 tokens</a></h2>
<h3 id="erc721-conformity-checks"><a class="header" href="#erc721-conformity-checks">ERC721 Conformity Checks</a></h3>
<p>The behavior of certain contracts may differ from the original ERC specification. Conduct a manual review of the following conditions:</p>
<ul>
<li><input disabled="" type="checkbox"/>
<strong>Transfers of tokens to the 0x0 address revert.</strong> Several tokens allow transfers to 0x0 and consider tokens transferred to that address to have been burned; however, the ERC721 standard requires that such transfers revert.</li>
<li><input disabled="" type="checkbox"/>
<strong><code>safeTransferFrom</code> functions are implemented with the correct signature.</strong> Several token contracts do not implement these functions. A transfer of NFTs to one of those contracts can result in a loss of assets.</li>
<li><input disabled="" type="checkbox"/>
<strong>The <code>name</code>, <code>decimals</code>, and <code>symbol</code> functions are present if used.</strong> These functions are optional in the ERC721 standard and may not be present.</li>
<li><input disabled="" type="checkbox"/>
<strong>If it is used, <code>decimals</code> returns a <code>uint8(0)</code>.</strong> Other values are invalid.</li>
<li><input disabled="" type="checkbox"/>
<strong>The <code>name</code> and <code>symbol</code> functions can return an empty string.</strong> This behavior is allowed by the standard.</li>
<li><input disabled="" type="checkbox"/>
<strong>The <code>ownerOf</code> function reverts if the <code>tokenId</code> is invalid or is set to a token that has already been burned.</strong> The function cannot return 0x0. This behavior is required by the standard, but it is not always properly implemented.</li>
<li><input disabled="" type="checkbox"/>
<strong>A transfer of an NFT clears its approvals.</strong> This is required by the standard.</li>
<li><input disabled="" type="checkbox"/>
<strong>The token ID of an NFT cannot be changed during its lifetime.</strong> This is required by the standard.</li>
</ul>
<h3 id="common-risks-of-the-erc721-standard"><a class="header" href="#common-risks-of-the-erc721-standard">Common Risks of the ERC721 Standard</a></h3>
<p>To mitigate the risks associated with ERC721 contracts, conduct a manual review of the following conditions:</p>
<ul>
<li><input disabled="" type="checkbox"/>
<strong>The <code>onERC721Received</code> callback is taken into account.</strong> External calls in the transfer functions can lead to reentrancies, especially when the callback is not explicit (e.g., in <a href="https://www.paradigm.xyz/2021/08/the-dangers-of-surprising-code/"><code>safeMint</code></a> calls).</li>
<li><input disabled="" type="checkbox"/>
<strong>When an NFT is minted, it is safely transferred to a smart contract.</strong> If there is a minting function, it should behave similarly to safeTransferFrom and properly handle the minting of new tokens to a smart contract. This will prevent a loss of assets.</li>
<li><input disabled="" type="checkbox"/>
<strong>The burning of a token clears its approvals.</strong> If there is a burning function, it should clear the token’s previous approvals.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="incident-response-recommendations"><a class="header" href="#incident-response-recommendations">Incident Response Recommendations</a></h1>
<p>Here, we provide recommendations around the formulation of an incident response plan. </p>
<ul>
<li><input disabled="" type="checkbox"/>
<strong>Identify who (either specific people or roles) is responsible for carrying out the mitigations (deploying smart contracts, pausing contracts, upgrading the front end, etc.).</strong>
<ul>
<li>Specifying these roles will strengthen the incident response plan and ease the execution of mitigating actions when necessary.</li>
</ul>
</li>
<li><input disabled="" type="checkbox"/>
<strong>Document internal processes for situations in which a deployed remediation does not work or introduces a new bug.</strong>
<ul>
<li>Consider adding a fallback scenario that describes an action plan in the event of a failed remediation.</li>
</ul>
</li>
<li><input disabled="" type="checkbox"/>
<strong>Clearly describe the intended process of contract deployment.</strong></li>
<li><input disabled="" type="checkbox"/>
<strong>Consider whether and under what circumstances your company will make affected users whole after certain issues occur.</strong>
<ul>
<li>Some scenarios to consider include an individual or aggregate loss, a loss resulting from user error, a contract flaw, and a third-party contract flaw.</li>
</ul>
</li>
<li><input disabled="" type="checkbox"/>
<strong>Document how you plan to keep up to date on new issues, both to inform future development and to secure the deployment toolchain and the external on-chain and off-chain services that the system relies on.</strong>
<ul>
<li>For each language and component, describe the noteworthy sources for vulnerability news. Subscribe to updates for each source. Consider creating a special private Discord/Slack channel with a bot that will post the latest vulnerability news; this will help the team keep track of updates all in one place. Also consider assigning specific team members to keep track of the vulnerability news of a specific component of the system.</li>
</ul>
</li>
<li><input disabled="" type="checkbox"/>
<strong>Consider scenarios involving issues that would indirectly affect the system.</strong></li>
<li><input disabled="" type="checkbox"/>
<strong>Determine when and how the team would reach out to and onboard external parties (auditors, affected users, other protocol developers, etc.).</strong>
<ul>
<li>Some issues may require collaboration with external parties to efficiently remediate them. </li>
</ul>
</li>
<li><input disabled="" type="checkbox"/>
<strong>Define contract behavior that is considered abnormal for off-chain monitoring.</strong>
<ul>
<li>Consider adding more resilient solutions for detection and mitigation, especially in terms of specific alternate endpoints and queries for different data as well as status pages and support contacts for affected services.</li>
</ul>
</li>
<li><input disabled="" type="checkbox"/>
<strong>Combine issues and determine whether new detection and mitigation scenarios are needed.</strong></li>
<li><input disabled="" type="checkbox"/>
<strong>Perform periodic dry runs of specific scenarios in the incident response plan to find gaps and opportunities for improvement and to develop muscle memory.</strong>
<ul>
<li>Document the intervals at which the team should perform dry runs of the various scenarios. For scenarios that are more likely to happen, perform dry runs more regularly. Create a template to be filled in after a dry run to describe the improvements that need to be made to the incident response.</li>
</ul>
</li>
</ul>
<h2 id="incident-response-plan-resources"><a class="header" href="#incident-response-plan-resources">Incident Response Plan Resources</a></h2>
<ul>
<li><a href="https://docs.yieldprotocol.com/#/operations/how_to_hack">How to Hack the Yield Protocol</a></li>
<li><a href="https://github.com/yearn/yearn-devdocs/blob/master/docs/developers/v2/EMERGENCY.md">Emergency Steps – Yearn</a></li>
</ul>
<h2 id="well-handled-ir-incidents"><a class="header" href="#well-handled-ir-incidents">Well-handled IR Incidents</a></h2>
<ul>
<li><a href="https://medium.com/yield-protocol/post-mortem-of-incident-on-august-5th-2022-7bb70dbb9ada">Yield Protocol</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="secure-development-workflow"><a class="header" href="#secure-development-workflow">Secure development workflow</a></h1>
<p>Here's a high-level process we recommend following while you write your smart contracts.</p>
<p>Check for known security issues:</p>
<ul>
<li><input disabled="" type="checkbox"/>
Review your contracts with <a href="https://github.com/crytic/slither">Slither</a>. It has more than 70 built-in detectors for common vulnerabilities. Run it on every check-in with new code and ensure it gets a clean report (or use triage mode to silence certain issues).</li>
</ul>
<p>Consider special features of your contract:</p>
<ul>
<li><input disabled="" type="checkbox"/>
Are your contracts upgradeable? Review your upgradeability code for flaws with <a href="https://github.com/crytic/slither/wiki/Upgradeability-Checks"><code>slither-check-upgradeability</code></a> or <a href="https://blog.trailofbits.com/2020/06/12/upgradeable-contracts-made-safer-with-crytic/">Crytic</a>. We've documented 17 ways upgrades can go sideways.</li>
<li><input disabled="" type="checkbox"/>
Do your contracts purport to conform to ERCs? Check them with <a href="https://github.com/crytic/slither/wiki/ERC-Conformance"><code>slither-check-erc</code></a>. This tool instantly identifies deviations from six common specs.</li>
<li><input disabled="" type="checkbox"/>
Do you have unit tests in Truffle? Enrich them with <a href="https://github.com/crytic/slither/wiki/Property-generation"><code>slither-prop</code></a>. It automatically generates a robust suite of security properties for features of ERC20 based on your specific code.</li>
<li><input disabled="" type="checkbox"/>
Do you integrate with 3rd party tokens? Review our <a href="development-guidelines/./token_integration.html">token integration checklist</a> before relying on external contracts. </li>
</ul>
<p>Visually inspect critical security features of your code:</p>
<ul>
<li><input disabled="" type="checkbox"/>
Review Slither's <a href="https://github.com/trailofbits/slither/wiki/Printer-documentation#inheritance-graph">inheritance-graph</a> printer. Avoid inadvertent shadowing and C3 linearization issues.</li>
<li><input disabled="" type="checkbox"/>
Review Slither's <a href="https://github.com/trailofbits/slither/wiki/Printer-documentation#function-summary">function-summary</a> printer. It reports function visibility and access controls.</li>
<li><input disabled="" type="checkbox"/>
Review Slither's <a href="https://github.com/trailofbits/slither/wiki/Printer-documentation#variables-written-and-authorization">vars-and-auth</a> printer. It reports access controls on state variables.</li>
</ul>
<p>Document critical security properties and use automated test generators to evaluate them:</p>
<ul>
<li><input disabled="" type="checkbox"/>
Learn to <a href="development-guidelines/../program-analysis/">document security properties for your code</a>. It's tough as first, but it's the single most important activity for achieving a good outcome. It's also a prerequisite for using any of the advanced techniques in this tutorial.</li>
<li><input disabled="" type="checkbox"/>
Define security properties in Solidity, for use with <a href="https://github.com/crytic/echidna">Echidna</a> and <a href="https://manticore.readthedocs.io/en/latest/verifier.html">Manticore</a>. Focus on your state machine, access controls, arithmetic operations, external interactions, and standards conformance.</li>
<li><input disabled="" type="checkbox"/>
Define security properties with <a href="development-guidelines/../program-analysis/slither">Slither's Python API</a>. Focus on inheritance, variable dependencies, access controls, and other structural issues.</li>
</ul>
<p>Finally, be mindful of issues that automated tools cannot easily find:</p>
<ul>
<li>Lack of privacy: everyone else can see your transactions while they're queued in the pool</li>
<li>Front running transactions</li>
<li>Cryptographic operations</li>
<li>Risky interactions with external DeFi components</li>
</ul>
<h2 id="ask-for-help"><a class="header" href="#ask-for-help">Ask for help</a></h2>
<p><a href="https://calendly.com/trail-of-bits-sales/trail-of-bits-office-hours">Office Hours</a> run every Tuesday afternoon. These 1-hour, 1-on-1 sessions are an opportunity to ask us any questions you have about security, troubleshoot using our tools, and get feedback from experts about your current approach. We will help you work through this guide.</p>
<p>Join our Slack: <a href="https://join.slack.com/t/empirehacking/shared_invite/zt-h97bbrj8-1jwuiU33nnzg67JcvIciUw">Empire Hacking</a>. We're always available in the #crytic and #ethereum channels if you have any questions.</p>
<h2 id="security-is-about-more-than-just-smart-contracts"><a class="header" href="#security-is-about-more-than-just-smart-contracts">Security is about more than just smart contracts</a></h2>
<p>Review our quick tips for <a href="https://docs.google.com/document/d/1-_0Wlwch_vtkPM4F-SdEXLjQYaYT7KoPlU2rjt7tkLQ/edit?usp=sharing">general application and corporate security</a>. It's most important that your code on-chain is secure, but lapses in off-chain security may be just as severe, especially where owner keys are concerned.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="learn-evm"><a class="header" href="#learn-evm">Learn EVM</a></h1>
<p>List of EVM technical knowledge </p>
<ul>
<li><a href="learn_evm/evm_opcodes.html">EVM Opcode Reference</a>: Reference and notes for each of the EVM opcodes</li>
<li><a href="learn_evm/tracing.html">Transaction Tracing</a>: Helper scripts and guidance for generating and navigating transaction traces</li>
<li><a href="learn_evm/yellow-paper.html">Yellow Paper Guidance</a>: Symbol reference for more easily reading the Ethereum yellow paper</li>
<li><a href="learn_evm/eips_forks.html">Forks &lt;&gt; EIPs</a>: Summarize the EIPs included in each fork
<ul>
<li><a href="learn_evm/cips_forks.html">Forks &lt;&gt; CIPs</a>: Summarize the CIPs and EIPs included in each Celo fork <em>(EVM-compatible chain)</em></li>
<li><a href="learn_evm/tips_upgrades.html">Upgrades &lt;&gt; TIPs</a>: Summarize the TIPs included in each TRON upgrade <em>(EVM-compatible chain)</em></li>
<li><a href="learn_evm/beps_forks.html">Forks &lt;&gt; BEPs</a>: Summarize the BEPs included in each BSC fork <em>(EVM-compatible chain)</em></li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ethereum-vm-evm-opcodes-and-instruction-reference"><a class="header" href="#ethereum-vm-evm-opcodes-and-instruction-reference">Ethereum VM (EVM) Opcodes and Instruction Reference</a></h1>
<p>This reference consolidates EVM opcode information from the <a href="http://gavwood.com/paper.pdf">yellow paper</a>, <a href="https://ethereum.stackexchange.com/questions/119/what-opcodes-are-available-for-the-ethereum-evm">stack exchange</a>, <a href="https://github.com/ethereum/solidity/blob/c61610302aa2bfa029715b534719d25fe3949059/libevmasm/Instruction.h#L40">solidity source</a>, <a href="https://github.com/paritytech/parity/blob/d365281cce919edc42340c97ce212f49d9447d2d/ethcore/evm/src/instructions.rs#L311">parity source</a>, <a href="https://github.com/djrtwo/evm-opcode-gas-costs/blob/master/opcode-gas-costs_EIP-150_revision-1e18248_2017-04-12.csv">evm-opcode-gas-costs</a> and <a href="https://github.com/trailofbits/manticore/blob/c6f457d72e1164c4c8c6d0256fe9b8b765d2cb24/manticore/platforms/evm.py#L590">Manticore</a>.</p>
<h2 id="notes"><a class="header" href="#notes">Notes</a></h2>
<p>The size of a &quot;word&quot; in EVM is 256 bits.</p>
<p>The gas information is a work in progress. If an asterisk is in the Gas column, the base cost is shown but may vary based on the opcode arguments.</p>
<h2 id="table"><a class="header" href="#table">Table</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Opcode</th><th>Name</th><th>Description</th><th>Extra Info</th><th>Gas</th></tr></thead><tbody>
<tr><td><a href="learn_evm/evm_opcodes.html#stop"><code>0x00</code></a></td><td>STOP</td><td>Halts execution</td><td>-</td><td>0</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#add"><code>0x01</code></a></td><td>ADD</td><td>Addition operation</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#mul"><code>0x02</code></a></td><td>MUL</td><td>Multiplication operation</td><td>-</td><td>5</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#sub"><code>0x03</code></a></td><td>SUB</td><td>Subtraction operation</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#div"><code>0x04</code></a></td><td>DIV</td><td>Integer division operation</td><td>-</td><td>5</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#sdiv"><code>0x05</code></a></td><td>SDIV</td><td>Signed integer division operation (truncated)</td><td>-</td><td>5</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#mod"><code>0x06</code></a></td><td>MOD</td><td>Modulo remainder operation</td><td>-</td><td>5</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#smod"><code>0x07</code></a></td><td>SMOD</td><td>Signed modulo remainder operation</td><td>-</td><td>5</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#addmod"><code>0x08</code></a></td><td>ADDMOD</td><td>Modulo addition operation</td><td>-</td><td>8</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#mulmod"><code>0x09</code></a></td><td>MULMOD</td><td>Modulo multiplication operation</td><td>-</td><td>8</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#exp"><code>0x0a</code></a></td><td>EXP</td><td>Exponential operation</td><td>-</td><td>10*</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#signextend"><code>0x0b</code></a></td><td>SIGNEXTEND</td><td>Extend length of two's complement signed integer</td><td>-</td><td>5</td></tr>
<tr><td><code>0x0c</code> - <code>0x0f</code></td><td>Unused</td><td>Unused</td><td>-</td><td></td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#lt"><code>0x10</code></a></td><td>LT</td><td>Less-than comparison</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#gt"><code>0x11</code></a></td><td>GT</td><td>Greater-than comparison</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#slt"><code>0x12</code></a></td><td>SLT</td><td>Signed less-than comparison</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#sgt"><code>0x13</code></a></td><td>SGT</td><td>Signed greater-than comparison</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#eq"><code>0x14</code></a></td><td>EQ</td><td>Equality comparison</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#iszero"><code>0x15</code></a></td><td>ISZERO</td><td>Simple not operator</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#and"><code>0x16</code></a></td><td>AND</td><td>Bitwise AND operation</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#or"><code>0x17</code></a></td><td>OR</td><td>Bitwise OR operation</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#xor"><code>0x18</code></a></td><td>XOR</td><td>Bitwise XOR operation</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#not"><code>0x19</code></a></td><td>NOT</td><td>Bitwise NOT operation</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#byte"><code>0x1a</code></a></td><td>BYTE</td><td>Retrieve single byte from word</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#shl"><code>0x1b</code></a></td><td>SHL</td><td>Shift Left</td><td><a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-145.md">EIP145</a></td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#shr"><code>0x1c</code></a></td><td>SHR</td><td>Logical Shift Right</td><td><a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-145.md">EIP145</a></td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#sar"><code>0x1d</code></a></td><td>SAR</td><td>Arithmetic Shift Right</td><td><a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-145.md">EIP145</a></td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#keccak256"><code>0x20</code></a></td><td>KECCAK256</td><td>Compute Keccak-256 hash</td><td>-</td><td>30*</td></tr>
<tr><td><code>0x21</code> - <code>0x2f</code></td><td>Unused</td><td>Unused</td><td></td><td></td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#address"><code>0x30</code></a></td><td>ADDRESS</td><td>Get address of currently executing account</td><td>-</td><td>2</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#balance"><code>0x31</code></a></td><td>BALANCE</td><td>Get balance of the given account</td><td>-</td><td>700</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#origin"><code>0x32</code></a></td><td>ORIGIN</td><td>Get execution origination address</td><td>-</td><td>2</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#caller"><code>0x33</code></a></td><td>CALLER</td><td>Get caller address</td><td>-</td><td>2</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#callvalue"><code>0x34</code></a></td><td>CALLVALUE</td><td>Get deposited value by the instruction/transaction responsible for this execution</td><td>-</td><td>2</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#calldataload"><code>0x35</code></a></td><td>CALLDATALOAD</td><td>Get input data of current environment</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#calldatasize"><code>0x36</code></a></td><td>CALLDATASIZE</td><td>Get size of input data in current environment</td><td>-</td><td>2*</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#calldatacopy"><code>0x37</code></a></td><td>CALLDATACOPY</td><td>Copy input data in current environment to memory</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#codesize"><code>0x38</code></a></td><td>CODESIZE</td><td>Get size of code running in current environment</td><td>-</td><td>2</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#codecopy"><code>0x39</code></a></td><td>CODECOPY</td><td>Copy code running in current environment to memory</td><td>-</td><td>3*</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#gasprice"><code>0x3a</code></a></td><td>GASPRICE</td><td>Get price of gas in current environment</td><td>-</td><td>2</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#extcodesize"><code>0x3b</code></a></td><td>EXTCODESIZE</td><td>Get size of an account's code</td><td>-</td><td>700</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#extcodecopy"><code>0x3c</code></a></td><td>EXTCODECOPY</td><td>Copy an account's code to memory</td><td>-</td><td>700*</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#returndatasize"><code>0x3d</code></a></td><td>RETURNDATASIZE</td><td>Pushes the size of the return data buffer onto the stack</td><td><a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-211.md">EIP 211</a></td><td>2</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#returndatacopy"><code>0x3e</code></a></td><td>RETURNDATACOPY</td><td>Copies data from the return data buffer to memory</td><td><a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-211.md">EIP 211</a></td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#extcodehash"><code>0x3f</code></a></td><td>EXTCODEHASH</td><td>Returns the keccak256 hash of a contract's code</td><td><a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1052.md">EIP 1052</a></td><td>700</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#blockhash"><code>0x40</code></a></td><td>BLOCKHASH</td><td>Get the hash of one of the 256 most recent complete blocks</td><td>-</td><td>20</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#coinbase"><code>0x41</code></a></td><td>COINBASE</td><td>Get the block's beneficiary address</td><td>-</td><td>2</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#timestamp"><code>0x42</code></a></td><td>TIMESTAMP</td><td>Get the block's timestamp</td><td>-</td><td>2</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#number"><code>0x43</code></a></td><td>NUMBER</td><td>Get the block's number</td><td>-</td><td>2</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#difficulty"><code>0x44</code></a></td><td>DIFFICULTY</td><td>Get the block's difficulty</td><td>-</td><td>2</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#gaslimit"><code>0x45</code></a></td><td>GASLIMIT</td><td>Get the block's gas limit</td><td>-</td><td>2</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#chainid"><code>0x46</code></a></td><td>CHAINID</td><td>Returns the current chain’s EIP-155 unique identifier</td><td><a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1344.md">EIP 1344</a></td><td>2</td></tr>
<tr><td><code>0x47</code> - <code>0x4f</code></td><td>Unused</td><td>-</td><td></td><td></td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#basefee"><code>0x48</code></a></td><td>BASEFEE</td><td>Returns the value of the base fee of the current block it is executing in.</td><td><a href="https://eips.ethereum.org/EIPS/eip-3198">EIP 3198</a></td><td>2</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#pop"><code>0x50</code></a></td><td>POP</td><td>Remove word from stack</td><td>-</td><td>2</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#mload"><code>0x51</code></a></td><td>MLOAD</td><td>Load word from memory</td><td>-</td><td>3*</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#mstore"><code>0x52</code></a></td><td>MSTORE</td><td>Save word to memory</td><td>-</td><td>3*</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#mstore8"><code>0x53</code></a></td><td>MSTORE8</td><td>Save byte to memory</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#sload"><code>0x54</code></a></td><td>SLOAD</td><td>Load word from storage</td><td>-</td><td>800</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#sstore"><code>0x55</code></a></td><td>SSTORE</td><td>Save word to storage</td><td>-</td><td>20000**</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#jump"><code>0x56</code></a></td><td>JUMP</td><td>Alter the program counter</td><td>-</td><td>8</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#jumpi"><code>0x57</code></a></td><td>JUMPI</td><td>Conditionally alter the program counter</td><td>-</td><td>10</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#pc"><code>0x58</code></a></td><td>PC</td><td>Get the value of the program counter prior to the increment</td><td>-</td><td>2</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#msize"><code>0x59</code></a></td><td>MSIZE</td><td>Get the size of active memory in bytes</td><td>-</td><td>2</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#gas"><code>0x5a</code></a></td><td>GAS</td><td>Get the amount of available gas, including the corresponding reduction for the cost of this instruction</td><td>-</td><td>2</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#jumpdest"><code>0x5b</code></a></td><td>JUMPDEST</td><td>Mark a valid destination for jumps</td><td>-</td><td>1</td></tr>
<tr><td><code>0x5c</code> - <code>0x5f</code></td><td>Unused</td><td>-</td><td></td><td></td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push1"><code>0x60</code></a></td><td>PUSH1</td><td>Place 1 byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push2"><code>0x61</code></a></td><td>PUSH2</td><td>Place 2-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push3"><code>0x62</code></a></td><td>PUSH3</td><td>Place 3-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push4"><code>0x63</code></a></td><td>PUSH4</td><td>Place 4-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push5"><code>0x64</code></a></td><td>PUSH5</td><td>Place 5-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push6"><code>0x65</code></a></td><td>PUSH6</td><td>Place 6-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push7"><code>0x66</code></a></td><td>PUSH7</td><td>Place 7-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push8"><code>0x67</code></a></td><td>PUSH8</td><td>Place 8-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push9"><code>0x68</code></a></td><td>PUSH9</td><td>Place 9-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push10"><code>0x69</code></a></td><td>PUSH10</td><td>Place 10-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push11"><code>0x6a</code></a></td><td>PUSH11</td><td>Place 11-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push12"><code>0x6b</code></a></td><td>PUSH12</td><td>Place 12-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push13"><code>0x6c</code></a></td><td>PUSH13</td><td>Place 13-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push14"><code>0x6d</code></a></td><td>PUSH14</td><td>Place 14-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push15"><code>0x6e</code></a></td><td>PUSH15</td><td>Place 15-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push16"><code>0x6f</code></a></td><td>PUSH16</td><td>Place 16-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push17"><code>0x70</code></a></td><td>PUSH17</td><td>Place 17-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push18"><code>0x71</code></a></td><td>PUSH18</td><td>Place 18-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push19"><code>0x72</code></a></td><td>PUSH19</td><td>Place 19-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push20"><code>0x73</code></a></td><td>PUSH20</td><td>Place 20-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push21"><code>0x74</code></a></td><td>PUSH21</td><td>Place 21-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push22"><code>0x75</code></a></td><td>PUSH22</td><td>Place 22-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push23"><code>0x76</code></a></td><td>PUSH23</td><td>Place 23-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push24"><code>0x77</code></a></td><td>PUSH24</td><td>Place 24-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push25"><code>0x78</code></a></td><td>PUSH25</td><td>Place 25-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push26"><code>0x79</code></a></td><td>PUSH26</td><td>Place 26-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push27"><code>0x7a</code></a></td><td>PUSH27</td><td>Place 27-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push28"><code>0x7b</code></a></td><td>PUSH28</td><td>Place 28-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push29"><code>0x7c</code></a></td><td>PUSH29</td><td>Place 29-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push30"><code>0x7d</code></a></td><td>PUSH30</td><td>Place 30-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push31"><code>0x7e</code></a></td><td>PUSH31</td><td>Place 31-byte item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#push32"><code>0x7f</code></a></td><td>PUSH32</td><td>Place 32-byte (full word) item on stack</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#dup1"><code>0x80</code></a></td><td>DUP1</td><td>Duplicate 1st stack item</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#dup2"><code>0x81</code></a></td><td>DUP2</td><td>Duplicate 2nd stack item</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#dup3"><code>0x82</code></a></td><td>DUP3</td><td>Duplicate 3rd stack item</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#dup4"><code>0x83</code></a></td><td>DUP4</td><td>Duplicate 4th stack item</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#dup5"><code>0x84</code></a></td><td>DUP5</td><td>Duplicate 5th stack item</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#dup6"><code>0x85</code></a></td><td>DUP6</td><td>Duplicate 6th stack item</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#dup7"><code>0x86</code></a></td><td>DUP7</td><td>Duplicate 7th stack item</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#dup8"><code>0x87</code></a></td><td>DUP8</td><td>Duplicate 8th stack item</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#dup9"><code>0x88</code></a></td><td>DUP9</td><td>Duplicate 9th stack item</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#dup10"><code>0x89</code></a></td><td>DUP10</td><td>Duplicate 10th stack item</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#dup11"><code>0x8a</code></a></td><td>DUP11</td><td>Duplicate 11th stack item</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#dup12"><code>0x8b</code></a></td><td>DUP12</td><td>Duplicate 12th stack item</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#dup13"><code>0x8c</code></a></td><td>DUP13</td><td>Duplicate 13th stack item</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#dup14"><code>0x8d</code></a></td><td>DUP14</td><td>Duplicate 14th stack item</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#dup15"><code>0x8e</code></a></td><td>DUP15</td><td>Duplicate 15th stack item</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#dup16"><code>0x8f</code></a></td><td>DUP16</td><td>Duplicate 16th stack item</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#swap1"><code>0x90</code></a></td><td>SWAP1</td><td>Exchange 1st and 2nd stack items</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#swap2"><code>0x91</code></a></td><td>SWAP2</td><td>Exchange 1st and 3rd stack items</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#swap3"><code>0x92</code></a></td><td>SWAP3</td><td>Exchange 1st and 4th stack items</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#swap4"><code>0x93</code></a></td><td>SWAP4</td><td>Exchange 1st and 5th stack items</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#swap5"><code>0x94</code></a></td><td>SWAP5</td><td>Exchange 1st and 6th stack items</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#swap6"><code>0x95</code></a></td><td>SWAP6</td><td>Exchange 1st and 7th stack items</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#swap7"><code>0x96</code></a></td><td>SWAP7</td><td>Exchange 1st and 8th stack items</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#swap8"><code>0x97</code></a></td><td>SWAP8</td><td>Exchange 1st and 9th stack items</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#swap9"><code>0x98</code></a></td><td>SWAP9</td><td>Exchange 1st and 10th stack items</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#swap10"><code>0x99</code></a></td><td>SWAP10</td><td>Exchange 1st and 11th stack items</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#swap11"><code>0x9a</code></a></td><td>SWAP11</td><td>Exchange 1st and 12th stack items</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#swap12"><code>0x9b</code></a></td><td>SWAP12</td><td>Exchange 1st and 13th stack items</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#swap13"><code>0x9c</code></a></td><td>SWAP13</td><td>Exchange 1st and 14th stack items</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#swap14"><code>0x9d</code></a></td><td>SWAP14</td><td>Exchange 1st and 15th stack items</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#swap15"><code>0x9e</code></a></td><td>SWAP15</td><td>Exchange 1st and 16th stack items</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#swap16"><code>0x9f</code></a></td><td>SWAP16</td><td>Exchange 1st and 17th stack items</td><td>-</td><td>3</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#log0"><code>0xa0</code></a></td><td>LOG0</td><td>Append log record with no topics</td><td>-</td><td>375</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#log1"><code>0xa1</code></a></td><td>LOG1</td><td>Append log record with one topic</td><td>-</td><td>750</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#log2"><code>0xa2</code></a></td><td>LOG2</td><td>Append log record with two topics</td><td>-</td><td>1125</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#log3"><code>0xa3</code></a></td><td>LOG3</td><td>Append log record with three topics</td><td>-</td><td>1500</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#log4"><code>0xa4</code></a></td><td>LOG4</td><td>Append log record with four topics</td><td>-</td><td>1875</td></tr>
<tr><td><code>0xa5</code> - <code>0xaf</code></td><td>Unused</td><td>-</td><td></td><td></td></tr>
<tr><td><code>0xb0</code></td><td>JUMPTO</td><td>Tentative <a href="https://github.com/ethereum/solidity/blob/c61610302aa2bfa029715b534719d25fe3949059/libevmasm/Instruction.h#L176">libevmasm has different numbers</a></td><td><a href="https://github.com/ethereum/EIPs/blob/606405b5ab7aa28d8191958504e8aad4649666c9/EIPS/eip-615.md">EIP 615</a></td><td></td></tr>
<tr><td><code>0xb1</code></td><td>JUMPIF</td><td>Tentative</td><td><a href="https://github.com/ethereum/EIPs/blob/606405b5ab7aa28d8191958504e8aad4649666c9/EIPS/eip-615.md">EIP 615</a></td><td></td></tr>
<tr><td><code>0xb2</code></td><td>JUMPSUB</td><td>Tentative</td><td><a href="https://github.com/ethereum/EIPs/blob/606405b5ab7aa28d8191958504e8aad4649666c9/EIPS/eip-615.md">EIP 615</a></td><td></td></tr>
<tr><td><code>0xb4</code></td><td>JUMPSUBV</td><td>Tentative</td><td><a href="https://github.com/ethereum/EIPs/blob/606405b5ab7aa28d8191958504e8aad4649666c9/EIPS/eip-615.md">EIP 615</a></td><td></td></tr>
<tr><td><code>0xb5</code></td><td>BEGINSUB</td><td>Tentative</td><td><a href="https://github.com/ethereum/EIPs/blob/606405b5ab7aa28d8191958504e8aad4649666c9/EIPS/eip-615.md">EIP 615</a></td><td></td></tr>
<tr><td><code>0xb6</code></td><td>BEGINDATA</td><td>Tentative</td><td><a href="https://github.com/ethereum/EIPs/blob/606405b5ab7aa28d8191958504e8aad4649666c9/EIPS/eip-615.md">EIP 615</a></td><td></td></tr>
<tr><td><code>0xb8</code></td><td>RETURNSUB</td><td>Tentative</td><td><a href="https://github.com/ethereum/EIPs/blob/606405b5ab7aa28d8191958504e8aad4649666c9/EIPS/eip-615.md">EIP 615</a></td><td></td></tr>
<tr><td><code>0xb9</code></td><td>PUTLOCAL</td><td>Tentative</td><td><a href="https://github.com/ethereum/EIPs/blob/606405b5ab7aa28d8191958504e8aad4649666c9/EIPS/eip-615.md">EIP 615</a></td><td></td></tr>
<tr><td><code>0xba</code></td><td>GETLOCAL</td><td>Tentative</td><td><a href="https://github.com/ethereum/EIPs/blob/606405b5ab7aa28d8191958504e8aad4649666c9/EIPS/eip-615.md">EIP 615</a></td><td></td></tr>
<tr><td><code>0xbb</code> - <code>0xe0</code></td><td>Unused</td><td>-</td><td></td><td></td></tr>
<tr><td><code>0xe1</code></td><td>SLOADBYTES</td><td>Only referenced in pyethereum</td><td>-</td><td>-</td></tr>
<tr><td><code>0xe2</code></td><td>SSTOREBYTES</td><td>Only referenced in pyethereum</td><td>-</td><td>-</td></tr>
<tr><td><code>0xe3</code></td><td>SSIZE</td><td>Only referenced in pyethereum</td><td>-</td><td>-</td></tr>
<tr><td><code>0xe4</code> - <code>0xef</code></td><td>Unused</td><td>-</td><td></td><td></td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#create"><code>0xf0</code></a></td><td>CREATE</td><td>Create a new account with associated code</td><td>-</td><td>32000</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#call"><code>0xf1</code></a></td><td>CALL</td><td>Message-call into an account</td><td>-</td><td>Complicated</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#callcode"><code>0xf2</code></a></td><td>CALLCODE</td><td>Message-call into this account with alternative account's code</td><td>-</td><td>Complicated</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#return"><code>0xf3</code></a></td><td>RETURN</td><td>Halt execution returning output data</td><td>-</td><td>0</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#delegatecall"><code>0xf4</code></a></td><td>DELEGATECALL</td><td>Message-call into this account with an alternative account's code, but persisting into this account with an alternative account's code</td><td>-</td><td>Complicated</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#create2"><code>0xf5</code></a></td><td>CREATE2</td><td>Create a new account and set creation address to <code>sha3(sender + sha3(init code)) % 2**160</code></td><td>-</td><td></td></tr>
<tr><td><code>0xf6</code> - <code>0xf9</code></td><td>Unused</td><td>-</td><td>-</td><td></td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#staticcall"><code>0xfa</code></a></td><td>STATICCALL</td><td>Similar to CALL, but does not modify state</td><td>-</td><td>40</td></tr>
<tr><td><code>0xfb</code></td><td>Unused</td><td>-</td><td>-</td><td></td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#revert"><code>0xfd</code></a></td><td>REVERT</td><td>Stop execution and revert state changes, without consuming all provided gas and providing a reason</td><td>-</td><td>0</td></tr>
<tr><td><code>0xfe</code></td><td>INVALID</td><td>Designated invalid instruction</td><td>-</td><td>0</td></tr>
<tr><td><a href="learn_evm/evm_opcodes.html#selfdestruct"><code>0xff</code></a></td><td>SELFDESTRUCT</td><td>Halt execution and register account for later deletion</td><td>-</td><td>5000*</td></tr>
</tbody></table>
</div>
<h2 id="instruction-details"><a class="header" href="#instruction-details">Instruction Details</a></h2>
<hr />
<h3 id="stop"><a class="header" href="#stop">STOP</a></h3>
<p><strong>0x00</strong></p>
<p>() =&gt; ()</p>
<p>halts execution</p>
<hr />
<h3 id="add"><a class="header" href="#add">ADD</a></h3>
<p><strong>0x01</strong></p>
<p>Takes two words from stack, adds them, then pushes the result onto the stack.</p>
<p>(a, b) =&gt; (c)</p>
<p>c = a + b</p>
<hr />
<h3 id="mul"><a class="header" href="#mul">MUL</a></h3>
<p><strong>0x02</strong></p>
<p>(a, b) =&gt; (c)</p>
<p>c = a * b</p>
<hr />
<h3 id="sub"><a class="header" href="#sub">SUB</a></h3>
<p><strong>0x03</strong></p>
<p>(a, b) =&gt; (c)</p>
<p>c = a - b</p>
<hr />
<h3 id="div"><a class="header" href="#div">DIV</a></h3>
<p><strong>0x04</strong></p>
<p>(a, b) =&gt; (c)</p>
<p>c = a / b</p>
<hr />
<h3 id="sdiv"><a class="header" href="#sdiv">SDIV</a></h3>
<p><strong>0x05</strong></p>
<p>(a: int256, b: int256) =&gt; (c: int256)</p>
<p>c = a / b</p>
<hr />
<h3 id="mod"><a class="header" href="#mod">MOD</a></h3>
<p><strong>0x06</strong></p>
<p>(a, b) =&gt; (c)</p>
<p>c = a % b</p>
<hr />
<h3 id="smod"><a class="header" href="#smod">SMOD</a></h3>
<p><strong>0x07</strong></p>
<p>(a: int256, b: int256) =&gt; (c: int256)</p>
<p>c = a % b</p>
<hr />
<h3 id="addmod"><a class="header" href="#addmod">ADDMOD</a></h3>
<p><strong>0x08</strong></p>
<p>(a, b, m) =&gt; (c)</p>
<p>c = (a + b) % m</p>
<hr />
<h3 id="mulmod"><a class="header" href="#mulmod">MULMOD</a></h3>
<p><strong>0x09</strong></p>
<p>(a, b, m) =&gt; (c)</p>
<p>c = (a * b) % m</p>
<hr />
<h3 id="exp"><a class="header" href="#exp">EXP</a></h3>
<p><strong>0x0a</strong></p>
<p>(a, b, m) =&gt; (c)</p>
<p>c = (a * b) % m</p>
<hr />
<h3 id="signextend"><a class="header" href="#signextend">SIGNEXTEND</a></h3>
<p><strong>0x0b</strong></p>
<p>(b, x) =&gt; (y)</p>
<p>y = SIGNEXTEND(x, b)</p>
<p>sign extends x from (b + 1) * 8 bits to 256 bits.</p>
<hr />
<h3 id="lt"><a class="header" href="#lt">LT</a></h3>
<p><strong>0x10</strong></p>
<p>(a, b) =&gt; (c)</p>
<p>c = a &lt; b</p>
<p>all values interpreted as uint256</p>
<hr />
<h3 id="gt"><a class="header" href="#gt">GT</a></h3>
<p><strong>0x11</strong></p>
<p>(a, b) =&gt; (c)</p>
<p>c = a &gt; b</p>
<p>all values interpreted as uint256</p>
<hr />
<h3 id="slt"><a class="header" href="#slt">SLT</a></h3>
<p><strong>0x12</strong></p>
<p>(a, b) =&gt; (c)</p>
<p>c = a &lt; b</p>
<p>all values interpreted as int256</p>
<hr />
<h3 id="sgt"><a class="header" href="#sgt">SGT</a></h3>
<p><strong>0x13</strong></p>
<p>(a, b) =&gt; (c)</p>
<p>c = a &gt; b</p>
<p>all values interpreted as int256</p>
<hr />
<h3 id="eq"><a class="header" href="#eq">EQ</a></h3>
<p><strong>0x14</strong></p>
<p>Pops 2 elements off the stack and pushes the value 1 to the stack in case they're equal, otherwise the value 0.</p>
<p>(a, b) =&gt; (c)</p>
<p>c = a == b</p>
<hr />
<h3 id="iszero"><a class="header" href="#iszero">ISZERO</a></h3>
<p><strong>0x15</strong></p>
<p>(a) =&gt; (c)</p>
<p>c = a == 0</p>
<hr />
<h3 id="and"><a class="header" href="#and">AND</a></h3>
<p><strong>0x16</strong></p>
<p>(a, b) =&gt; (c)</p>
<p>c = a &amp; b</p>
<hr />
<h3 id="or"><a class="header" href="#or">OR</a></h3>
<p><strong>0x17</strong></p>
<p>(a, b) =&gt; (c)</p>
<p>c = a | b</p>
<hr />
<h3 id="xor"><a class="header" href="#xor">XOR</a></h3>
<p><strong>0x18</strong></p>
<p>(a, b) =&gt; (c)</p>
<p>c = a ^ b</p>
<hr />
<h3 id="not"><a class="header" href="#not">NOT</a></h3>
<p><strong>0x19</strong></p>
<p>(a) =&gt; (c)</p>
<p>c = ~a</p>
<hr />
<h3 id="byte"><a class="header" href="#byte">BYTE</a></h3>
<p><strong>0x1a</strong></p>
<p>(i, x) =&gt; (y)</p>
<p>y = (x &gt;&gt; (248 - i * 8) &amp; 0xff</p>
<hr />
<h3 id="shl"><a class="header" href="#shl">SHL</a></h3>
<p><strong>0x1b</strong></p>
<p>Pops 2 elements from the stack and pushes the second element onto the stack shifted left by the shift amount (first element).</p>
<p>(shift, value) =&gt; (res)</p>
<p>res = value &lt;&lt; shift</p>
<hr />
<h3 id="shr"><a class="header" href="#shr">SHR</a></h3>
<p><strong>0x1c</strong></p>
<p>Pops 2 elements from the stack and pushes the second element onto the stack shifted right by the shift amount (first element). </p>
<p>(shift, value) =&gt; (res)</p>
<p>res = value &gt;&gt; shift</p>
<hr />
<h3 id="sar"><a class="header" href="#sar">SAR</a></h3>
<p><strong>0x1d</strong></p>
<p>(shift, value) =&gt; (res)</p>
<p>res = value &gt;&gt; shift</p>
<p>value: int256</p>
<hr />
<h3 id="keccak256"><a class="header" href="#keccak256">KECCAK256</a></h3>
<p><strong>0x20</strong></p>
<p>(offset, len) =&gt; (hash)</p>
<p>hash = keccak256(memory[offset:offset+len])</p>
<hr />
<h3 id="address"><a class="header" href="#address">ADDRESS</a></h3>
<p><strong>0x30</strong></p>
<p>() =&gt; (address(this))</p>
<hr />
<h3 id="balance"><a class="header" href="#balance">BALANCE</a></h3>
<p><strong>0x31</strong></p>
<p>() =&gt; (address(this).balance)</p>
<hr />
<h3 id="origin"><a class="header" href="#origin">ORIGIN</a></h3>
<p><strong>0x32</strong></p>
<p>() =&gt; (tx.origin)</p>
<hr />
<h3 id="caller"><a class="header" href="#caller">CALLER</a></h3>
<p><strong>0x33</strong></p>
<p>() =&gt; (msg.sender)</p>
<hr />
<h3 id="callvalue"><a class="header" href="#callvalue">CALLVALUE</a></h3>
<p><strong>0x34</strong></p>
<p>() =&gt; (msg.value)</p>
<hr />
<h3 id="calldataload"><a class="header" href="#calldataload">CALLDATALOAD</a></h3>
<p><strong>0x35</strong></p>
<p>(index) =&gt; (msg.data[index:index+32])</p>
<hr />
<h3 id="calldatasize"><a class="header" href="#calldatasize">CALLDATASIZE</a></h3>
<p><strong>0x36</strong></p>
<p>() =&gt; (msg.data.size)</p>
<hr />
<h3 id="calldatacopy"><a class="header" href="#calldatacopy">CALLDATACOPY</a></h3>
<p><strong>0x37</strong></p>
<p>(memOffset, offset, length) =&gt; ()</p>
<p>memory[memOffset:memOffset+len] = msg.data[offset:offset+len]</p>
<hr />
<h3 id="codesize"><a class="header" href="#codesize">CODESIZE</a></h3>
<p><strong>0x38</strong></p>
<p>() =&gt; (address(this).code.size)</p>
<hr />
<h3 id="codecopy"><a class="header" href="#codecopy">CODECOPY</a></h3>
<p><strong>0x39</strong></p>
<p>(memOffset, codeOffset, len) =&gt; ()</p>
<p>memory[memOffset:memOffset+len] = address(this).code[codeOffset:codeOffset+len]</p>
<hr />
<h3 id="gasprice"><a class="header" href="#gasprice">GASPRICE</a></h3>
<p><strong>0x3a</strong></p>
<p>() =&gt; (tx.gasprice)</p>
<hr />
<h3 id="extcodesize"><a class="header" href="#extcodesize">EXTCODESIZE</a></h3>
<p><strong>0x3b</strong></p>
<p>(addr) =&gt; (address(addr).code.size)</p>
<hr />
<h3 id="extcodecopy"><a class="header" href="#extcodecopy">EXTCODECOPY</a></h3>
<p><strong>0x3c</strong></p>
<p>(addr, memOffset, offset, length) =&gt; ()</p>
<p>memory[memOffset:memOffset+len] = address(addr).code[codeOffset:codeOffset+len]</p>
<hr />
<h3 id="returndatasize"><a class="header" href="#returndatasize">RETURNDATASIZE</a></h3>
<p><strong>0x3d</strong></p>
<p>() =&gt; (size)</p>
<p>size = RETURNDATASIZE()</p>
<p>The number of bytes that were returned from the last ext call</p>
<hr />
<h3 id="returndatacopy"><a class="header" href="#returndatacopy">RETURNDATACOPY</a></h3>
<p><strong>0x3e</strong></p>
<p>(memOffset, offset, length) =&gt; ()</p>
<p>memory[memOffset:memOffset+len] = RETURNDATA[codeOffset:codeOffset+len]</p>
<p>RETURNDATA is the data returned from the last external call</p>
<hr />
<h3 id="extcodehash"><a class="header" href="#extcodehash">EXTCODEHASH</a></h3>
<p><strong>0x3f</strong></p>
<p>(addr) =&gt; (hash)</p>
<p>hash = address(addr).exists ? keccak256(address(addr).code) : 0</p>
<hr />
<h3 id="blockhash"><a class="header" href="#blockhash">BLOCKHASH</a></h3>
<p><strong>0x40</strong></p>
<p>(number) =&gt; (hash)</p>
<p>hash = block.blockHash(number)</p>
<hr />
<h3 id="coinbase"><a class="header" href="#coinbase">COINBASE</a></h3>
<p><strong>0x41</strong></p>
<p>() =&gt; (block.coinbase)</p>
<hr />
<h3 id="timestamp"><a class="header" href="#timestamp">TIMESTAMP</a></h3>
<p><strong>0x42</strong></p>
<p>() =&gt; (block.timestamp)</p>
<hr />
<h3 id="number"><a class="header" href="#number">NUMBER</a></h3>
<p><strong>0x43</strong></p>
<p>() =&gt; (block.number)</p>
<hr />
<h3 id="difficulty"><a class="header" href="#difficulty">DIFFICULTY</a></h3>
<p><strong>0x44</strong></p>
<p>() =&gt; (block.difficulty)</p>
<hr />
<h3 id="gaslimit"><a class="header" href="#gaslimit">GASLIMIT</a></h3>
<p><strong>0x45</strong></p>
<p>() =&gt; (block.gaslimit)</p>
<hr />
<h3 id="chainid"><a class="header" href="#chainid">CHAINID</a></h3>
<p><strong>0x46</strong></p>
<p>() =&gt; (chainid)</p>
<p>where chainid = 1 for mainnet &amp; some other value for other networks</p>
<hr />
<h3 id="selfbalance"><a class="header" href="#selfbalance">SELFBALANCE</a></h3>
<p><strong>0x47</strong></p>
<p>() =&gt; (address(this).balance)</p>
<hr />
<h3 id="basefee"><a class="header" href="#basefee">BASEFEE</a></h3>
<p><strong>0x48</strong></p>
<p>() =&gt; (block.basefee)</p>
<p>current block's base fee (related to EIP1559)</p>
<hr />
<h3 id="pop"><a class="header" href="#pop">POP</a></h3>
<p><strong>0x50</strong></p>
<p>(a) =&gt; ()</p>
<p>discards the top stack item</p>
<hr />
<h3 id="mload"><a class="header" href="#mload">MLOAD</a></h3>
<p><strong>0x51</strong></p>
<p>(offset) =&gt; (value)</p>
<p>value = memory[offset:offset+32]</p>
<hr />
<h3 id="mstore"><a class="header" href="#mstore">MSTORE</a></h3>
<p><strong>0x52</strong></p>
<p>Saves a word to the EVM memory. Pops 2 elements from stack - the first element being the word memory address where the saved value (second element popped from stack) will be stored. </p>
<p>(offset, value) =&gt; ()</p>
<p>memory[offset:offset+32] = value</p>
<hr />
<h3 id="mstore8"><a class="header" href="#mstore8">MSTORE8</a></h3>
<p><strong>0x53</strong></p>
<p>(offset, value) =&gt; ()</p>
<p>memory[offset:offset+32] = value &amp; 0xff</p>
<hr />
<h3 id="sload"><a class="header" href="#sload">SLOAD</a></h3>
<p><strong>0x54</strong></p>
<p>Pops 1 element off the stack, that being the key which is the storage slot and returns the read value stored there. </p>
<p>(key) =&gt; (value)</p>
<p>value = storage[key]</p>
<hr />
<h3 id="sstore"><a class="header" href="#sstore">SSTORE</a></h3>
<p><strong>0x55</strong></p>
<p>Pops 2 elements off the stack, the first element being the key and the second being the value which is then stored at the storage slot represented from the first element (key). </p>
<p>(key, value) =&gt; ()</p>
<p>storage[key] = value</p>
<hr />
<h3 id="jump"><a class="header" href="#jump">JUMP</a></h3>
<p><strong>0x56</strong></p>
<p>(dest) =&gt; ()</p>
<p>pc = dest</p>
<hr />
<h3 id="jumpi"><a class="header" href="#jumpi">JUMPI</a></h3>
<p><strong>0x57</strong></p>
<p>Conditional - Pops 2 elements from the stack, the first element being the jump location and the second being the value 0 (false) or 1 (true). If the value’s 1 the PC will be altered and the jump executed. Otherwise, the value will be 0 and the PC will remain the same and execution unaltered.</p>
<p>(dest, cond) =&gt; ()</p>
<p>pc = cond ? dest : pc + 1</p>
<hr />
<h3 id="pc"><a class="header" href="#pc">PC</a></h3>
<p><strong>0x58</strong></p>
<p>() =&gt; (pc)</p>
<hr />
<h3 id="msize"><a class="header" href="#msize">MSIZE</a></h3>
<p><strong>0x59</strong></p>
<p>() =&gt; (memory.size)</p>
<hr />
<h3 id="gas"><a class="header" href="#gas">GAS</a></h3>
<p><strong>0x5a</strong></p>
<p>() =&gt; (gasRemaining)</p>
<p>not including the gas required for this opcode</p>
<hr />
<h3 id="jumpdest"><a class="header" href="#jumpdest">JUMPDEST</a></h3>
<p><strong>0x5b</strong></p>
<p>() =&gt; ()</p>
<p>noop, marks a valid jump destination</p>
<hr />
<h3 id="push1"><a class="header" href="#push1">PUSH1</a></h3>
<p><strong>0x60</strong></p>
<p>The following byte is read from PC, placed into a word, then this word is pushed onto the stack.</p>
<p>() =&gt; (address(this).code[pc+1:pc+2])</p>
<hr />
<h3 id="push2"><a class="header" href="#push2">PUSH2</a></h3>
<p><strong>0x61</strong></p>
<p>() =&gt; (address(this).code[pc+2:pc+3])</p>
<hr />
<h3 id="push3"><a class="header" href="#push3">PUSH3</a></h3>
<p><strong>0x62</strong></p>
<p>() =&gt; (address(this).code[pc+3:pc+4])</p>
<hr />
<h3 id="push4"><a class="header" href="#push4">PUSH4</a></h3>
<p><strong>0x63</strong></p>
<p>() =&gt; (address(this).code[pc+4:pc+5])</p>
<hr />
<h3 id="push5"><a class="header" href="#push5">PUSH5</a></h3>
<p><strong>0x64</strong></p>
<p>() =&gt; (address(this).code[pc+5:pc+6])</p>
<hr />
<h3 id="push6"><a class="header" href="#push6">PUSH6</a></h3>
<p><strong>0x65</strong></p>
<p>() =&gt; (address(this).code[pc+6:pc+7])</p>
<hr />
<h3 id="push7"><a class="header" href="#push7">PUSH7</a></h3>
<p><strong>0x66</strong></p>
<p>() =&gt; (address(this).code[pc+7:pc+8])</p>
<hr />
<h3 id="push8"><a class="header" href="#push8">PUSH8</a></h3>
<p><strong>0x67</strong></p>
<p>() =&gt; (address(this).code[pc+8:pc+9])</p>
<hr />
<h3 id="push9"><a class="header" href="#push9">PUSH9</a></h3>
<p><strong>0x68</strong></p>
<p>() =&gt; (address(this).code[pc+9:pc+10])</p>
<hr />
<h3 id="push10"><a class="header" href="#push10">PUSH10</a></h3>
<p><strong>0x69</strong></p>
<p>() =&gt; (address(this).code[pc+10:pc+11])</p>
<hr />
<h3 id="push11"><a class="header" href="#push11">PUSH11</a></h3>
<p><strong>0x6a</strong></p>
<p>() =&gt; (address(this).code[pc+11:pc+12])</p>
<hr />
<h3 id="push12"><a class="header" href="#push12">PUSH12</a></h3>
<p><strong>0x6b</strong></p>
<p>() =&gt; (address(this).code[pc+12:pc+13])</p>
<hr />
<h3 id="push13"><a class="header" href="#push13">PUSH13</a></h3>
<p><strong>0x6c</strong></p>
<p>() =&gt; (address(this).code[pc+13:pc+14])</p>
<hr />
<h3 id="push14"><a class="header" href="#push14">PUSH14</a></h3>
<p><strong>0x6d</strong></p>
<p>() =&gt; (address(this).code[pc+14:pc+15])</p>
<hr />
<h3 id="push15"><a class="header" href="#push15">PUSH15</a></h3>
<p><strong>0x6e</strong></p>
<p>() =&gt; (address(this).code[pc+15:pc+16])</p>
<hr />
<h3 id="push16"><a class="header" href="#push16">PUSH16</a></h3>
<p><strong>0x6f</strong></p>
<p>() =&gt; (address(this).code[pc+16:pc+17])</p>
<hr />
<h3 id="push17"><a class="header" href="#push17">PUSH17</a></h3>
<p><strong>0x70</strong></p>
<p>() =&gt; (address(this).code[pc+17:pc+18])</p>
<hr />
<h3 id="push18"><a class="header" href="#push18">PUSH18</a></h3>
<p><strong>0x71</strong></p>
<p>() =&gt; (address(this).code[pc+18:pc+19])</p>
<hr />
<h3 id="push19"><a class="header" href="#push19">PUSH19</a></h3>
<p><strong>0x72</strong></p>
<p>() =&gt; (address(this).code[pc+19:pc+20])</p>
<hr />
<h3 id="push20"><a class="header" href="#push20">PUSH20</a></h3>
<p><strong>0x73</strong></p>
<p>() =&gt; (address(this).code[pc+20:pc+21])</p>
<hr />
<h3 id="push21"><a class="header" href="#push21">PUSH21</a></h3>
<p><strong>0x74</strong></p>
<p>() =&gt; (address(this).code[pc+21:pc+22])</p>
<hr />
<h3 id="push22"><a class="header" href="#push22">PUSH22</a></h3>
<p><strong>0x75</strong></p>
<p>() =&gt; (address(this).code[pc+22:pc+23])</p>
<hr />
<h3 id="push23"><a class="header" href="#push23">PUSH23</a></h3>
<p><strong>0x76</strong></p>
<p>() =&gt; (address(this).code[pc+23:pc+24])</p>
<hr />
<h3 id="push24"><a class="header" href="#push24">PUSH24</a></h3>
<p><strong>0x77</strong></p>
<p>() =&gt; (address(this).code[pc+24:pc+25])</p>
<hr />
<h3 id="push25"><a class="header" href="#push25">PUSH25</a></h3>
<p><strong>0x78</strong></p>
<p>() =&gt; (address(this).code[pc+25:pc+26])</p>
<hr />
<h3 id="push26"><a class="header" href="#push26">PUSH26</a></h3>
<p><strong>0x79</strong></p>
<p>() =&gt; (address(this).code[pc+26:pc+27])</p>
<hr />
<h3 id="push27"><a class="header" href="#push27">PUSH27</a></h3>
<p><strong>0x7a</strong></p>
<p>() =&gt; (address(this).code[pc+27:pc+28])</p>
<hr />
<h3 id="push28"><a class="header" href="#push28">PUSH28</a></h3>
<p><strong>0x7b</strong></p>
<p>() =&gt; (address(this).code[pc+28:pc+29])</p>
<hr />
<h3 id="push29"><a class="header" href="#push29">PUSH29</a></h3>
<p><strong>0x7c</strong></p>
<p>() =&gt; (address(this).code[pc+29:pc+30])</p>
<hr />
<h3 id="push30"><a class="header" href="#push30">PUSH30</a></h3>
<p><strong>0x7d</strong></p>
<p>() =&gt; (address(this).code[pc+30:pc+31])</p>
<hr />
<h3 id="push31"><a class="header" href="#push31">PUSH31</a></h3>
<p><strong>0x7e</strong></p>
<p>() =&gt; (address(this).code[pc+31:pc+32])</p>
<hr />
<h3 id="push32"><a class="header" href="#push32">PUSH32</a></h3>
<p><strong>0x7f</strong></p>
<p>() =&gt; (address(this).code[pc+32:pc+33])</p>
<hr />
<h3 id="dup1"><a class="header" href="#dup1">DUP1</a></h3>
<p><strong>0x80</strong></p>
<p>(1) =&gt; (1, 1)</p>
<hr />
<h3 id="dup2"><a class="header" href="#dup2">DUP2</a></h3>
<p><strong>0x81</strong></p>
<p>(1, 2) =&gt; (2, 1, 2)</p>
<hr />
<h3 id="dup3"><a class="header" href="#dup3">DUP3</a></h3>
<p><strong>0x82</strong></p>
<p>(1, 2, 3) =&gt; (3, 1, 2, 3)</p>
<hr />
<h3 id="dup4"><a class="header" href="#dup4">DUP4</a></h3>
<p><strong>0x83</strong></p>
<p>(1, ..., 4) =&gt; (4, 1, ..., 4)</p>
<hr />
<h3 id="dup5"><a class="header" href="#dup5">DUP5</a></h3>
<p><strong>0x84</strong></p>
<p>(1, ..., 5) =&gt; (5, 1, ..., 5)</p>
<hr />
<h3 id="dup6"><a class="header" href="#dup6">DUP6</a></h3>
<p><strong>0x85</strong></p>
<p>(1, ..., 6) =&gt; (6, 1, ..., 6)</p>
<hr />
<h3 id="dup7"><a class="header" href="#dup7">DUP7</a></h3>
<p><strong>0x86</strong></p>
<p>(1, ..., 7) =&gt; (7, 1, ..., 7)</p>
<hr />
<h3 id="dup8"><a class="header" href="#dup8">DUP8</a></h3>
<p><strong>0x87</strong></p>
<p>(1, ..., 8) =&gt; (8, 1, ..., 8)</p>
<hr />
<h3 id="dup9"><a class="header" href="#dup9">DUP9</a></h3>
<p><strong>0x88</strong></p>
<p>(1, ..., 9) =&gt; (9, 1, ..., 9)</p>
<hr />
<h3 id="dup10"><a class="header" href="#dup10">DUP10</a></h3>
<p><strong>0x89</strong></p>
<p>(1, ..., 10) =&gt; (10, 1, ..., 10)</p>
<hr />
<h3 id="dup11"><a class="header" href="#dup11">DUP11</a></h3>
<p><strong>0x8a</strong></p>
<p>(1, ..., 11) =&gt; (11, 1, ..., 11)</p>
<hr />
<h3 id="dup12"><a class="header" href="#dup12">DUP12</a></h3>
<p><strong>0x8b</strong></p>
<p>(1, ..., 12) =&gt; (12, 1, ..., 12)</p>
<hr />
<h3 id="dup13"><a class="header" href="#dup13">DUP13</a></h3>
<p><strong>0x8c</strong></p>
<p>(1, ..., 13) =&gt; (13, 1, ..., 13)</p>
<hr />
<h3 id="dup14"><a class="header" href="#dup14">DUP14</a></h3>
<p><strong>0x8d</strong></p>
<p>(1, ..., 14) =&gt; (14, 1, ..., 14)</p>
<hr />
<h3 id="dup15"><a class="header" href="#dup15">DUP15</a></h3>
<p><strong>0x8e</strong></p>
<p>(1, ..., 15) =&gt; (15, 1, ..., 15)</p>
<hr />
<h3 id="dup16"><a class="header" href="#dup16">DUP16</a></h3>
<p><strong>0x8f</strong></p>
<p>(1, ..., 16) =&gt; (16, 1, ..., 16)</p>
<hr />
<h3 id="swap1"><a class="header" href="#swap1">SWAP1</a></h3>
<p><strong>0x90</strong></p>
<p>(1, 2) =&gt; (2, 1)</p>
<hr />
<h3 id="swap2"><a class="header" href="#swap2">SWAP2</a></h3>
<p><strong>0x91</strong></p>
<p>(1, 2, 3) =&gt; (3, 2, 1)</p>
<hr />
<h3 id="swap3"><a class="header" href="#swap3">SWAP3</a></h3>
<p><strong>0x92</strong></p>
<p>(1, ..., 4) =&gt; (4, ..., 1)</p>
<hr />
<h3 id="swap4"><a class="header" href="#swap4">SWAP4</a></h3>
<p><strong>0x93</strong></p>
<p>(1, ..., 5) =&gt; (5, ..., 1)</p>
<hr />
<h3 id="swap5"><a class="header" href="#swap5">SWAP5</a></h3>
<p><strong>0x94</strong></p>
<p>(1, ..., 6) =&gt; (6, ..., 1)</p>
<hr />
<h3 id="swap6"><a class="header" href="#swap6">SWAP6</a></h3>
<p><strong>0x95</strong></p>
<p>(1, ..., 7) =&gt; (7, ..., 1)</p>
<hr />
<h3 id="swap7"><a class="header" href="#swap7">SWAP7</a></h3>
<p><strong>0x96</strong></p>
<p>(1, ..., 8) =&gt; (8, ..., 1)</p>
<hr />
<h3 id="swap8"><a class="header" href="#swap8">SWAP8</a></h3>
<p><strong>0x97</strong></p>
<p>(1, ..., 9) =&gt; (9, ..., 1)</p>
<hr />
<h3 id="swap9"><a class="header" href="#swap9">SWAP9</a></h3>
<p><strong>0x98</strong></p>
<p>(1, ..., 10) =&gt; (10, ..., 1)</p>
<hr />
<h3 id="swap10"><a class="header" href="#swap10">SWAP10</a></h3>
<p><strong>0x99</strong></p>
<p>(1, ..., 11) =&gt; (11, ..., 1)</p>
<hr />
<h3 id="swap11"><a class="header" href="#swap11">SWAP11</a></h3>
<p><strong>0x9a</strong></p>
<p>(1, ..., 12) =&gt; (12, ..., 1)</p>
<hr />
<h3 id="swap12"><a class="header" href="#swap12">SWAP12</a></h3>
<p><strong>0x9b</strong></p>
<p>(1, ..., 13) =&gt; (13, ..., 1)</p>
<hr />
<h3 id="swap13"><a class="header" href="#swap13">SWAP13</a></h3>
<p><strong>0x9c</strong></p>
<p>(1, ..., 14) =&gt; (14, ..., 1)</p>
<hr />
<h3 id="swap14"><a class="header" href="#swap14">SWAP14</a></h3>
<p><strong>0x9d</strong></p>
<p>(1, ..., 15) =&gt; (15, ..., 1)</p>
<hr />
<h3 id="swap15"><a class="header" href="#swap15">SWAP15</a></h3>
<p><strong>0x9e</strong></p>
<p>(1, ..., 16) =&gt; (16, ..., 1)</p>
<hr />
<h3 id="swap16"><a class="header" href="#swap16">SWAP16</a></h3>
<p><strong>0x9f</strong></p>
<p>(1, ..., 17) =&gt; (17, ..., 1)</p>
<hr />
<h3 id="log0"><a class="header" href="#log0">LOG0</a></h3>
<p><strong>0xa0</strong></p>
<p>(offset, length) =&gt; ()</p>
<p>emit(memory[offset:offset+length])</p>
<hr />
<h3 id="log1"><a class="header" href="#log1">LOG1</a></h3>
<p><strong>0xa1</strong></p>
<p>(offset, length, topic0) =&gt; ()</p>
<p>emit(memory[offset:offset+length], topic0)</p>
<hr />
<h3 id="log2"><a class="header" href="#log2">LOG2</a></h3>
<p><strong>0xa2</strong></p>
<p>(offset, length, topic0, topic1) =&gt; ()</p>
<p>emit(memory[offset:offset+length], topic0, topic1)</p>
<hr />
<h3 id="log3"><a class="header" href="#log3">LOG3</a></h3>
<p><strong>0xa3</strong></p>
<p>(offset, length, topic0, topic1, topic2) =&gt; ()</p>
<p>emit(memory[offset:offset+length], topic0, topic1, topic2)</p>
<hr />
<h3 id="log4"><a class="header" href="#log4">LOG4</a></h3>
<p><strong>0xa4</strong></p>
<p>(offset, length, topic0, topic1, topic2, topic3) =&gt; ()</p>
<p>emit(memory[offset:offset+length], topic0, topic1, topic2, topic3)</p>
<hr />
<h3 id="create"><a class="header" href="#create">CREATE</a></h3>
<p><strong>0xf0</strong></p>
<p>(value, offset, length) =&gt; (addr)</p>
<p>addr = keccak256(rlp([address(this), this.nonce]))[12:]
addr.code = exec(memory[offset:offset+length])
addr.balance += value
this.balance -= value
this.nonce += 1</p>
<hr />
<h3 id="call"><a class="header" href="#call">CALL</a></h3>
<p><strong>0xf1</strong></p>
<p>(gas, addr, value, argsOffset, argsLength, retOffset, retLength) =&gt; (success)</p>
<p>memory[retOffset:retOffset+retLength] = address(addr).callcode.gas(gas).value(value)(memory[argsOffset:argsOffset+argsLength])
success = true (unless the prev call reverted)</p>
<hr />
<h3 id="callcode"><a class="header" href="#callcode">CALLCODE</a></h3>
<p><strong>0xf2</strong></p>
<p>(gas, addr, value, argsOffset, argsLength, retOffset, retLength) =&gt; (success)</p>
<p>memory[retOffset:retOffset+retLength] = address(addr).callcode.gas(gas).value(value)(memory[argsOffset:argsOffset+argsLength])
success = true (unless the prev call reverted)</p>
<p>TODO: what's the difference between this &amp; CALL?</p>
<hr />
<h3 id="return"><a class="header" href="#return">RETURN</a></h3>
<p><strong>0xf3</strong></p>
<p>(offset, length) =&gt; ()</p>
<p>return memory[offset:offset+length]</p>
<hr />
<h3 id="delegatecall"><a class="header" href="#delegatecall">DELEGATECALL</a></h3>
<p><strong>0xf4</strong></p>
<p>(gas, addr, argsOffset, argsLength, retOffset, retLength) =&gt; (success)</p>
<p>memory[retOffset:retOffset+retLength] = address(addr).delegatecall.gas(gas)(memory[argsOffset:argsOffset+argsLength])
success = true (unless the prev call reverted)</p>
<hr />
<h3 id="create2"><a class="header" href="#create2">CREATE2</a></h3>
<p><strong>0xf5</strong></p>
<p>(value, offset, length, salt) =&gt; (addr)</p>
<p>initCode = memory[offset:offset+length]
addr = keccak256(0xff ++ address(this) ++ salt ++ keccak256(initCode))[12:]
address(addr).code = exec(initCode)</p>
<hr />
<h3 id="staticcall"><a class="header" href="#staticcall">STATICCALL</a></h3>
<p><strong>0xfa</strong></p>
<p>(gas, addr, argsOffset, argsLength, retOffset, retLength) =&gt; (success)</p>
<p>memory[retOffset:retOffset+retLength] = address(addr).delegatecall.gas(gas)(memory[argsOffset:argsOffset+argsLength])
success = true (unless the prev call reverted)</p>
<p>TODO: what's the difference between this &amp; DELEGATECALL?</p>
<hr />
<h3 id="revert"><a class="header" href="#revert">REVERT</a></h3>
<p><strong>0xfd</strong></p>
<p>(offset, length) =&gt; ()</p>
<p>revert(memory[offset:offset+length])</p>
<hr />
<h3 id="selfdestruct"><a class="header" href="#selfdestruct">SELFDESTRUCT</a></h3>
<p><strong>0xff</strong></p>
<p>(addr) =&gt; ()</p>
<p>address(addr).send(address(this).balance)
this.code = 0</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tracing-utils"><a class="header" href="#tracing-utils">Tracing Utils</a></h1>
<h2 id="transaction-tracing"><a class="header" href="#transaction-tracing">Transaction Tracing</a></h2>
<p>One great way to learn more about how the EVM works internally is to trace the execution of a transaction opcode by opcode. This technique can also help you assess the correctness of assembly code and catch problems related to the compiler or it's optimization steps.</p>
<p>The following Javascript snippet uses an <code>ethers</code> provider to connect to an ethereum node with the <code>debug</code> JSON RPC endpoints activated. Although this requires an archive node on mainnet, it can also be run quickly &amp; easily against a local development testnet using hardhat node, ganache, or some other ethprovider that targets developers.</p>
<p>Transaction traces for even simple smart contract interactions are verbose so we recommend you provide a filename to save the trace at for further analysis. Note that the following function depends on the <code>fs</code> module built into node.js so it should be copied into a node console rather than a browser console, however the filesystem interactions could be removed for use in the browser.</p>
<pre><code>const ethers = require(&quot;ethers&quot;);
const fs = require(&quot;fs&quot;);

const provider = new ethers.providers.JsonRpcProvider(
  process.env.ETH_PROVIDER || &quot;http://localhost:8545&quot;
);

let traceTx = async (txHash, filename) =&gt; {
  await provider.send(&quot;debug_traceTransaction&quot;, [txHash]).then((res) =&gt; {
    console.log(`Got a response with keys: ${Object.keys(res)}`);
    const indexedRes = {
      ...res,
      structLogs: res.structLogs.map((structLog, index) =&gt; ({
        index,
        ...structLog,
      })),
    };
    if (filename) {
      fs.writeFileSync(filename, JSON.stringify(indexedRes, null, 2));
    } else {
      log(indexecRes);
    }
  });
};
</code></pre>
<p>Note that, by default, transaction traces do not feature a sequential index making it difficult to answer, for example, &quot;Which was the 100th opcode executed?&quot; The above script adds such an index for easier navigation and communication.</p>
<p>The output of the above features a list of opcode executions, a snippet of which might look something like:</p>
<pre><code>{
  &quot;structLogs&quot;: [
    ...,  
    {
      &quot;index&quot;: 191,
      &quot;pc&quot;: 3645,
      &quot;op&quot;: &quot;SSTORE&quot;,
      &quot;gas&quot;: 10125,
      &quot;gasCost&quot;: 2900,
      &quot;depth&quot;: 1,
      &quot;stack&quot;: [
        &quot;0xa9059cbb&quot;,
        &quot;0x700&quot;,
        &quot;0x7fb610713c8404e21676c01c271bb662df6eb63c&quot;,
        &quot;0x1d8b64f4775be40000&quot;,
        &quot;0x0&quot;,
        &quot;0x1e01&quot;,
        &quot;0x68e224065325c640131672779181a2f2d1324c4d&quot;,
        &quot;0x7fb610713c8404e21676c01c271bb662df6eb63c&quot;,
        &quot;0x1d8b64f4775be40000&quot;,
        &quot;0x0&quot;,
        &quot;0x14af3e50252dfc40000&quot;,
        &quot;0x14af3e50252dfc40000&quot;,
        &quot;0x7d7d4dc7c32ad4c905ab39fc25c4323c4a85e4b1b17a396514e6b88ee8b814e8&quot;
      ],
      &quot;memory&quot;: [
        &quot;00000000000000000000000068e224065325c640131672779181a2f2d1324c4d&quot;,
        &quot;0000000000000000000000000000000000000000000000000000000000000002&quot;,
        &quot;0000000000000000000000000000000000000000000000000000000000000080&quot;
      ],
      &quot;storage&quot;: {
        &quot;7d7d4dc7c32ad4c905ab39fc25c4323c4a85e4b1b17a396514e6b88ee8b814e8&quot;: &quot;00000000000000000000000000000000000000000000014af3e50252dfc40000&quot;
      }
    },
    ...,  
  ],
  &quot;gas&quot;: 34718,
  &quot;failed&quot;: false,
  &quot;returnValue&quot;: &quot;0000000000000000000000000000000000000000000000000000000000000001&quot;
}
</code></pre>
<p>An overview of the fields for opcode execution trace:</p>
<ul>
<li><code>index</code>: The index we added, indicates that the above opcode was the 191st one executed. Helpful for staying oriented as you jump around the trace.</li>
<li><code>pc</code>: program counter eg this opcode exists at index <code>3645</code> of the contract bytecode. You'll notice that <code>pc</code> increments by one for many common opcodes, by more than one for PUSH opcodes, and is reset entirely by JUMP/JUMP opcodes.</li>
<li><code>op</code>: name of the opcode, because most of the actual data is hex-encoded, using grep or ctrl-f to search through the trace for opcode names is an effective strategy.</li>
<li><code>gas</code>: remaining gas <em>before</em> the opcode is executed</li>
<li><code>gasCost</code>: cost of this operation, for CALL &amp; similar opcodes, this cost takes into account all gas spent by the child execution frame.</li>
<li><code>depth</code>: each call creates a new child execution frame &amp; this variable tracks how many sub-frames exist. Generally, CALL opcodes increase the depth and RETURN opcodes decrease it.</li>
<li><code>stack</code>: a snapshot of the entire stack <em>before</em> the opcode executes</li>
<li><code>memory</code>: a snapshot of the entire memory <em>before</em> the opcode executes</li>
<li><code>storage</code>: an accumulation of all state changes made during the execution of the transaction being traced</li>
</ul>
<p>One big challenge of navigating such a transaction trace is matching opcode executions to higher-level solidity code. An effective first step is to identify uncommon opcodes which correspond to easily identified logic of the source code. Generally, expensive operations are relatively uncommon so SLOAD and SSTORE are good ones to scan for first and match against places where state variables are being read or written in solidity. Alternatively, CALL and related opcodes are relatively uncommon and can be matched with calls to other contracts in the source code.</p>
<p>If there's a specific part of the source code that you're interested in tracing, matching uncommon opcodes to the source code will give you bounds on where to search. From here, you'll likely start walking through the trace opcode-by-opcode as you review the source code line by line. Leaving a few ephemeral comments in the source code like <code># opcode 191</code> can help you keep track and pick up where you left off if you need to take a break.</p>
<p>Exploring transaction traces is challenging work but the reward is an ultra-high-definition view into how the EVM operates internally and can help you identify problems that might not be apparent from just the source code.</p>
<h2 id="storage-tracing"><a class="header" href="#storage-tracing">Storage Tracing</a></h2>
<p>Although you can get an overview of all the changes to the contract state by checking the <code>storage</code> field of the last executed opcode in the above trace, the following helper function will extract that for you for quicker and easier analysis. If you're doing a more involved investigation into a contract's state, we recommend you check out the <a href="https://blog.trailofbits.com/2022/07/28/shedding-smart-contract-storage-with-slither/"><code>slither-read-storage</code></a> command for a more powerful tool.</p>
<pre><code>const traceStorage = async (txHash) =&gt; {
  await provider.send(&quot;debug_traceTransaction&quot;, [txHash]).then((res) =&gt; {
    log(res.structLogs[res.structLogs.length - 1].storage);
  });
};
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ethereum-yellow-paper"><a class="header" href="#ethereum-yellow-paper">Ethereum Yellow Paper</a></h1>
<p>So, you want to read the yellow paper. Before we dive in, keep in mind that the yellow paper is out of date and some in the community might refer to it as being depreciated. Check out the <a href="https://github.com/ethereum/yellowpaper/blob/master/BRANCHES.md">BRANCHES.md</a> file of the <a href="https://github.com/ethereum/yellowpaper"><code>yellowpaper</code> repository on github</a> to stay up-to-date on how closely this document tracks the latest version of the Ethereum protocol. At the time of writing, the yellow paper is up to date with the Berlin hardfork which occurred in April 2021. For an overview of all Ethereum forks and which EIPs are included in each of them, see the <a href="learn_evm/./eips_forks.html">EIPs Forks</a> page.</p>
<p>For a more up-to-date reference, check out the <a href="https://ethereum.github.io/execution-specs/autoapi/ethereum/">Ethereum Specification</a> which features a detailed description of each opcode <em>for each hardfork</em> in addition to reference implementations written in python.</p>
<p>That said, the yellow paper is still a rich resource for ramping up on the fundamentals of the Ethereum protocol. This document aims to provide some guidance and assistance in deciphering Ethereum's flagship specification.</p>
<h2 id="mathematical-symbols"><a class="header" href="#mathematical-symbols">Mathematical Symbols</a></h2>
<p>One challenging part of the yellow paper, for those of us who are not so well trained in formal mathematics, is comprehending the mathematical symbols. A cheat-sheet of some of these symbols is provided below</p>
<ul>
<li><code>∃</code>: there exists</li>
<li><code>∀</code>: for all</li>
<li><code>∧</code>: and</li>
<li><code>∨</code>: or</li>
</ul>
<p>And some more Ethereum-specific symbols:</p>
<ul>
<li><code>N_{H}</code>: 1,150,000 aka block number at which the protocol was upgraded from homestead to frontier.</li>
<li><code>T</code>: a transaction eg <code>T = { n: nonce, p: gasPrice, g: gasLimit, t: to, v: value, i: initBytecode, d: data }</code></li>
<li><code>S()</code>: returns the sender of a transaction eg <code>S(T) = T.from</code></li>
<li><code>Λ</code>: (lambda) account creation function</li>
<li><code>KEC</code>: Keccak SHA-3 hash function</li>
<li><code>RLP</code>: Recursive Length Prefix encoding</li>
</ul>
<h2 id="high-level-glossary"><a class="header" href="#high-level-glossary">High-level glossary</a></h2>
<p>The following are symbols and function representations that provide a high-level description of ethereum. Many of these symbols represent a data structure, the details of which are described in subsequent sections.</p>
<ul>
<li><code>σ</code>: ethereum world state</li>
<li><code>B</code>: block</li>
<li><code>μ</code>: EVM state</li>
<li><code>A</code>: accumulated transaction sub-state</li>
<li><code>I</code>: execution environment</li>
<li><code>o</code>: output of <code>H(μ,I)</code> ie null if we're good to go or a set of data if execution should halt</li>
<li><code>Υ(σ,T) =&gt; σ'</code>: the transaction-level state transition function</li>
<li><code>Π(σ,B) =&gt; σ'</code>: the block-level state transition function, processes all transactions then finalizes with Ω</li>
<li><code>Ω(B,σ) =&gt; σ</code>: block-finalisation state transition function</li>
<li><code>O(σ,μ,A,I)</code>: one iteration of the execution cycle</li>
<li><code>H(μ,I) =&gt; o</code>: outputs null while execution should continue or a series if execution should halt.</li>
</ul>
<h2 id="ethereum-world-state-σ"><a class="header" href="#ethereum-world-state-σ">Ethereum World-State: σ</a></h2>
<p>A mapping between addresses (external or contract) and account states. Saved as a Merkle-Patricia tree whose root is recorded on the blockchain backbone.</p>
<pre><code>σ = [ account1={...}, account2={...},
  account3= {
    n: nonce aka number of transactions sent by account3
    b: balance ie number of wei account3 controls
    s: storage root, hash of the merkle-patricia tree that contains this accounts long-term data store
    c: code, hash of the EVM bytecode that controls this account. If this equals the hash of an empty string, this is a non-contract account.
  }, ...
]
</code></pre>
<h2 id="the-block-b"><a class="header" href="#the-block-b">The Block: B</a></h2>
<pre><code>B = Block = {
  H: Header = {
    p: parentHash,
    o: ommersHash,
    c: beneficiary,
    r: stateRoot,
    t: transactionsRoot,
    e: receiptsRoot,
    b: logsBloomFilter,
    d: difficulty,
    i: number,
    l: gasLimit,
    g: gasUsed,
    s: timestamp,
    x: extraData,
    m: mixHash,
    n: nonce,
  },
  T: Transactions = [
    tx1, tx2...
  ],
  U: Uncle block headers = [
    header1, header2..
  ],
  R: Transaction Receipts = [
    receipt_1 = {
      σ: root hash of the ETH state after transaction 1 finishes executing,
      u: cumulative gas used immediately after this tx completes,
      b: bloom filter,
      l: set of logs created while executing this tx
    }
  ]
}
</code></pre>
<h2 id="execution-environment-i"><a class="header" href="#execution-environment-i">Execution Environment: I</a></h2>
<pre><code>I = Execution Environment = {
  a: address(this) address of the account which owns the executing code
  o: tx.origin original sender of the tx that initialized this execution
  p: tx.gasPrice price of gas
  d: data aka byte array of method id &amp; args
  s: sender of this tx or initiator of this execution
  v: value send along w this execution or transaction
  b: byte array of machine code to be executed
  H: header of the current block
  e: current stack depth
}
</code></pre>
<h2 id="evm-state-μ"><a class="header" href="#evm-state-μ">EVM state: μ</a></h2>
<p>The state of the EVM during execution. This is the data structure provided by the <code>debug_traceTransaction</code> JSON RPC method, see <a href="learn_evm/./tracing.html">this page</a> for more details about using this method to investigate transaction execution.</p>
<pre><code>μ = {
  g: gas left
  pc: program counter ie index into which instruction of I.b to execute next
  m: memory contents, lazily initialized to 2^256 zeros
  i: number of words in memory
  s: stack contents
}
</code></pre>
<h2 id="accrued-sub-state-a"><a class="header" href="#accrued-sub-state-a">Accrued sub-state: A</a></h2>
<p>The data accumulated during tx execution that needs to be available at the end to finalize the transactions state changes.</p>
<pre><code>A = {
  s: suicide set ie the accounts to delete at the end of this tx
  l: logs
  t: touched accounts
  r: refunds eg gas received when storage is freed
}
</code></pre>
<h2 id="contract-creation"><a class="header" href="#contract-creation">Contract Creation</a></h2>
<p>If we send a transaction <code>tx</code> to create a contract, <code>tx.to</code> is set to <code>null</code> and we include a <code>tx.init</code> field that contains bytecode. This is NOT the bytecode run by the contract, rather it RETURNS the bytecode run by the contract ie the <code>tx.init</code> code is run ONCE at contract creation and never again.</p>
<p>If <code>T.to == 0</code> then this is a contract creation transaction and <code>T.init != null</code>, <code>T.data == null</code></p>
<div style="break-before: page; page-break-before: always;"></div><p>The following lists every EIP associated to an Ethereum fork.</p>
<div class="table-wrapper"><table><thead><tr><th>Fork</th><th>EIP</th><th>What it does</th><th>Opcode</th><th>Gas</th><th>Notes</th></tr></thead><tbody>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-606">Homestead (606)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-2">2</a></td><td>Homestead Hard-fork Changes</td><td></td><td>X</td><td></td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-606">Homestead (606)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-7">7</a></td><td>Delegatecall</td><td>X</td><td></td><td></td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-606">Homestead (606)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-8">8</a></td><td>Networking layer: devp2p Forward Compatibility Requirements for Homestead</td><td></td><td></td><td></td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-779">DAO Fork (779)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-779">779</a></td><td>DAO Fork</td><td></td><td></td><td></td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-608">Tangerine Whistle (608)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-150">150</a></td><td>Gas cost changes for IO-heavy operations</td><td></td><td>X</td><td>Define the <em>all but one 64th</em> rule</td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-607">Spurious Dragon (607)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-155">155</a></td><td>Simple replay attack protection</td><td></td><td></td><td></td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-607">Spurious Dragon (607)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-160">160</a></td><td>EXP cost increase</td><td></td><td>X</td><td></td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-607">Spurious Dragon (607)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-161">161</a></td><td>State trie clearing (invariant-preserving alternative)</td><td></td><td>X</td><td></td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-607">Spurious Dragon (607)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-170">170</a></td><td>Contract code size limit</td><td></td><td></td><td>Change the semantics of CREATE</td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-609">Byzantium (609)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-100">100</a></td><td>Change difficulty adjustment to target mean block time including uncles</td><td></td><td></td><td></td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-609">Byzantium (609)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-140">140</a></td><td>REVERT instruction</td><td>X</td><td></td><td></td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-609">Byzantium (609)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-196">196</a></td><td>Precompiled contracts for addition and scalar multiplication on the elliptic curve alt_bn128</td><td></td><td></td><td></td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-609">Byzantium (609)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-197">197</a></td><td>Precompiled contracts for optimal ate pairing check on the elliptic curve alt_bn128</td><td></td><td></td><td></td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-609">Byzantium (609)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-198">198</a></td><td>Precompiled contract for bigint modular exponentiation</td><td></td><td></td><td></td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-609">Byzantium (609)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-211">211</a></td><td>RETURNDATASIZE and RETURNDATACOPY</td><td>X</td><td></td><td></td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-609">Byzantium (609)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-214">214</a></td><td>STATICCALL</td><td>X</td><td></td><td></td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-609">Byzantium (609)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-649">649</a></td><td>Metropolis Difficulty Bomb Delay and Block Reward Reduction</td><td></td><td></td><td></td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-609">Byzantium (609)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-658">658</a></td><td>Embedding transaction status code in receipts</td><td></td><td></td><td></td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-1013">Constantinople (1013)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-145">145</a></td><td>Bitwise shifting instructions in EVM</td><td>X</td><td></td><td></td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-1013">Constantinople (1013)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-1014">1014</a></td><td>Skinny CREATE2</td><td>X</td><td></td><td></td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-1234">Constantinople (1013)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-1234">1234</a></td><td>Constantinople Difficulty Bomb Delay and Block Reward Adjustment</td><td></td><td></td><td></td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-1234">Constantinople (1013)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-1283">1283</a></td><td>Net gas metering for SSTORE without dirty maps</td><td></td><td>X</td><td>This EIP leads to reentrancies risks (see <a href="https://github.com/trailofbits/publications/blob/master/reviews/EIP-1283.pdf">EIP-1283 incident report</a>) and was directly removed with <a href="https://eips.ethereum.org/EIPS/eip-1716">EIP-1716</a></td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-1716">Petersburg (1716)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-1716">1716</a></td><td>Remove EIP-1283</td><td></td><td>X</td><td>See <a href="https://github.com/trailofbits/publications/blob/master/reviews/EIP-1283.pdf">EIP-1283 incident report</a></td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-1679">Istanbul (1679)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-152">152</a></td><td>Precompiled contract for the BLAKE2 F compression function</td><td></td><td></td><td></td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-1679">Istanbul (1679)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-1108">1108</a></td><td>Reduce alt_bn128 precompile gas costs</td><td></td><td>X</td><td></td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-1679">Istanbul (1679)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-1344">1344</a></td><td>ChainID opcode</td><td>X</td><td></td><td></td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-1679">Istanbul (1679)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-1884">1884</a></td><td>Repricing for trie-size-dependent opcodes</td><td>X</td><td>X</td><td>The EIP changes the gas cost of multiple opcodes, and add SELFBALANCE</td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-1679">Istanbul (1679)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-2028">2028</a></td><td>Transaction data gas cost reduction</td><td></td><td>X</td><td></td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-1679">Istanbul (1679)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-2200">2200</a></td><td>Structured Definitions for Net Gas Metering</td><td></td><td>X</td><td></td></tr>
<tr><td><a href="https://eips.ethereum.org/EIPS/eip-2387">Muir Glacier (2387)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-2384">2384</a></td><td>Istanbul/Berlin Difficulty Bomb Delay</td><td></td><td></td><td></td></tr>
<tr><td><a href="https://github.com/ethereum/execution-specs/blob/a01c4c76e12fe9f0debf93bda7f67f002d77f8b4/network-upgrades/mainnet-upgrades/berlin.md">Berlin (2070)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-2565">2565</a></td><td>ModExp Gas Cost</td><td></td><td>X</td><td></td></tr>
<tr><td><a href="https://github.com/ethereum/execution-specs/blob/a01c4c76e12fe9f0debf93bda7f67f002d77f8b4/network-upgrades/mainnet-upgrades/berlin.md">Berlin (2070)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-2929">2929</a></td><td>Gas cost increases for state access opcodes</td><td></td><td>X</td><td></td></tr>
<tr><td><a href="https://github.com/ethereum/execution-specs/blob/a01c4c76e12fe9f0debf93bda7f67f002d77f8b4/network-upgrades/mainnet-upgrades/berlin.md">Berlin (2718)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-2718">2718</a></td><td>Typed Transaction Envelope</td><td></td><td></td><td></td></tr>
<tr><td><a href="https://github.com/ethereum/execution-specs/blob/a01c4c76e12fe9f0debf93bda7f67f002d77f8b4/network-upgrades/mainnet-upgrades/berlin.md">Berlin (2718)</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-2930">2930</a></td><td>Typed Transaction Envelope</td><td></td><td></td><td></td></tr>
<tr><td><a href="https://github.com/ethereum/execution-specs/blob/a01c4c76e12fe9f0debf93bda7f67f002d77f8b4/network-upgrades/mainnet-upgrades/london.md">London</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-1559">1559</a></td><td>Fee market change for ETH 1.0 chain</td><td></td><td>X</td><td>Significant modifications of Ethereum gas pricing</td></tr>
<tr><td><a href="https://github.com/ethereum/execution-specs/blob/a01c4c76e12fe9f0debf93bda7f67f002d77f8b4/network-upgrades/mainnet-upgrades/london.md">London</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-3198">3198</a></td><td>BASEFEE</td><td>X</td><td></td><td></td></tr>
<tr><td><a href="https://github.com/ethereum/execution-specs/blob/a01c4c76e12fe9f0debf93bda7f67f002d77f8b4/network-upgrades/mainnet-upgrades/london.md">London</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-3529">3529</a></td><td>Reduction in refunds</td><td></td><td>X</td><td>Remove <a href="https://gastoken.io/">gas tokens</a> benefits</td></tr>
<tr><td><a href="https://github.com/ethereum/execution-specs/blob/a01c4c76e12fe9f0debf93bda7f67f002d77f8b4/network-upgrades/mainnet-upgrades/london.md">London</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-3554">3554</a></td><td>Difficulty Bomb Delay to December 1st 2021</td><td></td><td></td><td></td></tr>
<tr><td><a href="https://github.com/ethereum/execution-specs/blob/bfe84c9a9b24695f160b4686d3b4640786ee9bac/network-upgrades/mainnet-upgrades/arrow-glacier.md">Arrow Glacier</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-4345">4345</a></td><td>Difficulty Bomb Delay to June 2022</td><td></td><td></td><td></td></tr>
<tr><td><a href="https://github.com/ethereum/execution-specs/blob/bfe84c9a9b24695f160b4686d3b4640786ee9bac/network-upgrades/mainnet-upgrades/gray-glacier.md">Gray Glacier</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-5133">5133</a></td><td>Difficulty Bomb Delay to mid-September 2022</td><td></td><td></td><td></td></tr>
<tr><td><a href="https://github.com/ethereum/execution-specs/blob/0a18c44ab6e567d74f2700ab1a3208644e08276b/network-upgrades/mainnet-upgrades/paris.md">Paris</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-3675">3675</a></td><td>Upgrade consensus to Proof-of-Stake</td><td></td><td></td><td>Changes to <code>DIFFICULTY</code> and <code>BLOCKHASH</code></td></tr>
<tr><td><a href="https://github.com/ethereum/execution-specs/blob/0a18c44ab6e567d74f2700ab1a3208644e08276b/network-upgrades/mainnet-upgrades/paris.md">Paris</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-4399">4399</a></td><td>Supplant DIFFICULTY opcode with PREVRANDAO</td><td>X</td><td></td><td><code>DIFFICULTY</code> becomes <code>PREVRANDAO</code></td></tr>
</tbody></table>
</div>
<p>In this table:</p>
<ul>
<li><code>Opcode</code>: the EIP adds or removes an opcode</li>
<li><code>Gas</code>: the EIP changes the gas rules</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><p>The following lists every CIP associated to a Celo fork. Celo is an EVM-compatible chain.</p>
<div class="table-wrapper"><table><thead><tr><th>Fork</th><th>CIP/EIP</th><th>What it does</th></tr></thead><tbody>
<tr><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0024.md">Churrito</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-211">EIP 211</a></td><td>Create <code>RETURNDATASIZE</code> and <code>RETURNDATACOPY</code> opcodes</td></tr>
<tr><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0027.md">Donut</a></td><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0025.md">CIP 25</a></td><td>Add Ed25519 precompile</td></tr>
<tr><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0027.md">Donut</a></td><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0031.md">CIP 31 - <em>copied from EIP-2539</em></a></td><td>Add precompile for BLS12-381 curve operations</td></tr>
<tr><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0027.md">Donut</a></td><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0030.md">CIP 30 - <em>copied from EIP-2539</em></a></td><td>Add precompile for BLS12-377 curve operations</td></tr>
<tr><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0027.md">Donut</a></td><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0020.md">CIP 20</a></td><td>Add extensible hash function precompile</td></tr>
<tr><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0027.md">Donut</a></td><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0021.md">CIP 21</a></td><td>Add governable lookback window</td></tr>
<tr><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0027.md">Donut</a></td><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0022.md">CIP 22</a></td><td>Upgrade epoch SNARK data</td></tr>
<tr><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0027.md">Donut</a></td><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0026.md">CIP 26</a></td><td>Add precompile to return BLS pubkey of given validator</td></tr>
<tr><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0027.md">Donut</a></td><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0028.md">CIP 28</a></td><td>Split etherbase into separate addresses</td></tr>
<tr><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0027.md">Donut</a></td><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0035.md">CIP 35</a></td><td>Add support for Ethereum-compatible transactions</td></tr>
<tr><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0041.md">Espresso</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-2565">EIP 2565</a></td><td>Define gas cost of ModExp precompile</td></tr>
<tr><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0041.md">Espresso</a></td><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0048.md">CIP 48 - <em>modified from EIP 2929</em></a></td><td>Gas repricing</td></tr>
<tr><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0041.md">Espresso</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-2718">EIP 2718</a></td><td>Introduce typed transaction envelope</td></tr>
<tr><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0041.md">Espresso</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-2930">EIP 2930</a></td><td>Introduce optional access lists</td></tr>
<tr><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0041.md">Espresso</a></td><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0042.md">CIP 42 - <em>modified from EIP 1559</em></a></td><td>Fee market changes</td></tr>
<tr><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0041.md">Espresso</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-3529">EIP 3529</a></td><td>Reduction in gas refunds</td></tr>
<tr><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0041.md">Espresso</a></td><td><a href="https://eips.ethereum.org/EIPS/eip-3541">EIP 3541</a></td><td>Reject deployment of contract code starting with the <code>0xEF</code> byte</td></tr>
<tr><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0041.md">Espresso</a></td><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0043.md">CIP 43</a></td><td>Block Context</td></tr>
<tr><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0041.md">Espresso</a></td><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0047.md">CIP 47</a></td><td>Modify round change timeout formula</td></tr>
<tr><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0041.md">Espresso</a></td><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0045.md">CIP 45</a></td><td>Modify transaction fee check</td></tr>
<tr><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0041.md">Espresso</a></td><td><a href="https://github.com/celo-org/celo-proposals/blob/master/CIPs/cip-0050.md">CIP 50</a></td><td>Make replay protection optional</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><p>The following lists every TIP associated to a TRON upgrade.
TRON is an EVM-compatible chain.</p>
<div class="table-wrapper"><table><thead><tr><th>Upgrade</th><th>TIP</th><th>What it does</th></tr></thead><tbody>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/Odyssey-v3.5">Odyssey-v3.5</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-12.md">12</a></td><td>Event subscription model</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/Odyssey-v3.5">Odyssey-v3.5</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-16.md">16</a></td><td>Account multi-signature/different permissions support</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/Odyssey-v3.5">Odyssey-v3.5</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-17.md">17</a></td><td>Adapative energy upper limit</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/Odyssey-v3.5.1">Odyssey-v3.5.1</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-24.md">24</a></td><td>RocksDB offered as storage engine</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/Odyssey-v3.6.0">Odyssey-v3.6.0</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-26.md">26</a></td><td>Add <code>create2</code> instruction to TVM</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/Odyssey-v3.6.0">Odyssey-v3.6.0</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-28.md">28</a></td><td>Built-in Message Queue in Event Subscription Model</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/Odyssey-v3.6.0">Odyssey-v3.6.0</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-29.md">29</a></td><td>Add bitwise shifting instructions to TVM</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/Odyssey-v3.6.0">Odyssey-v3.6.0</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-30.md">30</a></td><td>Add <code>extcodehash</code> instruction to TVM to return keccak256 hash of a contract's code</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/Odyssey-v3.6.0">Odyssey-v3.6.0</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-31.md">31</a></td><td>Add <code>triggerConstantContract</code> API to support contracts without ABI</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/Odyssey-v3.6.0">Odyssey-v3.6.0</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-32.md">32</a></td><td>Add <code>clearContractABI</code> API to clear existing ABI of contract</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/Odyssey-v3.6.1">Odyssey-v3.6.1</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-41.md">41</a></td><td>Optimize transactionHistoryStore occupancy space</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/Odyssey-v3.6.5">Odyssey-v3.6.5</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-37.md">37</a></td><td>Prohibit TransferContract &amp; TransferAssetContract use for contract account</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/Odyssey-v3.6.5">Odyssey-v3.6.5</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-43.md">43</a></td><td>Add precompiled contract function <code>batchvalidatesign</code> to TVM that supports parallel signature verification</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/Odyssey-v3.6.5">Odyssey-v3.6.5</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-44.md">44</a></td><td>Add <code>ISCONTRACT</code> opcode</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/Odyssey-v3.6.5">Odyssey-v3.6.5</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-53.md">53</a></td><td>Optimize current TRON delegation mechanism</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/Odyssey-v3.6.5">Odyssey-v3.6.5</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-54.md">54</a></td><td>Automatic account activation when transferring TRX/TRC10 tokens in contracts</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/Odyssey-v3.6.5">Odyssey-v3.6.5</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-60.md">60</a></td><td>Add <code>validatemultisign</code> instruction to TVM to support multi-signature verification</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.0.0">GreatVoyage-v4.0.0</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-135.md">135</a></td><td>Introduce shielded TRC-20 contract standards</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.0.0">GreatVoyage-v4.0.0</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-137.md">137</a></td><td>Add ZKP verification functions to shielded TRC-20 contract -  <code>verifyMintProof</code>, <code>verifyTransferProof</code>, and <code>verifyBurnProof</code></td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.0.0">GreatVoyage-v4.0.0</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-138.md">138</a></td><td>Add Pedersen hash computation <code>pedersenHash</code> function to shielded TRC-20 contract</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.1.0">GreatVoyage-v4.1.0</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-127.md">127</a></td><td>Add new system contracts to support token exchange (including TRX and TRC-10)</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.1.0">GreatVoyage-v4.1.0</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-128.md">128</a></td><td>Add new node type: Lite Fullnode</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.1.0">GreatVoyage-v4.1.0</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-174.md">174</a></td><td>Add <code>CHAINID</code> instruction to TVM</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.1.0">GreatVoyage-v4.1.0</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-175.md">175</a></td><td>Add <code>SELFBALANCE</code> instruction to TVM</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.1.0">GreatVoyage-v4.1.0</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-176.md">176</a></td><td><code>altbn128</code>-related operation energy reduction in TVM</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.1.2">GreatVoyage-v4.1.2</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-196.md">196</a></td><td>Reward SRs with tx fees</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.1.2">GreatVoyage-v4.1.2</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-204.md">204</a></td><td><code>MAX_FEE_LIMIT</code> is configurable</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.1.2">GreatVoyage-v4.1.2</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-209.md">209</a></td><td>Adapt Solidity compilers to Solidity 0.6.0</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.2.0">GreatVoyage-v4.2.0(Plato)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-157.md">157</a></td><td>Add freeze instructions to TVM - <code>FREEZE</code>, <code>UNFREEZE</code>, and <code>FREEZEEXPIRETIME</code></td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.2.0">GreatVoyage-v4.2.0(Plato)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-207.md">207</a></td><td>Optimize TRX freezing resource utilization</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.2.2">GreatVoyage-v4.2.2(Lucretius)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-268.md">268</a></td><td>ABI optimization - Move ABI out of SmartContract and store it in a new ABI store to reduce execution speeds of certain opcodes</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.2.2">GreatVoyage-v4.2.2(Lucretius)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-269.md">269</a></td><td>Optimize block processing speed</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.2.2">GreatVoyage-v4.2.2(Lucretius)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-281.md">281</a></td><td>Optimize database query performance</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.3.0">GreatVoyage-v4.3.0(Bacon)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-271.md">271</a></td><td>Add vote instructions and precompile contracts to TVM</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.3.0">GreatVoyage-v4.3.0(Bacon)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-276.md">276</a></td><td>Optimize block verification logic</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.3.0">GreatVoyage-v4.3.0(Bacon)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-285.md">285</a></td><td>Optimize node startup</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.3.0">GreatVoyage-v4.3.0(Bacon)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-292.md">292</a></td><td>Adjust account free net limit</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.3.0">GreatVoyage-v4.3.0(Bacon)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-293.md">293</a></td><td>Adjust total net limit</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.3.0">GreatVoyage-v4.3.0(Bacon)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-295.md">295</a></td><td>Optimize account data structure</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.3.0">GreatVoyage-v4.3.0(Bacon)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-298.md">298</a></td><td>Add new plugin to optimize levelDB performance startup</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.3.0">GreatVoyage-v4.3.0(Bacon)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-306.md">306</a></td><td>Add <code>Error</code> type in smart contract ABI</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.4.0">GreatVoyage-v4.4.0(Rousseau)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-289.md">289</a></td><td>Block broadcasting optimization</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.4.0">GreatVoyage-v4.4.0(Rousseau)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-290.md">290</a></td><td>Optimize dynamic database query performance</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.4.0">GreatVoyage-v4.4.0(Rousseau)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-272.md">272</a></td><td>TVM compatibility with EVM</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.4.0">GreatVoyage-v4.4.0(Rousseau)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-318.md">318</a></td><td>Adapt to Ethereum London Upgrade</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.4.2">GreatVoyage-v4.4.2(Augustinus)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-343.md">343</a></td><td>Optimize levelDB read performance</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.4.2">GreatVoyage-v4.4.2(Augustinus)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-344.md">343</a></td><td>Optimize TVM instruction execution</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.4.4">GreatVoyage-v4.4.4(Plotinus)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-362.md">362</a></td><td>Optimize node broadcast data caching</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.4.4">GreatVoyage-v4.4.4(Plotinus)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-366.md">366</a></td><td>Optimize node startup process</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.5.1">GreatVoyage-v4.5.1(Tertullian)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-369.md">369</a></td><td>Support prometheus (metrics interface)</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.5.1">GreatVoyage-v4.5.1(Tertullian)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-370.md">370</a></td><td>Support node conditionalized stop</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.5.1">GreatVoyage-v4.5.1(Tertullian)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-382.md">382</a></td><td>Optimize account assets data structure</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.5.1">GreatVoyage-v4.5.1(Tertullian)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-383.md">383</a></td><td>Optimize transaction cache loading</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.5.1">GreatVoyage-v4.5.1(Tertullian)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-388.md">388</a></td><td>Optimize light node synchronization logic</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.5.1">GreatVoyage-v4.5.1(Tertullian)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-391.md">391</a></td><td>Optimize block process and broadcasting logic</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.5.1">GreatVoyage-v4.5.1(Tertullian)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-397.md">397</a></td><td>Raise limit of the 13th network parameter</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.5.2">GreatVoyage-v4.5.2(Aurelius)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-425.md">425</a></td><td>Speed up TCP connection establishment.</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.5.2">GreatVoyage-v4.5.2(Aurelius)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-440.md">440</a></td><td>Optimize transaction cache</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.5.2">GreatVoyage-v4.5.2(Aurelius)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-428.md">428</a></td><td>Optimize lock competition in block processing</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.6.0">GreatVoyage-v4.6.0(Socrates)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-461.md">461</a></td><td>Upgrade checkpoint mechanism to V2 in database module</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.6.0">GreatVoyage-v4.6.0(Socrates)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-476.md">476</a></td><td>Optimize delegate data structure</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.6.0">GreatVoyage-v4.6.0(Socrates)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-387.md">387</a></td><td>Add transaction memo fee</td></tr>
<tr><td><a href="https://github.com/tronprotocol/java-tron/releases/tag/GreatVoyage-v4.6.0">GreatVoyage-v4.6.0(Socrates)</a></td><td><a href="https://github.com/tronprotocol/TIPs/blob/master/tip-465.md">465</a></td><td>Optimize reward calculation algorithm</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><p>The following lists every BEP associated to a Binance Smart Chain fork.</p>
<div class="table-wrapper"><table><thead><tr><th>Release</th><th>BEP</th><th>What it does</th></tr></thead><tbody>
<tr><td><a href="https://github.com/bnb-chain/bsc/releases/tag/v1.0.6">v1.0.6</a></td><td><a href="https://github.com/bnb-chain/BEPs/blob/master/BEP84.md">84</a></td><td>Issue/bind BEP2 with existing BEP20 tokens</td></tr>
<tr><td><a href="https://github.com/bnb-chain/bsc/releases/tag/v1.1.5">v1.1.5</a></td><td><a href="https://github.com/bnb-chain/BEPs/blob/master/BEP93.md">93</a></td><td>Introduces new block syncing protocol</td></tr>
<tr><td><a href="https://github.com/bnb-chain/bsc/releases/tag/v1.1.5">v1.1.5</a></td><td><a href="https://github.com/bnb-chain/BEPs/blob/master/BEP95.md">95</a></td><td>Creates real-time burning mechanism</td></tr>
<tr><td><a href="https://github.com/bnb-chain/bsc/releases/tag/v1.1.11">v1.1.11</a></td><td><a href="https://github.com/bnb-chain/BEPs/blob/master/BEP127.md">127</a></td><td>Creates &quot;Temporary Maintenance&quot; mode for validators</td></tr>
<tr><td><a href="https://github.com/bnb-chain/bsc/releases/tag/v1.1.11">v1.1.11</a></td><td><a href="https://github.com/bnb-chain/BEPs/blob/master/BEP131.md">131</a></td><td>Increase validator set with &quot;Candidate&quot; validators</td></tr>
<tr><td><a href="https://github.com/bnb-chain/bsc/releases/tag/v1.1.11">v1.1.18</a></td><td><a href="https://github.com/bnb-chain/BEPs/blob/master/BEP153.md">153</a></td><td>Creates native staking protocol</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="not-so-smart-contracts"><a class="header" href="#not-so-smart-contracts">(Not So) Smart Contracts</a></h1>
<p>This repository contains examples of common smart contract vulnerabilities, including code from real smart contracts. Use Not So Smart Contracts to learn about vulnerabilities, as a reference when performing security reviews, and as a benchmark for security and analysis tools:</p>
<ul>
<li><a href="not-so-smart-contracts/./algorand/README.html">Algorand</a></li>
<li><a href="not-so-smart-contracts/./cairo/README.html">Cairo</a></li>
<li><a href="not-so-smart-contracts/./cosmos/README.html">Cosmos</a></li>
<li><a href="not-so-smart-contracts/./solana/README.html">Solana</a></li>
<li><a href="not-so-smart-contracts/./substrate/README.html">Substrate</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="not-so-smart-contracts-1"><a class="header" href="#not-so-smart-contracts-1">(Not So) Smart Contracts</a></h1>
<p>This repository contains examples of common Algorand smart contract vulnerabilities, including code from real smart contracts. Use Not So Smart Contracts to learn about Algorand vulnerabilities, as a reference when performing security reviews, and as a benchmark for security and analysis tools.</p>
<h2 id="features"><a class="header" href="#features">Features</a></h2>
<p>Each <em>Not So Smart Contract</em> includes a standard set of information:</p>
<ul>
<li>Description of the vulnerability type</li>
<li>Attack scenarios to exploit the vulnerability</li>
<li>Recommendations to eliminate or mitigate the vulnerability</li>
<li>Real-world contracts that exhibit the flaw</li>
<li>References to third-party resources with more information</li>
</ul>
<h2 id="vulnerabilities"><a class="header" href="#vulnerabilities">Vulnerabilities</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Not So Smart Contract</th><th>Description</th><th>Applicable to smart signatures</th><th>Applicable to smart contracts</th></tr></thead><tbody>
<tr><td><a href="not-so-smart-contracts/algorand/rekeying">Rekeying</a></td><td>Attacker rekeys an account</td><td>yes</td><td>yes</td></tr>
<tr><td><a href="not-so-smart-contracts/algorand/unchecked_transaction_fee">Unchecked Transaction Fees</a></td><td>Attacker sets excessive fees for smart signature transactions</td><td>yes</td><td>no</td></tr>
<tr><td><a href="not-so-smart-contracts/algorand/closing_account">Closing Account</a></td><td>Attacker closes smart signature accounts</td><td>yes</td><td>no</td></tr>
<tr><td><a href="not-so-smart-contracts/algorand/closing_asset">Closing Asset</a></td><td>Attacker transfers entire asset balance of a smart signature</td><td>yes</td><td>no</td></tr>
<tr><td><a href="not-so-smart-contracts/algorand/group_size_check">Group Size Check</a></td><td>Contract does not check transaction group size</td><td>yes</td><td>yes</td></tr>
<tr><td><a href="not-so-smart-contracts/algorand/time_based_replay_attack">Time-based Replay Attack</a></td><td>Contract does not use lease for periodic payments</td><td>yes</td><td>no</td></tr>
<tr><td><a href="not-so-smart-contracts/algorand/access_controls">Access Controls</a></td><td>Contract does not enfore access controls for updating and deleting application</td><td>no</td><td>yes</td></tr>
<tr><td><a href="not-so-smart-contracts/algorand/asset_id_check">Asset Id Check</a></td><td>Contract does not check asset id for asset transfer operations</td><td>yes</td><td>yes</td></tr>
<tr><td><a href="not-so-smart-contracts/algorand/denial_of_service">Denial of Service</a></td><td>Attacker stalls contract execution by opting out of a asset</td><td>yes</td><td>yes</td></tr>
</tbody></table>
</div>
<h2 id="credits"><a class="header" href="#credits">Credits</a></h2>
<p>These examples are developed and maintained by <a href="https://www.trailofbits.com/">Trail of Bits</a>.</p>
<p>If you have questions, problems, or just want to learn more, then join the #ethereum channel on the <a href="https://empireslacking.herokuapp.com/">Empire Hacking Slack</a> or <a href="https://www.trailofbits.com/contact/">contact us</a> directly.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rekeying"><a class="header" href="#rekeying">Rekeying</a></h1>
<p>The lack of check for RekeyTo field in the Teal program allows malicious actors to rekey the associated account and control the account assets directly, bypassing the restrictions imposed by the Teal contract.</p>
<h2 id="description"><a class="header" href="#description">Description</a></h2>
<p>Rekeying is an Algorand feature which allows a user to transfer the authorization power of their account to a different account. When an account has been rekeyed, all the future transactions from that account are accepted by the blockchain, if and only if the transaction has been authorized by the rekeyed account.</p>
<p>A user can rekey their account to the selected account by sending a rekey-to transaction with rekey-to field set to the target account address. A rekey-to transaction is atransaction which has the rekey-to field set to a well formed Algorand address.
Any algorand account can be rekeyed by sending a rekey-to transaction from that account, this includes the contract accounts.</p>
<p>Contract accounts are accounts which are derived from the Teal code that is in control of that account. Anyone can set the fields and submit a transaction from the contract account as long as it passes the checks enforced in the Teal code. This results in an issue if the Teal code is supposed to approve a transaction that passes specific checks and does not check the rekey-to field. A malicious user can first send a transaction approved by the Teal code with rekey-to set to their account. After rekeying, the attacker can transfer the assets, algos directly by authorizing the transactions with their private key.</p>
<p>Similar issue affects the accounts that created a delegate signature by signing a Teal program. Delegator is only needed to sign the contract and any user with access to delegate signature can construct and submit transactions. Because of this, a malicious user can rekey the sender’s account if the Teal logic accepts a transaction with the rekey-to field set to the user controlled address.</p>
<p>Note: From Teal v6, Applications can also be rekeyed by executing an inner transaction with &quot;RekeyTo&quot; field set to a non-zero address. Rekeying an application allows to bypass the application logic and directly transfer Algos and assets of the application account.</p>
<h2 id="exploit-scenarios"><a class="header" href="#exploit-scenarios">Exploit Scenarios</a></h2>
<p>A user creates a delegate signature for recurring payments. Attacker rekeys the sender’s account by specifying the rekey-to field in a valid payment transaction.</p>
<h2 id="example"><a class="header" href="#example">Example</a></h2>
<p>Note: This code contains several other vulnerabilities, <a href="not-so-smart-contracts/algorand/rekeying/../unchecked_transaction_fee">Unchecked Transaction Fees</a>, <a href="not-so-smart-contracts/algorand/rekeying/../closing_account">Closing Account</a>, <a href="not-so-smart-contracts/algorand/rekeying/../time_based_replay_attack">Time-based Replay Attack</a>.</p>
<pre><code class="language-py">def withdraw(
    duration,
    period,
    amount,
    receiver,
    timeout,
):
    return And(
        Txn.type_enum() == TxnType.Payment,
        Txn.first_valid() % period == Int(0),
        Txn.last_valid() == Txn.first_valid() + duration,
        Txn.receiver() == receiver,
        Txn.amount() == amount,
        Txn.first_valid() &lt; timeout,
    )
</code></pre>
<h2 id="recommendations"><a class="header" href="#recommendations">Recommendations</a></h2>
<ul>
<li>
<p>For the Teal programs written in Teal version 2 or greater, either used as delegate signature or contract account, include a check in the program that verifies rekey-to field to be equal to ZeroAddress or any intended address. Teal contracts written in Teal version 1 are not affected by this issue. Rekeying feature is introduced in version 2 and Algorand rejects transactions that use features introduced in the versions later than the executed Teal program version.</p>
</li>
<li>
<p>Use <a href="https://github.com/crytic/tealer">Tealer</a> to detect this issue.</p>
</li>
<li>
<p>For Applications, verify that user provided value is not used for <code>RekeyTo</code> field of a inner transaction. Additionally, avoid rekeying an application to admin controlled address. This allows for the possibility of &quot;rug pull&quot; by a malicious admin.</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="unchecked-transaction-fee"><a class="header" href="#unchecked-transaction-fee">Unchecked Transaction Fee</a></h1>
<p>Lack of transaction fee check in smart signatures allows malicious users to drain the contract account or the delegator’s account by specifying excessive fees.</p>
<h2 id="description-1"><a class="header" href="#description-1">Description</a></h2>
<p>Any user can submit transactions using the smart signatures and decide on the transaction fields. It is the responsibility of the creator to enforce restrictions on all the transaction fields to prevent malicious users from misusing the smart signature.</p>
<p>One of these transaction fields is Fee. Fee field specifies the number of micro-algos paid for processing the transaction. Protocol only verifies that the transaction pays a fee greater than protocol decided minimum fee. If a smart signature doesn’t bound the transaction fee, a user could set an excessive fee and drain the sender funds. Sender will be the signer of the Teal program in case of delegate signature and the contract account otherwise.</p>
<h2 id="exploit-scenarios-1"><a class="header" href="#exploit-scenarios-1">Exploit Scenarios</a></h2>
<p>A user creates a delegate signature for recurring payments. Attacker creates a valid transaction and drains the user funds by specifying excessive fee.</p>
<h2 id="examples"><a class="header" href="#examples">Examples</a></h2>
<p>Note: This code contains several other vulnerabilities, see <a href="not-so-smart-contracts/algorand/unchecked_transaction_fee/../rekeying">Rekeying</a>, <a href="not-so-smart-contracts/algorand/unchecked_transaction_fee/../closing_account">Closing Account</a>, <a href="not-so-smart-contracts/algorand/unchecked_transaction_fee/../time_based_replay_attack">Time-based Replay Attack</a>.</p>
<pre><code class="language-py">def withdraw(
    duration,
    period,
    amount,
    receiver,
    timeout,
):
    return And(
        Txn.type_enum() == TxnType.Payment,
        Txn.first_valid() % period == Int(0),
        Txn.last_valid() == Txn.first_valid() + duration,
        Txn.receiver() == receiver,
        Txn.amount() == amount,
        Txn.first_valid() &lt; timeout,
    )
</code></pre>
<h2 id="recommendations-1"><a class="header" href="#recommendations-1">Recommendations</a></h2>
<ul>
<li>Force the transaction fee to be <code>0</code> and use fee pooling. If the users should be able to call the smart signature outside of a group, force the transaction fee to be minimum transaction fee:  <code>global MinTxnFee</code>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="closing-account"><a class="header" href="#closing-account">Closing Account</a></h1>
<p>Lack of check for CloseRemainderTo transaction field in smart signatures allows attackers to transfer entire funds of the contract account or the delegator’s account to their account.</p>
<h2 id="description-2"><a class="header" href="#description-2">Description</a></h2>
<p>Algorand accounts must satisfy minimum balance requirement and protocol rejects transactions whose execution results in account balance lower than the required minimum. In order to transfer the entire balance and close the account, users should use the CloseRemainderTo field of a payment transaction. Setting the CloseRemainderTo field transfers the entire account balance remaining after transaction execution to the specified address.</p>
<p>Any user with access to the smart signature may construct and submit the transactions using the smart signature. The smart signatures approving payment transactions have to ensure that the CloseRemainderTo field is set to the ZeroAddress or any other specific address to avoid unintended transfer of funds.</p>
<h2 id="exploit-scenarios-2"><a class="header" href="#exploit-scenarios-2">Exploit Scenarios</a></h2>
<p>A user creates a delegate signature for recurring payments. Attacker creates a valid transaction and sets the CloseRemainderTo field to their address.</p>
<h2 id="examples-1"><a class="header" href="#examples-1">Examples</a></h2>
<p>Note: This code contains several other vulnerabilities, see <a href="not-so-smart-contracts/algorand/closing_account/../rekeying">Rekeying</a>, <a href="not-so-smart-contracts/algorand/closing_account/../unchecked_transaction_fee">Unchecked Transaction Fees</a>, <a href="not-so-smart-contracts/algorand/closing_account/../time_based_replay_attack">Time-based Replay Attack</a>.</p>
<pre><code class="language-py">def withdraw(
    duration,
    period,
    amount,
    receiver,
    timeout,
):
    return And(
        Txn.type_enum() == TxnType.Payment,
        Txn.first_valid() % period == Int(0),
        Txn.last_valid() == Txn.first_valid() + duration,
        Txn.receiver() == receiver,
        Txn.amount() == amount,
        Txn.first_valid() &lt; timeout,
    )
</code></pre>
<h2 id="recommendations-2"><a class="header" href="#recommendations-2">Recommendations</a></h2>
<p>Verify that the CloseRemainderTo field is set to the ZeroAddress or to any intended address before approving the transaction in the Teal contract.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="closing-asset"><a class="header" href="#closing-asset">Closing Asset</a></h1>
<p>Lack of check for AssetCloseTo transaction field in smart signatures allows attackers to transfer the entire asset balance of the contract account or the delegator’s account to their account.</p>
<h2 id="description-3"><a class="header" href="#description-3">Description</a></h2>
<p>Algorand supports Fungible and Non Fungible Tokens using Algorand Standard Assets(ASA). An Algorand account must first opti-in to the asset before that account can receive any tokens. Opting to an asset increases the minimum balance requirement of the account. Users can opt-out of the asset and decrease the minimum balance requirement using the AssetCloseTo field of Asset Transfer transaction. Setting the AssetCloseTo field transfers the account’s entire token balance remaining after transaction execution to the specified address.</p>
<p>Any user with access to the smart signature may construct and submit the transactions using the smart signature. The smart signatures approving asset transfer transactions have to ensure that the AssetCloseTo field is set to the ZeroAddress or any other specific address to avoid unintended transfer of tokens.</p>
<h2 id="exploit-scenarios-3"><a class="header" href="#exploit-scenarios-3">Exploit Scenarios</a></h2>
<p>User creates a delegate signature that allows recurring transfers of a certain asset. Attacker creates a valid asset transfer transaction with AssetCloseTo field set to their address.</p>
<h2 id="examples-2"><a class="header" href="#examples-2">Examples</a></h2>
<p>Note: This code contains several other vulnerabilities, see <a href="not-so-smart-contracts/algorand/closing_asset/../rekeying">Rekeying</a>, <a href="not-so-smart-contracts/algorand/closing_asset/../unchecked_transaction_fee">Unchecked Transaction Fees</a>, <a href="not-so-smart-contracts/algorand/closing_asset/../closing_asset">Closing Asset</a>, <a href="not-so-smart-contracts/algorand/closing_asset/../time_based_replay_attack">Time-based Replay Attack</a>, <a href="not-so-smart-contracts/algorand/closing_asset/../asset_id_check">Asset Id Check</a>.</p>
<pre><code class="language-py">def withdraw_asset(
    duration,
    period,
    amount,
    receiver,
    timeout,
):
    return And(
        Txn.type_enum() == TxnType.AssetTransfer,
        Txn.first_valid() % period == Int(0),
        Txn.last_valid() == Txn.first_valid() + duration,
        Txn.asset_receiver() == receiver,
        Txn.asset_amount() == amount,
        Txn.first_valid() &lt; timeout,
    )
</code></pre>
<h2 id="recommendations-3"><a class="header" href="#recommendations-3">Recommendations</a></h2>
<p>Verify that the AssetCloseTo field is set to the ZeroAddress or to the intended address before approving the transaction in the Teal contract.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="group-size-check"><a class="header" href="#group-size-check">Group Size Check</a></h1>
<p>Lack of group size check in contracts that are supposed to be called in an atomic group transaction might allow attackers to misuse the application.</p>
<h2 id="description-4"><a class="header" href="#description-4">Description</a></h2>
<p>Algorand supports atomic transfers, an atomic transfer is a group of transactions that are submitted and processed as a single transaction. A group can contain upto 16 transactions and the group transaction fails if any of the included transactions fails. Algorand applications make use of group transactions to realize operations that may not be possible using a single transaction model. In such cases, it is necessary to check that the group transaction in itself is valid along with the individual transactions. One of the checks whose absence could be misused is group size check.</p>
<h2 id="exploit-scenarios-4"><a class="header" href="#exploit-scenarios-4">Exploit Scenarios</a></h2>
<p>Application only checks that transactions at particular indices are meeting the criteria and performs the operations based on that. Attackers can create the transactions at the checked indices correctly and include equivalent application call transactions at all the remaining indices. Each application call executes successfully as every execution checks the same set of transactions. This results in performing operations multiple times, once for each application call. This could be damaging if those operations include funds or assets transfers among others.</p>
<h2 id="examples-3"><a class="header" href="#examples-3">Examples</a></h2>
<p>Note: This code contains several other vulnerabilities, see <a href="not-so-smart-contracts/algorand/group_size_check/../rekeying">Rekeying</a>, <a href="not-so-smart-contracts/algorand/group_size_check/../unchecked_transaction_fee">Unchecked Transaction Fees</a>, <a href="not-so-smart-contracts/algorand/group_size_check/../closing_account">Closing Account</a>, <a href="not-so-smart-contracts/algorand/group_size_check/../time_based_replay_attack">Time-based Replay Attack</a>.</p>
<pre><code class="language-py">def split_and_withdraw(
    amount_1,
    receiver_1,
    amount_2,
    receiver_2,
    lock_expire_round,
):
    return And(
        Gtxn[0].type_enum() == TxnType.Payment,
        Gtxn[0].receiver() == receiver_1,
        Gtxn[0].amount() == amount_1,

        Gtxn[1].type_enum() == TxnType.Payment,
        Gtxn[1].receiver() == receiver_2,
        Gtxn[1].amount() == amount_2,

        Gtxn[0].first_valid == lock_expire_round,
    )
</code></pre>
<h2 id="recommendations-4"><a class="header" href="#recommendations-4">Recommendations</a></h2>
<ul>
<li>
<p>Verify that the group size of an atomic transfer is the intended size in the contracts.</p>
</li>
<li>
<p>Use <a href="https://github.com/crytic/tealer">Tealer</a> to detect this issue.</p>
</li>
<li>
<p>Favor using ABI for smart contracts and relative indexes to verify the group transaction.</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="time-based-replay-attack"><a class="header" href="#time-based-replay-attack">Time-based Replay Attack</a></h1>
<p>Lack of check for lease field in smart signatures that intend to approve a single transaction in the particular period allows attackers to submit multiple valid transactions in that period. </p>
<h2 id="description-5"><a class="header" href="#description-5">Description</a></h2>
<p>Algorand stops transaction replay attacks using a validity period. A validity period of a transaction is the sequence of blocks between FirstValid block and LastValid block. The transaction is considered valid only in that period and a transaction with the same hash can be processed only once in that period. Algorand also limits the period to a maximum of 1000 blocks. This allows the transaction creator to select the FirstValid, LastValid fields appropriately and feel assured that the transaction is processed only once in that period.</p>
<p>However, The same does not apply for transactions authorized by smart signatures. Even if the contract developer verifies the FirstValid and LastValid transaction fields to fixed values, an attacker can submit multiple transactions that are valid as per the contract. This is because any user can create and submit transactions authorized by a smart signature. The attacker can create transactions which have equal values for most transaction fields, for fields verified in the contract and slightly different values for the rest. Each one of these transactions will have a different hash and will be accepted by the protocol.</p>
<h2 id="exploit-scenarios-5"><a class="header" href="#exploit-scenarios-5">Exploit Scenarios</a></h2>
<p>A user creates a delegate signature for recurring payments. Contract verifies the FirstValid and LastValid to only allow a single transaction each time. Attacker creates and submits multiple valid transactions with different hashes.</p>
<h2 id="examples-4"><a class="header" href="#examples-4">Examples</a></h2>
<p>Note: This code contains several other vulnerabilities, see <a href="not-so-smart-contracts/algorand/time_based_replay_attack/../rekeying">Rekeying</a>, <a href="not-so-smart-contracts/algorand/time_based_replay_attack/../unchecked_transaction_fee">Unchecked Transaction Fees</a>, <a href="not-so-smart-contracts/algorand/time_based_replay_attack/../closing_account">Closing Account</a>.</p>
<pre><code class="language-py">def withdraw(
    duration,
    period,
    amount,
    receiver,
    timeout,
):
    return And(
        Txn.type_enum() == TxnType.Payment,
        Txn.first_valid() % period == Int(0),
        Txn.last_valid() == Txn.first_valid() + duration,
        Txn.receiver() == receiver,
        Txn.amount() == amount,
        Txn.first_valid() &lt; timeout,
    )
</code></pre>
<h2 id="recommendations-5"><a class="header" href="#recommendations-5">Recommendations</a></h2>
<p>Verify that the Lease field of the transaction is set to a specific value. Lease enforces mutual exclusion, once a transaction with non-zero lease is confirmed by the protocol, no other transactions with same lease and sender will be accepted till the LastValid block</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="access-controls"><a class="header" href="#access-controls">Access Controls</a></h1>
<p>Lack of appropriate checks for application calls of type UpdateApplication and DeleteApplication allows attackers to update application’s code or delete an application entirely.</p>
<h2 id="description-6"><a class="header" href="#description-6">Description</a></h2>
<p>When an application call is successful, additional operations are executed based on the OnComplete field. If the OnComplete field is set to UpdateApplication the approval and clear programs of the application are replaced with the programs specified in the transaction. Similarly, if the OnComplete field is set to DeleteApplication, application parameters are deleted. 
This allows attackers to update or delete the application if proper access controls are not enforced in the application.</p>
<h2 id="exploit-scenarios-6"><a class="header" href="#exploit-scenarios-6">Exploit Scenarios</a></h2>
<p>A stateful contract serves as a liquidity pool for a pair of tokens. Users can deposit the tokens to get the liquidity tokens and can get back their funds with rewards through a burn operation. The contract does not enforce restrictions for UpdateApplication type application calls. Attacker updates the approval program with a malicious program that transfers all assets in the pool to the attacker's address.</p>
<h2 id="recommendations-6"><a class="header" href="#recommendations-6">Recommendations</a></h2>
<ul>
<li>
<p>Set proper access controls and apply various checks before approving applications calls of type UpdateApplication and DeleteApplication.</p>
</li>
<li>
<p>Use <a href="https://github.com/crytic/tealer">Tealer</a> to detect this issue.</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="asset-id-check"><a class="header" href="#asset-id-check">Asset Id Check</a></h1>
<p>Lack of verification of asset id in the contract allows attackers to transfer a different asset in place of the expected asset and mislead the application.</p>
<h2 id="description-7"><a class="header" href="#description-7">Description</a></h2>
<p>Contracts accepting and doing operations based on the assets transferred to the contract must verify that the transferred asset is the expected asset by checking the asset Id. Absence of check for expected asset Id could allow attackers to manipulate contract’s logic by transferring a fake, less or more valuable asset instead of the correct asset.</p>
<h2 id="exploit-scenarios-7"><a class="header" href="#exploit-scenarios-7">Exploit Scenarios</a></h2>
<ul>
<li>A liquidity pool contract mints liquidity tokens on deposit of two tokens. Contract does not check that the asset Ids in the two asset transfer transactions are correct. Attacker deposits the same less valuable asset in the two transactions and withdraws both tokens by burning the pool tokens.</li>
<li>User creates a delegate signature that allows recurring transfers of a certain asset. Attacker creates a valid asset transfer transaction of more valuable assets.</li>
</ul>
<h2 id="examples-5"><a class="header" href="#examples-5">Examples</a></h2>
<p>Note: This code contains several other vulnerabilities, see <a href="not-so-smart-contracts/algorand/asset_id_check/../rekeying">Rekeying</a>, <a href="not-so-smart-contracts/algorand/asset_id_check/../unchecked_transaction_fee">Unchecked Transaction Fees</a>, <a href="not-so-smart-contracts/algorand/asset_id_check/../closing_asset">Closing Asset</a>, <a href="not-so-smart-contracts/algorand/asset_id_check/../time_based_replay_attack">Time-based Replay Attack</a>.</p>
<pre><code class="language-py">def withdraw_asset(
    duration,
    period,
    amount,
    receiver,
    timeout,
):
    return And(
        Txn.type_enum() == TxnType.AssetTransfer,
        Txn.first_valid() % period == Int(0),
        Txn.last_valid() == Txn.first_valid() + duration,
        Txn.asset_receiver() == receiver,
        Txn.asset_amount() == amount,
        Txn.first_valid() &lt; timeout,
    )
</code></pre>
<h2 id="recommendations-7"><a class="header" href="#recommendations-7">Recommendations</a></h2>
<p>Verify the asset id to be expected asset for all asset related operations in the contract.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="denial-of-service"><a class="header" href="#denial-of-service">Denial of Service</a></h1>
<p>When a contract does not verify whether an account has opted in to an asset and attempts to transfer that asset, an attacker can DoS other users if the contract's operation is to transfer asset to multiple accounts. </p>
<h2 id="description-8"><a class="header" href="#description-8">Description</a></h2>
<p>A user must explicitly opt-in to receive any particular Algorand Standard Asset(ASAs). A user may also opt out of an ASA. A transaction will fail if it attempts to transfer tokens to an account that didn’t opt in to that asset. This could be leveraged by attackers to DOS a contract if the contract’s operation depends on successful transfer of an asset to the attacker owned address. </p>
<h2 id="exploit-scenarios-8"><a class="header" href="#exploit-scenarios-8">Exploit Scenarios</a></h2>
<p>Contract attempts to transfer assets to multiple users. One user is not opted in to the asset. The transfer operation fails for all users.</p>
<h2 id="examples-6"><a class="header" href="#examples-6">Examples</a></h2>
<p>Note: This code contains several other vulnerabilities, see <a href="not-so-smart-contracts/algorand/denial_of_service/../rekeying">Rekeying</a>, <a href="not-so-smart-contracts/algorand/denial_of_service/../unchecked_transaction_fee">Unchecked Transaction Fees</a>, <a href="not-so-smart-contracts/algorand/denial_of_service/../closing_asset">Closing Asset</a>, <a href="not-so-smart-contracts/algorand/denial_of_service/../group_size_check">Group Size Check</a>, <a href="not-so-smart-contracts/algorand/denial_of_service/../time_based_replay_attack">Time-based Replay Attack</a>, <a href="not-so-smart-contracts/algorand/denial_of_service/../asset_id_check">Asset Id Check</a></p>
<pre><code class="language-py">def split_and_withdraw_asset(
    amount_1,
    receiver_1,
    amount_2,
    receiver_2,
    lock_expire_round,
):
    return And(
        Gtxn[0].type_enum() == TxnType.AssetTransfer,
        Gtxn[0].asset_receiver() == receiver_1,
        Gtxn[0].asset_amount() == amount_1,

        Gtxn[1].type_enum() == TxnType.AssetTransfer,
        Gtxn[1].receiver() == receiver_2,
        Gtxn[1].amount() == amount_2,

        Gtxn[0].first_valid == lock_expire_round,
    )
</code></pre>
<h2 id="recommendations-8"><a class="header" href="#recommendations-8">Recommendations</a></h2>
<p>Use pull over push pattern for transferring assets to users.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="not-so-smart-contracts-2"><a class="header" href="#not-so-smart-contracts-2">(Not So) Smart Contracts</a></h1>
<p>This repository contains examples of common Cairo smart contract vulnerabilities, including code from real smart contracts. Use Not So Smart Contracts to learn about Cairo vulnerabilities, as a reference when performing security reviews, and as a benchmark for security and analysis tools.</p>
<h2 id="features-1"><a class="header" href="#features-1">Features</a></h2>
<p>Each <em>Not So Smart Contract</em> includes a standard set of information:</p>
<ul>
<li>Description of the vulnerability type</li>
<li>Attack scenarios to exploit the vulnerability</li>
<li>Recommendations to eliminate or mitigate the vulnerability</li>
<li>Real-world contracts that exhibit the flaw</li>
<li>References to third-party resources with more information</li>
</ul>
<h2 id="vulnerabilities-1"><a class="header" href="#vulnerabilities-1">Vulnerabilities</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Not So Smart Contract</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="not-so-smart-contracts/cairo/access_controls">Improper access controls</a></td><td>Broken access controls due to StarkNet account abstraction</td></tr>
<tr><td><a href="not-so-smart-contracts/cairo/integer_division">Integer division errors</a></td><td>Unexpected results due to division in a finite field</td></tr>
<tr><td><a href="not-so-smart-contracts/cairo/view_state">View state modifications</a></td><td>View functions don't prevent state modifications</td></tr>
<tr><td><a href="not-so-smart-contracts/cairo/arithmetic_overflow">Arithmetic overflow</a></td><td>Arithmetic in Cairo is not safe by default</td></tr>
<tr><td><a href="not-so-smart-contracts/cairo/replay_protection">Signature replays</a></td><td>Account abstraction requires robust reuse protections</td></tr>
<tr><td><a href="not-so-smart-contracts/cairo/L1_to_L2_address_conversion">L1 to L2 Address Conversion</a></td><td>L1 to L2 messaging requires L2 address checks</td></tr>
<tr><td><a href="not-so-smart-contracts/cairo/incorrect_felt_comparison">Incorrect Felt Comparison</a></td><td>Unexpected results can occur during felt comparison</td></tr>
<tr><td><a href="not-so-smart-contracts/cairo/namespace_storage_var_collision">Namespace Storage Var Collision</a></td><td>Storage variables are not scoped by namespaces</td></tr>
<tr><td><a href="not-so-smart-contracts/cairo/dangerous_public_imports_in_libraries">Dangerous Public Imports in Libraries</a></td><td>Nonimported external functions can still be called</td></tr>
</tbody></table>
</div>
<h2 id="credits-1"><a class="header" href="#credits-1">Credits</a></h2>
<p>These examples are developed and maintained by <a href="https://www.trailofbits.com/">Trail of Bits</a>.</p>
<p>If you have questions, problems, or just want to learn more, then join the #ethereum channel on the <a href="https://empireslacking.herokuapp.com/">Empire Hacking Slack</a> or <a href="https://www.trailofbits.com/contact/">contact us</a> directly.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="access-controls--account-abstraction"><a class="header" href="#access-controls--account-abstraction">Access controls &amp; account abstraction</a></h1>
<p>NOTE: The following was possible before StarkNet OS enforced the use of an account contract.</p>
<p>The account abstraction model used by StarkNet has some important differences from what Solidity developers might be used to. There are no EOA addresses in StarkNet, only contract addresses. Rather than interact with contracts directly, users will usually deploy a contract that authenticates them and makes further calls on the user's behalf. At its simplest, this contract checks that the transaction is signed by the expected key, but it could also represent a multisig or DAO, or have more complex logic for what kinds of transactions it will allow (e.g. deposits and withdrawals could be handled by separate contracts or it could prevent unprofitable trades).</p>
<p>It is still possible to interact with contracts directly. But from the perspective of the contract, the caller's address will be 0. Since 0 is also the default value for uninitialized storage, it's possible to accidentally construct access control checks that fail open instead of properly restricting access to only the intended users.</p>
<h2 id="example-1"><a class="header" href="#example-1">Example</a></h2>
<p>Consider the following two functions that both allow a user to claim a small amount of tokens. The first, without any checks, will end up sending tokens to the zero address, effectively burning them by removing them from the circlating supply. The latter will ensure that this cannot happen.</p>
<pre><code class="language-cairo">@external
func bad_claim_tokens{syscall_ptr : felt*, pedersen_ptr : HashBuiltin*, range_check_ptr}():
    let (user) = get_caller_address()

    let (user_current_balance) = user_balances.read(sender_address)
    user_balances.write(user_current_balance + 200)

    return ()
end

@external
func better_claim_tokens{syscall_ptr : felt*, pedersen_ptr : HashBuiltin*, range_check_ptr}():
    let (user) = get_caller_address()
    assert_not_equal(user,0)

    let (user_current_balance) = user_balances.read(sender_address)
    user_balances.write(user, user_current_balance + 200)

    return ()
end
</code></pre>
<h2 id="mitigations"><a class="header" href="#mitigations">Mitigations</a></h2>
<ul>
<li>Add zero address checks. Note that this will prevent users from interacting with the contract directly.</li>
</ul>
<h2 id="external-examples"><a class="header" href="#external-examples">External Examples</a></h2>
<ul>
<li>An <a href="https://github.com/OpenZeppelin/cairo-contracts/issues/148">issue</a> in the ERC721 implementation included in a pre-0.1.0 version of OpenZeppelin's Cairo contract library would have allowed unapproved users to transfer tokens.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="integer-division"><a class="header" href="#integer-division">Integer Division</a></h1>
<p>Math in Cairo is done in a finite field, which is why the numeric type is called <code>felt</code>, for field elements. In most cases addition, subtraction and multiplication will behave as they would in standard integer operations when writing Cairo code. However, developers need to pay a little bit extra attention when performing division. Unlike in Solidity, where division is carried out as if the values were real numbers and anything after the decimal place is truncated, in Cairo it's more intuitive to think of division as the inverse of multiplication. When a number divides a whole number of times into another number, the result is what we would expect, for example 30/6=5. But if we try to divide numbers that don't quite match up so perfectly, like 30/9, the result can be a bit surprising, in this case 1206167596222043737899107594365023368541035738443865566657697352045290673497. That's because 120...97 * 9  = 30 (modulo the <a href="https://docs.starkware.co/starkex-v4/crypto/stark-curve">252-bit prime used by StarkNet</a>)</p>
<h2 id="example-2"><a class="header" href="#example-2">Example</a></h2>
<p>Consider the following functions that normalize a user's token balance to a human readable value for a token with 10^18 decimals. In the first function, it will only provide meaningful values if a user has a whole number of tokens and return non-sense values in every other case. The better version stores these values as Uint256s and uses more traditional integer division. </p>
<pre><code class="language-cairo">@external
func bad_normalize_tokens{syscall_ptr: felt*, pedersen_ptr: HashBuiltin*, range_check_ptr}() -&gt; (
    normalized_balance: felt
) {
    let (user) = get_caller_address();

    let (user_current_balance) = user_balances.read(user);
    let (normalized_balance) = user_current_balance / 10 ** 18;

    return (normalized_balance,);
}

@external
func better_normalize_tokens{syscall_ptr: felt*, pedersen_ptr: HashBuiltin*, range_check_ptr}() -&gt; (
    normalized_balance: Uint256
) {
    let (user) = get_caller_address();

    let (user_current_balance) = user_balances.read(user);
    let (normalized_balance, _) = uint256_unsigned_div_rem(user_current_balance, 10 ** 18);

    return (normalized_balance,);
}
</code></pre>
<h2 id="mitigations-1"><a class="header" href="#mitigations-1">Mitigations</a></h2>
<ul>
<li>Review which numeric type is most appropriate for your use case. Especially if your programs rely on division, consider using <a href="https://github.com/starkware-libs/cairo-lang/blob/master/src/starkware/cairo/common/uint256.cairo">the uint256 module</a> instead of the felt primitive type.</li>
</ul>
<h2 id="external-examples-1"><a class="header" href="#external-examples-1">External Examples</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="state-modifications-in-a-view-function"><a class="header" href="#state-modifications-in-a-view-function">State modifications in a view function</a></h1>
<p>StarkNet provides the @view decorator to signal that a function should not make state modifications. However, this is <a href="https://www.cairo-lang.org/docs/hello_starknet/intro.html">not currently enforced by the compiler</a>. Developers should take care when designing view functions but also when calling functions in other contracts as they may result in unexpected behavior if they do include state modifications accidentally.</p>
<h2 id="example-3"><a class="header" href="#example-3">Example</a></h2>
<p>Consider the following function that's declared as a <code>@view</code>. It may have originally been intended as an actual view function but was later repurposed to fetch a nonce <em>and also increment it in the process</em> to ensure a nonce is never repeated when building a signature. </p>
<pre><code class="language-cairo">@view
func bad_get_nonce{syscall_ptr: felt*, pedersen_ptr: HashBuiltin*, range_check_ptr}() -&gt; (
    nonce: felt
) {
    let (user) = get_caller_address();
    let (nonce) = user_nonces.read(user);
    user_nonces.write(user, nonce + 1);

    return (nonce);
}
</code></pre>
<h2 id="mitigations-2"><a class="header" href="#mitigations-2">Mitigations</a></h2>
<ul>
<li>Carefully review all <code>@view</code> functions, including those called in 3rd party contracts, to ensure they don't modify state unexpectedly.</li>
</ul>
<h2 id="external-examples-2"><a class="header" href="#external-examples-2">External Examples</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="arithmetic-overflow"><a class="header" href="#arithmetic-overflow">Arithmetic overflow</a></h1>
<p>The default primitive type, the felt or field element, behaves a lot like an integer does in any other language but it has a few important differences to keep in mind. A felt can be interpreted as a signed integer in the range (-P/2,P/2) or as an unsigned integer in the range (0, P]. P here is the prime used by Cairo, which is current a 252-bit number. Arithemtic using felts is unchecked for overflow and can lead to unexpected results if this isn't properly accounted for. And since the range of values spans both negative and positive values, things like multiplying two positive numbers can have a negative value as a result, and vice versa, multiplying a two negative numbers doesn't always have a positive result.</p>
<p>StarkNet also provides the Uint256 module which offers a more typical 256-bit integer to developers. However, the arithmetic provided by this module is also unchecked so overflow is still something to keep in mind. For more robust integer support, consider using SafeUint256 from OpenZeppelin's Contracts for Cairo.</p>
<h2 id="attack-scenarios"><a class="header" href="#attack-scenarios">Attack Scenarios</a></h2>
<h2 id="mitigations-3"><a class="header" href="#mitigations-3">Mitigations</a></h2>
<ul>
<li>Always add checks for overflow when working with felts or Uint256s directly.</li>
<li>Consider using the <a href="https://github.com/OpenZeppelin/cairo-contracts/blob/main/src/openzeppelin/security/safemath/library.cairo">OpenZeppelin Contracts for Cairo's SafeUint256 functions</a> instead of doing arithmetic directly</li>
</ul>
<h2 id="examples-7"><a class="header" href="#examples-7">Examples</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="signature-replay-protection"><a class="header" href="#signature-replay-protection">Signature replay protection</a></h1>
<p>The StarkNet account abstraction model allows a lot of the details of authentication to be offloaded to contracts. This provides a greater amount of flexibility, but that also means signature schemas need to be constructed with great care. Signatures must be resilient to replay attacks and signature malleability. Signatures must include a nonce and should have a domain separator to bind the signature to a particular contract and chain, so for example testnet signatures can't be replayed against mainnet contracts.</p>
<h2 id="example-4"><a class="header" href="#example-4">Example</a></h2>
<p>Consider the following function that validates a signature for EIP712-style permit functionality. The first version includes neither a nonce, nor a way of identifying the specific chain a signature is for. This signature schema would allow signatures to be replayed both on the same chain, but also across chains, for example between a testnet and mainnet.</p>
<pre><code class="language-cairo">    # TODO
</code></pre>
<h2 id="mitigations-4"><a class="header" href="#mitigations-4">Mitigations</a></h2>
<ul>
<li>Consider using the <a href="https://github.com/OpenZeppelin/cairo-contracts/blob/main/docs/modules/ROOT/pages/accounts.adoc">OpenZeppelin Contracts for Cairo Account contract</a> or another existing account contract implementation.</li>
</ul>
<h2 id="external-examples-3"><a class="header" href="#external-examples-3">External Examples</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="l1-to-l2-address-conversion"><a class="header" href="#l1-to-l2-address-conversion">L1 to L2 Address Conversion</a></h1>
<p>In Starknet, addresses are of type <code>felt</code> while on L1 addresses are of type <code>uint160</code>. Thus, in order to pass around address types during cross layer messaging, the address variable is typically given as a <code>uint256</code>. However, this can create an issue where an address on L1 can map to the zero address (or an unexpected address) on L2. This is because the primitive type in Cairo is the <code>felt</code>, which is in between the range <code> 0 &lt; x &lt; P</code>, where P is the prime order of the curve. Typically we have <code>P = 2^251 + 17 * 2^192 + 1</code>.</p>
<h1 id="example-5"><a class="header" href="#example-5">Example</a></h1>
<p>Suppose that the following code to initiate L2 deposits from L1. The first example has no checks on the <code>to</code> parameter and thus depending on the users' address, it is possible to transfer tokens to an unexpected address on L2. The second example, however, verifies to make sure this check cannot happen. Note that the code is just a simplification of how messages are sent on L1 and processed on L2. For a more thorough overview, see here: https://www.cairo-lang.org/docs/hello_starknet/l1l2.html.</p>
<pre><code class="language-solidity">uint256 public constant STARKNET_FIELD_PRIME; // the prime order P of the elliptic curve used 
IERC20 public constant token; //some token to deposit on L2
event Deposited(uint256 sender, uint256 amount);

function badDepositToL2(uint256 to,  uint256 amount) public returns (bool) {
    token.transferFrom(to, address(this),amount);
    emit Deposited(to,amount); // this message gets processed on L2
    return true;
}

function betterDepositToL2(uint256 to,  uint256 amount) public returns (bool) {
    require(to !=0 &amp;&amp; to &lt; STARKNET_FIELD_PRIME, &quot;invalid address&quot;); //verifies 0 &lt; to &lt; P 
    token.transferFrom(to, address(this),amount);
    emit Deposited(to,amount); // this message gets processed on L2
    return true;
}
</code></pre>
<h1 id="mitigations-5"><a class="header" href="#mitigations-5">Mitigations</a></h1>
<p>When sending a message from L1 to L2, remember to verify parameters, especially user supplied params. Remember that the type and range of Cairo's default <code>felt</code> type is less than the <code>uint256</code> type used by Solidity. </p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="incorrect-felt-comparison"><a class="header" href="#incorrect-felt-comparison">Incorrect Felt Comparison</a></h1>
<p>In Cairo, there are two methods for the less than or equal to comparison operator: <code>assert_le</code> and <code>assert_nn_le</code>:</p>
<ul>
<li><code>assert_le</code> asserts that a number <code>a</code> is less than or equal to <code>b</code>, regardless of the size of <code>a</code></li>
<li><code>assert_nn_le</code> additionally asserts that <code>a</code> is <a href="https://github.com/starkware-libs/cairo-lang/blob/9889fbd522edc5eff603356e1912e20642ae20af/src/starkware/cairo/common/math.cairo#L71">non-negative</a>, i.e. not greater than or equal to the <code>RANGE_CHECK_BOUND</code> value of <code>2^128</code>. </li>
</ul>
<p><code>assert_nn_le</code> works to compare unsigned integers but with a value less than <code>2^128</code> (e.g. an <a href="https://github.com/starkware-libs/cairo-lang/blob/9889fbd522edc5eff603356e1912e20642ae20af/src/starkware/cairo/common/uint256.cairo#L9-L14">Uint256</a> field). To compare felts as unsigned integer over the entire range (0, P], <code>assert_le_felt</code> should be used. Note these functions exist also with the <code>is_</code> prefix where they return 1 (TRUE) or 0 (FALSE).</p>
<p>Due to the complexity of these assertions, a common mistake is to use <code>assert_le</code> when <code>assert_nn_le</code> should be used.</p>
<h1 id="example-6"><a class="header" href="#example-6">Example</a></h1>
<p>Suppose that a codebase uses the following checks regarding a hypothetical ERC20 token. In the first function, it may be possible that <code>value</code> is in fact greater than <code>max_supply</code>, yet because the function does not verify <code>value &gt;= 0</code> the assertion will incorrectly pass. The second function, however, asserts that <code>0 &lt;= value &lt;= max_supply</code>, which will correctly not let an incorrect <code>value</code> go through the assertion.</p>
<pre><code class="language-cairo">@storage_var
func max_supply() -&gt; (res: felt) {
}

@external
func bad_comparison{syscall_ptr : felt*, pedersen_ptr : HashBuiltin*, range_check_ptr}() {
    let (value: felt) = ERC20.total_supply();
    assert_le{range_check_ptr=range_check_ptr}(value, max_supply.read());

    // do something...

    return ();
}

@external
func better_comparison{syscall_ptr : felt*, pedersen_ptr : HashBuiltin*, range_check_ptr}() {
    let (value: felt) = ERC20.total_supply();
    assert_nn_le{range_check_ptr=range_check_ptr}(value, max_supply.read());

    // do something...

    return ();

    
}
</code></pre>
<h1 id="mitigations-6"><a class="header" href="#mitigations-6">Mitigations</a></h1>
<ul>
<li>Review all felt comparisons closely. </li>
<li>Determine what sort of behavior the comparison should have, and if <code>assert_nn_le</code> or <code>assert_le_felt</code> is more appropriate. </li>
<li>Use <code>assert_le</code> if you explicitly want to make comparison between signed integers - otherwise explicitely document why it is used over <code>assert_nn_le</code></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="namespace-storage-variable-collsion"><a class="header" href="#namespace-storage-variable-collsion">Namespace Storage Variable Collsion</a></h1>
<p>NOTE: The following was possible until cairo-lang 0.10.0.</p>
<p>In Cairo, it is possible to use namespaces to scope functions under an identifier. However, storage variables are not scoped by these namespaces. If a developer accidentally uses the same variable name in two different namespaces, it could lead to a storage collision.</p>
<h1 id="example-7"><a class="header" href="#example-7">Example</a></h1>
<p>The following example has been copied from <a href="https://gist.github.com/koloz193/18cb491167e844e9a28ac69825f68975">here</a>. Suppose we have two different namespaces <code>A</code> and <code>B</code>, both with the same <code>balance</code> storage variable. In addition, both namespaces have respective functions <code>increase_balance()</code> and <code>get_balance()</code> to increment the storage variable and retrieve it respectively. When either <code>increase_balance_a</code> or <code>increase_balance_b()</code> is called, the expected behavior would be to have two seperate storage variables have their balance increased respectively. However, because storage variables are not scoped by namespaces, there will be one <code>balance</code> variable updated twice: </p>
<pre><code class="language-cairo">%lang starknet

from starkware.cairo.common.cairo_builtins import HashBuiltin

from openzeppelin.a import A
from openzeppelin.b import B

@external
func increase_balance_a{
        syscall_ptr : felt*, pedersen_ptr : HashBuiltin*,
        range_check_ptr}(amount : felt):
    A.increase_balance(amount)
    return ()
end

@external
func increase_balance_b{
        syscall_ptr : felt*, pedersen_ptr : HashBuiltin*,
        range_check_ptr}(amount : felt):
    B.increase_balance(amount)
    return ()
end

@view
func get_balance_a{
        syscall_ptr : felt*, pedersen_ptr : HashBuiltin*,
        range_check_ptr}() -&gt; (res : felt):
    let (res) = A.get_balance()
    return (res)
end

@view
func get_balance_b{
        syscall_ptr : felt*, pedersen_ptr : HashBuiltin*,
        range_check_ptr}() -&gt; (res : felt):
    let (res) = B.get_balance()
    return (res)
end
</code></pre>
<h1 id="mitigations-7"><a class="header" href="#mitigations-7">Mitigations</a></h1>
<p>Make sure to not use the same storage variable name in the namespace (or change the return value's name, see <a href="https://github.com/crytic/amarna/issues/10">here</a>). Also use <a href="https://github.com/crytic/amarna">Amarna</a> to uncover this issue, since it has a detector for storage variable collisions.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dangerous-public-imports-in-libraries"><a class="header" href="#dangerous-public-imports-in-libraries">Dangerous Public Imports in Libraries</a></h1>
<p>NOTE: The following was possible until cairo-lang 0.10.0.</p>
<p>When a library is imported in Cairo, all functions can be called even if some of them are not declared in the import statement. As a result, it is possible to call functions that a developer may think is unexposed, leading to unexpected behavior.</p>
<h1 id="example-8"><a class="header" href="#example-8">Example</a></h1>
<p>Consider the library <code>library.cairo</code>. Even though the <code>example.cairo</code> file imports only the <code>check_owner()</code> and the <code>do_something()</code> function, the <code>bypass_owner_do_something()</code> function is still exposed and can thus be called, making it possible to circumvent the owner check.</p>
<pre><code class="language-cairo">
# library.cairo

%lang starknet
from starkware.cairo.common.cairo_builtins import HashBuiltin
@storage_var
func owner() -&gt; (res: felt):
end

func check_owner{syscall_ptr: felt*, pedersen_ptr: HashBuiltin*, range_check_ptr: felt*}():
    let caller = get_caller_address()
    let owner = owner.read()
    assert caller = owner
    return ()
end

func do_something():
    # do something potentially dangerous that only the owner can do
    return ()
end

# for testing purposes only
@external
func bypass_owner_do_something():
    do_something()
    return ()
end



# example.cairo
%lang starknet
%builtins pedersen range_check
from starkware.cairo.common.cairo_builtins import HashBuiltin
from library import check_owner(), do_something()
# Even though we just import check_owner() and do_something(), we can still call bypass_owner_do_something()!
func check_owner_and_do_something{syscall_ptr: felt*, pedersen_ptr: HashBuiltin*, range_check_ptr: felt*}():
    check_owner()
    do_something()
    return ()
end
</code></pre>
<h1 id="mitigations-8"><a class="header" href="#mitigations-8">Mitigations</a></h1>
<p>Make sure to exercise caution when declaring external functions in a library. Recognize the possible state changes that can be made through the function and verify it is acceptable for anyone to call it. In addition, <a href="https://github.com/crytic/amarna">Amarna</a> has a detector to uncover this issue. </p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="not-so-smart-cosmos"><a class="header" href="#not-so-smart-cosmos">(Not So) Smart Cosmos</a></h1>
<p>This repository contains examples of common Cosmos applications vulnerabilities, including code from real applications. Use Not So Smart Cosmos to learn about Cosmos (Tendermint) vulnerabilities, as a reference when performing security reviews, and as a benchmark for security and analysis tools.</p>
<h2 id="features-2"><a class="header" href="#features-2">Features</a></h2>
<p>Each <em>Not So Smart Cosmos</em> includes a standard set of information:</p>
<ul>
<li>Description of the vulnerability type</li>
<li>Attack scenarios to exploit the vulnerability</li>
<li>Recommendations to eliminate or mitigate the vulnerability</li>
<li>Real-world contracts that exhibit the flaw</li>
<li>References to third-party resources with more information</li>
</ul>
<h2 id="vulnerabilities-2"><a class="header" href="#vulnerabilities-2">Vulnerabilities</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Not So Smart Contract</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="not-so-smart-contracts/cosmos/incorrect_getsigners">Incorrect signers</a></td><td>Broken access controls due to incorrect signers validation</td></tr>
<tr><td><a href="not-so-smart-contracts/cosmos/non_determinism">Non-determinism</a></td><td>Consensus failure because of non-determinism</td></tr>
<tr><td><a href="not-so-smart-contracts/cosmos/messages_priority">Not prioritized messages</a></td><td>Risks arising from usage of not prioritized message types</td></tr>
<tr><td><a href="not-so-smart-contracts/cosmos/abci_fast">Slow ABCI methods</a></td><td>Consensus failure because of slow ABCI methods</td></tr>
<tr><td><a href="not-so-smart-contracts/cosmos/abci_panic">ABCI methods panic</a></td><td>Chain halt due to panics in ABCI methods</td></tr>
<tr><td><a href="not-so-smart-contracts/cosmos/broken_bookkeeping">Broken bookkeeping</a></td><td>Exploit mismatch between different modules' views on balances</td></tr>
<tr><td><a href="not-so-smart-contracts/cosmos/rounding_errors">Rounding errors</a></td><td>Bugs related to imprecision of finite precision arithmetic</td></tr>
<tr><td><a href="not-so-smart-contracts/cosmos/unregistered_msg_handler">Unregistered message handler</a></td><td>Broken functionality because of unregistered msg handler</td></tr>
<tr><td><a href="not-so-smart-contracts/cosmos/missing_error_handler">Missing error handler</a></td><td>Missing error handling leads to successful execution of a transaction that should have failed</td></tr>
</tbody></table>
</div>
<h2 id="credits-2"><a class="header" href="#credits-2">Credits</a></h2>
<p>These examples are developed and maintained by <a href="https://www.trailofbits.com/">Trail of Bits</a>.</p>
<p>If you have questions, problems, or just want to learn more, then join the #ethereum channel on the <a href="https://empireslacking.herokuapp.com/">Empire Hacking Slack</a> or <a href="https://www.trailofbits.com/contact/">contact us</a> directly.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="incorrect-signers"><a class="header" href="#incorrect-signers">Incorrect Signers</a></h1>
<p>In Cosmos, transaction's signature(s) are validated against public keys (addresses) taken from the transaction itself,
where locations of the keys <a href="https://docs.cosmos.network/v0.46/core/transactions.html#signing-transactions">are specified in <code>GetSigners</code> methods</a>.</p>
<p>In the simplest case there is just one signer required, and its address is simple to use correctly.
However, in more complex scenarios like when multiple signatures are required or a delegation schema is implemented,
it is possible to make mistakes about what addresses in the transaction (the message) are actually authenticated. </p>
<p>Fortunately, mistakes in <code>GetSigners</code> should make part of application's intended functionality not working,
making it easy to spot the bug.</p>
<h2 id="example-9"><a class="header" href="#example-9">Example</a></h2>
<p>The example application allows an author to create posts. A post can be created with a <code>MsgCreatePost</code> message, which has <code>signer</code> and <code>author</code> fields.</p>
<pre><code class="language-proto">service Msg {
      rpc CreatePost(MsgCreatePost) returns (MsgCreatePostResponse);
}

message MsgCreatePost {
  string signer = 1;
  string author = 2;
  string title = 3;
  string body = 4;
}

message MsgCreatePostResponse {
  uint64 id = 1;
}

message Post {
  string author = 1;
  uint64 id = 2;
  string title = 3;
  string body = 4;
}
</code></pre>
<p>The <code>signer</code> field is used for signature verification - as can be seen in <code>GetSigners</code> method below.</p>
<pre><code class="language-go">func (msg *MsgCreatePost) GetSigners() []sdk.AccAddress {
    signer, err := sdk.AccAddressFromBech32(msg.Signer)
    if err != nil {
        panic(err)
    }
    return []sdk.AccAddress{Signer}
}

func (msg *MsgCreatePost) GetSignBytes() []byte {
    bz := ModuleCdc.MustMarshalJSON(msg)
    return sdk.MustSortJSON(bz)
}

func (msg *MsgCreatePost) ValidateBasic() error {
    _, err := sdk.AccAddressFromBech32(msg.Signer)
    if err != nil {
        return sdkerrors.Wrapf(sdkerrors.ErrInvalidAddress, &quot;invalid creator address (%s)&quot;, err)
    }
    return nil
}
</code></pre>
<p>The <code>author</code> field is saved along with the post's content:</p>
<pre><code class="language-go">func (k msgServer) CreatePost(goCtx context.Context, msg *types.MsgCreatePost) (*types.MsgCreatePostResponse, error) {
    ctx := sdk.UnwrapSDKContext(goCtx)

    var post = types.Post{
        Author: msg.Author,
        Title:  msg.Title,
        Body:   msg.Body,
    }

    id := k.AppendPost(ctx, post)

    return &amp;types.MsgCreatePostResponse{Id: id}, nil
}
</code></pre>
<p>The bug here - mismatch between the message signer address and the stored address - allows users to impersonate other users by sending an arbitrary <code>author</code> field.</p>
<h2 id="mitigations-9"><a class="header" href="#mitigations-9">Mitigations</a></h2>
<ul>
<li>Keep signers-related logic simple</li>
<li>Implement basic sanity tests for all functionalities</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="non-determinism"><a class="header" href="#non-determinism">Non-determinism</a></h1>
<p>Non-determinism in conensus-relevant code will cause the blockchain to halt.
There are quite a few sources of non-determinism, some of which are specific to the Go language:</p>
<ul>
<li><a href="https://lev.pm/posts/2020-04-18-golang-map-randomness/"><code>range</code> iterations over an unordered map or other operations involving unordered structures</a></li>
<li><a href="https://go.dev/ref/spec#Numeric_types">Implementation (platform) dependent types like <code>int</code></a> or <code>filepath.Ext</code></li>
<li><a href="https://github.com/golang/go/issues/33702">goroutines and <code>select</code> statement</a></li>
<li><a href="https://github.com/cosmos/cosmos-sdk/issues/11726#issuecomment-1108427164">Memory addresses</a></li>
<li><a href="https://en.wikipedia.org/wiki/Floating-point_arithmetic#Accuracy_problems">Floating point arithmetic operations</a></li>
<li>Randomness (<a href="https://github.com/golang/go/issues/42701">may be problematic even with a constant seed</a>)</li>
<li>Local time and timezones</li>
<li>Packages like <code>unsafe</code>, <code>reflect</code>, and <code>runtime</code></li>
</ul>
<h2 id="example-10"><a class="header" href="#example-10">Example</a></h2>
<p>Below we can see an iteration over a <code>amounts</code> <code>map</code>. If <code>k.GetPool</code> fails for more than one <code>asset</code>, then different nodes will fail with different errors, causing the chain to halt.</p>
<pre><code class="language-go">func (k msgServer) CheckAmounts(goCtx context.Context, msg *types.MsgCheckAmounts) (*types.MsgCheckAmountsResponse, error) {
    ctx := sdk.UnwrapSDKContext(goCtx)

    amounts := make(map[Asset]int)
    for asset, coin := range allMoney.Coins {
        amounts[asset] = Compute(coin)
    }

    total int := 0
    for asset, f := range amounts {
        poolSize, err := k.GetPool(ctx, asset, f)
        if err != nil {
            return nil, err
        }
        total += poolSize
    }

    if total == 0 {
        return nil, errors.New(&quot;Zero total&quot;)
    }

    return &amp;types.MsgCheckAmountsResponse{}, nil
}
</code></pre>
<p>Even if we fix the <code>map</code> problem, it is still possible that the <code>total</code> overflows for nodes running on 32-bit architectures earlier than for the rest of the nodes, again causing the chain split.</p>
<h2 id="mitigations-10"><a class="header" href="#mitigations-10">Mitigations</a></h2>
<ul>
<li>Use static analysis, for example <a href="https://github.com/crypto-com/cosmos-sdk-codeql">custom CodeQL rules</a></li>
<li>Test your application with nodes running on various architectures or require nodes to run on a specific one</li>
<li>Prepare and test procedures for recovering from a blockchain split</li>
</ul>
<h2 id="external-examples-4"><a class="header" href="#external-examples-4">External examples</a></h2>
<ul>
<li><a href="https://gitlab.com/thorchain/thornode/-/issues/1169">ThorChain halt due to &quot;iteration over a map error-ing at different indexes&quot;</a></li>
<li><a href="https://github.com/cybercongress/go-cyber/issues/66">Cyber's had problems with <code>float64</code> type</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="not-prioritized-messages"><a class="header" href="#not-prioritized-messages">Not prioritized messages</a></h1>
<p>Some message types may be more important than others and should have priority over them. That is, the more significant a message type is, the more quickly it should be included in a block, before other messages are.</p>
<p>Failing to prioritize message types allows attackers to front-run them, possibly gaining unfair advantage. Moreover, during high network congestion, the message may be simply not included in a block for a long period, causing the system to malfunction.</p>
<p>In the Cosmos's mempool, transactions are <a href="https://github.com/tendermint/tendermint/blob/f9e0f77af333f4ab7bfa1c0c303f7db47cec0c9e/docs/architecture/adr-067-mempool-refactor.md#context">ordered in first-in-first-out (FIFO) manner</a> by default. Especially, there is no fee-based ordering.</p>
<h2 id="example-11"><a class="header" href="#example-11">Example</a></h2>
<p>An example application implements a lending platform. It uses a price oracle mechanism, where privileged entities can vote on new assets' prices. The mechanism is implemented as standard messages.</p>
<pre><code class="language-go">service Msg {
  rpc Lend(MsgLend) returns (MsgLendResponse);

  rpc Borrow(MsgBorrow) returns (MsgBorrowResponse);

  rpc Liquidate(MsgLiquidate) returns (MsgLiquidateResponse);

  rpc OracleCommitPrice(MsgOracleCommitPrice) returns (MsgOracleCommitPriceResponse);

  rpc OracleRevealPrice(MsgOracleRevealPrice) returns (MsgOracleRevealPriceResponse);
}
</code></pre>
<p>Prices ought to be updated (committed and revealed) after every voting period. However, an attacker can spam the network with low-cost transactions to completely fill blocks, leaving no space for price updates. He can then profit from the fact that the system uses outdated, stale prices.</p>
<h2 id="example-2"><a class="header" href="#example-2">Example 2</a></h2>
<p>Lets consider a liquidity pool application that implements the following message types:</p>
<pre><code class="language-go">service Msg {
  rpc CreatePool(MsgCreatePool) returns (MsgCreatePoolResponse);

  rpc Deposit(MsgDeposit) returns (MsgDepositResponse);

  rpc Withdraw(MsgWithdraw) returns (MsgWithdrawResponse);

  rpc Swap(MsgSwap) returns (MsgSwapResponse);

  rpc Pause(MsgPause) returns (MsgPauseResponse);

  rpc Resume(MsgResume) returns (MsgResumeResponse);
}
</code></pre>
<p>There is the <code>Pause</code> message, which allows privileged users to stop the pool.</p>
<p>Once a bug in pool's implementation is discovered, attackers and the pool's operators will compete for whose message is first executed (<code>Swap</code> vs <code>Pause</code>). Prioritizing <code>Pause</code> messages will help pool's operators to prevent exploitation, but in this case it won't stop the attackers completely. They can outrun the <code>Pause</code> message by order of magnitude - so the priority will not matter -  or even cooperate with a malicious validator node - who can order his mempool in an arbitrary way.</p>
<h2 id="mitigations-11"><a class="header" href="#mitigations-11">Mitigations</a></h2>
<ul>
<li><a href="https://github.com/tendermint/spec/blob/v0.7.1/spec/abci/abci.md#checktx-1">Use <code>CheckTx</code>'s <code>priority</code> return value</a> to prioritize messages. Please note that this feature has a transaction (not a message) granularity - users can send multiple messages in a single transaction, and it is the transaction that will have to be prioritized.</li>
<li>Perform authorization for prioritized transactions as early as possible. That is, during the <code>CheckTx</code> phase. This will prevent attackers from filling whole blocks with invalid, but prioritized transactions. In other words, implement a mechanism that will prevent validators from accepting not-authorized, prioritized messages into a mempool.</li>
<li>Alternatively, charge a high fee for prioritized transactions to disincentivize attackers.</li>
</ul>
<h2 id="external-examples-5"><a class="header" href="#external-examples-5">External examples</a></h2>
<ul>
<li><a href="https://cryptorisks.substack.com/p/ust-december-2021">Terra Money's oracle messages were not prioritized</a> (search for &quot;priority&quot;). It was <a href="https://github.com/terra-money/tendermint/commit/6805b4866bdbd6933000eb0e761acbf15edd8ed6">fixed with modifications to Tendermint</a>.</li>
<li><a href="https://github.com/trailofbits/publications/blob/master/reviews/Umee.pdf">Umee oracle and orchestrator messages were not prioritized</a> (search for finding TOB-UMEE-20 and TOB-UMEE-31).</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="slow-abci-methods"><a class="header" href="#slow-abci-methods">Slow ABCI methods</a></h1>
<p>ABCI methods (like <code>EndBlocker</code>) <a href="https://docs.cosmos.network/v0.45/basics/app-anatomy.html#beginblocker-and-endblocker">are not constrained by <code>gas</code></a>. Therefore, it is essential to ensure that they always will finish in a reasonable time. Otherwise, the chain will halt.</p>
<h2 id="example-12"><a class="header" href="#example-12">Example</a></h2>
<p>Below you can find part of a tokens lending application. Before a block is executed, the <code>BeginBlocker</code> method charges an interest for each borrower.</p>
<pre><code class="language-go">func BeginBlocker(ctx sdk.Context, k keeper.Keeper) {
    updatePrices(ctx, k)
    accrueInterest(ctx, k)
}

func accrueInterest(ctx sdk.Context, k keeper.Keeper) {
    for _, pool := range k.GetLendingPools() {
        poolAssets := k.GetPoolAssets(ctx, pool.Id)
        for userId, _ := range k.GetAllUsers() {
            for _, asset := range poolAssets {
                for _, loan := range k.GetUserLoans(ctx, pool, asset, userId) {
                    if err := k.AccrueInterest(ctx, loan); err != nil {
                        k.PunishUser(ctx, userId)
                    }
                }
            }
        }
    }
}
</code></pre>
<p>The <code>accrueInterest</code> contains multiple nested for loops and is obviously too complex to be efficient. Mischievous
users can take a lot of small loans to slow down computation to a point where the chain is not able to keep up with blocks production and halts.</p>
<h2 id="mitigations-12"><a class="header" href="#mitigations-12">Mitigations</a></h2>
<ul>
<li>Estimate computational complexity of all implemented ABCI methods and ensure that they will scale correctly with the application's usage growth</li>
<li>Implement stress tests for the ABCI methods</li>
<li><a href="https://docs.cosmos.network/v0.46/basics/gas-fees.html#introduction-to-gas-and-fees">Ensure that minimal fees are enforced on all messages</a> to prevent spam</li>
</ul>
<h2 id="external-examples-6"><a class="header" href="#external-examples-6">External examples</a></h2>
<ul>
<li><a href="https://github.com/althea-net/cosmos-gravity-bridge/issues/347">Gravity Bridge's <code>slashing</code> method was executed in the <code>EndBlocker</code> and contained a computationally expensive, nested loop</a>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="abci-methods-panic"><a class="header" href="#abci-methods-panic">ABCI methods panic</a></h1>
<p>A <code>panic</code> inside an ABCI method (e.g., <code>EndBlocker</code>) will stop the chain. There should be no unanticipated <code>panic</code>s in these methods.</p>
<p>Some less expected <code>panic</code> sources are:</p>
<ul>
<li><a href="https://github.com/cosmos/cosmos-sdk/blob/afbb0bd1941f7ad36e086913153af02eb6a68f5a/types/coin.go#L68"><code>Coins</code>, <code>DecCoins</code>, <code>Dec</code>, <code>Int</code>, and <code>UInt</code> types panics a lot</a>, <a href="https://github.com/cosmos/cosmos-sdk/blob/afbb0bd1941f7ad36e086913153af02eb6a68f5a/types/dec_coin.go#L105">for example on overflows</a> and <a href="https://github.com/cosmos/cosmos-sdk/blob/afbb0bd1941f7ad36e086913153af02eb6a68f5a/types/decimal.go#L648">rounding errors</a></li>
<li><a href="https://pkg.go.dev/github.com/cosmos/cosmos-sdk/types@v0.45.5#Dec"><code>new Dec</code> panics</a></li>
<li><a href="https://github.com/cosmos/cosmos-sdk/blob/1b1dbf8ab722e4689e14a5a2a1fc433b69bc155e/x/params/doc.go#L107-L108"><code>x/params</code>'s <code>SetParamSet</code> panics if arguments are invalid</a></li>
</ul>
<h2 id="example-13"><a class="header" href="#example-13">Example</a></h2>
<p>The application below enforces limits on how much coins can be borrowed globally. If the <code>loan.Borrowed</code> array of Coins can be forced to be not-sorted (by coins' denominations), the <code>Add</code> method will <code>panic</code>.</p>
<p>Moreover, the <code>Mul</code> may panic if some asset's price becomes large.</p>
<pre><code class="language-go">func BeginBlocker(ctx sdk.Context, k keeper.Keeper) {
    if !validateTotalBorrows(ctx, k) {
        k.PauseNewLoans(ctx)
    }
}

func validateTotalBorrows(ctx sdk.Context, k keeper.Keeper) {
    total := sdk.NewCoins()
    for _, loan := range k.GetUsersLoans() {
        total.Add(loan.Borrowed...)
    }

    for _, totalOneAsset := range total {
        if totalOneAsset.Amount.Mul(k.GetASsetPrice(totalOneAsset.Denom)).GTE(k.GetGlobalMaxBorrow()) {
            return false
        }
    }
    return true
}
</code></pre>
<h2 id="mitigations-13"><a class="header" href="#mitigations-13">Mitigations</a></h2>
<ul>
<li><a href="https://github.com/crypto-com/cosmos-sdk-codeql/blob/main/src/beginendblock-panic.ql">Use CodeQL static analysis</a> to detect <code>panic</code>s in ABCI methods</li>
<li>Review the code against unexpected <code>panic</code>s</li>
</ul>
<h2 id="external-examples-7"><a class="header" href="#external-examples-7">External examples</a></h2>
<ul>
<li><a href="https://giters.com/althea-net/cosmos-gravity-bridge/issues/348">Gravity Bridge can <code>panic</code> in multiple locations in the <code>EndBlocker</code> method</a></li>
<li><a href="https://github.com/Agoric/agoric-sdk/blob/9116ede69169ebb252faf069d90022e8e05c6a4e/golang/cosmos/x/vbank/module.go#L166">Agoric <code>panic</code>s purposefully if the <code>PushAction</code> method returns an error</a></li>
<li><a href="https://github.com/cosmos/cosmos-sdk/issues/5808">Setting invalid parameters in <code>x/distribution</code> module causes <code>panic</code> in <code>BeginBlocker</code></a>. Valid parameters are <a href="https://docs.cosmos.network/v0.45/modules/distribution/07_params.html">described in the documentation</a>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="broken-bookkeeping"><a class="header" href="#broken-bookkeeping">Broken Bookkeeping</a></h1>
<p>The <code>x/bank</code> module is the standard way to manage tokens in a cosmos-sdk based applications. The module allows to mint, burn, and transfer coins between both users' and modules' accounts. If an application implements its own, internal bookkeeping, it must carefully use the <code>x/bank</code>'s features.</p>
<h2 id="example-14"><a class="header" href="#example-14">Example</a></h2>
<p>An application enforces the following invariant as a sanity-check: amount of tokens owned by a module equals to the amount of tokens deposited by users via the custom <code>x/hodl</code> module.</p>
<pre><code class="language-go">func BalanceInvariant(k Keeper) sdk.Invariant {
    return func(ctx sdk.Context) (string, bool) {
        weAreFine := true
        msg := &quot;hodling hard&quot;

        weHold := k.bankKeeper.SpendableCoins(authtypes.NewModuleAddress(types.ModuleName)).AmountOf(&quot;BTC&quot;)
        usersDeposited := k.GetTotalDeposited(&quot;BTC&quot;)

        if weHold != usersDeposited {
            msg = fmt.Sprintf(&quot;%dBTC missing! Halting chain.\n&quot;, usersDeposited - weHold)
            weAreFine = false
        }

        return sdk.FormatInvariant(types.ModuleName, &quot;hodl-balance&quot;,), weAreFine
    }
}
</code></pre>
<p>A spiteful user can simply transfer a tiny amount of BTC tokens directly to the <code>x/hodl</code> module via a message to the <code>x/bank</code> module. That would bypass accounting of the <code>x/hodl</code>, so the <code>GetTotalDeposited</code> function would report a not-updated amount, smaller than the module's <code>SpendableCoins</code>.</p>
<p>Because an invariant's failure stops the chain, the bug constitutes a simple Denial-of-Service attack vector.</p>
<h2 id="example-2-1"><a class="header" href="#example-2-1">Example 2</a></h2>
<p>An example application implements a lending platform. It allows users to deposit Tokens in exchange for xTokens - similarly to the <a href="https://compound.finance/docs/ctokens#exchange-rate">Compound's cTokens</a>. Token:xToken exchange rate is calculated as <code>(amount of Tokens borrowed + amount of Tokens held by the module account) / (amount of uTokens in circulation)</code>.</p>
<p>Implementation of the <code>GetExchangeRate</code> method computing an exchange rate is presented below. </p>
<pre><code class="language-go">func (k Keeper) GetExchangeRate(tokenDenom string) sdk.Coin {
    uTokenDenom := createUDenom(tokenDenom)

    tokensHeld := k.bankKeeper.SpendableCoins(authtypes.NewModuleAddress(types.ModuleName)).AmountOf(tokenDenom).ToDec()
    tokensBorrowed := k.GetTotalBorrowed(tokenDenom)
    uTokensInCirculation := k.bankKeeper.GetSupply(uTokenDenom).Amount

    return (tokensHeld + tokensBorrowed) / uTokensInCirculation
}

</code></pre>
<p>A malicious user can screw an exchange rate in two ways:</p>
<ul>
<li>by force-sending Tokens to the module, changing the <code>tokensHeld</code> value</li>
<li>by transferring uTokens to another chain via IBC, chaning <code>uTokensInCirculation</code> value</li>
</ul>
<p>The first &quot;attack&quot; could be pulled of by sending <a href="https://docs.cosmos.network/main/modules/bank#msgsend"><code>MsgSend</code></a> message. However, it would be not profitable (probably), as executing it would irreversibly decrease an attacker's resources.</p>
<p>The second one works because the IBC module <a href="https://github.com/cosmos/ibc-go/blob/48a6ae512b4ea42c29fdf6c6f5363f50645591a2/modules/apps/transfer/keeper/relay.go#L135-L136">burns transferred coins in the source chain</a> and mints corresponding tokens in the destination chain. Therefore, it will decrease the supply reported by the <code>x/bank</code> module, increasing the exchange rate. After the attack the malicious user can just transfer back uTokens.</p>
<h2 id="mitigations-14"><a class="header" href="#mitigations-14">Mitigations</a></h2>
<ul>
<li>Use <a href="https://docs.cosmos.network/v0.45/modules/bank/02_keepers.html#blocklisting-addresses"><code>Blocklist</code> to prevent unexpected token transfers</a> to specific addresses</li>
<li>Use <a href="https://docs.cosmos.network/v0.45/modules/bank/05_params.html#parameters"><code>SendEnabled</code> parameter to prevent unexpected transfers</a> of specific tokens (denominations)</li>
<li>Ensure that the blocklist is explicitly checked <a href="https://github.com/cosmos/cosmos-sdk/issues/8463#issuecomment-801046285">whenever a new functionality allowing for tokens transfers is implemented</a></li>
</ul>
<h2 id="external-examples-8"><a class="header" href="#external-examples-8">External examples</a></h2>
<ul>
<li><a href="https://github.com/trailofbits/publications/blob/master/reviews/Umee.pdf">Umee was vulnerable to the token:uToken exchange rate manipulation</a> (search for finding TOB-UMEE-21).</li>
<li><a href="https://github.com/desmos-labs/desmos/blob/e3c89e2f9ddd5dfde5d11c3ad5319e3c249cacb3/CHANGELOG.md#version-0154">Desmos incorrectly blocklisted addresses</a> (check app.go file in <a href="https://github.com/desmos-labs/desmos/compare/v0.15.3...v0.15.4">the commits diff</a>)</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rounding-errors"><a class="header" href="#rounding-errors">Rounding errors</a></h1>
<p>Application developers must take care of correct rounding of numbers, especially if the rounding impacts tokens amounts.</p>
<p>Cosmos-sdk offers two custom types for dealing with numbers:</p>
<ul>
<li><code>sdk.Int</code> (<code>sdk.UInt</code>) type for integral numbers</li>
<li><code>sdk.Dec</code> type for decimal arithmetic</li>
</ul>
<p>The <code>sdk.Dec</code> type <a href="https://github.com/cosmos/cosmos-sdk/issues/7773">has problems with precision and does not guarantee associativity</a>, so it must be used carefully. But even if a more robust library for decimal numbers is deployed in the cosmos-sdk, rounding may be unavoidable. </p>
<h2 id="example-15"><a class="header" href="#example-15">Example</a></h2>
<p>Below we see a simple example demonstrating <code>sdk.Dec</code> type's precision problems.</p>
<pre><code class="language-go">func TestDec() {
    a := sdk.MustNewDecFromStr(&quot;10&quot;)
    b := sdk.MustNewDecFromStr(&quot;1000000010&quot;)
    x := a.Quo(b).Mul(b)
    fmt.Println(x)  // 9.999999999999999000

    q := float32(10)
    w := float32(1000000010)
    y := (q / w) * w
    fmt.Println(y)  // 10
}
</code></pre>
<h2 id="mitigations-15"><a class="header" href="#mitigations-15">Mitigations</a></h2>
<ul>
<li>
<p>Ensure that all tokens operations that must round results always benefit the system (application) and not users. In other words, always decide on the correct rounding direction. See <a href="https://github.com/trailofbits/publications/blob/master/reviews/Umee.pdf">Appendix G in the Umee audit report</a></p>
</li>
<li>
<p>Apply &quot;multiplication before division&quot; pattern. That is, instead of computing <code>(x / y) * z</code> do <code>(x * z) / y</code></p>
</li>
<li>
<p>Observe <a href="https://github.com/cosmos/cosmos-sdk/issues/11783">issue #11783</a> for a replacement of the <code>sdk.Dec</code> type</p>
</li>
</ul>
<h2 id="external-examples-9"><a class="header" href="#external-examples-9">External examples</a></h2>
<ul>
<li><a href="https://github.com/umee-network/umee/issues/545">Umee had vulnerability caused by incorrect rounding direction</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="unregistered-message-handler"><a class="header" href="#unregistered-message-handler">Unregistered message handler</a></h1>
<p>In the legacy version of the <code>Msg Service</code>, all messages have to be registered in a module keeper's <code>NewHandler</code> method. Failing to do so would prevent users from sending the not-registered message.</p>
<p>In <a href="https://docs.cosmos.network/v0.47/building-modules/msg-services">the recent Cosmos version manual registration is no longer needed</a>.</p>
<h2 id="example-16"><a class="header" href="#example-16">Example</a></h2>
<p>There is one message handler missing.</p>
<pre><code class="language-go">service Msg {
  rpc ConfirmBatch(MsgConfirmBatch) returns (MsgConfirmBatchResponse) {
      option (google.api.http).post = &quot;/gravity/v1/confirm_batch&quot;;
  }
  rpc UpdateCall(MsgUpdateCall) returns (MsgUpdateCallResponse) {
      option (google.api.http).post = &quot;/gravity/v1/update_call&quot;;
  }
  rpc CancelCall(MsgCancelCall) returns (MsgCancelCallResponse) {
      option (google.api.http).post = &quot;/gravity/v1/cancel_call&quot;;
  }
  rpc SetCall(MsgSetCall) returns (MsgSetCallResponse) {
      option (google.api.http).post = &quot;/gravity/v1/set_call&quot;;
  }
  rpc SendCall(MsgSendCall) returns (MsgSendCallResponse) {
      option (google.api.http).post = &quot;/gravity/v1/send_call&quot;;
  }
  rpc SetUserAddress(MsgSetUserAddress) returns (MsgSetUserAddressResponse) {
      option (google.api.http).post = &quot;/gravity/v1/set_useraddress&quot;;
  }
  rpc SendUserAddress(MsgSendUserAddress) returns (MsgSendUserAddressResponse) {
      option (google.api.http).post = &quot;/gravity/v1/send_useraddress&quot;;
  }
  rpc RequestBatch(MsgRequestBatch) returns (MsgRequestBatchResponse) {
      option (google.api.http).post = &quot;/gravity/v1/request_batch&quot;;
  }
  rpc RequestCall(MsgRequestCall) returns (MsgRequestCallResponse) {
      option (google.api.http).post = &quot;/gravity/v1/request_call&quot;;
  }
  rpc RequestUserAddress(MsgRequestUserAddress) returns (MsgRequestUserAddressResponse) {
      option (google.api.http).post = &quot;/gravity/v1/request_useraddress&quot;;
  }
  rpc ConfirmEthClaim(MsgConfirmEthClaim) returns (MsgConfirmEthClaimResponse) {
      option (google.api.http).post = &quot;/gravity/v1/confirm_ethclaim&quot;;
  }
  rpc UpdateEthClaim(MsgUpdateEthClaim) returns (MsgUpdateEthClaimResponse) {
      option (google.api.http).post = &quot;/gravity/v1/update_ethclaim&quot;;
  }
  rpc SetBatch(MsgSetBatch) returns (MsgSetBatchResponse) {
      option (google.api.http).post = &quot;/gravity/v1/set_batch&quot;;
  }
  rpc SendBatch(MsgSendBatch) returns (MsgSendBatchResponse) {
      option (google.api.http).post = &quot;/gravity/v1/send_batch&quot;;
  }
  rpc CancelUserAddress(MsgCancelUserAddress) returns (MsgCancelUserAddressResponse) {
      option (google.api.http).post = &quot;/gravity/v1/cancel_useraddress&quot;;
  }
  rpc CancelEthClaim(MsgCancelEthClaim) returns (MsgCancelEthClaimResponse) {
      option (google.api.http).post = &quot;/gravity/v1/cancel_ethclaim&quot;;
  }
  rpc RequestEthClaim(MsgRequestEthClaim) returns (MsgRequestEthClaimResponse) {
      option (google.api.http).post = &quot;/gravity/v1/request_ethclaim&quot;;
  }
  rpc UpdateBatch(MsgUpdateBatch) returns (MsgUpdateBatchResponse) {
      option (google.api.http).post = &quot;/gravity/v1/update_batch&quot;;
  }
  rpc SendEthClaim(MsgSendEthClaim) returns (MsgSendEthClaimResponse) {
      option (google.api.http).post = &quot;/gravity/v1/send_ethclaim&quot;;
  }
  rpc SetEthClaim(MsgSetEthClaim) returns (MsgSetEthClaimResponse) {
      option (google.api.http).post = &quot;/gravity/v1/set_ethclaim&quot;;
  }
  rpc CancelBatch(MsgCancelBatch) returns (MsgCancelBatchResponse) {
      option (google.api.http).post = &quot;/gravity/v1/cancel_batch&quot;;
  }
  rpc UpdateUserAddress(MsgUpdateUserAddress) returns (MsgUpdateUserAddressResponse) {
      option (google.api.http).post = &quot;/gravity/v1/update_useraddress&quot;;
  }
  rpc ConfirmCall(MsgConfirmCall) returns (MsgConfirmCallResponse) {
      option (google.api.http).post = &quot;/gravity/v1/confirm_call&quot;;
  }
  rpc ConfirmUserAddress(MsgConfirmUserAddress) returns (MsgConfirmUserAddressResponse) {
      option (google.api.http).post = &quot;/gravity/v1/confirm_useraddress&quot;;
  }
}
</code></pre>
<pre><code class="language-go">func NewHandler(k keeper.Keeper) sdk.Handler {
    msgServer := keeper.NewMsgServerImpl(k)

    return func(ctx sdk.Context, msg sdk.Msg) (*sdk.Result, error) {
        ctx = ctx.WithEventManager(sdk.NewEventManager())
        switch msg := msg.(type) {
        case *types.MsgSetBatch:
            res, err := msgServer.SetBatch(sdk.WrapSDKContext(ctx), msg)
            return sdk.WrapServiceResult(ctx, res, err)
        case *types.MsgUpdateUserAddress:
            res, err := msgServer.UpdateUserAddress(sdk.WrapSDKContext(ctx), msg)
            return sdk.WrapServiceResult(ctx, res, err)
        case *types.MsgUpdateCall:
            res, err := msgServer.UpdateCall(sdk.WrapSDKContext(ctx), msg)
            return sdk.WrapServiceResult(ctx, res, err)
        case *types.MsgSendBatch:
            res, err := msgServer.SendBatch(sdk.WrapSDKContext(ctx), msg)
            return sdk.WrapServiceResult(ctx, res, err)
        case *types.MsgCancelUserAddress:
            res, err := msgServer.CancelUserAddress(sdk.WrapSDKContext(ctx), msg)
            return sdk.WrapServiceResult(ctx, res, err)
        case *types.MsgRequestBatch:
            res, err := msgServer.RequestBatch(sdk.WrapSDKContext(ctx), msg)
            return sdk.WrapServiceResult(ctx, res, err)
        case *types.MsgUpdateEthClaim:
            res, err := msgServer.UpdateEthClaim(sdk.WrapSDKContext(ctx), msg)
            return sdk.WrapServiceResult(ctx, res, err)
        case *types.MsgSendCall:
            res, err := msgServer.SendCall(sdk.WrapSDKContext(ctx), msg)
            return sdk.WrapServiceResult(ctx, res, err)
        case *types.MsgSetCall:
            res, err := msgServer.SetCall(sdk.WrapSDKContext(ctx), msg)
            return sdk.WrapServiceResult(ctx, res, err)
        case *types.MsgCancelEthClaim:
            res, err := msgServer.CancelEthClaim(sdk.WrapSDKContext(ctx), msg)
            return sdk.WrapServiceResult(ctx, res, err)
        case *types.MsgConfirmEthClaim:
            res, err := msgServer.ConfirmEthClaim(sdk.WrapSDKContext(ctx), msg)
            return sdk.WrapServiceResult(ctx, res, err)
        case *types.MsgConfirmCall:
            res, err := msgServer.ConfirmCall(sdk.WrapSDKContext(ctx), msg)
            return sdk.WrapServiceResult(ctx, res, err)
        case *types.MsgRequestCall:
            res, err := msgServer.RequestCall(sdk.WrapSDKContext(ctx), msg)
            return sdk.WrapServiceResult(ctx, res, err)
        case *types.MsgConfirmUserAddress:
            res, err := msgServer.ConfirmUserAddress(sdk.WrapSDKContext(ctx), msg)
            return sdk.WrapServiceResult(ctx, res, err)
        case *types.MsgRequestUserAddress:
            res, err := msgServer.RequestUserAddress(sdk.WrapSDKContext(ctx), msg)
            return sdk.WrapServiceResult(ctx, res, err)
        case *types.MsgSendEthClaim:
            res, err := msgServer.SendEthClaim(sdk.WrapSDKContext(ctx), msg)
            return sdk.WrapServiceResult(ctx, res, err)
        case *types.MsgSetEthClaim:
            res, err := msgServer.SetEthClaim(sdk.WrapSDKContext(ctx), msg)
            return sdk.WrapServiceResult(ctx, res, err)
        case *types.MsgCancelBatch:
            res, err := msgServer.CancelBatch(sdk.WrapSDKContext(ctx), msg)
            return sdk.WrapServiceResult(ctx, res, err)
        case *types.MsgSetUserAddress:
            res, err := msgServer.SetUserAddress(sdk.WrapSDKContext(ctx), msg)
            return sdk.WrapServiceResult(ctx, res, err)
        case *types.MsgRequestEthClaim:
            res, err := msgServer.RequestEthClaim(sdk.WrapSDKContext(ctx), msg)
            return sdk.WrapServiceResult(ctx, res, err)
        case *types.MsgConfirmBatch:
            res, err := msgServer.ConfirmBatch(sdk.WrapSDKContext(ctx), msg)
            return sdk.WrapServiceResult(ctx, res, err)
        case *types.MsgUpdateBatch:
            res, err := msgServer.UpdateBatch(sdk.WrapSDKContext(ctx), msg)
            return sdk.WrapServiceResult(ctx, res, err)
        case *types.MsgSendUserAddress:
            res, err := msgServer.SendUserAddress(sdk.WrapSDKContext(ctx), msg)
            return sdk.WrapServiceResult(ctx, res, err)

        default:
            return nil, sdkerrors.Wrap(sdkerrors.ErrUnknownRequest, fmt.Sprintf(&quot;Unrecognized Gravity Msg type: %v&quot;, msg.Type()))
        }
    }
}
</code></pre>
<p>And it is the <code>CancelCall</code> msg.</p>
<h2 id="mitigations-16"><a class="header" href="#mitigations-16">Mitigations</a></h2>
<ul>
<li>Use the recent Msg Service mechanism</li>
<li>Test all functionalities</li>
<li>Deploy static-analysis tests in CI pipeline for all manually maintained code that must be repeated in multiple files/methods</li>
</ul>
<h2 id="external-examples-10"><a class="header" href="#external-examples-10">External examples</a></h2>
<ul>
<li>The bug occured in the <a href="https://github.com/code-423n4/2021-08-gravitybridge-findings/issues/64">Gravity Bridge</a>. It was impossible to send evidence of malicious behavior, which impacted Gravity Bridge's security model.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="missing-error-handler"><a class="header" href="#missing-error-handler">Missing error handler</a></h1>
<p>The idiomatic way of handling errors in <code>Go</code> is to compare the returned error to nil. This way of checking for errors gives the programmer a lot of control. However, when error handling is ignored it can also lead to numerous problems. The impact of this is most obvious in method calls in the <code>bankKeeper</code> module, which even causes some accounts with insufficient balances to perform <code>SendCoin</code> operations normally without triggering a transaction failure.</p>
<h2 id="example-17"><a class="header" href="#example-17">Example</a></h2>
<p>In the following code, <code>k.bankKeeper.SendCoins(ctx, sender, receiver, amount)</code> does not have any return values being used, including <code>err</code>. This results in <code>SendCoin</code> not being able to prevent the transaction from executing even if there is an <code>error</code> due to insufficient balance in <code>SendCoin</code>.</p>
<pre><code class="language-golang">func (k msgServer) Transfer(goCtx context.Context, msg *types.MsgTransfer) (*types.MsgTransferResponse, error) {
	...
	k.bankKeeper.SendCoins(ctx, sender, receiver, amount)
	...
	return &amp;types.MsgTransferResponse{}, nil
}
</code></pre>
<h2 id="mitigations-17"><a class="header" href="#mitigations-17">Mitigations</a></h2>
<ul>
<li>Implement the error handling process instead of missing it</li>
</ul>
<h2 id="external-examples-11"><a class="header" href="#external-examples-11">External examples</a></h2>
<ul>
<li><a href="https://github.com/ignite/cli/issues/2828">ignite's tutorials</a>. </li>
<li><a href="https://github.com/fadeev/loan/blob/master/x/loan/keeper/msg_server_approve_loan.go">Fadeev's Loan Project</a></li>
<li><a href="https://github.com/JackalLabs/canine-chain/issues/8">JackalLabs</a>.</li>
<li><a href="https://github.com/OllO-Station/ollo/issues/20">OllO</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="not-so-smart-contracts-3"><a class="header" href="#not-so-smart-contracts-3">(Not So) Smart Contracts</a></h1>
<p>This repository contains examples of common Solana smart contract vulnerabilities, including code from real smart contracts. Use Not So Smart Contracts to learn about Solana vulnerabilities, as a reference when performing security reviews, and as a benchmark for security and analysis tools.</p>
<h2 id="features-3"><a class="header" href="#features-3">Features</a></h2>
<p>Each <em>Not So Smart Contract</em> includes a standard set of information:</p>
<ul>
<li>Description of the vulnerability type</li>
<li>Attack scenarios to exploit the vulnerability</li>
<li>Recommendations to eliminate or mitigate the vulnerability</li>
<li>Real-world contracts that exhibit the flaw</li>
<li>References to third-party resources with more information</li>
</ul>
<h2 id="vulnerabilities-3"><a class="header" href="#vulnerabilities-3">Vulnerabilities</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Not So Smart Contract</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="not-so-smart-contracts/solana/arbitrary_cpi">Arbitrary CPI</a></td><td>Arbitrary program account passed in upon invocation</td></tr>
<tr><td><a href="not-so-smart-contracts/solana/improper_pda_validation">Improper PDA Validation</a></td><td>PDAs are vulnerable to being spoofed via bump seeds</td></tr>
<tr><td><a href="not-so-smart-contracts/solana/ownership_check">Ownership Check</a></td><td>Broken access control due to missing ownership validation</td></tr>
<tr><td><a href="not-so-smart-contracts/solana/signer_check">Signer Check</a></td><td>Broken access control due to missing signer validation</td></tr>
<tr><td><a href="not-so-smart-contracts/solana/sysvar_account_check">Sysvar Account Check</a></td><td>Sysvar accounts are vulnerable to being spoofed</td></tr>
</tbody></table>
</div>
<h2 id="credits-3"><a class="header" href="#credits-3">Credits</a></h2>
<p>These examples are developed and maintained by <a href="https://www.trailofbits.com/">Trail of Bits</a>.</p>
<p>If you have questions, problems, or just want to learn more, then join the #solana channel on the <a href="https://empireslacking.herokuapp.com/">Empire Hacking Slack</a> or <a href="https://www.trailofbits.com/contact/">contact us</a> directly.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="arbitrary-cpi"><a class="header" href="#arbitrary-cpi">Arbitrary CPI</a></h1>
<p>Solana allows programs to call one another through cross-program invocation (CPI). This can be done via <code>invoke</code>, which is responsible for routing the passed in instruction to the program. Whenever an external contract is invoked via CPI, the program must check and verify the program ID. If the program ID isn't verified, then the contract can call an attacker-controlled program instead of the intended one.</p>
<p>View ToB's lint implementation for the arbitrary CPI issue <a href="https://github.com/crytic/solana-lints/tree/master/lints/arbitrary_cpi">here</a>.</p>
<h2 id="exploit-scenario"><a class="header" href="#exploit-scenario">Exploit Scenario</a></h2>
<p>Consider the following <code>withdraw</code> function. Tokens are able to be withdrawn from the pool to a user account. The program invoked here is user-controlled and there's no check that the program passed in is the intended <code>token_program</code>. This allows a malicious user to pass in their own program with functionality to their discretion - such as draining the pool of the inputted <code>amount</code> tokens.</p>
<h3 id="example-contract"><a class="header" href="#example-contract">Example Contract</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>   pub fn withdraw(accounts: &amp;[AccountInfo], amount: u64) -&gt; ProgramResult {
        let account_info_iter = &amp;mut accounts.iter();
        let token_program = next_account_info(account_info_iter)?;
        let pool = next_account_info(account_info_iter)?;
        let pool_auth = next_account_info(account_info_iter)?;
        let destination = next_account_info(account_info_iter)?;
        invoke(
            &amp;spl_token::instruction::transfer(
                &amp;token_program.key,
                &amp;pool.key,
                &amp;destination.key,
                &amp;pool_auth.key,
                &amp;[],
                amount,
            )?,
            &amp;[
                &amp;pool.clone(),
                &amp;destination.clone(),
                &amp;pool_auth.clone(),
            ],
        )
    }
<span class="boring">}</span></code></pre></pre>
<p><em>Inspired by <a href="https://github.com/coral-xyz/sealevel-attacks/">Sealevel</a></em></p>
<h2 id="mitigation"><a class="header" href="#mitigation">Mitigation</a></h2>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>        if INPUTTED_PROGRAM.key != &amp;INTENDED_PROGRAM::id() {
            return Err(ProgramError::InvalidProgramId);
        }
<span class="boring">}</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="improper-pda-bump-seed-validation"><a class="header" href="#improper-pda-bump-seed-validation">Improper PDA bump seed validation</a></h1>
<p>PDAs (Program Derived Addresses) are, by definition, <a href="https://docs.solana.com/terminology#program-derived-account-pda">program-controlled</a> accounts and therefore can be used to sign without the need to provide a private key. PDAs are generated through a set of seeds and a program id, which are then collectively hashed to verify that the point doesn't lie on the ed25519 curve (the curve used by Solana to sign transactions).</p>
<p>Values on this elliptic curve have a corresponding private key, which wouldn't make it a PDA. In the case a point lying on the elliptic curve is found, our 32-byte address is modified through the addition of a bump to &quot;bump&quot; it off the curve. A bump, represented by a singular byte iterating through 255 to 0, is added onto our input until a point that doesn’t lie on the elliptic curve is generated, meaning that we’ve found an address without an associated private key.</p>
<p>The issue arises with seeds being able to have multiple bumps, thus allowing varying PDAs that are valid from the same seeds. An attacker can create a PDA with the correct program ID but with a different bump. Without any explicit check against the bump seed itself, the program leaves itself vulnerable to the attacker tricking the program into thinking they’re using the expected PDA when in fact they're interacting with an illegitimate account.</p>
<p>View ToB's lint implementation for the bump seed canonicalization issue <a href="https://github.com/crytic/solana-lints/tree/master/lints/bump_seed_canonicalization">here</a>.</p>
<h2 id="exploit-scenario-1"><a class="header" href="#exploit-scenario-1">Exploit Scenario</a></h2>
<p>In Solana, the <code>create_program_address</code> function creates a 32-byte address based off the set of seeds and program address. On its own, the point may lie on the ed25519 curve. Consider the following without any other validation being referenced within a sensitive function, such as one that handles transfers. That PDA could be spoofed by a passed in user-controlled PDA.</p>
<h3 id="example-contract-1"><a class="header" href="#example-contract-1">Example Contract</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let program_address = Pubkey::create_program_address(&amp;[key.to_le_bytes().as_ref(), &amp;[reserve_bump]], program_id)?;

...
<span class="boring">}</span></code></pre></pre>
<h2 id="mitigation-1"><a class="header" href="#mitigation-1">Mitigation</a></h2>
<p>The <code>find_program_address</code> function finds the largest bump seeds for which there exists a corresponding PDA (i.e., a point not on the ed25519 curve), and returns both the address and the bump seed. The function panics in the case that no PDA address can be found.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>        let (address, _system_bump) = Pubkey::find_program_address(&amp;[key.to_le_bytes().as_ref()], program_id);

        if program_address != &amp;account_data.key() {
            return Err(ProgramError::InvalidAddress);
        }
<span class="boring">}</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="missing-ownership-check"><a class="header" href="#missing-ownership-check">Missing Ownership Check</a></h1>
<p>Accounts in Solana include metadata of an owner. These owners are identified by their own program ID. Without sufficient checks that the expected program ID matches that of the passed in account, an attacker can fabricate an account with spoofed data to pass any other preconditions.</p>
<p>This malicious account will inherently have a different program ID as owner, but considering there’s no check that the program ID is the same, as long as the other preconditions are passed, the attacker can trick the program into thinking their malicious account is the expected account.</p>
<h2 id="exploit-scenario-2"><a class="header" href="#exploit-scenario-2">Exploit Scenario</a></h2>
<p>The following contract allows funds to be dispersed from an escrow account vault, provided the escrow account's state is <code>Complete</code>. Unfortunately, there is no check that the <code>State</code> account is owned by the program.
Therefore, a malicious actor can pass in their own fabricated <code>State</code> account with spoofed data, allowing the attacker to send the vault's funds to themselves.</p>
<h3 id="example-contract-2"><a class="header" href="#example-contract-2">Example Contract</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn pay_escrow(_program_id: &amp;Pubkey, accounts: &amp;[AccountInfo], _instruction_data: &amp;[u8]) -&gt; ProgramResult {
    let account_info_iter = &amp;mut accounts.iter();
    let state_info = next_account_info(account_info_iter)?;
    let escrow_vault_info = next_account_info(account_info_iter)?;
    let escrow_receiver_info = next_account_info(account_info_iter)?;

    let state = State::deserialize(&amp;mut &amp;**state_info.data.borrow())?;

    if state.escrow_state == EscrowState::Complete {
        **escrow_vault_info.try_borrow_mut_lamports()? -= state.amount;
        **escrow_receiver_info.try_borrow_mut_lamports()? += state.amount;
    }

    Ok(())
}
<span class="boring">}</span></code></pre></pre>
<p><em>Inspired by <a href="https://github.com/solana-labs/solana-program-library/tree/master/token-lending/program">SPL Lending Program</a></em></p>
<h2 id="mitigation-2"><a class="header" href="#mitigation-2">Mitigation</a></h2>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>  	if EXPECTED_ACCOUNT.owner != program_id {
    	    return Err(ProgramError::IncorrectProgramId);
	}
<span class="boring">}</span></code></pre></pre>
<p>For further reading on different forms of account verification in Solana and implementation refer to the <a href="https://solanacookbook.com/references/programs.html#how-to-verify-accounts">Solana Cookbook</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="missing-signer-check"><a class="header" href="#missing-signer-check">Missing Signer Check</a></h1>
<p>In Solana, each public key has an associated private key that can be used to generate signatures. A <a href="https://docs.solana.com/developing/programming-model/transactions">transaction</a> lists each account public key whose private key was used to generate a signature for the transaction. These signatures are verified using the inputted public keys prior to transaction execution.</p>
<p>In case certain permissions are required to perform a sensitive function of the contract, a missing signer check becomes an issue. Without this check, an attacker would be able to call the respective access controlled functions permissionlessly.</p>
<h2 id="exploit-scenario-3"><a class="header" href="#exploit-scenario-3">Exploit Scenario</a></h2>
<p>The following contract sets an escrow account's state to <code>Complete</code>. Unfortunately, the contract does not check whether the <code>State</code> account's <code>authority</code> has signed the transaction.
Therefore, a malicious actor can set the state to <code>Complete</code>, without needing access to the <code>authority</code>’s private key.</p>
<h3 id="example-contract-3"><a class="header" href="#example-contract-3">Example Contract</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn complete_escrow(_program_id: &amp;Pubkey, accounts: &amp;[AccountInfo], _instruction_data: &amp;[u8]) -&gt; ProgramResult {
    let account_info_iter = &amp;mut accounts.iter();
    let state_info = next_account_info(account_info_iter)?;
    let authority = next_account_info(account_info_iter)?;

    let mut state = State::deserialize(&amp;mut &amp;**state_info.data.borrow())?;
    
    if state.authority != *authority.key {
        return Err(ProgramError::IncorrectAuthority);
    }
    
    state.escrow_state = EscrowState::Complete;
    state.serialize(&amp;mut &amp;mut **state_info.data.borrow_mut())?;
    
    Ok(())
    
}
<span class="boring">}</span></code></pre></pre>
<p><em>Inspired by <a href="https://github.com/solana-labs/solana-program-library/tree/master/token-lending/program">SPL Lending Program</a></em></p>
<h2 id="mitigation-3"><a class="header" href="#mitigation-3">Mitigation</a></h2>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>  	if !EXPECTED_ACCOUNT.is_signer {
    	return Err(ProgramError::MissingRequiredSignature);
	}
<span class="boring">}</span></code></pre></pre>
<p>For further reading on different forms of account verification in Solana and implementation refer to the <a href="https://solanacookbook.com/references/programs.html#how-to-verify-accounts">Solana Cookbook</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="missing-sysvar-account-check"><a class="header" href="#missing-sysvar-account-check">Missing Sysvar Account Check</a></h1>
<p>The sysvar (system account) account is often used while validating access control for restricted functions by confirming that the inputted sysvar account by the user matches up with the expected sysvar account. Without this check in place, any user is capable of passing in their own spoofed sysvar account and in turn bypassing any further authentication associated with it, causing potentially disastrous effects.</p>
<h2 id="exploit-scenario-4"><a class="header" href="#exploit-scenario-4">Exploit Scenario</a></h2>
<p>secp256k1 is an elliptic curve used by a number of blockchains for signatures. Validating signatures is crucial as by bypassing signature checks, an attacker can gain access to restricted functions that could lead to drainage of funds.</p>
<p>Here, <code>load_current_index</code> and <code>load_instruction_at</code> are functions that don't verify that the inputted sysvar account is authorized, therefore allowing serialized maliciously fabricated data to sucessfully spoof as an authorized secp256k1 signature.</p>
<h3 id="example-contract-4"><a class="header" href="#example-contract-4">Example Contract</a></h3>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn verify_signatures(account_info: &amp;AccountInfo) -&gt; ProgramResult {
    let index = solana_program::sysvar::instructions::load_current_index(
        &amp;account_info.try_borrow_mut_data()?,
    );

    let secp_instruction = sysvar::instructions::load_instruction_at(
        (index - 1) as usize,
        &amp;account_info.try_borrow_mut_data()?,
    );
    if secp_instruction.program_id != secp256k1_program::id() {
        return Err(InvalidSecpInstruction.into());
    }
    ...
}
<span class="boring">}</span></code></pre></pre>
<p>Refer to <a href="https://github.com/crytic/building-secure-contracts/tree/master/not-so-smart-contracts/solana/sysvar_account_check#Mitigation">Mitigation</a> to understand what's wrong with these functions and how sysvar account checks were added.</p>
<h2 id="mitigation-4"><a class="header" href="#mitigation-4">Mitigation</a></h2>
<ul>
<li>Solana libraries should be running on version 1.8.1 and up</li>
<li>Use <code>load_instruction_at_checked</code> and <code>load_current_index_checked</code></li>
</ul>
<p>Utilizing the latest Solana version and referencing checked functions, especially on sensitive parts of a contract is crucial even if potential attack vectors have been fixed post-audit.
Leaving the system exposed to any point of failure compromises the entire system's integrity, especially while the contracts are being constantly updated.</p>
<p>Here is the code showing the sysvar account checks added between unchecked and checked functions:</p>
<ul>
<li><a href="https://docs.rs/solana-program/1.13.5/src/solana_program/sysvar/instructions.rs.html#186-188">load_instruction_at</a> vs <a href="https://docs.rs/solana-program/1.13.5/src/solana_program/sysvar/instructions.rs.html#192-205">load_instruction_at_checked</a></li>
<li><a href="https://docs.rs/solana-program/1.13.5/src/solana_program/sysvar/instructions.rs.html#107-112">load_current_index</a> vs <a href="https://docs.rs/solana-program/1.13.5/src/solana_program/sysvar/instructions.rs.html#116-128">load_current_index_checked</a></li>
</ul>
<hr />
<h2 id="example-wormhole-exploit-february-2022"><a class="header" href="#example-wormhole-exploit-february-2022">Example: Wormhole Exploit (February 2022)</a></h2>
<h3 id="funds-lost-326000000-usd"><a class="header" href="#funds-lost-326000000-usd">Funds lost: ~326,000,000 USD</a></h3>
<p><strong>Note: The following analysis is condensed down to be present this attack vector as clearly as possible, and certain details might’ve been left out for the sake of simplification</strong></p>
<p>The Wormhole hack serves to be one of the most memorable exploits in terms of impact DeFi has ever seen.</p>
<p>This exploit also happens to incorporate a missing sysvar account check that allowed the attacker to:</p>
<ol>
<li>Spoof Guardian signatures as valid</li>
<li>Use them to create a Validator Action Approval (VAA)</li>
<li>Mint 120,000 ETH via calling complete_wrapped function</li>
</ol>
<p>(These actions are all chronologically dependent on one another based on permissions and conditions - this analysis will only dive into “Step 1”)</p>
<p>The SignatureSet was able to be faked because the <code>verify_signatures</code> function failed to appropriately <a href="https://github.com/wormhole-foundation/wormhole/blob/ca509f2d73c0780e8516ffdfcaf90b38ab6db203/solana/bridge/program/src/api/verify_signature.rs#L101">verify</a> the sysvar account passed in:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let secp_ix = solana_program::sysvar::instructions::load_instruction_at(
    secp_ix_index as usize,
    &amp;accs.instruction_acc.try_borrow_mut_data()?,
)
<span class="boring">}</span></code></pre></pre>
<p><code>load_instruction_at</code> doesn't verify that the inputted data came from the authorized sysvar account.</p>
<p>The fix for this was to upgrade the Solana version and get rid of these unsafe deprecated functions (see <a href="https://github.com/crytic/building-secure-contracts/tree/master/not-so-smart-contracts/solana/sysvar_account_check#Mitigation">Mitigation</a>). Wormhole had <a href="https://github.com/wormhole-foundation/wormhole/commit/7edbbd3677ee6ca681be8722a607bc576a3912c8#diff-0d27d8889edd071b86d3f3299276882d97613ad6ab3b0b6412ae4ebf3ccd6370R92-R103">caught</a>  this issue but didn't update their deployed contracts in time before the exploiter had already managed to drain funds.</p>
<h2 id="resources"><a class="header" href="#resources">Resources:</a></h2>
<p><a href="https://twitter.com/samczsun/status/1489044939732406275">samczsun's Wormhole exploit breakdown thread</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="not-so-smart-pallets"><a class="header" href="#not-so-smart-pallets">(Not So) Smart Pallets</a></h1>
<p>This repository contains examples of common Substrate pallet vulnerabilities. Use Not So Smart Pallets to learn about Substrate vulnerabilities, as a reference when performing security reviews, and as a benchmark for security and analysis tools.</p>
<h2 id="features-4"><a class="header" href="#features-4">Features</a></h2>
<p>Each <em>Not So Smart Pallet</em> includes a standard set of information:</p>
<ul>
<li>Description of the vulnerability type</li>
<li>Attack scenarios to exploit the vulnerability</li>
<li>Recommendations to eliminate or mitigate the vulnerability</li>
<li>A mock pallet that exhibits the flaw</li>
<li>References to third-party resources with more information</li>
</ul>
<h2 id="vulnerabilities-4"><a class="header" href="#vulnerabilities-4">Vulnerabilities</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Not So Smart Pallet</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="not-so-smart-contracts/substrate/arithmetic_overflow">Arithmetic overflow</a></td><td>Integer overflow due to incorrect use of arithmetic operators</td></tr>
<tr><td><a href="not-so-smart-contracts/substrate/dont_panic">Don't panic!</a></td><td>System panics create a potential DoS attack vector</td></tr>
<tr><td><a href="not-so-smart-contracts/substrate/weights_and_fees">Weights and fees</a></td><td>Incorrect weight calculations can create a potential DoS attack vector</td></tr>
<tr><td><a href="not-so-smart-contracts/substrate/verify_first">Verify first</a></td><td>Verify first, write last</td></tr>
<tr><td><a href="not-so-smart-contracts/substrate/validate_unsigned">Unsigned transaction validation</a></td><td>Insufficient validation of unsigned transactions</td></tr>
<tr><td><a href="not-so-smart-contracts/substrate/randomness">Bad randomness</a></td><td>Unsafe sources of randomness in Substrate</td></tr>
<tr><td><a href="not-so-smart-contracts/substrate/origins">Bad origin</a></td><td>Incorrect use of call origin can lead to bypassing access controls</td></tr>
</tbody></table>
</div>
<h2 id="credits-4"><a class="header" href="#credits-4">Credits</a></h2>
<p>These examples are developed and maintained by <a href="https://www.trailofbits.com/">Trail of Bits</a>.</p>
<p>If you have questions, problems, or just want to learn more, then join the #ethereum channel on the <a href="https://empireslacking.herokuapp.com/">Empire Hacking Slack</a> or <a href="https://www.trailofbits.com/contact/">contact us</a> directly.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="arithmetic-overflow-1"><a class="header" href="#arithmetic-overflow-1">Arithmetic overflow</a></h1>
<p>Arithmetic overflow in Substrate occurs when arithmetic operations are performed using primitive operations instead of specialized functions that check for overflow. When a Substrate node is compiled in <code>debug</code> mode, integer overflows will cause the program to panic. However, when the node is compiled in <code>release</code> mode (e.g. <code>cargo build --release</code>), Substrate will perform two's complement wrapping. A production-ready node will be compiled in <code>release</code> mode, which makes it vulnerable to arithmetic overflow.</p>
<h1 id="example-18"><a class="header" href="#example-18">Example</a></h1>
<p>In the <a href="not-so-smart-contracts/substrate/arithmetic_overflow/./pallet-overflow.rs"><code>pallet-overflow</code></a> pallet, notice that the <code>transfer</code> function sets <code>update_sender</code> and <code>update_to</code> using primitive arithmetic operations.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>   /// Allow minting account to transfer a given balance to another account.
   ///
   /// Parameters:
   /// - `to`: The account to receive the transfer.
   /// - `amount`: The amount of balance to transfer.
   ///
   /// Emits `Transferred` event when successful.
   #[pallet::weight(10_000)]
   pub fn transfer(
       origin: OriginFor&lt;T&gt;,
       to: T::AccountId,
       amount: u64,
   ) -&gt; DispatchResultWithPostInfo {
       let sender = ensure_signed(origin)?;
       let sender_balance = Self::get_balance(&amp;sender);
       let receiver_balance = Self::get_balance(&amp;to);

       // Calculate new balances.
       let update_sender = sender_balance - amount;
       let update_to = receiver_balance + amount;
       [...]
   }
<span class="boring">}</span></code></pre></pre>
<p>The sender of the extrinsic can exploit this vulnerability by causing <code>update_sender</code> to underflow, which artificially inflates their balance. </p>
<p><strong>Note</strong>: Aside from the stronger mitigations mentioned below, a check to make sure that <code>sender</code> has at least <code>amount</code> balance would have also prevented an underflow.</p>
<h1 id="mitigations-18"><a class="header" href="#mitigations-18">Mitigations</a></h1>
<ul>
<li>Use <code>checked</code> or <code>saturating</code> functions for arithmetic operations.
<ul>
<li><a href="https://docs.rs/num/0.4.0/num/traits/trait.CheckedAdd.html"><code>CheckedAdd</code> trait</a></li>
<li><a href="https://docs.rs/num/0.4.0/num/traits/trait.Saturating.html"><code>Saturating</code> trait</a></li>
</ul>
</li>
</ul>
<h1 id="references"><a class="header" href="#references">References</a></h1>
<ul>
<li>https://doc.rust-lang.org/book/ch03-02-data-types.html#integer-overflow</li>
<li>https://docs.substrate.io/reference/how-to-guides/basics/use-helper-functions/</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dont-panic"><a class="header" href="#dont-panic">Don't Panic!</a></h1>
<p>Panics occur when the node enters a state that it cannot handle and stops the program / process instead of trying to proceed. Panics can occur for a large variety of reasons such as out-of-bounds array access, incorrect data validation, type conversions, and much more. A well-designed Substrate node must NEVER panic! If a node panics, it opens up the possibility for a denial-of-service (DoS) attack.</p>
<h1 id="example-19"><a class="header" href="#example-19">Example</a></h1>
<p>In the <a href="not-so-smart-contracts/substrate/dont_panic/./pallet-dont-panic.rs"><code>pallet-dont-panic</code></a> pallet, the <code>find_important_value</code> dispatchable checks to see if <code>useful_amounts[0]</code> is greater than <code>1_000</code>. If so, it sets the <code>ImportantVal</code> <code>StorageValue</code> to the value held in <code>useful_amounts[0]</code>. </p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    /// Do some work
    ///
    /// Parameters:
    /// - `useful_amounts`: A vector of u64 values in which there is a important value.
    ///
    /// Emits `FoundVal` event when successful.
    #[pallet::weight(10_000)]
    pub fn find_important_value(
        origin: OriginFor&lt;T&gt;,
        useful_amounts: Vec&lt;u64&gt;,
    ) -&gt; DispatchResultWithPostInfo {
        let sender = ensure_signed(origin)?;

        ensure!(useful_amounts[0] &gt; 1_000, &lt;Error&lt;T&gt;&gt;::NoImportantValueFound);
        
        // Found the important value
        ImportantValue::&lt;T&gt;::put(&amp;useful_amounts[0]);
        [...]
    }
<span class="boring">}</span></code></pre></pre>
<p>However, notice that there is no check before the array indexing to see whether the length of <code>useful_amounts</code> is greater than zero. Thus, if <code>useful_amounts</code> is empty, the indexing will cause an array out-of-bounds error which will make the node panic. Since the <code>find_important_value</code> function is callable by anyone, an attacker can set <code>useful_amounts</code> to an empty array and spam the network with malicious transactions to launch a DoS attack.</p>
<h1 id="mitigations-19"><a class="header" href="#mitigations-19">Mitigations</a></h1>
<ul>
<li>Write non-throwing Rust code (e.g. prefer returning <a href="https://paritytech.github.io/substrate/master/frame_support/dispatch/result/enum.Result.html"><code>Result</code></a> types, use <a href="https://paritytech.github.io/substrate/master/frame_support/macro.ensure.html"><code>ensure!</code></a>, etc.).</li>
<li>Proper data validation of all input parameters is crucial to ensure that an unexpected panic does not occur.</li>
<li>A thorough suite of unit tests should be implemented.</li>
<li>Fuzz testing (e.g. using <a href="https://github.com/trailofbits/test-fuzz"><code>test-fuzz</code></a>) can aid in exploring more of the input space.</li>
</ul>
<h1 id="references-1"><a class="header" href="#references-1">References</a></h1>
<ul>
<li>https://docs.substrate.io/main-docs/build/events-errors/#errors</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="weights-and-fees"><a class="header" href="#weights-and-fees">Weights and Fees</a></h1>
<p>Weights and transaction fees are the two main ways to regulate the consumption of blockchain resources. The overuse of blockchain resources can allow a malicious actor to spam the network to cause a denial-of-service (DoS). Weights are used to manage the time it takes to validate the block. The larger the weight, the more &quot;resources&quot; / time the computation takes. Transaction fees provide an economic incentive to limit the number of resources used to perform operations; the fee for a given transaction is a function of the weight required by the transaction. </p>
<p>Weights can be fixed or a custom &quot;weight annotation / function&quot; can be implemented. A weight function can calculate the weight, for example, based on the number of database read / writes and the size of the input paramaters (e.g. a long <code>Vec&lt;&gt;</code>). To optimize the weight such that users do not pay too little or too much for a transaction, benchmarking can be used to empirically determine the correct weight in worst case scenarios.</p>
<p>Specifying the correct weight function and benchmarking it is crucial to protect the Substrate node from denial-of-service (DoS) attacks. Since fees are a function of weight, a bad weight function implies incorrect fees. For example, if some function performs heavy computation (which takes a lot of time) but specifies a very small weight, it is cheap to call that function. In this way an attacker can perform a low-cost attack while still stealing a large amount of block execution time. This will prevent regular transactions from being fit into those blocks. </p>
<h1 id="example-20"><a class="header" href="#example-20">Example</a></h1>
<p>In the <a href="not-so-smart-contracts/substrate/weights_and_fees/./pallet-bad-weights.rs"><code>pallet-bad-weights</code></a> pallet, a custom weight function, <code>MyWeightFunction</code>, is used to calculate the weight for a call to <code>do_work</code>. The weight required for a call to <code>do_work</code> is <code>10_000_000</code> times the length of the <code>useful_amounts</code> vector. </p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl WeighData&lt;(&amp;Vec&lt;u64&gt;,)&gt; for MyWeightFunction {
    fn weigh_data(&amp;self, (amounts,): (&amp;Vec&lt;u64&gt;,)) -&gt; Weight {
        self.0.saturating_mul(amounts.len() as u64).into()
    }
}
<span class="boring">}</span></code></pre></pre>
<p>However, if the length of the <code>useful_amounts</code> vector is zero, the weight to call <code>do_work</code> would be zero. A weight of zero implies that calling this function is financially cheap. This opens the opportunity for an attacker to call <code>do_work</code> a large number of times to saturate the network with malicious transactions without having to pay a large fee and could cause a DoS attack.</p>
<p>One potential fix for this is to set a fixed weight if the length of <code>useful_amounts</code> is zero.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl WeighData&lt;(&amp;Vec&lt;u64&gt;,)&gt; for MyWeightFunction {
    fn weigh_data(&amp;self, (amounts,): (&amp;Vec&lt;u64&gt;,)) -&gt; Weight {
        // The weight function is `y = mx + b` where `m` and `b` are both `self.0` (the static fee) and `x` is the length of the `amounts` array.
        // If `amounts.len() == 0` then the weight is simply the static fee (i.e. `y = b`)
        self.0 + self.0.saturating_mul(amounts.len() as u64).into()
    }
}
<span class="boring">}</span></code></pre></pre>
<p>In the example above, if the length of <code>amounts</code> (i.e. <code>useful_amounts</code>) is zero, then the function will return <code>self.0</code> (i.e. <code>10_000_000</code>). </p>
<p>On the other hand, if an attacker sends a <code>useful_amounts</code> vector that is incredibly large, the returned <code>Weight</code> can become large enough such that the dispatchable takes up a large amount block execution time and prevents other transactions from being fit into the block. A fix for this would be to bound the maximum allowable length for <code>useful_amounts</code>. </p>
<p><strong>Note</strong>: Custom <em>fee</em> functions can also be created. These functions should also be carefully evaluated and tested to ensure that the risk of DoS attacks is mitigated.</p>
<h1 id="mitigations-20"><a class="header" href="#mitigations-20">Mitigations</a></h1>
<ul>
<li>Use <a href="https://docs.substrate.io/main-docs/test/benchmark/">benchmarking</a> to empirically test the computational resources utilized by various dispatchable functions. Additionally, use benchmarking to define a lower and upper weight bound for each dispatchable. </li>
<li>Create bounds for input arguments to prevent a transaction from taking up too many computational resources. For example, if a <code>Vec&lt;&gt;</code> is being taken as an input argument to a function, prevent the length of the <code>Vec&lt;&gt;</code> from being too large.</li>
<li>Be wary of fixed weight dispatchables (e.g. <code>#[pallet::weight(1_000_000)]</code>). A weight that is completely agnostic to database read / writes or input parameters may open up avenues for DoS attacks. </li>
</ul>
<h1 id="references-2"><a class="header" href="#references-2">References</a></h1>
<ul>
<li>https://docs.substrate.io/main-docs/build/tx-weights-fees/</li>
<li>https://docs.substrate.io/reference/how-to-guides/weights/add-benchmarks/</li>
<li>https://docs.substrate.io/reference/how-to-guides/weights/use-custom-weights/</li>
<li>https://docs.substrate.io/reference/how-to-guides/weights/use-conditional-weights/</li>
<li>https://www.shawntabrizi.com/substrate/substrate-weight-and-fees/</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="verify-first-write-last"><a class="header" href="#verify-first-write-last">Verify First, Write Last</a></h1>
<p><strong>NOTE</strong>: As of <a href="https://github.com/substrate-developer-hub/substrate-docs/issues/1215">Polkadot v0.9.25</a>, the <strong>Verify First, Write Last</strong> practice is no longer required. However, since older versions are still vulnerable and because it is still best practice, it is worth discussing the &quot;Verify First, Write Last&quot; idiom.</p>
<p>Substrate does not cache state prior to extrinsic dispatch. Instead, state changes are made as they are invoked. This is in contrast to a transaction in Ethereum where, if the transaction reverts, no state changes will persist. In the case of Substrate, if a state change is made and then the dispatch throws a <code>DispatchError</code>, the original state change will persist. This unique behavior has led to the &quot;Verify First, Write Last&quot; practice.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>{
  // all checks and throwing code go here

  // ** no throwing code below this line **

  // all event emissions &amp; storage writes go here
}
<span class="boring">}</span></code></pre></pre>
<h1 id="example-21"><a class="header" href="#example-21">Example</a></h1>
<p>In the <a href="not-so-smart-contracts/substrate/verify_first/./pallet-verify-first.rs"><code>pallet-verify-first</code></a> pallet, the <code>init</code> dispatchable is used to set up the <code>TotalSupply</code> of the token and transfer them to the <code>sender</code>. <code>init</code> should be only called once. Thus, the <code>Init</code> boolean is set to <code>true</code> when it is called initially. If <code>init</code> is called more than once, the transaction will throw an error because <code>Init</code> is already <code>true</code>.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Initialize the token
/// Transfers the total_supply amount to the caller
/// If init() has already been called, throw AlreadyInitialized error
#[pallet::weight(10_000)]
pub fn init(
    origin: OriginFor&lt;T&gt;,
    supply: u64
) -&gt; DispatchResultWithPostInfo {
    let sender = ensure_signed(origin)?;
    
    if supply &gt; 0 {
        &lt;TotalSupply&lt;T&gt;&gt;::put(&amp;supply);
    }
    // Set sender's balance to total_supply()
    &lt;BalanceToAccount&lt;T&gt;&gt;::insert(&amp;sender, supply);

    // Revert above changes if init() has already been called
    ensure!(!Self::is_init(), &lt;Error&lt;T&gt;&gt;::AlreadyInitialized);

    // Set Init StorageValue to `true`
    Init::&lt;T&gt;::put(true);
    
    // Emit event
    Self::deposit_event(Event::Initialized(sender));

    Ok(().into())
}
<span class="boring">}</span></code></pre></pre>
<p>However, notice that the setting of <code>TotalSupply</code> and the transfer of funds happens before the check on <code>Init</code>. This violates the &quot;Verify First, Write Last&quot; practice. In an older version of Substrate, this would allow a malicious <code>sender</code> to call <code>init</code> multiple times and change the value of <code>TotalSupply</code> and their balance of the token.</p>
<h1 id="mitigations-21"><a class="header" href="#mitigations-21">Mitigations</a></h1>
<ul>
<li>Follow the &quot;Verify First, Write Last&quot; practice by doing all the necessary data validation before performing state changes and emitting events.</li>
</ul>
<h1 id="references-3"><a class="header" href="#references-3">References</a></h1>
<ul>
<li>https://docs.substrate.io/main-docs/build/runtime-storage/#best-practices</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="unsigned-transaction-validation"><a class="header" href="#unsigned-transaction-validation">Unsigned Transaction Validation</a></h1>
<p>There are three types of transactions allowed in a Substrate runtime: signed, unsigned, and inherent. An unsigned transaction does not require a signature and does not include information about who sent the transaction. This is naturally problematic because there is no by-default deterrent to spam or replay attacks. Because of this, Substrate allows users to create custom functions to validate unsigned transaction. However, incorrect or improper validation of an unsigned transaction can allow <em>anyone</em> to perform potentially malicious actions. Usually, unsigned transactions are allowed only for select parties (e.g., off-chain workers (OCW)). But, if improper data validation of an unsigned transaction allows a malicious actor to spoof data as if it came from an OCW, this can lead to unexpected behavior. Additionally, improper validation opens up the possibility to replay attacks where the same transaction can be sent to the transaction pool again and again to perform some malicious action repeatedly.</p>
<p>The validation of an unsigned transaction must be provided by the pallet that chooses to accept them. To allow unsigned transactions, a pallet must implement the <a href="https://paritytech.github.io/substrate/master/frame_support/attr.pallet.html#validate-unsigned-palletvalidate_unsigned-optional"><code>frame_support::unsigned::ValidateUnsigned</code></a> trait. The <code>validate_unsigned</code> function, which must be implemented as part of the <code>ValidateUnsigned</code> trait, will provide the logic necessary to ensure that the transaction is valid. An off chain worker (OCW) can be implemented directly in a pallet using the <code>offchain_worker</code> <a href="https://paritytech.github.io/substrate/master/frame_support/attr.pallet.html#hooks-pallethooks-optional">hook</a>. The OCW can send an unsigned transaction by calling <a href="https://paritytech.github.io/substrate/master/frame_system/offchain/struct.SubmitTransaction.html"><code>SubmitTransaction::submit_unsigned_transaction</code></a>. Upon submission, the <code>validate_unsigned</code> function will ensure that the transaction is valid and then pass the transaction on towards towards the final dispatchable function.</p>
<h1 id="example-22"><a class="header" href="#example-22">Example</a></h1>
<p>The <a href="not-so-smart-contracts/substrate/validate_unsigned/./pallet-bad-unsigned.rs"><code>pallet-bad-unsigned</code></a> pallet is an example that showcases improper unsigned transaction validation. The pallet tracks the average, rolling price of some &quot;asset&quot;; this price data is being retrieved by an OCW. The <code>fetch_price</code> function, which is called by the OCW, naively returns 100 as the current price (note that an <a href="https://github.com/paritytech/substrate/blob/e8a7d161f39db70cb27fdad6c6e215cf493ebc3b/frame/examples/offchain-worker/src/lib.rs#L572-L625">HTTP request</a> can be made here for true price data). The <code>validate_unsigned</code> function (see below) simply validates that the <code>Call</code> is being made to <code>submit_price_unsigned</code> and nothing else. </p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// By default unsigned transactions are disallowed, but implementing the validator
/// here we make sure that some particular calls (the ones produced by offchain worker)
/// are being whitelisted and marked as valid.
fn validate_unsigned(_source: TransactionSource, call: &amp;Self::Call) -&gt; TransactionValidity {
    // If `submit_price_unsigned` is being called, the transaction is valid.
    // Otherwise, it is an InvalidTransaction.
    if let Call::submit_price_unsigned { block_number, price: new_price } = call {
        let avg_price = Self::average_price()
        .map(|price| if &amp;price &gt; new_price { price - new_price } else { new_price - price })
        .unwrap_or(0);

        let valid_tx = | provide | {
            ValidTransaction::with_tag_prefix(&quot;ExampleOffchainWorker&quot;)
            .priority(T::UnsignedPriority::get().saturating_add(avg_price as _))
            .and_provides([&amp;provide])
            .longevity(5)
            .propagate(true)
            .build()
        };
        valid_tx(b&quot;submit_price_unsigned&quot;.to_vec())
    } else {
        InvalidTransaction::Call.into()
    }
}
<span class="boring">}</span></code></pre></pre>
<p>However, notice that there is nothing preventing an attacker from sending malicious price data. Both <code>block_number</code> and <code>price</code> can be set to arbitrary values. For <code>block_number</code>, it would be valuable to ensure that it is not a block number in the future; only price data for the current block can be submitted. Additionally, medianization can be used to ensure that the reported price is not severely affected by outliers. Finally, unsigned submissions can be throttled by enforcing a delay after each submission.</p>
<p>Note that the simplest solution would be to sign the offchain submissions so that the runtime can validate that a known OCW is sending the price submission transactions.</p>
<h1 id="mitigations-22"><a class="header" href="#mitigations-22">Mitigations</a></h1>
<ul>
<li>Consider whether unsigned transactions is a requirement for the runtime that is being built. OCWs can also submit signed transactions or transactions with signed payloads.</li>
<li>Ensure that each parameter provided to <code>validate_unsigned</code> is validated to prevent the runtime from entering a state that is vulnerable or undefined.</li>
</ul>
<h1 id="references-4"><a class="header" href="#references-4">References</a></h1>
<ul>
<li>https://docs.substrate.io/main-docs/fundamentals/transaction-types/#unsigned-transactions</li>
<li>https://docs.substrate.io/main-docs/fundamentals/offchain-operations/</li>
<li>https://github.com/paritytech/substrate/blob/polkadot-v0.9.26/frame/examples/offchain-worker/src/lib.rs</li>
<li>https://docs.substrate.io/tutorials/work-with-pallets/add-offchain-workers/</li>
<li>https://docs.substrate.io/reference/how-to-guides/offchain-workers/offchain-http-requests/</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bad-randomness"><a class="header" href="#bad-randomness">Bad Randomness</a></h1>
<p>To use randomness in a Substrate pallet, all you need to do is require a source of randomness in the <code>Config</code> trait of a pallet. This source of Randomness must implement the <a href="https://paritytech.github.io/substrate/master/frame_support/traits/trait.Randomness.html"><code>Randomness</code></a> trait. The trait provides two methods for obtaining randomness.</p>
<ol>
<li><code>random_seed</code>: This function takes no arguments and returns back a random value. Calling this value multiple times in a block will result in the same value.</li>
<li><code>random</code>: Takes in a byte-array (a.k.a &quot;context-identifier&quot;) and returns a value that is as independent as possible from other contexts. </li>
</ol>
<p>Substrate provides the <a href="https://docs.rs/pallet-randomness-collective-flip/latest/pallet_randomness_collective_flip/">Randomness Collective Flip Pallet</a> and a Verifiable Random Function implementation in the <a href="https://paritytech.github.io/substrate/master/pallet_babe/index.html">BABE pallet</a>. Developers can also choose to build their own source of randomness.</p>
<p>A bad source of randomness can lead to a variety of exploits such as the theft of funds or undefined system behavior. </p>
<h1 id="example-23"><a class="header" href="#example-23">Example</a></h1>
<p>The <a href="not-so-smart-contracts/substrate/randomness/./pallet-bad-lottery.rs"><code>pallet-bad-lottery</code></a> pallet is a simplified &quot;lottery&quot; system that requires one to guess the next random number. If they guess correctly, they are the winner of the lottery. </p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[pallet::call]
impl&lt;T:Config&gt; Pallet&lt;T&gt; {
/// Guess the random value
/// If you guess correctly, you become the winner
#[pallet::weight(10_000)]
pub fn guess(
    origin: OriginFor&lt;T&gt;,
    guess: T::Hash
) -&gt; DispatchResultWithPostInfo {
    let sender = ensure_signed(origin)?;
    // Random value.
    let nonce = Self::get_and_increment_nonce();
    let (random_value, _) = T::MyRandomness::random(&amp;nonce);
    // Check if guess is correct
    ensure!(guess == random_value, &lt;Error&lt;T&gt;&gt;::IncorrectGuess);
    &lt;Winner&lt;T&gt;&gt;::put(&amp;sender);

    Self::deposit_event(Event::NewWinner(sender));

    Ok(().into())
}
}

impl&lt;T:Config&gt; Pallet&lt;T&gt; {
/// Increment the nonce each time guess() is called
pub fn get_and_increment_nonce() -&gt; Vec&lt;u8&gt; {
    let nonce = Nonce::&lt;T&gt;::get();
    Nonce::&lt;T&gt;::put(nonce.wrapping_add(1));
    nonce.encode()
}
}
<span class="boring">}</span></code></pre></pre>
<p>Note that the quality of randomness provided to the <code>pallet-bad-lottery</code> pallet is related to the randomness source. If the randomness source is the &quot;Randomness Collective Flip Pallet&quot;, this lottery system is insecure. This is because the collective flip pallet implements &quot;low-influence randomness&quot;. This makes it vulnerable to a collusion attack where a small minority of participants can give the same random number contribution making it highly likely to have the seed be this random number (click <a href="https://ethresear.ch/t/rng-exploitability-analysis-assuming-pure-randao-based-main-chain/1825/7">here</a> to learn more). Additionally, as mentioned in the Substrate documentation, &quot;low-influence randomness can be useful when defending against relatively weak adversaries. Using this pallet as a randomness source is advisable primarily in low-security situations like testing.&quot; </p>
<h1 id="mitigations-23"><a class="header" href="#mitigations-23">Mitigations</a></h1>
<ul>
<li>Use the randomness implementation provided by the <a href="https://paritytech.github.io/substrate/master/pallet_babe/index.html">BABE pallet</a>. This pallet provides &quot;production-grade randomness, and is used in Polkadot. <strong>Selecting this randomness source dictates that your blockchain use Babe consensus.</strong>&quot;</li>
<li>Defer from creating a custom source of randomness unless specifically necessary for the runtime being developed.</li>
<li>Do not use <code>random_seed</code> as the method of choice for randomness unless specifically necessary for the runtime being developed.</li>
</ul>
<h1 id="references-5"><a class="header" href="#references-5">References</a></h1>
<ul>
<li>https://docs.substrate.io/main-docs/build/randomness/</li>
<li>https://docs.substrate.io/reference/how-to-guides/pallet-design/incorporate-randomness/</li>
<li>https://ethresear.ch/t/rng-exploitability-analysis-assuming-pure-randao-based-main-chain/1825/7</li>
<li>https://ethresear.ch/t/collective-coin-flipping-csprng/3252/21</li>
<li>https://github.com/paritytech/ink/issues/57#issuecomment-486998848</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="origins"><a class="header" href="#origins">Origins</a></h1>
<p>The origin of a call tells a dispatchable function where the call has come from. Origins are a way to implement access controls in the system. </p>
<p>There are three types of origins that can used in the runtime:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub enum RawOrigin&lt;AccountId&gt; {
	Root,
	Signed(AccountId),
	None,
}
<span class="boring">}</span></code></pre></pre>
<p>Outside of the out-of-box origins, custom origins can also be created that are catered to a specific runtime. The primary use case for custom origins is to configure privileged access to dispatch calls in the runtime, outside of <code>RawOrigin::Root</code>. </p>
<p>Using privileged origins, like <code>RawOrigin::Root</code> or custom origins, can lead to access control violations if not used correctly. It is a common error to use <code>ensure_signed</code> in place of <code>ensure_root</code> which would allow any user to bypass the access control placed by using <code>ensure_root</code>.</p>
<h1 id="example-24"><a class="header" href="#example-24">Example</a></h1>
<p>In the <a href="not-so-smart-contracts/substrate/origins/./pallet-bad-origin.rs"><code>pallet-bad-origin</code></a> pallet, there is a <code>set_important_val</code> function that should be only callable by the <code>ForceOrigin</code> <em>custom</em> origin type. This custom origin allows the pallet to specify that only a specific account can call <code>set_important_val</code>.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[pallet::call]
impl&lt;T:Config&gt; Pallet&lt;T&gt; {
    /// Set the important val
    /// Should be only callable by ForceOrigin
    #[pallet::weight(10_000)]
    pub fn set_important_val(
        origin: OriginFor&lt;T&gt;,
        new_val: u64
    ) -&gt; DispatchResultWithPostInfo {
        let sender = ensure_signed(origin)?;
        // Change to new value
        &lt;ImportantVal&lt;T&gt;&gt;::put(new_val);

        // Emit event
        Self::deposit_event(Event::ImportantValSet(sender, new_val));

        Ok(().into())
    }
}
<span class="boring">}</span></code></pre></pre>
<p>However, the <code>set_important_val</code> is using <code>ensure_signed</code>; this allows any account to set <code>ImportantVal</code>. To allow only the <code>ForceOrigin</code> to call <code>set_important_val</code> the following change can be made:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>T::ForceOrigin::ensure_origin(origin.clone())?;
let sender = ensure_signed(origin)?;
<span class="boring">}</span></code></pre></pre>
<h1 id="mitigations-24"><a class="header" href="#mitigations-24">Mitigations</a></h1>
<ul>
<li>Ensure that the correct access controls are placed on privileged functions.</li>
<li>Develop user documentation on all risks associated with the system, including those associated with privileged users.</li>
<li>A thorough suite of unit tests that validates access controls is crucial.</li>
</ul>
<h1 id="references-6"><a class="header" href="#references-6">References</a></h1>
<ul>
<li>https://docs.substrate.io/main-docs/build/origins/</li>
<li>https://docs.substrate.io/tutorials/work-with-pallets/specify-the-origin-for-a-call/</li>
<li>https://paritytech.github.io/substrate/master/pallet_sudo/index.html#</li>
<li>https://paritytech.github.io/substrate/master/pallet_democracy/index.html</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="program-analysis"><a class="header" href="#program-analysis">Program Analysis</a></h1>
<p>We are going use three distinctive testing and program analysis techniques:</p>
<ul>
<li><strong>Static analysis with <a href="program-analysis/./slither">Slither</a>.</strong> All the paths of the program are approximated and analyzed at the same time, through different program presentations (e.g. control-flow-graph)</li>
<li><strong>Fuzzing with <a href="program-analysis/./echidna">Echidna</a>.</strong> The code is executed with a pseudo-random generation of transactions. The fuzzer will try to find a sequence of transactions to violate a given property.</li>
<li><strong>Symbolic execution with <a href="program-analysis/./manticore">Manticore</a>.</strong> A formal verification technique, which translates each execution path to a mathematical formula, on which on top constraints can be checked.</li>
</ul>
<p>Each technique has advantages and pitfalls, and will be useful in <a href="program-analysis/index.html#determining-security-properties">specific cases</a>:</p>
<div class="table-wrapper"><table><thead><tr><th>Technique</th><th>Tool</th><th>Usage</th><th>Speed</th><th>Bugs missed</th><th>False Alarms</th></tr></thead><tbody>
<tr><td>Static Analysis</td><td>Slither</td><td>CLI &amp; scripts</td><td>seconds</td><td>moderate</td><td>low</td></tr>
<tr><td>Fuzzing</td><td>Echidna</td><td>Solidity properties</td><td>minutes</td><td>low</td><td>none</td></tr>
<tr><td>Symbolic Execution</td><td>Manticore</td><td>Solidity properties &amp; scripts</td><td>hours</td><td>none*</td><td>none</td></tr>
</tbody></table>
</div>
<p>* if all the paths are explored without timeout</p>
<p><strong>Slither</strong> analyzes contracts within seconds, however, static analysis might lead to false alarms and will be less suitable for complex checks (e.g. arithmetic checks). Run Slither via the API for push-button access to built-in detectors or via the API for user-defined checks.</p>
<p><strong>Echidna</strong> needs to run for several minutes and will only produce true positives. Echidna checks user-provided security properties, written in Solidity. It might miss bugs since it is based on random exploration.</p>
<p><strong>Manticore</strong> performs the &quot;heaviest weight&quot; analysis. Like Echidna, Manticore verifies user-provided properties. It will need more time to run, but it can prove the validity of a property and will not report false alarms.</p>
<h3 id="suggested-workflow"><a class="header" href="#suggested-workflow">Suggested workflow</a></h3>
<p>Start with Slither's built-in detectors to ensure that no simple bugs are present now or will be introduced later. Use Slither to check properties related to inheritance, variable dependencies, and structural issues. As the codebase grows, use Echidna to test more complex properties of the state machine. Revisit Slither to develop custom checks for protections unavailable from Solidity, like protecting against a function being overridden. Finally, use Manticore to perform targeted verification of critical security properties, e.g., arithmetic operations.</p>
<ul>
<li>Use Slither's CLI to catch common issues</li>
<li>Use Echidna to test high-level security properties of your contract</li>
<li>Use Slither to write custom static checks</li>
<li>Use Manticore once you want in-depth assurance of critical security properties</li>
</ul>
<p><strong>A note on unit tests</strong>. Unit tests are necessary to build high-quality software. However, these techniques are not the best suited to find security flaws. They are typically used to test positive behaviors of code (i.e. the code works as expected in the normal context), while security flaws tend to reside in edge cases that the developers did not consider. In our study of dozens of smart contract security reviews, <a href="https://blog.trailofbits.com/2019/08/08/246-findings-from-our-smart-contract-audits-an-executive-summary/">unit test coverage had no effect on the number or severity of security flaws</a> we found in our client's code.</p>
<h2 id="determining-security-properties"><a class="header" href="#determining-security-properties">Determining Security Properties</a></h2>
<p>To effectively test and verify your code, you must identify the areas that need attention. As your resources spent on security are limited, scoping the weak or high-value parts of your codebase is important to optimize your effort. Threat modeling can help. Consider reviewing:</p>
<ul>
<li><a href="https://infosec.mozilla.org/guidelines/risk/rapid_risk_assessment.html">Rapid Risk Assessments</a> (our preferred approach when time is short)</li>
<li><a href="https://csrc.nist.gov/publications/detail/sp/800-154/draft">Guide to Data-Centric System Threat Modeling</a> (aka NIST 800-154)</li>
<li><a href="https://www.amazon.com/Threat-Modeling-Designing-Adam-Shostack/dp/1118809998">Shostack thread modeling</a></li>
<li><a href="https://en.wikipedia.org/wiki/STRIDE_(security)">STRIDE</a> / <a href="https://en.wikipedia.org/wiki/DREAD_(risk_assessment_model)">DREAD</a></li>
<li><a href="https://en.wikipedia.org/wiki/Threat_model#P.A.S.T.A.">PASTA</a></li>
<li><a href="https://blog.regehr.org/archives/1091">Use of Assertions</a></li>
</ul>
<h3 id="components"><a class="header" href="#components">Components</a></h3>
<p>Knowing what you want to check will also help you to select the right tool.</p>
<p>The broad areas that are frequently relevant for smart contracts include:</p>
<ul>
<li>
<p><strong>State machine.</strong> Most contracts can be represented as a state machine. Consider checking that (1) No invalid state can be reached, (2) if a state is valid that it can be reached, and (3) no state traps the contract.</p>
<ul>
<li>Echidna and Manticore are the tools to favor to test state-machine specifications.</li>
</ul>
</li>
<li>
<p><strong>Access controls.</strong> If you system has privileged users (e.g. an owner, controllers, ...) you must ensure that (1) each user can only perform the authorized actions and (2) no user can block actions from a more priviledged user.</p>
<ul>
<li>Slither, Echidna and Manticore can check for correct access controls. For example, Slither can check that only whitelisted functions lack the onlyOwner modifier. Echidna and Manticore are useful for more complex access control, such as a permission given only if the contract reaches a given state.</li>
</ul>
</li>
<li>
<p><strong>Arithmetic operations.</strong> Checking the soundness of the arithmetic operations is critical. Using <code>SafeMath</code> everywhere is a good step to prevent overflow/underflow, however, you must still consider other arithmetic flaws, including rounding issues and flaws that trap the contract.</p>
<ul>
<li>Manticore is the best choice here. Echidna can be used if the arithmetic is out-of-scope of the SMT solver.</li>
</ul>
</li>
<li>
<p><strong>Inheritance correctness.</strong> Solidity contracts rely heavily on multiple inheritance. Mistakes such as a shadowing function missing a <code>super</code> call and misinterpreted c3 linearization order can easily be introduced.</p>
<ul>
<li>Slither is the tool to ensure detection of these issues.</li>
</ul>
</li>
<li>
<p><strong>External interactions.</strong> Contracts interact with each other, and some external contracts should not be trusted. For example, if your contract relies on external oracles, will it remain secure if half the available oracles are compromised?</p>
<ul>
<li>Manticore and Echidna are the best choice for testing external interactions with your contracts. Manticore has an built-in mechanism to stub external contracts.</li>
</ul>
</li>
<li>
<p><strong>Standard conformance.</strong> Ethereum standards (e.g. ERC20) have a history of flaws in their design. Be aware of the limitations of the standard you are building on.</p>
<ul>
<li>Slither, Echidna, and Manticore will help you to detect deviations from a given standard. </li>
</ul>
</li>
</ul>
<h3 id="tool-selection-cheatsheet"><a class="header" href="#tool-selection-cheatsheet">Tool selection cheatsheet</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Component</th><th>Tools</th><th>Examples</th></tr></thead><tbody>
<tr><td>State machine</td><td>Echidna, Manticore</td><td></td></tr>
<tr><td>Access control</td><td>Slither, Echidna, Manticore</td><td><a href="program-analysis/./slither/exercise2.html">Slither exercise 2</a>, <a href="program-analysis/./echidna/exercises/Exercise-2.html">Echidna exercise 2</a></td></tr>
<tr><td>Arithmetic operations</td><td>Manticore, Echidna</td><td><a href="program-analysis/./echidna/exercises/Exercise-1.html">Echidna exercise 1</a>, <a href="program-analysis/./manticore/exercises">Manticore exercises 1 - 3</a></td></tr>
<tr><td>Inheritance correctness</td><td>Slither</td><td><a href="program-analysis/./slither/exercise1.html">Slither exercise 1</a></td></tr>
<tr><td>External interactions</td><td>Manticore, Echidna</td><td></td></tr>
<tr><td>Standard conformance</td><td>Slither, Echidna, Manticore</td><td><a href="https://github.com/crytic/slither/wiki/ERC-Conformance"><code>slither-erc</code></a></td></tr>
</tbody></table>
</div>
<p>Other areas will need to be checked depending on your goals, but these coarse-grained areas of focus are a good start for any smart contract system.</p>
<p>Our public audits contain examples of verified or tested properties. Consider reading the <code>Automated Testing and Verification</code> sections of the following reports to review real-world security properties:</p>
<ul>
<li><a href="https://github.com/trailofbits/publications/blob/master/reviews/0x-protocol.pdf">0x</a></li>
<li><a href="https://github.com/trailofbits/publications/blob/master/reviews/BalancerCore.pdf">Balancer</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="echidna-tutorial"><a class="header" href="#echidna-tutorial">Echidna Tutorial</a></h1>
<p>The aim of this tutorial is to show how to use Echidna to automatically test smart contracts. </p>
<p>Watch our <a href="https://www.youtube.com/watch?v=QofNQxW_K08&amp;list=PLciHOL_J7Iwqdja9UH4ZzE8dP1IxtsBXI">Fuzzing workshop</a> to learn through live coding sessions.</p>
<p><strong>Table of contents:</strong></p>
<ul>
<li><a href="program-analysis/echidna/introduction">Introduction</a>: Introductory material to fuzzing and Echidna</li>
<li><a href="program-analysis/echidna/basic">Basic</a>: Learn the first steps on how to use Echidna</li>
<li><a href="program-analysis/echidna/advanced">Advanced</a>: Learn advanced features of Echidna</li>
<li><a href="program-analysis/echidna/./fuzzing_tips.html">Fuzzing tips</a>: General fuzzing tips</li>
<li><a href="program-analysis/echidna/./frequently_asked_questions.html">Frequently Asked Questions</a>: Answers to common questions about Echidna</li>
<li><a href="program-analysis/echidna/exercises">Exercises</a>: Exercises </li>
</ul>
<p>Join the team on Slack at: https://empireslacking.herokuapp.com/ #ethereum</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>Introductory material to fuzzing and Echidna</p>
<ul>
<li><a href="program-analysis/echidna/introduction/./installation.html">Installation</a></li>
<li><a href="program-analysis/echidna/introduction/./fuzzing-introduction.html">Introduction to fuzzing</a>: Brief introduction to fuzzing</li>
<li><a href="program-analysis/echidna/introduction/./how-to-test-a-property.html">How to test a property</a>: How to test a property with Echidna</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-to-property-based-fuzzing"><a class="header" href="#introduction-to-property-based-fuzzing">Introduction to property-based fuzzing</a></h1>
<p>Echidna is a property-based fuzzer, which we described in our previous blogposts (<a href="https://blog.trailofbits.com/2018/03/09/echidna-a-smart-fuzzer-for-ethereum/">1</a>, <a href="https://blog.trailofbits.com/2018/05/03/state-machine-testing-with-echidna/">2</a>, <a href="https://blog.trailofbits.com/2020/03/30/an-echidna-for-all-seasons/">3</a>).</p>
<h2 id="fuzzing"><a class="header" href="#fuzzing">Fuzzing</a></h2>
<p>Fuzzing is a well-known technique in the security community. It consists of generating more or less random inputs to find bugs in the program. Fuzzers for traditional software (such as <a href="http://lcamtuf.coredump.cx/afl/">AFL</a> or <a href="https://llvm.org/docs/LibFuzzer.html">LibFuzzer</a>) are known to be efficient tools to find bugs.</p>
<p>Beyond the purely random generation of inputs, there are many techniques and strategies to generate good inputs, including:</p>
<ul>
<li><strong>Obtain feedback from each execution and guide generation using it</strong>. For example, if a newly generated input leads to the discovery of a new path, it makes sense to generate new inputs closest to it.</li>
<li><strong>Generate input with respect to a structural constraint</strong>. For example, if your input contains a header with a checksum, it makes sense to let the fuzzer generate input validating the checksum.</li>
<li><strong>Use known inputs to generate new inputs</strong>. If you have access to a large dataset of valid input, your fuzzer can generate new inputs from them, rather than starting from scratch for each generation. These are usually called <em>seeds</em>.</li>
</ul>
<h2 id="property-based-fuzzing"><a class="header" href="#property-based-fuzzing">Property-based fuzzing</a></h2>
<p>Echidna belongs to a specific family of fuzzer: property-based fuzzing heavily inspired by <a href="https://en.wikipedia.org/wiki/QuickCheck">QuickCheck</a>. In contrast to a classic fuzzer that will try to find crashes, Echidna will try to break user-defined invariants.</p>
<p>In smart contracts, invariants are Solidity functions that can represent any incorrect or invalid state that the contract can reach, including:</p>
<ul>
<li>Incorrect access control: the attacker became the owner of the contract.</li>
<li>Incorrect state machine: the tokens can be transferred while the contract is paused.</li>
<li>Incorrect arithmetic: the user can underflow its balance and get unlimited free tokens.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="testing-a-property-with-echidna"><a class="header" href="#testing-a-property-with-echidna">Testing a Property with Echidna</a></h1>
<p><strong>Table of contents:</strong></p>
<ul>
<li><a href="program-analysis/echidna/introduction/how-to-test-a-property.html#testing-a-property-with-echidna">Testing a Property with Echidna</a>
<ul>
<li><a href="program-analysis/echidna/introduction/how-to-test-a-property.html#introduction">Introduction</a></li>
<li><a href="program-analysis/echidna/introduction/how-to-test-a-property.html#write-a-property">Write a property</a></li>
<li><a href="program-analysis/echidna/introduction/how-to-test-a-property.html#initiate-a-contract">Initiate a contract</a></li>
<li><a href="program-analysis/echidna/introduction/how-to-test-a-property.html#run-echidna">Run Echidna</a></li>
<li><a href="program-analysis/echidna/introduction/how-to-test-a-property.html#summary-testing-a-property">Summary: Testing a property</a></li>
</ul>
</li>
</ul>
<h2 id="introduction-1"><a class="header" href="#introduction-1">Introduction</a></h2>
<p>We will see how to test a smart contract with Echidna. The target is the following smart contract (<em><a href="program-analysis/echidna/introduction/../example/token.sol">../example/token.sol</a></em>):</p>
<pre><code class="language-Solidity">   contract Token{
      mapping(address =&gt; uint) public balances;
      function airdrop() public{
          balances[msg.sender] = 1000;
     }
     function consume() public{
          require(balances[msg.sender]&gt;0);
          balances[msg.sender] -= 1;
     }
     function backdoor() public{
          balances[msg.sender] += 1;
     }
   }
  
</code></pre>
<p>We will make the assumption that this token has the following properties:</p>
<ul>
<li>
<p>Anyone can have at maximum 1000 tokens</p>
</li>
<li>
<p>The token cannot be transferred (it is not an ERC20 token)</p>
</li>
</ul>
<h2 id="write-a-property"><a class="header" href="#write-a-property">Write a property</a></h2>
<p>Echidna properties are Solidity functions. A property must:</p>
<ul>
<li>Have no argument</li>
<li>Return true if it is successful</li>
<li>Have its name starting with <code>echidna</code></li>
</ul>
<p>Echidna will:</p>
<ul>
<li>Automatically generate arbitrary transactions to test the property.</li>
<li>Report any transactions leading a property to return false or throw an error. </li>
<li>Discard side-effects when calling a property (i.e. if the property changes a state variable, it is discarded after the test)</li>
</ul>
<p>The following property checks that the caller can have no more than 1000 tokens:</p>
<pre><code class="language-Solidity">    function echidna_balance_under_1000() public view returns(bool){
         return balances[msg.sender] &lt;= 1000;
    }
</code></pre>
<p>Use inheritance to separate your contract from your properties:</p>
<pre><code class="language-Solidity">    contract TestToken is Token{
         function echidna_balance_under_1000() public view returns(bool){
               return balances[msg.sender] &lt;= 1000;
          }
     }
</code></pre>
<p><em><a href="program-analysis/echidna/introduction/../example/testtoken.sol">../example/testtoken.sol</a></em> implements the property and inherits from the token.</p>
<h2 id="initiate-a-contract"><a class="header" href="#initiate-a-contract">Initiate a contract</a></h2>
<p>Echidna needs a constructor without input arguments.
If your contract needs a specific initialization, you need to do it in the constructor.</p>
<p>There are some specific addresses in Echidna:</p>
<ul>
<li>
<p><code>0x30000</code> calls the constructor.</p>
</li>
<li>
<p><code>0x10000</code>, <code>0x20000</code>, and <code>0x30000</code> randomly call the other functions.</p>
</li>
</ul>
<p>We do not need any particular initialization in our current example. As a result, our constructor is empty.</p>
<h2 id="run-echidna"><a class="header" href="#run-echidna">Run Echidna</a></h2>
<p>Echidna is launched with:</p>
<pre><code class="language-bash">$ echidna-test contract.sol
</code></pre>
<p>If <code>contract.sol</code> contains multiple contracts, you can specify the target:</p>
<pre><code class="language-bash">$ echidna-test contract.sol --contract MyContract
</code></pre>
<h2 id="summary-testing-a-property"><a class="header" href="#summary-testing-a-property">Summary: Testing a property</a></h2>
<p>The following summarizes the run of Echidna on our example:</p>
<pre><code class="language-Solidity">     contract TestToken is Token{
         constructor() public {}
             function echidna_balance_under_1000() public view returns(bool){
                return balances[msg.sender] &lt;= 1000;
             }
       }
</code></pre>
<pre><code class="language-bash">$ echidna-test testtoken.sol --contract TestToken
...

echidna_balance_under_1000: failed!💥  
  Call sequence, shrinking (1205/5000):
    airdrop()
    backdoor()

...
</code></pre>
<p>Echidna found that the property is violated if <code>backdoor</code> is called.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="basic"><a class="header" href="#basic">Basic</a></h1>
<ul>
<li><a href="program-analysis/echidna/basic/./testing-modes.html">How to select the most suitable testing mode</a>: How to select the most suitable testing mode</li>
<li><a href="program-analysis/echidna/basic/./common-testing-approaches.html">How to select the best testing approach</a>: How to select the best testing approach</li>
<li><a href="program-analysis/echidna/basic/./filtering-functions.html">How to filter functions</a>: How to filters the functions to be fuzzed</li>
<li><a href="program-analysis/echidna/basic/./assertion-checking.html">How to test assertions</a>: How to test assertions with Echidna</li>
<li><a href="program-analysis/echidna/basic/./property-creation.html">How to write good properties step by step</a>: How to iteratively improve property testing</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-select-the-most-suitable-testing-mode"><a class="header" href="#how-to-select-the-most-suitable-testing-mode">How to select the most suitable testing mode</a></h1>
<p>Since Echidna offers several ways to write properties, often developers or auditors are wondering which testing mode should use. We will review how each mode works, as well as their advantages or disadvantages. </p>
<p><strong>Table of contents:</strong></p>
<ul>
<li><a href="program-analysis/echidna/basic/testing-modes.html#boolean-properties">Boolean properties</a></li>
<li><a href="program-analysis/echidna/basic/testing-modes.html#assertions">Assertions</a></li>
<li><a href="program-analysis/echidna/basic/testing-modes.html#dapptest">Dapptest</a></li>
<li><a href="program-analysis/echidna/basic/testing-modes.html#stateless-vs-stateful">Stateless vs Stateful</a></li>
</ul>
<h2 id="boolean-properties"><a class="header" href="#boolean-properties">Boolean properties</a></h2>
<p>By default, the &quot;property&quot; testing mode is used, which reports failures using a special functions called properties:</p>
<ul>
<li>Testing functions should be named with a specific prefix (e.g. <code>echidna_</code>).</li>
<li>Testing functions take no parameters, and always return a boolean value.</li>
<li>Any side effect will be reverted at the end of the execution of the property.</li>
<li>Properties pass if they return true, and fail if they return false or revert. As an alternative, properties that starts with &quot;echidna_revert_&quot; will fail if they return any value (true or false), and pass if they revert. This pseudo-code summarizes how properties work:</li>
</ul>
<pre><code class="language-solidity">function echidna_property() public returns (bool) { // No arguments are required

    // The following statements can trigger a failure if they revert 
    publicFunction(..);
    internalFunction(..);
    contract.function(..);

    // The following statement can trigger a failure depending on the returned value
    return ..;
} // side effects are *not* preserved

function echidna_revert_property() public returns (bool) { // No arguments is required

    // The following statements can *never* trigger a failure
    publicFunction(..);
    internalFunction(..);
    contract.function(..);

    // The following statement will *always* trigger a failure regardless of the value returned
    return ..;
} // side effects are *not* preserved
</code></pre>
<h3 id="advantages"><a class="header" href="#advantages">Advantages:</a></h3>
<ul>
<li>Properties can be easier to write and understand compared to other approaches for testing.</li>
<li>No need to worry about side-effects, since these are reverted at the end of the property execution.</li>
</ul>
<h3 id="disadvantages"><a class="header" href="#disadvantages">Disadvantages:</a></h3>
<ul>
<li>Since the properties take no parameters, any additional input should be added using a state variable.</li>
<li>Any revert will be interpreted as a failure, which is not always expected. </li>
<li>No coverage is collected during its execution so these properties should be used with simple code. For anything complex (e.g. with a non-trivial amount of branches), other types of tests should be used.</li>
</ul>
<h3 id="recommendations-9"><a class="header" href="#recommendations-9">Recommendations</a></h3>
<p>This mode can be used when a property can be easily computed from the use of state variables (either internal or public), and there is no need to use extra parameters.</p>
<h2 id="assertions"><a class="header" href="#assertions">Assertions</a></h2>
<p>Using the &quot;assertion&quot; testing mode, Echidna will report an assert violation if:</p>
<ul>
<li>The execution reverts during a call to <code>assert</code>. Technically speaking, Echidna will detect an assertion failure if it executes an <code>assert</code> call that fails in the first call frame of the target contract (so this excludes any internal transactions in most of the cases). </li>
<li>An <code>AssertionFailed</code> event (with any number of parameters) is emitted by any contract. This pseudo-code summarizes how assertions work:</li>
</ul>
<pre><code class="language-solidity">function checkInvariant(..) public { // Any number of arguments is supported

    // The following statements can trigger a failure using `assert`
    assert(..); 
    publicFunction(..);
    internalFunction(..);

    // The following statement will always trigger a failure even if the execution ends with a revert
    emits AssertionFailed(..);

    // The following statement will *only* trigger a failure using `assert` if using solc 0.8.x or newer
    // To make sure it works in older versions, use the AssertionFailed(..) event
    anotherContract.function(..);
    
} // side effects are preserved
</code></pre>
<p>Functions checking assertions do not require any particular name and are executed like any other function, and therefore, their side effects are kept if they do not revert.</p>
<h3 id="advantages-1"><a class="header" href="#advantages-1">Advantages</a></h3>
<ul>
<li>Easy to implement, in particular, if there are any number of parameters required to compute the invariant.</li>
<li>Coverage is collected during the execution of these tests, so it can help to reach new failures.</li>
<li>If the code base already contains assertions for checking invariants, they can be reused.</li>
</ul>
<h3 id="disadvantages-1"><a class="header" href="#disadvantages-1">Disadvantages</a></h3>
<ul>
<li>If the code to test is already using assertions for data validation, it will not work as expected. For example:</li>
</ul>
<pre><code class="language-solidity">function deposit(uint256 tokens) public {
  assert(tokens &gt; 0); // should be strictly positive
  ..
</code></pre>
<p>Developers <em>should</em> avoid doing that and use <code>require</code> instead, but if that is not possible because you are calling some contract that is outside your control, you can use the <code>AssertionFailure</code> event.</p>
<h3 id="recommendation"><a class="header" href="#recommendation">Recommendation</a></h3>
<p>You should use assertions if your invariant is more natural to be expressed using arguments or if it can only be checked in the middle of a transaction. Another good use case of assertions is complex code that require to check something as well as changing the state. In the following example, we test staking of some ERC20, given that there is at least <code>MINSTAKE</code> tokens in the sender balance.</p>
<pre><code class="language-solidity">function testStake(uint256 toStake) public {
    uint256 balance = balanceOf(msg.sender);
    toStake = toStake % (balance + 1); 
    if (toStake &lt; MINSTAKE)                             // Pre: minimal stake is required
      return;
    stake(msg.sender, toStake);                         // Action: token staking
    assert(staked(msg.sender) == toStake);              // Post: staking amount is toStake
    assert(balanceOf(msg.sender) == balance - toStake); // Post: balance decreased
}
</code></pre>
<p><code>testStake</code> checks some invariants on staking, but also ensures that the state of the contract is properly updated (e.g only allowing a user to stake at least <code>MINSTAKE</code>). </p>
<h2 id="dapptest"><a class="header" href="#dapptest">Dapptest</a></h2>
<p>Using the &quot;dapptest&quot; testing mode, Echidna will report violations using certain functions following how dapptool and foundry work:</p>
<ul>
<li>This mode uses any function name with one or more arguments, which will trigger a failure if they revert, except in one special case. This is, if the execution reverts with the special reason “FOUNDRY::ASSUME”, then the test will pass (this emulates how <a href="https://github.com/gakonst/foundry/commit/7dcce93a38345f261d92297abf11fafd6a9e7a35#diff-47207bb2f6cf3c4ac054647e851a98a57286fb9bb37321200f91637262d3eabfR90-R96">the <code>assume</code> foundry cheat code works</a>). This pseudo-code summarizes how dapptests work:</li>
</ul>
<pre><code class="language-solidity">function checkDappTest(..) public { // One or more arguments are required
    // The following statements can trigger a failure if they revert
    publicFunction(..);
    internalFunction(..);
    anotherContract.function(..);
    // The following statement will never trigger a failure
    require(.., “FOUNDRY::ASSUME”);
}
</code></pre>
<ul>
<li>Functions implementing these tests do not require any particular name and are executed like any other function, and therefore, their side effects are kept if they do not revert (but usually, this mode is used only in stateless testing).</li>
<li>The function should NOT be payable (but this can change in the future)</li>
</ul>
<h3 id="advantages-2"><a class="header" href="#advantages-2">Advantages:</a></h3>
<ul>
<li>Easy to implement, in particular, for stateless mode.</li>
<li>Coverage is collected during the execution of these tests, so it can help to reach new failures.</li>
</ul>
<h3 id="disadvantages-2"><a class="header" href="#disadvantages-2">Disadvantages:</a></h3>
<ul>
<li>Almost any revert will be interpreted as a failure, which is not always expected. To avoid this, you should use reverts with <code>FOUNDRY::ASSUME</code> or use try/catch.</li>
</ul>
<h3 id="recommendation-1"><a class="header" href="#recommendation-1">Recommendation</a></h3>
<p>Use dapptest mode if you are testing stateless invariants and the code will never unexpectedly revert. Avoid using it for stateful testing, since it was not designed for that (however, Echidna supports it).</p>
<h2 id="stateless-vs-stateful"><a class="header" href="#stateless-vs-stateful">Stateless vs Stateful</a></h2>
<p>Any of these testing modes can be used, in either stateful (by default) or stateless mode (using <code>--seqLen 1</code>). In stateful mode, Echidna will keep the state between each function call and will try to break the invariants. In stateless, Echidna will discard the state changes during the fuzzing. There are notable differences in these two modes. </p>
<ul>
<li>Stateful is more powerful, and can allow breaking invariants that exist only if the contract reaches a specific state. </li>
<li>Stateless tests can be easier to use than stateful and benefits from simpler input generation.</li>
<li>Stateless tests can hide issues, since some of them can depend on a sequence of operations that is not reachable in a single transaction. </li>
<li>Stateless mode forces resetting the EVM after each transaction or test, which is usually slower than resetting the state once every certain amount of transactions (by default, every 100 transactions).</li>
</ul>
<h3 id="recommendations-10"><a class="header" href="#recommendations-10">Recommendations</a></h3>
<p>In terms of usage for beginners, we recommend starting using Echidna with stateless, and to switch to stateful once you have a good understanding of the system's invariants.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="common-testing-approaches"><a class="header" href="#common-testing-approaches">Common testing approaches</a></h1>
<p>Testing of smart contracts is not as straightforward as testing normal binaries that you run in your local computer. 
This is caused by the existence of multiple accounts interacting with one or many entry points. 
While a fuzzer can simulate the Ethereum Virtual Machine and can potentially use any account with any feature (e.g. a an unlimited amount of ETH), 
we take care to avoid breaking some important underlying assumptions of transactions that are impossible in Ethereum (e.g. for instance using msg.sender as the zero address). 
That is why it is important to have a clear view of the system to test, and how transactions are going to be simulated. There are a few classifications for the testing approach. 
We will start with two of them, internal and external:</p>
<p><strong>Table of contents:</strong></p>
<ul>
<li><a href="program-analysis/echidna/basic/common-testing-approaches.html#common-testing-approaches">Common testing approaches</a>
<ul>
<li><a href="program-analysis/echidna/basic/common-testing-approaches.html#internal-testing">Internal testing</a></li>
<li><a href="program-analysis/echidna/basic/common-testing-approaches.html#external-testing">External testing</a></li>
<li><a href="program-analysis/echidna/basic/common-testing-approaches.html#partial-testing">Partial testing</a></li>
</ul>
</li>
</ul>
<h2 id="internal-testing"><a class="header" href="#internal-testing">Internal testing</a></h2>
<p>In this testing approach, properties are defined inside the contract to test, with complete access to the internal state of the system.</p>
<pre><code class="language-solidity">Contract InternalTest is System { 
    function echidna_state_greater_than_X() public returns (bool) {
       return stateVar &gt; X;
    }
}
</code></pre>
<p>In this approach, Echidna will generate transactions from a simulated account to the target contract. This testing approach is particularly useful for simpler contracts that do not require a complex initialization and have a single entrypoint. 
Additionally, properties can be easier to write, since properties can access the system's internal state.</p>
<h2 id="external-testing"><a class="header" href="#external-testing">External testing</a></h2>
<p>In the external testing approach, properties are tested using external calls from a different contract. Properties are only allowed to access external/public variables or functions.</p>
<pre><code class="language-solidity">contract ExternalTest {
    constructor() public {
       addr = address(0x...);
    }
    function echidna_state_greater_than_X() public returns (bool) {
       return System(addr).stateVar() &gt; X;
    }
}
</code></pre>
<p>This testing approach is useful for dealing with contracts that require external initialization (e.g. using Etheno), however, it should handle correctly how Echidna runs the transactions, 
since the contract with the properties is no longer the same as the one we want to test. 
Since <code>ExternalTest</code> defines no additional methods, running Echidna directly on this will not allow any code to be executed from the contract to test (there are no functions in <code>ExternalTest</code> to call besides the actual properties). 
In this case, there are several alternatives:</p>
<p><strong>Contract wrapper</strong>: define specific operations to &quot;wrap&quot; the system to test. For every operation that we want Echidna to execute in the system to test, 
we add one or more functions that performs external call to it.</p>
<pre><code class="language-solidity">contract ExternalTest {
    constructor() public {
       addr = ..;
    }

    function method(...) public returns (...) {
       return System(addr).method(..);
    }

    function echidna_state_greater_than_X() public returns (bool) {
       return System(addr).stateVar() &gt; X;
    }
}
</code></pre>
<p>There are two important points to consider in this approach:</p>
<ul>
<li>
<p>The sender of each transaction will be the <code>ExternalTest</code> contract, instead of the simulated Echidna senders (e.g <code>0x10000</code>, ..). This means that the real address  interacting with the system will be the <code>External</code> contract one, instead of one of the Echidna senders. Please take particular care, if you need  to provide ETH or tokens into this contract. </p>
</li>
<li>
<p>This approach is manual and can be time consuming if there a lot of functions operations, 
but it can be useful when Echidna needs some help calculating some value which cannot be randomly sampled:</p>
</li>
</ul>
<pre><code class="language-solidity">contract ExternalTest {
    ...
    function methodUsingF(..., uint256 x) public returns (...) {
       return System(addr).method(.., f(x));
    }
    ... 
}
</code></pre>
<p><strong>Multi ABI</strong>: Echidna is capable of performing direct calls to every contract, if the <code>multi-abi</code> mode is enabled. 
This means that using it wil not require wrapped calls, however since every contract deployed can be called, there could be unintended effects. 
For instance, if we have a property to ensure that the amount of tokens is limited:</p>
<pre><code class="language-solidity">contract ExternalTest {
    constructor() public {
       addr = ..;
       MockERC20(..).mint(..);  
    }

    function echidna_limited_supply() public returns (bool) {
       return System(addr).balanceOf(...) &lt;= X;
    }
    ... 
}
</code></pre>
<p>If we used &quot;mock&quot; contracts for tokens (e.g. MockERC20)  could be an issue, because Echidna could call functions that are public but are only supposed to be used during the initialization such as <code>mint</code>. This can be easily solved using a blacklist of functions to ignore:</p>
<pre><code class="language-yaml">filterBlacklist: true
filterFunctions: [“MockERC20.mint(uint256,address)”]
</code></pre>
<p>Finally, there is another benefit for using this approach: it will force the developer or auditor to write properties using public data. 
If an important property cannot be defined using public data, it could be an indication that users or other contracts will NOT be able to easily interact with the system to either perform some operation or verify that the system is in a valid state.</p>
<h2 id="partial-testing"><a class="header" href="#partial-testing">Partial testing</a></h2>
<p>Ideally, testing a smart contract system uses the complete deployed system, with the same parameters that the developers intend to use. 
Testing with the real code, it is always preferred, even if it is slower than doing something else (but perhaps not in the case that it is extremely slow). 
However, there are many cases where even if the complete system is deployed, it cannot be simulated because it depends on off-chain 
components (e.g. a token bridge). In such cases, we are forced to implement alternative solutions.</p>
<p>In this case, we will do testing of some of the components, ignoring or abstracting uninteresting parts such as standard ERC20 tokens or oracles. 
There are a few ways to do this. </p>
<p><strong>Isolated testing</strong>: If a component is properly abstracted from the rest of the system, testing it can be easy. 
This is particularly useful for testing stateless properties that you can find in components that compute mathematical operations, such as 
mathematical libraries.</p>
<p><strong>Function override</strong>: Solidity allows to override functions, in order to change the functionality of a piece of code, without affecting the rest of the code base. We can use this to disable certain functions in our tests, in order to allow testing using Echidna:</p>
<pre><code class="language-solidity">Contract InternalTestOverridingSignatures is System {

    function verifySignature(..) public returns (bool) override {
      return true; // signatures are always valid
    }
 
    function echidna_state_greater_than_X() public returns (bool) {
       executeSomethingWithSignature(..)
       return stateVar &gt; X;
    }
}
</code></pre>
<p><strong>Model testing</strong>: if the system is not modular enough, then we will need a different approach. 
Instead of using the code as it is, we will create a “model” of the system in Solidity, using mostly the original code. While there is no defined list of steps to build a model, we can show a generic example. Let’s assume we have a complex system that include this piece of code:</p>
<pre><code class="language-solidity">Contract System {
    … 
    function calculateSomething() public returns (uint256) {
       if (booleanState) {
           stateSomething = (uint256State1 * uint256State2) / 2**128;
           return stateSomething / uint128State;
       } 
       …
    }
}
</code></pre>
<p>Where <code>boolState</code>, <code>uint256State1</code>, <code>uint256State2</code> and <code>stateSomething</code> are state variables of our system to test. 
We are going to create a model (e.g. copy, paste and modify the original code in a new contract), where each state variable is 
transformed into a parameter:</p>
<pre><code class="language-solidity">Contract SystemModel {

    function calculateSomething(bool boolState, uint256 uint256State1, …) public returns (uint256) {
       if (boolState) {
           stateSomething = (uint256State1 * uint256State2) / 2**128;
           return stateSomething / uint128State;
       } 
       …
    }
}
</code></pre>
<p>At this point, we should be able to compile our model without any dependency from the original codebase (everything necessary should be included in 
the model). Then, we can insert assertions to detect when the returned value exceeds a certain threshold.</p>
<p>While developers or auditors can be tempted to quickly create tests using this technique there are certain disadvantages when creating models:</p>
<ul>
<li>
<p>The code tested can be very different from the one we want to test: this can either introduce issues that are not real (false positives) or 
hide real issues from the original code (false negatives). In the example, it is unclear if the state variable can take arbitrary values.</p>
</li>
<li>
<p>The model will have a limited value if the code is changed since any modification in the original model will force a rebuild of the model, 
and this should be manually performed.</p>
</li>
</ul>
<p>In any case, developers should be warned that their code is difficult to test and it should be refactored to avoid this issue in the future.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="filtering-functions-to-call-during-a-fuzzing-campaign"><a class="header" href="#filtering-functions-to-call-during-a-fuzzing-campaign">Filtering functions to call during a fuzzing campaign</a></h1>
<p><strong>Table of contents:</strong></p>
<ul>
<li><a href="program-analysis/echidna/basic/filtering-functions.html#filtering-functions-to-call-during-a-fuzzing-campaign">Filtering functions to call during a fuzzing campaign</a>
<ul>
<li><a href="program-analysis/echidna/basic/filtering-functions.html#introduction">Introduction</a></li>
<li><a href="program-analysis/echidna/basic/filtering-functions.html#filtering-functions">Filtering functions</a></li>
</ul>
</li>
<li><a href="program-analysis/echidna/basic/filtering-functions.html#run-echidna">Run Echidna</a>
<ul>
<li><a href="program-analysis/echidna/basic/filtering-functions.html#summary-filtering-functions">Summary: Filtering functions</a></li>
</ul>
</li>
</ul>
<h2 id="introduction-2"><a class="header" href="#introduction-2">Introduction</a></h2>
<p>We will see how to filter the functions to be fuzzed.
The target is the following smart contract (<em><a href="program-analysis/echidna/basic/../example/multi.sol">../example/multi.sol</a></em>): </p>
<pre><code class="language-solidity">contract C {
  bool state1 = false;
  bool state2 = false;
  bool state3 = false;
  bool state4 = false;

  function f(uint x) public {
    require(x == 12);
    state1 = true;
  }

  function g(uint x) public {
    require(state1);
    require(x == 8);
    state2 = true;
  }

  function h(uint x) public {
    require(state2);
    require(x == 42);
    state3 = true;
  }

 function i() public {
    require(state3);
    state4 = true;
  }

  function reset1() public {
    state1 = false;
    state2 = false;
    state3 = false;
    return;
  }

  function reset2() public {
    state1 = false;
    state2 = false;
    state3 = false;
    return;
  }

  function echidna_state4() public returns (bool) {
    return (!state4);
  }

}
</code></pre>
<p>This small example forces Echidna to find a certain sequence of transactions to change a state variable. 
This is hard for a fuzzer (it is recommended to use a symbolic execution tool like <a href="https://github.com/trailofbits/manticore">Manticore</a>).
We can run Echidna to verify this:</p>
<pre><code>$ echidna-test multi.sol 
...
echidna_state4: passed! 🎉
Seed: -3684648582249875403
</code></pre>
<h2 id="filtering-functions"><a class="header" href="#filtering-functions">Filtering functions</a></h2>
<p>Echidna has trouble finding the correct sequence to test this contract because the two reset functions (<code>reset1</code> and <code>reset2</code>) will set all the state variables to <code>false</code>. 
However, we can use a special Echidna feature to either blacklist the <code>reset</code> functions or to whitelist only the <code>f</code>, <code>g</code>, 
<code>h</code> and <code>i</code> functions. </p>
<p>To blacklist functions, we can use this configuration file:</p>
<pre><code class="language-yaml">filterBlacklist: true
filterFunctions: [&quot;C.reset1()&quot;, &quot;C.reset2()&quot;]
</code></pre>
<p>Another approach to filter functions is to list the whitelisted functions. To do that, we can use this configuration file:</p>
<pre><code class="language-yaml">filterBlacklist: false
filterFunctions: [&quot;C.f(uint256)&quot;, &quot;C.g(uint256)&quot;, &quot;C.h(uint256)&quot;, &quot;C.i()&quot;]
</code></pre>
<ul>
<li><code>filterBlacklist</code> is <code>true</code> by default.</li>
<li>Filtering will be performed by full function name (contract name + &quot;.&quot; + ABI function signature). If you have <code>f()</code> and <code>f(uint256)</code>, you can specify exactly which function to filter.</li>
</ul>
<h1 id="run-echidna-1"><a class="header" href="#run-echidna-1">Run Echidna</a></h1>
<p>To run Echidna with a configuration file <code>blacklist.yaml</code>:</p>
<pre><code>$ echidna-test multi.sol --config blacklist.yaml 
...
echidna_state4: failed!💥  
  Call sequence:
    f(12)
    g(8)
    h(42)
    i()
</code></pre>
<p>Echidna will find the sequence of transactions to falsify the property almost immediately. </p>
<h2 id="summary-filtering-functions"><a class="header" href="#summary-filtering-functions">Summary: Filtering functions</a></h2>
<p>Echidna can either blacklist or whitelist functions to call during a fuzzing campaign using:</p>
<pre><code class="language-yaml">filterBlacklist: true
filterFunctions: [&quot;C.f1()&quot;, &quot;C.f2()&quot;, &quot;C.f3()&quot;]
</code></pre>
<pre><code class="language-bash">$ echidna-test contract.sol --config config.yaml 
...
</code></pre>
<p>According to the value of the <code>filterBlacklist</code> boolean, Echidna will start a fuzzing campaign by either blacklisting <code>C.f1()</code>, <code>C.f2()</code> and <code>C.f3()</code> or by <em>only</em> calling those functions.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-test-assertions-with-echidna"><a class="header" href="#how-to-test-assertions-with-echidna">How to test assertions with Echidna</a></h1>
<p><strong>Table of contents:</strong></p>
<ul>
<li><a href="program-analysis/echidna/basic/assertion-checking.html#how-to-test-assertions-with-echidna">How to test assertions with Echidna</a>
<ul>
<li><a href="program-analysis/echidna/basic/assertion-checking.html#introduction">Introduction</a></li>
<li><a href="program-analysis/echidna/basic/assertion-checking.html#write-an-assertion">Write an assertion</a></li>
<li><a href="program-analysis/echidna/basic/assertion-checking.html#run-echidna">Run Echidna</a></li>
<li><a href="program-analysis/echidna/basic/assertion-checking.html#when-and-how-to-use-assertions">When and how to use assertions</a></li>
<li><a href="program-analysis/echidna/basic/assertion-checking.html#summary-assertion-checking">Summary: Assertion Checking</a></li>
</ul>
</li>
</ul>
<h2 id="introduction-3"><a class="header" href="#introduction-3">Introduction</a></h2>
<p>In this short tutorial, we will show you how to use Echidna to check assertions in smart contracts. For this example, make sure you use Solidity 0.7.x or older. If you run them with Solidity 0.8.x, the test will never fail.</p>
<h2 id="write-an-assertion"><a class="header" href="#write-an-assertion">Write an assertion</a></h2>
<p>Let's suppose we have a contract like this one: </p>
<pre><code class="language-solidity">contract Incrementor {
  uint private counter = 2**200;

  function inc(uint val) public returns (uint){
    uint tmp = counter;
    counter += val;
    // tmp &lt;= counter
    return (counter - tmp);
  }
}
</code></pre>
<p>We want to make sure that <code>tmp</code> is less than or equal to <code>counter</code> after returning its difference. We could write an Echidna property, but we will need to store the <code>tmp</code> value somewhere. Instead, we could use an assertion like this one (<em><a href="program-analysis/echidna/basic/../example/assert.sol">../example/assert.sol</a></em>):</p>
<pre><code class="language-solidity">contract Incrementor {
  uint private counter = 2**200;

  function inc(uint val) public returns (uint){
    uint tmp = counter;
    counter += val;
    assert (tmp &lt;= counter);
    return (counter - tmp);
  }
}
</code></pre>
<p>We could also use a special event called <code>AssertionFailed</code> with any number of parameters to let Echidna know about a failed assertion without using <code>assert</code>. This will work in any contract. For instance:</p>
<pre><code class="language-solidity">contract Incrementor {
  event AssertionFailed(uint);
  uint private counter = 2**200;

  function inc(uint val) public returns (uint){
    uint tmp = counter;
    counter += val;
    if (tmp &gt; counter)
      emit AssertionFailed(counter);
    return (counter - tmp);
  }
}
</code></pre>
<h2 id="run-echidna-2"><a class="header" href="#run-echidna-2">Run Echidna</a></h2>
<p>To enable the assertion failure testing in Echidna, you can use <code>--test-mode assertion</code> directly from the command line. </p>
<p>Otherwise, you can create an <a href="https://github.com/crytic/echidna/wiki/Config">Echidna configuration file</a>, <code>config.yaml</code>, with <code>testMode</code> set for assertion checking:</p>
<pre><code class="language-yaml">testMode: assertion
</code></pre>
<p>When we run this contract with Echidna, we obtain the expected results:</p>
<pre><code>$ echidna-test assert.sol --test-mode assertion
Analyzing contract: assert.sol:Incrementor
assertion in inc: failed!💥  
  Call sequence, shrinking (2596/5000):
    inc(21711016731996786641919559689128982722488122124807605757398297001483711807488)
    inc(7237005577332262213973186563042994240829374041602535252466099000494570602496)
    inc(86844066927987146567678238756515930889952488499230423029593188005934847229952)

Seed: 1806480648350826486
</code></pre>
<p>As you can see, Echidna reports an assertion failure in the <code>inc</code> function. Adding more than one assertion per function is possible, however, Echidna cannot tell which assertion failed.</p>
<h2 id="when-and-how-to-use-assertions"><a class="header" href="#when-and-how-to-use-assertions">When and how to use assertions</a></h2>
<p>Assertions can be used as alternatives to explicit properties if the conditions to check are directly related to the correct use of some operation <code>f</code>. Adding assertions after some code will enforce that the check happens immediately after it was executed: </p>
<pre><code class="language-solidity">function f(..) public {
    // some complex code
    ...
    assert (condition);
    ...
}
</code></pre>
<p>On the contrary, using an explicit boolean property will randomly execute transactions and there is no easy way to enforce exactly when it will be checked. It is still possible to do this workaround:</p>
<pre><code class="language-solidity">function echidna_assert_after_f() public returns (bool) {
    f(..); 
    return(condition);
}
</code></pre>
<p>However, there are some issues:</p>
<ul>
<li>It does not compile if <code>f</code> is declared as <code>internal</code> or <code>external</code></li>
<li>It is unclear which arguments should be used to call <code>f</code></li>
<li>The property will fail if <code>f</code> reverts, </li>
</ul>
<p>Assertions can help to overcome this possible issues. For instance, they can be easily detected when calling internal or public functions:</p>
<pre><code class="language-solidity">function f(..) public {
    // some complex code
    ...
    g(..) // this contains an assert
    ...
}
</code></pre>
<p>If <code>g</code> is external, then assertion failure can be <strong>only detected in Solidity 0.8.x or later</strong>.</p>
<pre><code class="language-solidity">function f(..) public {
    // some complex code
    ...
    contract.g(..) // this contains an assert
    ...
}
</code></pre>
<p>In general, we recommend following <a href="https://blog.regehr.org/archives/1091">John Regehr's advice</a> on using assertions:</p>
<ul>
<li>Do not force any side effects during the assertion checking. For instance: <code>assert(ChangeStateAndReturn() == 1)</code></li>
<li>Do not assert obvious statements. For instance <code>assert(var &gt;= 0)</code> where <code>var</code> is declared as <code>uint</code>.</li>
</ul>
<p>Finally, please <strong>do not use</strong> <code>require</code> instead of <code>assert</code>, since Echidna will not be able to detect it (but the contract will revert anyway).</p>
<h2 id="summary-assertion-checking"><a class="header" href="#summary-assertion-checking">Summary: Assertion Checking</a></h2>
<p>The following summarizes the run of Echidna on our example (remember to use 0.7.x or older):</p>
<pre><code class="language-solidity">contract Incrementor {
  uint private counter = 2**200;

  function inc(uint val) public returns (uint){
    uint tmp = counter;
    counter += val;
    assert (tmp &lt;= counter);
    return (counter - tmp);
  }
}
</code></pre>
<pre><code class="language-bash">$ echidna-test assert.sol --test-mode assertion
Analyzing contract: assert.sol:Incrementor
assertion in inc: failed!💥  
  Call sequence, shrinking (2596/5000):
    inc(21711016731996786641919559689128982722488122124807605757398297001483711807488)
    inc(7237005577332262213973186563042994240829374041602535252466099000494570602496)
    inc(86844066927987146567678238756515930889952488499230423029593188005934847229952)

Seed: 1806480648350826486
</code></pre>
<p>Echidna found that the assertion in <code>inc</code> can fail if this function is called multiple times with large arguments.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-write-good-properties-step-by-step"><a class="header" href="#how-to-write-good-properties-step-by-step">How to write good properties step by step</a></h1>
<p><strong>Table of contents:</strong></p>
<ul>
<li><a href="program-analysis/echidna/basic/property-creation.html#introduction">Introduction</a></li>
<li><a href="program-analysis/echidna/basic/property-creation.html#a-first-approach">A first approach</a></li>
<li><a href="program-analysis/echidna/basic/property-creation.html#enhacing-postcondition-checks">Enhacing postcondition checks</a></li>
<li><a href="program-analysis/echidna/basic/property-creation.html#combining-properties">Combining properties</a></li>
<li><a href="program-analysis/echidna/basic/property-creation.html#summary-how-to-write-good-properties">Summary: How to write good properties</a></li>
</ul>
<h2 id="introduction-4"><a class="header" href="#introduction-4">Introduction</a></h2>
<p>In this short tutorial, we will detail some ideas to write interesting or useful properties using Echidna. At each step, we will iteratively improve our properties.</p>
<h2 id="a-first-approach"><a class="header" href="#a-first-approach">A first approach</a></h2>
<p>One of the simplest properties to write using Echidna is to throw an assertion when some function is expected to revert/return.</p>
<p>Let's suppose we have a contract interface like the one below: </p>
<pre><code class="language-solidity">interface DeFi {
  ERC20 t;
  function getShares(address user) external returns (uint256)
  function createShares(uint256 val) external returns (uint256)
  function depositShares(uint256 val) external
  function withdrawShares(uint256 val) external
  function transferShares(address to) external
  ...
</code></pre>
<p>In this example, users can deposit tokens using <code>depositShares</code>, mint shares using <code>createShares</code>, withdraw shares using <code>withdrawShares</code>, transfer all shares to another user using <code>transferShares</code>, and get the number of shares for any account using <code>getShares</code>. We will start with very basic properties:</p>
<pre><code class="language-solidity">contract Test {
  DeFi c;
  ERC20 token;

  constructor() {
    c = DeFi(..);
    token.mint(address(this), ...);
  }
  
  function getShares_never_reverts() public {
      (bool b,) = c.call(abi.encodeWithSignature(&quot;getShares(address)&quot;, address(this)));
      assert(b);
  }

  function depositShares_never_reverts(uint256 val) public {
    if (token.balanceOf(address(this)) &gt;= val) {
        (bool b,) = c.call(abi.encodeWithSignature(&quot;depositShares(uint256)&quot;, val));
        assert(b);
    }
  }
  
  function withdrawShares_never_reverts(uint256 val) public {
    if (c.getShares(address(this)) &gt;= val) {
        (bool b,) = c.call(abi.encodeWithSignature(&quot;withdrawShares(uint256)&quot;, val));
        assert(b);
    }
  }
  
  function depositShares_can_revert(uint256 val) public {
    if (token.balanceOf(address(this)) &lt; val) {
        (bool b,) = c.call(abi.encodeWithSignature(&quot;depositShares(uint256)&quot;, val));
        assert(!b);
    }
  }
  
  function withdrawShares_can_revert(uint256 val) public {
    if (c.getShares(address(this)) &lt; val) {
        (bool b,) = c.call(abi.encodeWithSignature(&quot;withdrawShares(uint256)&quot;, val));
        assert(!b);
    }
  }
  
}
</code></pre>
<p>After you have writen your first version of properties, run Echidna to make sure they work as expected. During this tutorial, we will improve them step by step. It is strongly recommended to run the fuzzer at each step to increase the probability of detecting any potential issues. </p>
<p>Perhaps you think these properties are too low level to be useful, particularly if the code has a good coverage in terms of unit tests.
But you will be surprised how often an unexpected revert/return uncovers a complex and severe issue. Moreover, we will see how these properties can be improved to cover more complex post-conditions.</p>
<p>Before we continue, we will improve these properties using <a href="https://docs.soliditylang.org/en/v0.6.0/control-structures.html#try-catch">try/catch</a>. The use of a low-level call forces us to manually encode the data, which can be error prone (an error will always cause calls to revert). Note, this will only work if the codebase is using solc 0.6.0 or later:</p>
<pre><code class="language-solidity">  ...
  function depositShares_never_reverts(uint256 val) public {
    if (token.balanceOf(address(this)) &gt;= val) {
        try c.depositShares(val) { /* not reverted */ } catch { assert(false); }
    }
  }
  
  function depositShares_can_revert(uint256 val) public {
    if (token.balanceOf(address(this)) &lt; val) {
        try c.depositShares(val) { assert(false); } catch { /* reverted */ }
    }
  }
  ...
  
}
</code></pre>
<h2 id="enhacing-postcondition-checks"><a class="header" href="#enhacing-postcondition-checks">Enhacing postcondition checks</a></h2>
<p>If the previous properties are passing, this means that the pre-conditions are good enough, however the post-conditions are not very precise. 
Avoiding reverts doesn't mean that the contract is in a valid state. Let's add some basic preconditions:</p>
<pre><code class="language-solidity">  ...
  function depositShares_never_reverts(uint256 val) public {
    if (token.balanceOf(address(this)) &gt;= val) {
        try c.depositShares(val) { /* not reverted */ } catch { assert(false); }
        assert(c.getShares(address(this)) &gt; 0);
    }
  }
  
  function withdrawShares_never_reverts(uint256 val) public {
    if (c.getShares(address(this)) &gt;= val) {
        try c.withdrawShares(val) { /* not reverted */ } catch { assert(false); }
        assert(token.balanceOf(address(this)) &gt; 0);
    }
  }
  ...
  
}
</code></pre>
<p>Uhm, it looks like it is not that easy to specify the value of shares/tokens obtained after each deposit/withdrawal. At least we can say that we must receive something, right?</p>
<h2 id="combining-properties"><a class="header" href="#combining-properties">Combining properties</a></h2>
<p>In this generic example, it is unclear if there is a way to calculate how many shares or tokens we should receive after executing the deposit/withdraw operations. Of course, if we have that information, we should use it. In any case, what we can do here is to combine these two properties into a single one to be able check more precisely it's preconditions. </p>
<pre><code class="language-solidity">  ...
  function deposit_withdraw_shares_never_reverts(uint256 val) public {
    uint256 original_balance = token.balanceOf(address(this)); 
    if (original_balance &gt;= val) {
        try c.depositShares(val) { /* not reverted */ } catch { assert(false); }
        uint256 shares = c.getShares(address(this);
        assert(shares &gt; 0);
        try c.withdrawShares(shares) { /* not reverted */ } catch { assert(false); }
        assert(token.balanceOf(address(this)) == original_balance);
    }
  }
  ...
  
}
</code></pre>
<p>The resulting property checks that calls to deposit/withdraw shares will never revert and once they execute, the original number of tokens remains the same. Keep in mind that this property should consider fees and any tolerated loss of precision (e.g. when the computation requires a division).</p>
<h2 id="final-considerations"><a class="header" href="#final-considerations">Final considerations</a></h2>
<p>Two important considerations for this example:</p>
<p>We want Echidna to spend most of the execution exploring the contract to test. So, in order to make the properties more efficient, we should avoid dead branches where there is nothing to do. That's why we can improve <code>depositShares_never_reverts</code> to use:</p>
<pre><code class="language-solidity">  function depositShares_never_reverts(uint256 val) public {
    if(token.balanceOf(address(this)) &gt; 0) {
      val = val % (token.balanceOf(address(this)) + 1);
      try c.depositShares(val) { /* not reverted */ } catch { assert(false); }
      assert(c.getShares(address(this)) &gt; 0);
    } else {
      ... // code to test depositing zero tokens
    }
  }
</code></pre>
<p>Additionally, combining properties does not mean that we will have to remove simpler ones. For instance, if we want to write <code>withdraw_deposit_shares_never_reverts</code>, in which we reverse the order of operations (withdraw and then deposit, instead of deposit and then withdraw), we will have to make sure <code>c.getShares(address(this))</code> can be positive. An easy way to do it is to keep <code>depositShares_never_reverts</code>, since this code allows Echidna to deposit tokens from <code>address(this)</code> (otherwise, this is impossible).</p>
<h2 id="summary-how-to-write-good-properties"><a class="header" href="#summary-how-to-write-good-properties">Summary: How to write good properties</a></h2>
<p>It is usually a good idea to start writing simple properties first and then improving them to make them more precise and easier to read. At each step you should run a short fuzzing campaign to make sure they work as expected and try to catch issues early during the development of your smart contracts. </p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="advanced"><a class="header" href="#advanced">Advanced</a></h1>
<ul>
<li><a href="program-analysis/echidna/advanced/./collecting-a-corpus.html">How to collect a corpus</a>: How to use Echidna to collect a corpus of transactions</li>
<li><a href="program-analysis/echidna/advanced/./optimization_mode.html">How to use optimization mode</a>: How to use Echidna to optimize a function</li>
<li><a href="program-analysis/echidna/advanced/./finding-transactions-with-high-gas-consumption.html">How to detect high gas consumption</a>: How to find functions with high gas consumption.</li>
<li><a href="program-analysis/echidna/advanced/./smart-contract-fuzzing-at-scale.html">How to perform smart contract fuzzing at a large scale</a>: How to use Echidna to run a long fuzzing campaign for complex smart contracts.</li>
<li><a href="https://blog.trailofbits.com/2020/08/17/using-echidna-to-test-a-smart-contract-library/">How to test a library</a>: How Echidna was used to test the library in Set Protocol (blogpost)</li>
<li><a href="program-analysis/echidna/advanced/./testing-bytecode.html">How to test bytecode-only contracts</a>: How to fuzz a contract without bytecode or to perform differential fuzzing between Solidity and Vyper</li>
<li><a href="program-analysis/echidna/advanced/./hevm-cheats-to-test-permit.html">How to use hevm cheats to test permit</a>: How to test code that depends on ecrecover signatures using hevm cheat codes</li>
<li><a href="program-analysis/echidna/advanced/./end-to-end-testing.html">How to seed Echidna with unit tests</a>: How to use existing unit tests to seed Echidna</li>
<li><a href="program-analysis/echidna/advanced/./using-multi-abi.html">Understanding and using <code>multi-abi</code></a>: What is <code>multi-abi</code> testing, and how can it be used</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="collecting-visualizing-and-modifying-an-echidna-corpus"><a class="header" href="#collecting-visualizing-and-modifying-an-echidna-corpus">Collecting, visualizing and modifying an Echidna corpus</a></h1>
<p><strong>Table of contents:</strong></p>
<ul>
<li><a href="program-analysis/echidna/advanced/collecting-a-corpus.html#collecting-visualizing-and-modifying-an-echidna-corpus">Collecting, visualizing and modifying an Echidna corpus</a>
<ul>
<li><a href="program-analysis/echidna/advanced/collecting-a-corpus.html#introduction">Introduction</a></li>
<li><a href="program-analysis/echidna/advanced/collecting-a-corpus.html#collecting-a-corpus">Collecting a corpus</a></li>
<li><a href="program-analysis/echidna/advanced/collecting-a-corpus.html#seeding-a-corpus">Seeding a corpus</a></li>
</ul>
</li>
</ul>
<h2 id="introduction-5"><a class="header" href="#introduction-5">Introduction</a></h2>
<p>We will see how to collect and use a corpus of transactions with Echidna. The target is the following smart contract (<em><a href="program-analysis/echidna/advanced/../example/magic.sol">../example/magic.sol</a></em>):</p>
<pre><code class="language-Solidity">contract C {
  bool value_found = false;
  function magic(uint magic_1, uint magic_2, uint magic_3, uint magic_4) public {
    require(magic_1 == 42);
    require(magic_2 == 129);
    require(magic_3 == magic_4+333);
    value_found = true;
    return;
  }

  function echidna_magic_values() public returns (bool) {
    return !value_found;
  }

}
</code></pre>
<p>This small example forces Echidna to find certain values to change a state variable. This is hard for a fuzzer
(it is recommended to use a symbolic execution tool like <a href="https://github.com/trailofbits/manticore">Manticore</a>).
We can run Echidna to verify this:</p>
<pre><code>$ echidna-test magic.sol 
...

echidna_magic_values: passed! 🎉

Seed: 2221503356319272685
</code></pre>
<p>However, we can still use Echidna to collect corpus when running this fuzzing campaign.</p>
<h2 id="collecting-a-corpus"><a class="header" href="#collecting-a-corpus">Collecting a corpus</a></h2>
<p>To enable the corpus collection, create a corpus directory:</p>
<pre><code>$ mkdir corpus-magic
</code></pre>
<p>And an <a href="https://github.com/crytic/echidna/wiki/Config">Echidna configuration file</a> <code>config.yaml</code>:</p>
<pre><code class="language-yaml">corpusDir: &quot;corpus-magic&quot;
</code></pre>
<p>Now we can run our tool and check the collected corpus:</p>
<pre><code>$ echidna-test magic.sol --config config.yaml 
</code></pre>
<p>Echidna still cannot find the correct magic value. We can verify where it gets stuck reviewing the <code>corpus-magic/covered.*.txt</code> file:</p>
<pre><code>r   |contract C {
  bool value_found = false;
r   |  function magic(uint magic_1, uint magic_2, uint magic_3, uint magic_4) public {
r   |    require(magic_1 == 42);
r   |    require(magic_2 == 129);
r   |    require(magic_3 == magic_4+333);
    value_found = true;
    return;
  }

  function echidna_magic_values() public returns (bool) {
    return !value_found;
  }

}
</code></pre>
<p>The label <code>r</code> on the left of each line shows that Echidna is able to reach these lines but it ends in a revert. 
As you can see, the fuzzer gets stuck at the last <code>require</code>.</p>
<p>To find a workaround, let's take a look at the corpus it collected. For instance, one of these files was:</p>
<pre><code class="language-json">[
   {
      &quot;_gas'&quot; : &quot;0xffffffff&quot;,
      &quot;_delay&quot; : [
         &quot;0x13647&quot;,
         &quot;0xccf6&quot;
      ],
      &quot;_src&quot; : &quot;00a329c0648769a73afac7f9381e08fb43dbea70&quot;,
      &quot;_dst&quot; : &quot;00a329c0648769a73afac7f9381e08fb43dbea72&quot;,
      &quot;_value&quot; : &quot;0x0&quot;,
      &quot;_call&quot; : {
         &quot;tag&quot; : &quot;SolCall&quot;,
         &quot;contents&quot; : [
            &quot;magic&quot;,
            [
               {
                  &quot;contents&quot; : [
                     256,
                     &quot;93723985220345906694500679277863898678726808528711107336895287282192244575836&quot;
                  ],
                  &quot;tag&quot; : &quot;AbiUInt&quot;
               },
               {
                  &quot;contents&quot; : [
                     256,
                     &quot;334&quot;
                  ],
                  &quot;tag&quot; : &quot;AbiUInt&quot;
               },
               {
                  &quot;contents&quot; : [
                     256,
                     &quot;68093943901352437066264791224433559271778087297543421781073458233697135179558&quot;
                  ],
                  &quot;tag&quot; : &quot;AbiUInt&quot;
               },
               {
                  &quot;tag&quot; : &quot;AbiUInt&quot;,
                  &quot;contents&quot; : [
                     256,
                     &quot;332&quot;
                  ]
               }
            ]
         ]
      },
      &quot;_gasprice'&quot; : &quot;0xa904461f1&quot;
   }
]
</code></pre>
<p>Clearly, this input will not trigger the failure in our property. In the next step, we will see how to modify it for that.</p>
<h2 id="seeding-a-corpus"><a class="header" href="#seeding-a-corpus">Seeding a corpus</a></h2>
<p>Echidna needs some help in order to deal with the <code>magic</code> function. We are going to copy and modify the input to use suitable
parameters for it:</p>
<pre><code>$ cp corpus-magic/coverage/2712688662897926208.txt corpus-magic/coverage/new.txt
</code></pre>
<p>We will modify <code>new.txt</code> to call <code>magic(42,129,333,0)</code>. Now, we can re-run Echidna:</p>
<pre><code>$ echidna-test magic.sol --config config.yaml 
...
echidna_magic_values: failed!💥  
  Call sequence:
    magic(42,129,333,0)


Unique instructions: 142
Unique codehashes: 1
Seed: -7293830866560616537

</code></pre>
<p>This time, the property is violated immediately. We can verify that another <code>covered.*.txt</code> file is created showing another trace (labeled with <code>*</code>) that Echidna executed which finished with a return at the end of the <code>magic</code> function.</p>
<pre><code>*r  |contract C {
  bool value_found = false;
*r  |  function magic(uint magic_1, uint magic_2, uint magic_3, uint magic_4) public {
*r  |    require(magic_1 == 42);
*r  |    require(magic_2 == 129);
*r  |    require(magic_3 == magic_4+333);
*   |    value_found = true;
    return;
  }

  function echidna_magic_values() public returns (bool) {
    return !value_found;
  }

}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="using-optimization-mode-to-find-local-maximums"><a class="header" href="#using-optimization-mode-to-find-local-maximums">Using optimization mode to find local maximums</a></h1>
<p><strong>Table of contents:</strong></p>
<ul>
<li><a href="program-analysis/echidna/advanced/optimization_mode.html#using-optimization-mode-to-find-local-maximums">Using optimization mode to find local maximums</a>
<ul>
<li><a href="program-analysis/echidna/advanced/optimization_mode.html#introduction">Introduction</a></li>
<li><a href="program-analysis/echidna/advanced/optimization_mode.html#optimizing-with-echidna">Optimizing with Echidna</a></li>
</ul>
</li>
</ul>
<h2 id="introduction-6"><a class="header" href="#introduction-6">Introduction</a></h2>
<p>We will see how to perform function optimization using Echidna. This tutorial will require Echidna 2.0.5 or greater, 
so make sure you have update it before starting.</p>
<p>Optimization mode is a experimental feature that allows to define a special function which takes no arguments 
and returns a <code>int256</code>. Echidna will try find a sequence of transactions to maximize the value returned:</p>
<pre><code class="language-solidity">    function echidna_opt_function() public view returns (int256) {
        // if it reverts, Echidna will assumed it returned type(int256).min
        return ..;
    }
</code></pre>
<h2 id="optimizing-with-echidna"><a class="header" href="#optimizing-with-echidna">Optimizing with Echidna</a></h2>
<p>In this example, the target is the following smart contract (<em><a href="program-analysis/echidna/advanced/../example/opt.sol">../example/opt.sol</a></em>):</p>
<pre><code class="language-solidity">contract TestDutchAuctionOptimization {
    int256 maxPriceDifference;

    function setMaxPriceDifference(
        uint256 startPrice,
        uint256 endPrice,
        uint256 startTime,
        uint256 endTime
    ) public {
        if (endTime &lt; (startTime + 900)) {
            revert();
        }
        if (startPrice &lt;= endPrice) {
            revert();
        }
        uint256 numerator = (startPrice - endPrice) *
            (block.timestamp - startTime);
        uint256 denominator = endTime - startTime;
        uint256 stepDecrease = numerator / denominator;
        uint256 currentAuctionPrice = startPrice - stepDecrease;
        if (currentAuctionPrice &lt; endPrice) {
            maxPriceDifference = int256(endPrice - currentAuctionPrice);
        }
        if (currentAuctionPrice &gt; startPrice) {
            maxPriceDifference = int256(currentAuctionPrice - startPrice);
        }
    }

    function echidna_opt_price_difference() public view returns (int256) {
        return maxPriceDifference;
    }
}
</code></pre>
<p>This small example forces Echidna to maximize certain price difference given some preconditions. If the preconditions are not
met, the function will revert, without changing the actual value.</p>
<p>To run this example:</p>
<pre><code>$ echidna-test opt.sol --test-mode optimization --test-limit 100000 --seq-len 1 --corpus-dir corpus --shrink-limit 50000
...
echidna_opt_price_difference: max value: 1076841

  Call sequence, shrinking (42912/50000):
    setMaxPriceDifference(1349752405,1155321,609,1524172858) Time delay: 603902 seconds Block delay: 21

</code></pre>
<p>The resulting max value is not unique, running in longer campaign will likely result in a larger value.</p>
<p>Regarding the command line, the optimization mode is enabled using <code>--test-mode optimization</code>. additionally, we included the following tweaks: </p>
<ol>
<li>Use only one transaction (we know that the function is stateless)</li>
<li>Use a large shrink limit in order to obtain a better value during the minimization of the complexity of the input.</li>
</ol>
<p>Every time Echidna is executed using the corpus directory, the last input that produces the maximum value should be re-used from the <code>reproducers</code> directory:</p>
<pre><code>$ echidna-test opt.sol --test-mode optimization --test-limit 100000 --seq-len 1 --corpus-dir corpus --shrink-limit 50000
Loaded total of 1 transactions from corpus/reproducers/
Loaded total of 9 transactions from corpus/coverage/
Analyzing contract: /home/g/Code/echidna/opt.sol:TestDutchAuctionOptimization
echidna_opt_price_difference: max value: 1146878

  Call sequence:
    setMaxPriceDifference(1538793592,1155321,609,1524172858) Time delay: 523701 seconds Block delay: 49387
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="finding-transactions-with-high-gas-consumption"><a class="header" href="#finding-transactions-with-high-gas-consumption">Finding transactions with high gas consumption</a></h1>
<p><strong>Table of contents:</strong></p>
<ul>
<li><a href="program-analysis/echidna/advanced/finding-transactions-with-high-gas-consumption.html#finding-transactions-with-high-gas-consumption">Finding transactions with high gas consumption</a>
<ul>
<li><a href="program-analysis/echidna/advanced/finding-transactions-with-high-gas-consumption.html#introduction">Introduction</a></li>
<li><a href="program-analysis/echidna/advanced/finding-transactions-with-high-gas-consumption.html#measuring-gas-consumption">Measuring Gas Consumption</a></li>
</ul>
</li>
<li><a href="program-analysis/echidna/advanced/finding-transactions-with-high-gas-consumption.html#run-echidna">Run Echidna</a></li>
<li><a href="program-analysis/echidna/advanced/finding-transactions-with-high-gas-consumption.html#filtering-out-gas-reducing-calls">Filtering Out Gas-Reducing Calls</a>
<ul>
<li><a href="program-analysis/echidna/advanced/finding-transactions-with-high-gas-consumption.html#summary-finding-transactions-with-high-gas-consumption">Summary: Finding transactions with high gas consumption</a></li>
</ul>
</li>
</ul>
<h2 id="introduction-7"><a class="header" href="#introduction-7">Introduction</a></h2>
<p>We will see how to find the transactions with high gas consumption with Echidna. The target is the following smart contract (<em><a href="program-analysis/echidna/advanced/../example/gas.sol">../example/gas.sol</a></em>):</p>
<pre><code class="language-solidity">contract C {
  uint state;

  function expensive(uint8 times) internal {
    for(uint8 i=0; i &lt; times; i++)
      state = state + i;
  }

  function f(uint x, uint y, uint8 times) public {
    if (x == 42 &amp;&amp; y == 123)
      expensive(times);
    else
      state = 0;
  }

  function echidna_test() public returns (bool) {
    return true;
  }

}
</code></pre>
<p>Here <code>expensive</code> can have a large gas consumption. </p>
<p>Currently, Echidna always needs a property to test: here <code>echidna_test</code> always returns <code>true</code>.
We can run Echidna to verify this:</p>
<pre><code>$ echidna-test gas.sol
...
echidna_test: passed! 🎉

Seed: 2320549945714142710
</code></pre>
<h2 id="measuring-gas-consumption"><a class="header" href="#measuring-gas-consumption">Measuring Gas Consumption</a></h2>
<p>To enable Echidna's gas consumption feature, create a configuration file <a href="program-analysis/echidna/advanced/../example/gas.yaml"><code>../example/gas.yaml</code></a>:</p>
<pre><code class="language-yaml">estimateGas: true
</code></pre>
<p>In this example, we will also reduce the size of the transaction sequence to make the results easier to understand: </p>
<pre><code class="language-yaml">seqLen: 2
estimateGas: true
</code></pre>
<h1 id="run-echidna-3"><a class="header" href="#run-echidna-3">Run Echidna</a></h1>
<p>Once we have the configuration file created, we can run Echidna like this:</p>
<pre><code>$ echidna-test gas.sol --config config.yaml 
...
echidna_test: passed! 🎉

f used a maximum of 1333608 gas
  Call sequence:
    f(42,123,249) Gas price: 0x10d5733f0a Time delay: 0x495e5 Block delay: 0x88b2

Unique instructions: 157
Unique codehashes: 1
Seed: -325611019680165325

</code></pre>
<ul>
<li>The gas shown is an estimation provided by <a href="https://github.com/dapphub/dapptools/tree/master/src/hevm#hevm-">HEVM</a>.</li>
</ul>
<h1 id="filtering-out-gas-reducing-calls"><a class="header" href="#filtering-out-gas-reducing-calls">Filtering Out Gas-Reducing Calls</a></h1>
<p>The tutorial on <a href="program-analysis/echidna/advanced/../basic/filtering-functions.html">filtering functions to call during a fuzzing campaign</a> shows how to
remove some functions during testing.<br />
This can be critical for getting an accurate gas estimate.
Consider the following example (<em><a href="program-analysis/echidna/advanced/../example/pushpop.sol">example/pushpop.sol</a></em>):</p>
<pre><code class="language-solidity">contract C {
  address [] addrs;
  function push(address a) public {
    addrs.push(a);
  }
  function pop() public {
    addrs.pop();
  }
  function clear() public{
    addrs.length = 0;
  }
  function check() public{
    for(uint256 i = 0; i &lt; addrs.length; i++)
      for(uint256 j = i+1; j &lt; addrs.length; j++)
        if (addrs[i] == addrs[j])
          addrs[j] = address(0x0);
  }
  function echidna_test() public returns (bool) {
      return true;
  }
}
</code></pre>
<p>If Echidna uses this <a href="program-analysis/echidna/advanced/../example/pushpop.yaml"><code>config.yaml</code></a>, it can call all functions and won't easily find transactions with high gas cost:</p>
<pre><code>$ echidna-test pushpop.sol --config config.yaml
...
pop used a maximum of 10746 gas
...
check used a maximum of 23730 gas
...
clear used a maximum of 35916 gas
...
push used a maximum of 40839 gas
</code></pre>
<p>That's because the cost depends on the size of <code>addrs</code> and random calls tend to leave the array almost empty.
Blacklisting <code>pop</code> and <code>clear</code>, however, gives us much better results (<em><a href="program-analysis/echidna/advanced/../example/blacklistpushpop.yaml">../example/blacklistpushpop.yaml</a></em>):</p>
<pre><code class="language-yaml">estimateGas: true
filterBlacklist: true
filterFunctions: [&quot;C.pop()&quot;, &quot;C.clear()&quot;]
</code></pre>
<pre><code>$ echidna-test pushpop.sol --config config.yaml
...
push used a maximum of 40839 gas
...
check used a maximum of 1484472 gas
</code></pre>
<h2 id="summary-finding-transactions-with-high-gas-consumption"><a class="header" href="#summary-finding-transactions-with-high-gas-consumption">Summary: Finding transactions with high gas consumption</a></h2>
<p>Echidna can find transactions with high gas consumption using the <code>estimateGas</code> configuration option:</p>
<pre><code class="language-yaml">estimateGas: true
</code></pre>
<pre><code class="language-bash">$ echidna-test contract.sol --config config.yaml 
...
</code></pre>
<p>Once the fuzzing campaign is over, Echidna will report a sequence with the maximum gas consumption for every function.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="smart-contract-fuzzing-at-scale-with-echidna"><a class="header" href="#smart-contract-fuzzing-at-scale-with-echidna">Smart contract Fuzzing at scale with Echidna</a></h1>
<p>In this tutorial we will review how we can create a dedicated server for fuzzing smart contracts using Echidna.</p>
<h3 id="workflow"><a class="header" href="#workflow">Workflow:</a></h3>
<ol>
<li>Install and setup a dedicated server</li>
<li>Start a short fuzzing campaign</li>
<li>Start a continuous fuzzing campaign</li>
<li>Add properties, check coverage and modify the code if necessary</li>
<li>Ending the campaign </li>
</ol>
<h2 id="1-install-and-setup-a-dedicated-server"><a class="header" href="#1-install-and-setup-a-dedicated-server">1. Install and setup a dedicated server</a></h2>
<p>First, obtain a dedicated server with at least 32 GB of RAM and as many cores as possible. Start by creating a user for the fuzzing campaign. 
<strong>Only use the root acount to create an unprivileged user</strong>: </p>
<pre><code># adduser echidna
# usermod -aG sudo echidna
</code></pre>
<p>Then, using that user (<code>echidna</code>), install some basic dependencies:</p>
<pre><code>$ sudo apt install unzip python3-pip
</code></pre>
<p>Then install everything necessary to build your smart contract(s) as well <code>slither</code> and <code>echidna-parade</code>. For instance:</p>
<pre><code>$ pip3 install solc-select
$ solc-select install all
$ pip3 install slither_analyzer
$ pip3 install echidna_parade
</code></pre>
<p>Add <code>$PATH=$PATH:/home/echidna/.local/bin</code> at the end of <code>/home/echidna/.bashrc</code></p>
<p>Next, install Echidna. The easiest way is to download the latest precompiled Echidna release, uncompress it, and move it to <code>/home/echidna/.local/bin</code>:</p>
<pre><code>$ wget &quot;https://github.com/crytic/echidna/releases/download/v2.0.0/echidna-test-2.0.0-Ubuntu-18.04.tar.gz&quot;
$ tar -xf echidna-test-2.0.0-Ubuntu-18.04.tar.gz
$ mv echidna-test /home/echidna/.local/bin
</code></pre>
<h2 id="2-start-a-short-fuzzing-campaign"><a class="header" href="#2-start-a-short-fuzzing-campaign">2. Start a short fuzzing campaign</a></h2>
<p>Select a contract to test and provide an initialization if needed. It does not have to be perfect, just start with some basic stuff and iterate over the result.
Before starting this campaign, modify your echidna config to define a corpus directory to use. For instance:</p>
<pre><code>corpusDir: &quot;corpus-exploration&quot;
</code></pre>
<p>This directory will be automatically created but since we are starting a new campaign, <strong>please remove the corpus directory if it was created by a previous echidna campaign</strong>. 
If you don't have any properties to test, you can use:</p>
<pre><code>testMode: exploration
</code></pre>
<p>to allow Echidna to run without any properties. </p>
<p>We will start a very short Echidna run (5 minutes), to check that everything looks fine. To do that, use the following config:</p>
<pre><code>testLimit: 100000000000
timeout: 300 # 5 minutes
</code></pre>
<p>After it runs, check the coverage file, located in <code>corpus-exploration/covered.*.txt</code>. If the initialization is wrong, <strong>clean the <code>corpus-exploration</code> directory</strong> and restart the campaign.</p>
<h2 id="3-starting-a-continuous-fuzzing-campaign"><a class="header" href="#3-starting-a-continuous-fuzzing-campaign">3. Starting a continuous fuzzing campaign</a></h2>
<p>When you are satisfied with the first iteration of the initialization, we can start a &quot;continuous campaign&quot; for exploration and testing using <a href="https://github.com/agroce/echidna-parade">echidna-parade</a>. Before starting, double check your config file. For instance, if you added properties, do not forget to remove <code>benchmarkMode</code>.</p>
<p><code>echidna-parade</code> is a tool is used to launch multiple Echidna instances at the same time, keeping track of the corpora of each one. Each instance will be configured to run for a certain amount of time, with different parameters, in order to maximize the chance to reach new code.</p>
<p>We will show it with an example, where:</p>
<ul>
<li>the initial corpus is empty</li>
<li>the base config file will be <code>exploration.yaml</code></li>
<li>the time to run the initial instance will be 3600 seconds (1 hour)</li>
<li>the time to run each &quot;generation&quot; will be 1800 seconds (30 minutes)</li>
<li>the campaign will run in continuous mode (if timeout is -1, it means run forever)</li>
<li>the number of Echidna instances per generation will be 8. This should be adjusted according to the number of available cores, but avoid using all your cores if you don't want to kill your server</li>
<li>the target contract is named <code>C</code></li>
<li>the file that contains the contract is <code>test.sol</code></li>
</ul>
<p>Finally, we will log the stdout and stderr in <code>parade.log</code> and <code>parade.err</code> and fork the process to let it run forever. </p>
<pre><code>$ echidna-parade test.sol --config exploration.yaml --initial_time 3600 --gen_time 1800 --timeout -1 --ncores 8 --contract C &gt; parade.log 2&gt; parade.err &amp;
</code></pre>
<p><strong>After you run this command, exit the shell so you won't kill it accidentally if your connection fails.</strong></p>
<h2 id="4-add-more-properties-check-coverage-and-modify-the-code-if-necessary"><a class="header" href="#4-add-more-properties-check-coverage-and-modify-the-code-if-necessary">4. Add more properties, check coverage and modify the code if necessary</a></h2>
<p>In this step, we can add more properties while Echidna is exploring the contracts. Keep in mind that you should avoid changing the ABI of the contracts 
(otherwise the quality of the corpus will degrade). </p>
<p>Also, we can tweak the code to improve coverage, but before starting that, we need to know how to monitor our fuzzing campaign. We can use this command:</p>
<pre><code>$ watch &quot;grep 'COLLECTING NEW COVERAGE' parade.log | tail -n 30&quot;
</code></pre>
<p>When new coverage is found, you will see something like this:</p>
<pre><code>COLLECTING NEW COVERAGE: parade.181140/gen.30.10/corpus/coverage/-3538310549422809236.txt
COLLECTING NEW COVERAGE: parade.181140/gen.35.9/corpus/coverage/5960152130200926175.txt
COLLECTING NEW COVERAGE: parade.181140/gen.35.10/corpus/coverage/3416698846701985227.txt
COLLECTING NEW COVERAGE: parade.181140/gen.36.6/corpus/coverage/-3997334938716772896.txt
COLLECTING NEW COVERAGE: parade.181140/gen.37.7/corpus/coverage/323061126212903141.txt
COLLECTING NEW COVERAGE: parade.181140/gen.37.6/corpus/coverage/6733481703877290093.txt
</code></pre>
<p>you can verify the corresponding covered file, such as <code>parade.181140/gen.37.6/corpus/covered.1615497368.txt</code>. </p>
<p>For examples on how to help Echidna to improve its coverage, please review the <a href="program-analysis/echidna/advanced/./collecting-a-corpus.html">improving coverage tutorial</a>.</p>
<p>To monitor failed properties, use this command:</p>
<pre><code>$ watch &quot;grep 'FAIL' parade.log | tail -n 30&quot;
</code></pre>
<p>When failed properties are found, you will see something like this:</p>
<pre><code>NEW FAILURE: assertion in f: failed!💥
parade.181140/gen.179.0 FAILED
parade.181140/gen.179.3 FAILED
parade.181140/gen.180.2 FAILED
parade.181140/gen.180.4 FAILED
parade.181140/gen.180.3 FAILED
...
</code></pre>
<h2 id="4-ending-the-campaign"><a class="header" href="#4-ending-the-campaign">4. Ending the campaign</a></h2>
<p>When you are satisfied with the coverage results, you can terminate the continuous campaign using:</p>
<pre><code>$ killall echidna-parade echidna
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-test-bytecode-only-contracts"><a class="header" href="#how-to-test-bytecode-only-contracts">How to test bytecode only contracts</a></h1>
<p><strong>Table of contents:</strong></p>
<ul>
<li><a href="program-analysis/echidna/advanced/testing-bytecode.html#how-to-test-bytecode-only-contracts">How to test bytecode only contracts</a>
<ul>
<li><a href="program-analysis/echidna/advanced/testing-bytecode.html#introduction">Introduction</a></li>
<li><a href="program-analysis/echidna/advanced/testing-bytecode.html#proxy-pattern">Proxy pattern</a></li>
<li><a href="program-analysis/echidna/advanced/testing-bytecode.html#run-echidna">Run Echidna</a>
<ul>
<li><a href="program-analysis/echidna/advanced/testing-bytecode.html#target-source-code">Target source code</a></li>
</ul>
</li>
<li><a href="program-analysis/echidna/advanced/testing-bytecode.html#differential-fuzzing">Differential fuzzing</a></li>
<li><a href="program-analysis/echidna/advanced/testing-bytecode.html#generic-proxy-code">Generic Proxy code</a></li>
<li><a href="program-analysis/echidna/advanced/testing-bytecode.html#summary-testing-contracts-without-source-code">Summary: Testing contracts without source code</a></li>
</ul>
</li>
</ul>
<h2 id="introduction-8"><a class="header" href="#introduction-8">Introduction</a></h2>
<p>We will see how to fuzz a contract without any provided source code. 
The technique can also be used to perform differential fuzzing (i.e. compare multiple implementations) between a Solidity contract and a Vyper contract.</p>
<p>Consider the following bytecode:</p>
<pre><code>608060405234801561001057600080fd5b506103e86000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506103e86001819055506101fa8061006e6000396000f3fe608060405234801561001057600080fd5b50600436106100415760003560e01c806318160ddd1461004657806370a0823114610064578063a9059cbb146100bc575b600080fd5b61004e61010a565b6040518082815260200191505060405180910390f35b6100a66004803603602081101561007a57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610110565b6040518082815260200191505060405180910390f35b610108600480360360408110156100d257600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919080359060200190929190505050610128565b005b60015481565b60006020528060005260406000206000915090505481565b806000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282540392505081905550806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282540192505081905550505056fe
</code></pre>
<p>For which we only know the ABI:</p>
<pre><code class="language-solidity">interface Target{
  function totalSupply() external returns(uint);
  function balanceOf(address) external returns(uint);
  function transfer(address, uint) external;
}
</code></pre>
<p>We want to test if it is possible to have more tokens than the total supply.</p>
<h2 id="proxy-pattern"><a class="header" href="#proxy-pattern">Proxy pattern</a></h2>
<p>Because we don't have the source code, we cannot directly add the property in the contract.
Instead we will use a proxy contract:</p>
<pre><code class="language-solidity">interface Target{
  function totalSupply() external returns(uint);
  function balanceOf(address) external returns(uint);
  function transfer(address, uint) external;
}

contract TestBytecodeOnly{
    Target t;

    constructor() public{
        address target_addr;
        // init bytecode
        bytes memory target_bytecode = hex&quot;608060405234801561001057600080fd5b506103e86000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506103e86001819055506101fa8061006e6000396000f3fe608060405234801561001057600080fd5b50600436106100415760003560e01c806318160ddd1461004657806370a0823114610064578063a9059cbb146100bc575b600080fd5b61004e61010a565b6040518082815260200191505060405180910390f35b6100a66004803603602081101561007a57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610110565b6040518082815260200191505060405180910390f35b610108600480360360408110156100d257600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919080359060200190929190505050610128565b005b60015481565b60006020528060005260406000206000915090505481565b806000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282540392505081905550806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282540192505081905550505056fe&quot;;

        uint size = target_bytecode.length;

        assembly{
            target_addr := create(0, 0xa0, size) // 0xa0 was manually computed. It might require different value according to the compiler version
        }
        t = Target(target_addr);
    }

    function transfer(address to, uint amount) public {
        t.transfer(to, amount);
    }

    function echidna_test_balance() public returns(bool){
        return t.balanceOf(address(this)) &lt;= t.totalSupply();
    }
}
</code></pre>
<p>The proxy:</p>
<ul>
<li>Deploys the bytecode in its constructor</li>
<li>Has one function that will call the target's <code>transfer</code> function</li>
<li>Has one Echidna property <code>t.balanceOf(address(this)) &lt;= t.totalSupply()</code></li>
</ul>
<h2 id="run-echidna-4"><a class="header" href="#run-echidna-4">Run Echidna</a></h2>
<pre><code class="language-bash">$ echidna-test bytecode_only.sol --contract TestBytecodeOnly
echidna_test_balance: failed!💥  
  Call sequence:
    transfer(0x0,1002)
</code></pre>
<p>Here Echidna found that by calling <code>transfer(0, 1002)</code> anyone can mint tokens. </p>
<h3 id="target-source-code"><a class="header" href="#target-source-code">Target source code</a></h3>
<p>The actual source code of the target is:</p>
<pre><code class="language-solidity">contract C{
    mapping(address =&gt; uint) public balanceOf;
    uint public totalSupply;

    constructor() public{
        balanceOf[msg.sender] = 1000;
        totalSupply = 1000;
    }

    function transfer(address to, uint amount) public{
        balanceOf[msg.sender] -= amount;
        balanceOf[to] += amount;
    }
}
</code></pre>
<p>Echidna correctly found the bug: lack of overflow checks in <code>transfer</code>.</p>
<h2 id="differential-fuzzing"><a class="header" href="#differential-fuzzing">Differential fuzzing</a></h2>
<p>Consider the following Vyper and Solidity contracts:</p>
<pre><code class="language-vyper">@view
@external
def my_func(a: uint256, b: uint256, c: uint256) -&gt; uint256:
    return a * b / c
</code></pre>
<pre><code class="language-solidity">contract SolidityVersion{
    function my_func(uint a, uint b, uint c) view public{
        return a * b / c;
    }
}
</code></pre>
<p>We can test that they return always the same values using the proxy pattern:</p>
<pre><code class="language-solidity">interface Target{
  function my_func(uint, uint, uint) external returns(uint);
}

contract SolidityVersion{
    Target t;

    constructor() public{
        address target_addr;

        // vyper bytecode
        bytes memory target_bytecode = hex&quot;61007756341561000a57600080fd5b60043610156100185761006d565b600035601c52630ff198a3600051141561006c57600435602435808202821582848304141761004657600080fd5b80905090509050604435808061005b57600080fd5b82049050905060005260206000f350005b5b60006000fd5b61000461007703610004600039610004610077036000f3&quot;;

        uint size = target_bytecode.length;

        assembly{
            target_addr := create(0, 0xa0, size) // 0xa0 was manually computed. It might require different value according to the compiler version
        }
        t = Target(target_addr);
    }

    function test(uint a, uint b, uint c) public returns(bool){
        assert(my_func(a, b, c) == t.my_func(a, b, c));
    }

    function my_func(uint a, uint b, uint c) view internal returns(uint){
        return a * b / c;
    }
}
</code></pre>
<p>Here we run Echidna with the <a href="program-analysis/echidna/advanced/../basic/assertion-checking.html">assertion mode</a>:</p>
<pre><code>$ echidna-test  vyper.sol --config config.yaml --contract SolidityVersion --test-mode assertion
assertion in test: passed! 🎉
</code></pre>
<h2 id="generic-proxy-code"><a class="header" href="#generic-proxy-code">Generic Proxy code</a></h2>
<p>Adapt the following code to your needs:</p>
<pre><code class="language-solidity">interface Target{
  // public/external functions
}

contract TestBytecodeOnly{
    Target t;

    constructor() public{
        address target_addr;
        // init bytecode
        bytes memory target_bytecode = hex&quot;&quot;;

        uint size = target_bytecode.length;

        assembly{
            target_addr := create(0, 0xa0, size) // 0xa0 was manually computed. It might require different value according to the compiler version
        }
        t = Target(target_addr);
    }

    // Add helper functions to call the target's functions from the proxy

    function echidna_test() public returns(bool){
      // The property to test
    }
}
</code></pre>
<h2 id="summary-testing-contracts-without-source-code"><a class="header" href="#summary-testing-contracts-without-source-code">Summary: Testing contracts without source code</a></h2>
<p>Echidna can fuzz contracts without source code using a proxy contract. This technique can be also used to compare implementations written in Solidity and Vyper.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="using-hevm-cheats-to-test-permit"><a class="header" href="#using-hevm-cheats-to-test-permit">Using HEVM Cheats To Test Permit</a></h1>
<h2 id="introduction-9"><a class="header" href="#introduction-9">Introduction</a></h2>
<p><a href="https://eips.ethereum.org/EIPS/eip-2612">EIP 2612</a> introduces the function <code>permit(address owner, address spender, uint value, uint deadline, uint8 v, bytes32 r, bytes32 s)</code> to the ERC20 abi. This function essentially takes in signature parameters generated through ECDSA combined with the <a href="https://eips.ethereum.org/EIPS/eip-712">EIP 712</a> standard for typed data hashing, and recovers the author of the signature through <code>ecrecover()</code>. It then sets <code>allowances[owner][spender]</code> to <code>value</code>.</p>
<h2 id="uses"><a class="header" href="#uses">Uses</a></h2>
<p>This is a new way of allocating allowances, as signatures can be computed offchain and passed to a contract. This allows a relayer to pay the entire gas fee of the permit transaction in exchange for a fee and thus allows completely gasless transactions for a user. Furthermore this removes the typical <code>approve() -&gt; transferFrom()</code> pattern that forces users to send two transactions instead of just one via this new method.</p>
<p>Do note that for the permit function to work, a valid signature is needed. This example will show how we can use <a href="https://github.com/dapphub/dapptools/blob/master/src/hevm/README.md#cheat-codes"><code>hevm</code>'s <code>sign</code> cheatcode</a> to sign data with a private key. More generally, you can use this cheatcode to test anything that requires valid signatures.</p>
<h2 id="example-25"><a class="header" href="#example-25">Example</a></h2>
<p>We use solmate’s implementation of the ERC20 standard that includes the permit function. Notice that there are also values for the <code>PERMIT_TYPEHASH</code> and a <code>mapping(address -&gt; uint256) public nonces</code> , the former is a part of the EIP712 standard and the latter is used to prevent signature replay attacks. </p>
<p>In our <code>TestDepositWithPermit</code> contract, we need to have the signature signed by an owner for validation. To do this, we can use <code>hevm</code>’s <code>sign</code> cheatcode, which takes in a message and a private key and creates a valid signature. For this example, we use the private key <code>0x02</code> and the following signed message, which essentially represents the permit signature following EIP 712:</p>
<pre><code class="language-solidity">    keccak256(
        abi.encodePacked(
                &quot;\x19\x01&quot;,
                asset.DOMAIN_SEPARATOR(),
                keccak256(
                    abi.encode(
                        keccak256(
                            &quot;Permit(address owner,address spender,uint256 value,uint256 nonce,uint256 deadline)&quot;
                        ),
                        owner,
                        spender,
                        assetAmount,
                        asset.nonces(owner),
                        block.timestamp
                    )
                )
            )
        );
</code></pre>
<p>The helper function <code>getSignature(address owner, address spender, uint256 assetAmount)</code> returns a valid signature generated via the <code>sign</code> cheatcode. Note that the sign cheatcode leaks the private key and thus it is best to use dummy keys when testing. Our keypair data was taken from <a href="https://privatekeys.pw/keys/ethereum/1">this site</a>. Now to test out the signature, we will mint a random amount to the <code>OWNER</code> address, the address corresponding to private key <code>0x02</code>, which was the signer of the permit signature. We then see if we can use that signature to transfer the owner’s tokens to ourselves. </p>
<p>First we will call <code>permit()</code> on our Mock ERC20 token with the signature generated in <code>getSignature()</code>, and then call <code>transferFrom()</code>. If our permit request and transfer was successful, our balance of the mock ERC20 should be increased by the amount permitted and <code>OWNER</code>'s balance should decrease as well. For simplicity, we'll transfer all the minted tokens so that <code>OWNER</code>'s balance should be <code>0</code>, and our balance should be <code>amount</code>. </p>
<h2 id="code"><a class="header" href="#code">Code</a></h2>
<p>The full example code can be found <a href="program-analysis/echidna/advanced/../example/TestDepositWithPermit.sol">here</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="end-to-end-testing-with-echidna-part-i"><a class="header" href="#end-to-end-testing-with-echidna-part-i">End-to-End testing with Echidna (Part I)</a></h1>
<p>When smart contracts require a complex initialization and the time to do it is short, we want to avoid manually recreating a deployment for a fuzzing campaign with Echidna. That's why we have a new approach for testing using Echidna based on the deployments and execution of tests directly from ganache.</p>
<h2 id="requirements"><a class="header" href="#requirements">Requirements:</a></h2>
<p>This approach needs a smart contract project, with the following constraints:</p>
<ul>
<li>It should use Solidity: Vyper is not supported, since Slither/Echidna is not very effective at running these (e.g. no AST is included). </li>
<li>It should have tests or at least, a complete deployment script. </li>
<li>It should work with Slither. If it fails, <a href="https://github.com/crytic/slither">please report the issue</a>.</li>
</ul>
<p>For this tutorial, <a href="https://github.com/truffle-box/drizzle-box">we used the drizzle-box example</a>. </p>
<h2 id="getting-started"><a class="header" href="#getting-started">Getting started:</a></h2>
<p>Before stating, make sure you have the latest releases from <a href="https://github.com/crytic/echidna/releases">Echidna</a> and <a href="https://github.com/crytic/etheno/releases">Etheno</a> installed.</p>
<p>Then, install the packages to compile the project:</p>
<pre><code>$ git clone https://github.com/truffle-box/drizzle-box
$ cd drizzle-box
$ npm i truffle
</code></pre>
<p>If <code>ganache</code> is not installed, add it manually. In our example, we will run: </p>
<pre><code>$ npm -g i ganache
</code></pre>
<p>Other projects using yarn will require:</p>
<pre><code>$ yarn global add ganache
</code></pre>
<p>Ensure that <code>$ ganache --version</code> outputs <code>ganache v7.3.2</code> or greater.</p>
<p>It is also important to select <em>one</em> test script from the available tests. Ideally, this test will deploy all (or most) contracts, including mock/test ones. For this example, we are going to take a look to the <code>SimpleStorage</code> contract:</p>
<pre><code class="language-solidity">contract SimpleStorage {
    event StorageSet(string _message);

    uint256 public storedData;

    function set(uint256 x) public {
        storedData = x;

        emit StorageSet(&quot;Data stored successfully!&quot;);
    }
}
</code></pre>
<p>This small contract allows to set the <code>storedData</code> state variable. As expected, we have a unit test that deploys and tests this contract (<code>simplestorage.js</code>):</p>
<pre><code class="language-js">const SimpleStorage = artifacts.require(&quot;SimpleStorage&quot;);

contract(&quot;SimpleStorage&quot;, accounts =&gt; {
  it(&quot;...should store the value 89.&quot;, async () =&gt; {
    const simpleStorageInstance = await SimpleStorage.deployed();

    // Set value of 89
    await simpleStorageInstance.set(89, { from: accounts[0] });

    // Get stored value
    const storedData = await simpleStorageInstance.storedData.call();

    assert.equal(storedData, 89, &quot;The value 89 was not stored.&quot;);
  });
});
</code></pre>
<h2 id="capturing-transactions"><a class="header" href="#capturing-transactions">Capturing transactions</a></h2>
<p>Before starting to write interesting properties, it is necessary to to collect an Etheno trace to replay it inside Echidna:</p>
<p>First, start Etheno: </p>
<pre><code class="language-bash">$ etheno --ganache --ganache-args=&quot;--miner.blockGasLimit 10000000&quot; -x init.json
</code></pre>
<p>By default the following Ganache arguments are set via Etheno:</p>
<ul>
<li><code>-d</code>: Ganache will use a pre-defined, deterministic seed to create all accounts.</li>
<li><code>--chain.allowUnlimitedContractSize</code>: Allows unlimited contract sizes while debugging. This is set so that there is no size limitations on the contracts that are going to be deployed</li>
<li><code>-p &lt;port_num&gt;</code>: The <code>port_num</code> will be set to (1) the value of <code>--ganache-port</code> or (2) Etheno will choose the smallest port number higher than the port number on which Etheno’s JSON RPC server is running.</li>
</ul>
<p><strong>NOTE:</strong> If you are using Docker to run etheno, the commands should be:</p>
<pre><code class="language-bash">$ docker run -it -p 8545:8545 -v ~/etheno:/home/etheno/ trailofbits/etheno
(you will now be working within the Docker instance)
$ etheno --ganache --ganache-args=&quot;--miner.blockGasLimit 10000000&quot; -x init.json
</code></pre>
<ul>
<li>The <code>-p</code> in the <em>first command</em> publishes (i.e. exposes) port 8545 from inside the Docker container out to port 8545 on the host.</li>
<li>The <code>-v</code> in the <em>first command</em> maps a directory from inside the Docker container to one outside the Docker container. After Etheno exits, the <code>init.json</code> file will now be in the <code>~/etheno</code> folder on the host.</li>
</ul>
<p>Note that if the deployment fails to complete successfully due to a <code>ProviderError: exceeds block gas limit</code> exception, increasing the <code>--miner.blockGasLimit</code> value can help.
This is especially helpful for large contract deployments. Learn more about the various Ganache command-line arguments that can be set by clicking <a href="https://www.npmjs.com/package/ganache">here</a>. </p>
<p>Additionally, if Etheno fails to produce any output, then it failed to execute <code>ganache</code> under-the-hood. Check if <code>ganache</code> (with the associated command-line arguments) can be executed correctly from your terminal without the use of Etheno.</p>
<p>Meanwhile, in another terminal, run <em>one</em> test or the deployment process. How to run it depends on how the project was developed. For instance, for truffle, use:</p>
<pre><code>$ truffle test test/test.js
</code></pre>
<p>for buidler:</p>
<pre><code>$ buidler test test/test.js --network localhost
</code></pre>
<p>In the Drizzle example, we will run:</p>
<pre><code>$ truffle test test/simplestorage.js --network develop.
</code></pre>
<p>After Etheno finishes, gently kill it by using Ctrl+c (or Command+C on Mac). It will save the <code>init.json</code> file. If your test fails for some reason or you want to run a different one, restart Etheno and re-run the test.</p>
<h2 id="writing-and-running-a-property"><a class="header" href="#writing-and-running-a-property">Writing and running a property</a></h2>
<p>Once we have a json file with saved transactions, we can verify that the <code>SimpleStorage</code> contract is deployed at <code>0x871DD7C2B4b25E1Aa18728e9D5f2Af4C4e431f5c</code>, so we can easily write a contract (<code>./contracts/crytic/E2E.sol</code>) with a simple a property to test it:</p>
<pre><code class="language-solidity">import &quot;../SimpleStorage.sol&quot;;

contract E2E {
        SimpleStorage st = SimpleStorage(0x871DD7C2B4b25E1Aa18728e9D5f2Af4C4e431f5c);
        function crytic_const_storage() public returns(bool) {
            return st.storedData() == 89;
        }
}
</code></pre>
<p>For large, multi-contract deployments, using <code>console.log</code> to print out the deployed, contract addresses can be valuable in quickly setting up the Echidna testing contract.</p>
<p>This simple property checks if the stored data remains constant. To run it you will need the following echidna config file (<code>echidna.yaml</code>):</p>
<pre><code class="language-yaml">prefix: crytic_
initialize: init.json
multi-abi: true
cryticArgs: ['--truffle-build-directory', 'app/src/contracts/'] # needed by drizzle
</code></pre>
<p>Then, running Echidna shows the results immediately: </p>
<pre><code>$ echidna-test . --contract E2E --config echidna.yaml
...
crytic_const_storage: failed!💥  
  Call sequence:
    (0x871dd7c2b4b25e1aa18728e9d5f2af4c4e431f5c).set(0) from: 0x0000000000000000000000000000000000010000
</code></pre>
<p>For this last step, make sure you are using <code>.</code> as a target for <code>echidna-test</code>. If you use the path to the <code>E2E.sol</code> file instead, then Echidna will not be able get information from all the deployed contracts to call the <code>set(uint256)</code> function and the property will never fail.</p>
<h2 id="key-considerations"><a class="header" href="#key-considerations">Key considerations:</a></h2>
<p>When using Etheno with Echidna, note that there are two edge cases that may cause unexpected behavior:</p>
<ol>
<li>Function calls that use ether: The accounts that are created and used for testing in Ganache are not the same as the accounts that are used to send transactions in Echidna. Thus, the account balances of the Ganache accounts do not carry over to the accounts used by Echidna. So, if there is a function call logged by Etheno that requires the transfer of some ether from an account that exists in Ganache, this call will fail in Echidna.</li>
<li>Fuzz tests that rely on <code>block.timestamp</code>: The concept of time is different between Ganache and Echidna. Echidna always starts with a fixed timestamp while Etheno will use Ganache's concept of time. This means that assertions or requirements in a fuzz test that rely on timestamp comparisons / evaluations may fail in Echidna. </li>
</ol>
<p>In the next part of this tutorial, we will explore how to easily find where contracts are deployed with a specific tool based on Slither. This will be useful if the deployment process is complex and we need to test an specific contract.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="understanding-and-using-multi-abi-in-echidna"><a class="header" href="#understanding-and-using-multi-abi-in-echidna">Understanding and using <code>multi-abi</code> in Echidna</a></h1>
<p><strong>Table of contents:</strong></p>
<ul>
<li><a href="program-analysis/echidna/advanced/using-multi-abi.html#understanding-and-using-multi-abi-in-echidna">Understanding and using <code>multi-abi</code> in Echidna</a>
<ul>
<li><a href="program-analysis/echidna/advanced/using-multi-abi.html#introduction">Introduction</a></li>
<li><a href="program-analysis/echidna/advanced/using-multi-abi.html#what-is-multi-abi-testing">What is <code>multi-abi</code> testing?</a></li>
<li><a href="program-analysis/echidna/advanced/using-multi-abi.html#when-and-how-to-use-multi-abi">When and how to use <code>multi-abi</code></a></li>
<li><a href="program-analysis/echidna/advanced/using-multi-abi.html#run-echidna">Run Echidna</a>
<ul>
<li><a href="program-analysis/echidna/advanced/using-multi-abi.html#example-run-with-multi-abi-set-to-false">Example run with <code>multi-abi</code> set to <code>false</code></a></li>
<li><a href="program-analysis/echidna/advanced/using-multi-abi.html#example-run-with-multi-abi-set-to-true">Example run with <code>multi-abi</code> set to <code>true</code></a></li>
</ul>
</li>
<li><a href="program-analysis/echidna/advanced/using-multi-abi.html#use-cases-and-conclusions">Use cases and conclusions</a></li>
</ul>
</li>
</ul>
<h2 id="introduction-10"><a class="header" href="#introduction-10">Introduction</a></h2>
<p>This tutorial is written as a hands-on guide to using <code>multi-abi</code> testing in Echidna. You will learn what <code>multi-abi</code> testing is, how to use it in your tests, and what to expect from its usage.</p>
<h2 id="what-is-multi-abi-testing"><a class="header" href="#what-is-multi-abi-testing">What is <code>multi-abi</code> testing?</a></h2>
<p>It is a testing mode that allows Echidna to call functions from any contract not directly under test. The ABI for the contract must be known, and it must have been deployed by the contract under test.</p>
<h2 id="when-and-how-to-use-multi-abi"><a class="header" href="#when-and-how-to-use-multi-abi">When and how to use <code>multi-abi</code></a></h2>
<p>By default, Echidna calls functions from the contract to be analyzed, sending the transactions randomly from addresses <code>0x10000</code>, <code>0x20000</code> and <code>0x30000</code>.</p>
<p>In some systems, the user has to interact with other contracts prior to calling a function on the fuzzed contract. A common example is when you want to provide liquidity to a DeFi protocol, you will first need to approve the protocol for spending your tokens. This transaction has to be initiated from your account before actually interacting with the protocol contract.</p>
<p>A fuzzing campaign meant to test this example protocol contract won't be able to modify users allowances, therefore most of the interactions with the protocol won't be tested correctly.</p>
<p>This is where <code>multi-abi</code> testing is useful: It allows Echidna to call functions from other contracts (not just from the contract under test), sending the transactions from the same accounts that will interact with the target contract.</p>
<h2 id="run-echidna-5"><a class="header" href="#run-echidna-5">Run Echidna</a></h2>
<p>We will use a simple example to show how <code>multi-abi</code> works. We will be using two contracts, <code>Flag</code> and <code>EchidnaTest</code>, both available in <a href="program-analysis/echidna/advanced/../example/multiabi.sol"><code>../example/multiabi.sol</code></a>.</p>
<p>The <code>Flag</code> contract contains a boolean flag that is only set if <code>flip()</code> is called, and a getter function that returns the value of the flag. For now, ignore <code>test_fail()</code>, we will talk about this function later.</p>
<pre><code class="language-solidity">contract Flag {

   bool flag = false;

   function flip() public {
       flag = !flag;
   }

   function get() public returns (bool) {
        return flag;
   }

   function test_fail() public {
       assert(false);
   }
}
</code></pre>
<p>The test harness will instantiate a new <code>Flag</code>, and the invariant under test will be that <code>f.get()</code> (that is, the boolean value of the flag) is always false. </p>
<pre><code class="language-solidity">contract EchidnaTest {
   Flag f;

   constructor() {
      f = new Flag();
   }

   function test_flag_is_false() public {
      assert(f.get() == false);
   }

}
</code></pre>
<p>In a non <code>multi-abi</code> fuzzing campaign, Echidna is not able to break the invariant, because it only interacts with <code>EchidnaTest</code> functions. However, if we use the following configuration file, enabling <code>multi-abi</code> testing, the invariant is broken. You can access <a href="program-analysis/echidna/advanced/../example/multiabi.yaml"><code>../example/multiabi.yaml</code> here</a>.</p>
<pre><code class="language-yaml">testMode: assertion
testLimit: 50000
multi-abi: true
</code></pre>
<p>To run the Echidna tests, run <code>echidna-test multiabi.sol --contract EchidnaTest --config multiabi.yaml</code> from the <code>example</code> directory. Alternatively, you can specify <code>--multi-abi</code> in the command line instead of using a configuration file.</p>
<h3 id="example-run-with-multi-abi-set-to-false"><a class="header" href="#example-run-with-multi-abi-set-to-false">Example run with <code>multi-abi</code> set to <code>false</code></a></h3>
<pre><code>$ echidna-test multiabi.sol --contract EchidnaTest --config multiabi.yaml 
Analyzing contract: building-secure-contracts/program-analysis/echidna/example/multiabi.sol:EchidnaTest
test_flag_is_false():  passed! 🎉
AssertionFailed(..):  passed! 🎉

Unique instructions: 282
Unique codehashes: 2
Corpus size: 2
Seed: -8252538430849362039
</code></pre>
<h3 id="example-run-with-multi-abi-set-to-true"><a class="header" href="#example-run-with-multi-abi-set-to-true">Example run with <code>multi-abi</code> set to <code>true</code></a></h3>
<pre><code>$ echidna-test multiabi.sol --contract EchidnaTest --config multiabi.yaml 
Analyzing contract: building-secure-contracts/program-analysis/echidna/example/multiabi.sol:EchidnaTest
test_flag_is_false(): failed!💥  
  Call sequence:
    flip()
    flip()
    flip()
    test_flag_is_false()

Event sequence: Panic(1)
AssertionFailed(..):  passed! 🎉

Unique instructions: 368
Unique codehashes: 2
Corpus size: 6
Seed: -6168343983565830424
</code></pre>
<h2 id="use-cases-and-conclusions"><a class="header" href="#use-cases-and-conclusions">Use cases and conclusions</a></h2>
<p>Testing with <code>multi-abi</code> is a useful tool for complex systems that require the user to interact with more than one contract, as we mentioned earlier. Another use case is for deployed contracts that require interactions to be initiated by specific addresses: for those, specifying the <code>sender</code> configuration setting allows to send the transactions from the correct account.</p>
<p>A side-effect of using <code>multi-abi</code> is that the search space grows with the number of functions that can be called. This, combined with high values of sequence lengths, can make the fuzzing test not so thorough, because the dimension of the search space is simply too big to reasonably explore. Finally, adding more functions as fuzzing candidates makes the campaigns to take up more execution time.</p>
<p>A final remark is that <code>multi-abi</code> testing in assertion mode ignores all assert failures from the contracts not under test. This is shown in <code>Flag.test_fail()</code> function: even though it explicitly asserts false, the Echidna test ignores it.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="fuzzing-tips"><a class="header" href="#fuzzing-tips">Fuzzing Tips</a></h1>
<p>The following describe fuzzing tips to make Echidna more efficient:</p>
<ul>
<li><strong>To filter the values range of inputs, use <code>%</code></strong>. See <a href="program-analysis/echidna/fuzzing_tips.html#filtering-inputs">Filtering inputs</a>.</li>
<li><strong>When dynamic arrays are needed, use push/pop</strong>. See <a href="program-analysis/echidna/fuzzing_tips.html#dealing-with-dynamic-arrays">Dealing with dynamic arrays</a>.</li>
</ul>
<h2 id="filtering-inputs"><a class="header" href="#filtering-inputs">Filtering inputs</a></h2>
<p>To filter inputs, <code>%</code> is more efficient than adding <code>require</code> or <code>if</code> statements. For example, if you are a fuzzing a <code>operation(uint256 index, ..)</code> where <code>index</code> is supposed to be less than <code>10**18</code>, use:</p>
<pre><code class="language-solidity">function operation(uint index, ...) public{
   index = index % 10**18
   ...
}
</code></pre>
<p>If <code>require(index &lt;= 10**18)</code> is used instead, many transactions generated will revert, slowing the fuzzer. </p>
<p>This can also be generalized define a min and max range, for example:</p>
<pre><code class="language-solidity">function operation(uint balance, ...) public{
   balance = MIN_BALANCE + balance % (MAX_BALANCE - MIN_BALANCE);
   ...
}
</code></pre>
<p>Will ensure that <code>balance</code> is always between <code>MIN_BALANCE</code> and <code>MAX_BALANCE</code>, without discarding any generated transactions. As expected, this will speed up the exploration, but at the cost of avoiding certain paths in your code. To overcome this issue, the usual solution is to have two functions:</p>
<pre><code class="language-solidity">function operation(uint balance, ...) public{
   ... // original code
}

function safeOperation(uint balance, ...) public{
   balance = MIN_BALANCE + balance % (MAX_BALANCE - MIN_BALANCE); // safe balance
   ...
}
</code></pre>
<p>So Echidna is free to use any of these, exploring safe and unsafe usage of the input data.</p>
<h1 id="dealing-with-dynamic-arrays"><a class="header" href="#dealing-with-dynamic-arrays">Dealing with dynamic arrays</a></h1>
<p>When a dynamic array is used as input, Echidna will limit the size of it to 32 elements:</p>
<pre><code class="language-solidity">function operation(uint256[] data, ...) public{
   ... // use of data
}
</code></pre>
<p>This is because deserializing dynamic arrays is slow and can take some amount of memory during the execution. Dynamic arrays are also problematic since they are hard to mutate. Despite this, Echidna includes some specific mutators to remove/repeat elements or cut elements. These mutators are performed using the collected corpus. In general, we suggest the use of <code>push(..)</code> and <code>pop()</code> functions to handle the exploration of dynamic arrays used as inputs:</p>
<pre><code class="language-solidity">private uint256[] data;
function push(uint256 x) public{
   data.push(x);
}

function pop() public{
   data.pop();
}

function operation(...) public{
   ... // use of data
}
</code></pre>
<p>This will work well to test arrays with a small amount of elements; however, it introduces an unexpected bias in the exploration: since <code>push</code> an <code>pop</code> are functions that will be selected with equal probability, the chance of building large arrays (e.g. more than 64 elements) is very very small. One quick solution could be to blacklist the <code>pop()</code> function during a short campaign:</p>
<pre><code>filterFunctions: [&quot;C.pop()&quot;]
</code></pre>
<p>This is enough for small scale testing. A more general solution is available using a specific testing technique called <a href="https://www.cs.utah.edu/~regehr/papers/swarm12.pdf"><em>swarm testing</em></a>. This allows to run a long testing campaign with some tool but randomly shuffling the configuration of it. In case of Echidna, swarm testing runs with different config files, where it blacklists some number of random functions from the contract before testing. We offer swarm testing and scalability with <a href="https://github.com/crytic/echidna-parade">echidna-parade</a>, our dedicated tool for fuzzing smart contracts. A specific tutorial in the use of echidna-parade is available <a href="program-analysis/echidna/./advanced/smart-contract-fuzzing-at-scale.html">here</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="frequently-asked-questions-about-echidna"><a class="header" href="#frequently-asked-questions-about-echidna">Frequently asked questions about Echidna</a></h1>
<p>This list contains answers to frequent questions related with the usage of Echidna. If this looks too difficult to understand for you, you need to make sure you already reviewed <a href="program-analysis/echidna/./README.html">all the other Echidna documentation</a>. </p>
<h2 id="echidna-fails-to-start-or-compile-my-contract-what-should-i-do"><a class="header" href="#echidna-fails-to-start-or-compile-my-contract-what-should-i-do">Echidna fails to start or compile my contract, what should I do?</a></h2>
<p>Start testing if <code>crytic-compile</code> can compile your contracts. If you are using a compilation framework such as truffle or hardhat, use:</p>
<p><code>crytic-compile .</code></p>
<p>And check for any errors. If there is an unexpected error, please <a href="https://github.com/crytic/crytic-compile/issues">report it in the crytic-compile issue tracker</a>.</p>
<p>If <code>crytic-compile</code> works fine, test <code>slither</code> to see if there is any issues with the information that this tool extract for running Echidna. Again, if you are using a compilation framework, use:</p>
<p><code>slither . --print echidna</code></p>
<p>If that command works correctly, it should print a json file with some information from your contracts, otherwise, report any error <a href="https://github.com/crytic/slither/issues">in the slither issue tracker</a>. 
If everything here works, but Echidna still fails, please open an issue in our issue tracker or ask in the #ethereum channel of the EmpireHacking slack.</p>
<h2 id="how-long-should-i-run-echidna"><a class="header" href="#how-long-should-i-run-echidna">How long should I run Echidna?</a></h2>
<p>Echidna uses fuzzing testing which runs for a fixed amount of transactions (or a global timeout). 
Users should specify a suitable number of transactions or a timeout (in seconds), depending on the amount of resources available for a fuzzing campaign 
and the complexity of the code.  Determining the best amount of time to run a fuzzer is still an <a href="https://blog.trailofbits.com/2021/03/23/a-year-in-the-life-of-a-compiler-fuzzing-campaign/">open research question</a>, however, <a href="program-analysis/echidna/./advanced/collecting-a-corpus.html">monitoring the code coverage of your smart contracts</a> can be a good way to determinate if the fuzzing campaign should be extended.</p>
<h2 id="why-has-echidna-not-implemented-fuzzing-of-smart-contract-constructors-with-parameters"><a class="header" href="#why-has-echidna-not-implemented-fuzzing-of-smart-contract-constructors-with-parameters">Why has Echidna not implemented fuzzing of smart contract constructors with parameters?</a></h2>
<p>Echidna is focused on security testing during audits. When we perform testing, we adjust the fuzzing campaign to test with a limited number of possible constructor parameters (normally, the ones that are going to be used for the real deployment). We are not focused on issues that depend on alternative deployments that should not happen. On top of that, redeploying contracts during the fuzzing campaign has a performance impact and the sequences of transactions that we collect in the corpus could be more difficult (or even impossible) to reuse and mutate in different contexts. </p>
<h2 id="how-does-echidna-know-which-sequence-of-transactions-should-be-added-into-the-corpus"><a class="header" href="#how-does-echidna-know-which-sequence-of-transactions-should-be-added-into-the-corpus">How does Echidna know which sequence of transactions should be added into the corpus?</a></h2>
<p>Echidna starts generating a sequence with a number of transactions to execute. It will execute them one by one, collecting coverage information for every transaction. If a transaction adds new coverage, then the complete sequence (up to that transaction), will be added into the corpus.</p>
<h2 id="how-is-coverage-information-used"><a class="header" href="#how-is-coverage-information-used">How is coverage information used?</a></h2>
<p>Coverage information is used to determine if a sequence of transactions has reached a new program state and added into the internal corpus.</p>
<h2 id="what-is-coverage-information-exactly"><a class="header" href="#what-is-coverage-information-exactly">What is coverage information exactly?</a></h2>
<p>Coverage is a combination of the following information:</p>
<ul>
<li>Echidna reached a certain program counter in a given contract.</li>
<li>The execution ended, either with stop, revert or a variety of errors (e.g. assertion failed, out of gas, not enough ether balance, etc) </li>
<li>The number of EVM frames when the execution ended (in other words, how deep ends the execution in terms of internal transactions) </li>
</ul>
<h2 id="how-is-the-corpus-used"><a class="header" href="#how-is-the-corpus-used">How is the corpus used?</a></h2>
<p>The corpus is used as the primary source of transactions to replay and mutate during a fuzzing campaign. The probability of using a sequence of transactions to replay and mutate is directly proportional to the number of transactions needed to add it into the corpus. In other words, more rare sequences are replayed and mutated more often during a fuzzing campaign.</p>
<h2 id="when-a-new-sequence-of-transactions-is-added-into-the-corpus-does-this-mean-that-a-new-line-of-code-is-always-reached"><a class="header" href="#when-a-new-sequence-of-transactions-is-added-into-the-corpus-does-this-mean-that-a-new-line-of-code-is-always-reached">When a new sequence of transactions is added into the corpus, does this mean that a new line of code is always reached?</a></h2>
<p>Not always, it means we reached some program state given our coverage definition.</p>
<h2 id="why-not-use-coverage-per-individual-transaction-instead-of-per-sequence-of-transactions"><a class="header" href="#why-not-use-coverage-per-individual-transaction-instead-of-per-sequence-of-transactions">Why not use coverage per individual transaction, instead of per sequence of transactions?</a></h2>
<p>Coverage per isolated transaction will be possible, however, it is incomplete vision of the coverage since some code requires previous transaction to reach some specific lines.</p>
<h2 id="how-to-know-which-type-of-testing-should-be-used-boolean-properties-assertions-etc"><a class="header" href="#how-to-know-which-type-of-testing-should-be-used-boolean-properties-assertions-etc">How to know which type of testing should be used? (boolean properties, assertions, etc)</a></h2>
<p>Check the <a href="program-analysis/echidna/./basic/testing-modes.html">tutorial on selecting the right test mode</a></p>
<h2 id="why-does-echidna-return-property-x-failed-with-no-transactions-made-when-running-one-or-more-tests"><a class="header" href="#why-does-echidna-return-property-x-failed-with-no-transactions-made-when-running-one-or-more-tests">Why does Echidna return “Property X failed with no transactions made” when running one or more tests?</a></h2>
<p>Before starting a fuzzing campaign, Echidna tests the properties with no transactions at all to check if they fail. In that case, a property can be detected to fail in the initial state (after the contract is deployed). You should check that the property is correct to know why it fails without any transactions.</p>
<h2 id="how-can-i-know-how-a-property-or-assertion-failed"><a class="header" href="#how-can-i-know-how-a-property-or-assertion-failed">How can I know how a property or assertion failed?</a></h2>
<p>Echidna indicates the cause of a failed test in the UI. For instance, if a boolean property X fails because of a revert, Echidna will show “property X FAILED! with ErrorRevert”, otherwise, it should show “property X FAILED! with ErrorReturnFalse”. Assertion can only fail because with “ErrorUnrecognizedOpcode”, which is how Solidity implements assertions in EVM.</p>
<h2 id="how-can-i-know-exactly-where-and-how-property-or-assertion-failed"><a class="header" href="#how-can-i-know-exactly-where-and-how-property-or-assertion-failed">How can I know exactly where and how property or assertion failed?</a></h2>
<p>Events are an easy way to output values from the EVM. You can use them to get information in the code that has the failed property or assertion. Only the events of transaction triggering the failure will be shown (this will be improved in the near future). Also, events are collected and displayed, even if the transaction reverted (despite the Yellow Paper states that the event log should be cleaned). </p>
<p>Another way to see where an assertion failed is using the coverage information. This requires to enable the corpus collection (e.g. <code>--corpus-dir X</code>) and check the coverage.*.txt file to see something like this: </p>
<pre><code>*e  |   function test(int x, address y, address z) public {
*e  |     require(x &gt; 0 || x &lt;= 0);
*e  |     assert(z != address(0x0));
*   |     assert(y != z);
*   |     state = x;
    |   }
</code></pre>
<p>The <code>e</code> marker indicates that Echidna collected a trace that ends with an assertion failure. As we can see, 
the path ends in the assert, so it should fail there.</p>
<h2 id="why-coverage-information-seems-incorrect-or-incomplete"><a class="header" href="#why-coverage-information-seems-incorrect-or-incomplete">Why coverage information seems incorrect or incomplete?</a></h2>
<p>Coverage mappings can be imprecesie, however, if it fails completely, it could be that you are using the <a href="https://docs.soliditylang.org/en/v0.8.14/ir-breaking-changes.html?highlight=viaIR#solidity-ir-based-codegen-changes"><code>viaIR</code> optimization option</a>, which seems to have some unexpected impact on the solc maps that we are still investigating. As a workaround, disable <code>viaIR</code>. </p>
<h2 id="echidna-crashes-showing--nonemptyfromlist-empty-list"><a class="header" href="#echidna-crashes-showing--nonemptyfromlist-empty-list">Echidna crashes showing <code> NonEmpty.fromList: empty list</code></a></h2>
<p>Echidna relies on the Solidity metadata to detect where each contract is deployed. Please do not disable it. If this is not the case, please <a href="https://github.com/crytic/echidna/issues">open an issue</a> in our issue tracker.</p>
<h2 id="echidna-stopped-working-for-some-reason-how-can-i-debug-it"><a class="header" href="#echidna-stopped-working-for-some-reason-how-can-i-debug-it">Echidna stopped working for some reason. How can I debug it?</a></h2>
<p>Use <code>--format text</code> and open an issue with the error you see in your console or ask in the #ethereum channel at the EmpireHacking slack.</p>
<h2 id="i-am-not-getting-expected-results-from-echidna-tests-what-can-i-do"><a class="header" href="#i-am-not-getting-expected-results-from-echidna-tests-what-can-i-do">I am not getting expected results from Echidna tests. What can I do?</a></h2>
<p>Sometimes it is useful to create small properties or assertions to test that the tool executed them correctly. For instance, for property mode:</p>
<pre><code class="language-solidity">    function echidna_test() public returns (bool) {
       return false;
    }
</code></pre>
<p>And for assertion mode:</p>
<pre><code class="language-solidity">    function test_assert_false() public {
       assert(false); 
    }
</code></pre>
<p>If these are not failing, please <a href="https://github.com/crytic/echidna/issues">open an issue</a> so we can take a look.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercises"><a class="header" href="#exercises">Exercises</a></h1>
<ul>
<li><a href="program-analysis/echidna/exercises/./Exercise-1.html">Exercise 1</a>: Testing token balances</li>
<li><a href="program-analysis/echidna/exercises/./Exercise-2.html">Exercise 2</a>: Testing access control</li>
<li><a href="program-analysis/echidna/exercises/./Exercise-3.html">Exercise 3</a>: Testing with custom initialization</li>
<li><a href="program-analysis/echidna/exercises/./Exercise-4.html">Exercise 4</a>: Testing with <code>assert</code></li>
<li><a href="program-analysis/echidna/exercises/./Exercise-5.html">Exercise 5</a>: Solving Damn Vulnerable DeFi - Naive Receiver</li>
<li><a href="program-analysis/echidna/exercises/./Exercise-6.html">Exercise 6</a>: Solving Damn Vulnerable DeFi - Unstoppable</li>
<li><a href="program-analysis/echidna/exercises/./Exercise-7.html">Exercise 7</a>: Solving Damn Vulnerable DeFi - Side Entrance</li>
<li><a href="program-analysis/echidna/exercises/./Exercise-8.html">Exercise 8</a>: Solving Damn Vulnerable DeFi - The Rewarder</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercise-1"><a class="header" href="#exercise-1">Exercise 1</a></h1>
<p><strong>Table of contents:</strong></p>
<ul>
<li><a href="program-analysis/echidna/exercises/Exercise-1.html#targeted-contract">Targeted contract</a></li>
<li><a href="program-analysis/echidna/exercises/Exercise-1.html#testing-a-token-balance">Exercise</a></li>
<li><a href="program-analysis/echidna/exercises/Exercise-1.html#solution">Solution</a></li>
</ul>
<p>Join the team on Slack at: https://empireslacking.herokuapp.com/ #ethereum</p>
<h2 id="targeted-contract"><a class="header" href="#targeted-contract">Targeted contract</a></h2>
<p>We will test the following contract <em><a href="program-analysis/echidna/exercises/./exercise1/token.sol">./exercise1/token.sol</a></em>:</p>
<pre><code class="language-Solidity"> contract Ownership{
    address owner = msg.sender;
    function Owner(){
         owner = msg.sender;
     }
     modifier isOwner(){
         require(owner == msg.sender);
         _;
      }
   }

  contract Pausable is Ownership{
     bool is_paused;
     modifier ifNotPaused(){
              require(!is_paused);
              _;
      }

      function paused() isOwner public{
          is_paused = true;
      }

      function resume() isOwner public{
          is_paused = false;
      }
   }

   contract Token is Pausable{
      mapping(address =&gt; uint) public balances;
      function transfer(address to, uint value) ifNotPaused public{
           balances[msg.sender] -= value;
           balances[to] += value;
       }
    }

</code></pre>
<h2 id="testing-a-token-balance"><a class="header" href="#testing-a-token-balance">Testing a token balance</a></h2>
<h3 id="goals"><a class="header" href="#goals">Goals</a></h3>
<ul>
<li>Add a property to check that <code>echidna_caller</code> cannot have more than an initial balance of 10000.</li>
<li>Once Echidna finds the bug, fix the issue, and re-check your property with Echidna.</li>
</ul>
<p>The skeleton for this exercise is (<em><a href="program-analysis/echidna/exercises/./exercise1/template.sol">./exercise1/template.sol</a></em>):</p>
<pre><code class="language-Solidity">     import &quot;token.sol&quot;;
     contract TestToken is Token {
       address echidna_caller = msg.sender;

        constructor() public{
            balances[echidna_caller] = 10000;
         }
         // add the property
        function echidna_test_balance() public view returns (bool) {}
      }
</code></pre>
<h2 id="solution"><a class="header" href="#solution">Solution</a></h2>
<p>This solution can be found in <a href="program-analysis/echidna/exercises/./exercise1/solution.sol">./exercise1/solution.sol</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercise-2"><a class="header" href="#exercise-2">Exercise 2</a></h1>
<p>This exercise requires to finish the <a href="program-analysis/echidna/exercises/Exercise-1.html">exercise 1</a>.</p>
<p><strong>Table of contents:</strong></p>
<ul>
<li><a href="program-analysis/echidna/exercises/Exercise-2.html#targeted-contract">Targeted contract</a></li>
<li><a href="program-analysis/echidna/exercises/Exercise-2.html#testing-access-control">Exercise</a></li>
<li><a href="program-analysis/echidna/exercises/Exercise-2.html#solution">Solution</a></li>
</ul>
<p>Join the team on Slack at: https://empireslacking.herokuapp.com/ #ethereum</p>
<h2 id="targeted-contract-1"><a class="header" href="#targeted-contract-1">Targeted contract</a></h2>
<p>We will test the following contract <em><a href="program-analysis/echidna/exercises/./exercise2/token.sol">./exercise2/token.sol</a></em>:</p>
<pre><code class="language-Solidity"> contract Ownership{
    address owner = msg.sender;
    function Owner() public {
         owner = msg.sender;
     }
     modifier isOwner(){
         require(owner == msg.sender);
         _;
      }
   }

  contract Pausable is Ownership{
     bool is_paused;
     modifier ifNotPaused(){
               require(!is_paused);
               _;
      }

      function paused() isOwner public{
          is_paused = true;
      }

      function resume() isOwner public{
          is_paused = false;
      }
   }

   contract Token is Pausable{
      mapping(address =&gt; uint) public balances;
      function transfer(address to, uint value) ifNotPaused public{
           balances[msg.sender] -= value;
           balances[to] += value;
       }
    }

</code></pre>
<h2 id="testing-access-control"><a class="header" href="#testing-access-control">Testing access control</a></h2>
<h3 id="goals-1"><a class="header" href="#goals-1">Goals</a></h3>
<ul>
<li>Consider <code>paused()</code> to be called at deployment, and the ownership removed.</li>
<li>Add a property to check that the contract cannot be unpaused.</li>
<li>Once Echidna finds the bug, fix the issue, and re-try your property with Echidna.</li>
</ul>
<p>The skeleton for this exercise is (<em><a href="program-analysis/echidna/exercises/./exercise2/template.sol">./exercise2/template.sol</a></em>):</p>
<pre><code class="language-Solidity">   import &quot;token.sol&quot;;
   contract TestToken is Token {
      address echidna_caller = msg.sender;
      constructor(){
         paused(); // pause the contract
         owner = 0x0; // lose ownership
       }
      // add the property
      function echidna_no_transfer() public view returns (bool) {}
   }
</code></pre>
<h2 id="solution-1"><a class="header" href="#solution-1">Solution</a></h2>
<p>This solution can be found in <a href="program-analysis/echidna/exercises/./exercise2/solution.sol">./exercise2/solution.sol</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercise-3"><a class="header" href="#exercise-3">Exercise 3</a></h1>
<p>This exercise requires to finish <a href="program-analysis/echidna/exercises/./Exercise-1.html">exercise 1</a> and <a href="program-analysis/echidna/exercises/./Exercise-2.html">exercise 2</a></p>
<p><strong>Table of contents:</strong></p>
<ul>
<li><a href="program-analysis/echidna/exercises/Exercise-3.html#targeted-contract">Targeted contract</a></li>
<li><a href="program-analysis/echidna/exercises/Exercise-3.html#testing-with-custom-initialization">Exercise</a></li>
<li><a href="program-analysis/echidna/exercises/Exercise-3.html#solution">Solution</a></li>
</ul>
<p>Join the team on Slack at: https://empireslacking.herokuapp.com/ #ethereum</p>
<h2 id="targeted-contract-2"><a class="header" href="#targeted-contract-2">Targeted contract</a></h2>
<p>We will test the following contract <em><a href="program-analysis/echidna/exercises/./exercise3/token.sol">./exercise3/token.sol</a></em>:</p>
<pre><code class="language-Solidity"> contract Ownership{
    address owner = msg.sender;
    constructor() public {
        owner = msg.sender;
    }
     modifier isOwner(){
         require(owner == msg.sender);
         _;
      }
   }

  contract Pausable is Ownership{
     bool is_paused;
     modifier ifNotPaused(){
          require(!is_paused);
          _;
      }

      function paused() isOwner public{
          is_paused = true;
      }

      function resume() isOwner public{
          is_paused = false;
      }
   }

   contract Token is Pausable{
      mapping(address =&gt; uint) public balances;
      function transfer(address to, uint value) ifNotPaused public{
            require(balances[msg.sender] &gt;= value);
            balances[msg.sender] -= value;
            balances[to] += value;
       }
    }

</code></pre>
<h2 id="testing-with-custom-initialization"><a class="header" href="#testing-with-custom-initialization">Testing with custom initialization</a></h2>
<p>Consider the following extension of the token (<em><a href="program-analysis/echidna/exercises/./exercise3/mintable.sol">./exercise3/mintable.sol</a></em>):</p>
<pre><code class="language-Solidity">   import &quot;token.sol&quot;;
   contract MintableToken is Token{
      int totalMinted;
      int totalMintable;

      constructor(int _totalMintable) public {
         totalMintable = _totalMintable;
      }

      function mint(uint value) isOwner() public{
          require(int(value) + totalMinted &lt; totalMintable);
          totalMinted += int(value);
          balances[msg.sender] += value;
       }
    }
</code></pre>
<p>The <a href="program-analysis/echidna/exercises/./exercise3/token.sol#L1">version of token.sol</a> contains the fixes of the previous exercises.</p>
<h3 id="goals-2"><a class="header" href="#goals-2">Goals</a></h3>
<ul>
<li>Create a scenario, where <code>echidna_caller (msg.sender)</code> becomes the owner of the contract at construction, and <code>totalMintable</code> is set to 10,000. Recall that Echidna needs a constructor without argument.</li>
<li>Add a property to check if <code>echidna_caller</code> can mint more than 10,000 tokens.</li>
<li>Once Echidna finds the bug, fix the issue, and re-try your property with Echidna.</li>
</ul>
<p>The skeleton for this exercise is (<em><a href="program-analysis/echidna/exercises/./exercise3/template.sol">./exercise3/template.sol</a></em>):</p>
<pre><code class="language-Solidity">   import &quot;mintable.sol&quot;;
   contract TestToken is MintableToken {
      address echidna_caller = msg.sender;

      // update the constructor
      constructor() public {}

      // add the property
      function echidna_test_balance() public view returns (bool) {}
   }
</code></pre>
<h2 id="solution-2"><a class="header" href="#solution-2">Solution</a></h2>
<p>This solution can be found in <a href="program-analysis/echidna/exercises/./exercise3/solution.sol">./exercise3/solution.sol</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercise-4"><a class="header" href="#exercise-4">Exercise 4</a></h1>
<p><strong>Table of contents:</strong></p>
<ul>
<li><a href="program-analysis/echidna/exercises/Exercise-4.html#exercise-4">Exercise 4</a>
<ul>
<li><a href="program-analysis/echidna/exercises/Exercise-4.html#targeted-contract">Targeted contract</a></li>
<li><a href="program-analysis/echidna/exercises/Exercise-4.html#exercise">Exercise</a>
<ul>
<li><a href="program-analysis/echidna/exercises/Exercise-4.html#goals">Goals</a></li>
</ul>
</li>
<li><a href="program-analysis/echidna/exercises/Exercise-4.html#solution">Solution</a></li>
</ul>
</li>
</ul>
<p>This exercise is based on the tutorial <a href="program-analysis/echidna/exercises/../basic/assertion-checking.html">How to test assertions</a>.</p>
<p>Join the team on Slack at: https://empireslacking.herokuapp.com/ #ethereum</p>
<h2 id="targeted-contract-3"><a class="header" href="#targeted-contract-3">Targeted contract</a></h2>
<p>We will test the following contract <em><a href="program-analysis/echidna/exercises/./exercise4/token.sol">./exercise4/token.sol</a></em>:</p>
<pre><code class="language-Solidity"> contract Ownership{
    address owner = msg.sender;
    function Owner() public{
         owner = msg.sender;
     }
     modifier isOwner(){
         require(owner == msg.sender);
         _;
      }
   }

  contract Pausable is Ownership{
     bool is_paused;
     modifier ifNotPaused(){
              require(!is_paused);
              _;
      }

      function paused() isOwner public{
          is_paused = true;
      }

      function resume() isOwner public{
          is_paused = false;
      }
   }

   contract Token is Pausable{
      mapping(address =&gt; uint) public balances;
      function transfer(address to, uint value) ifNotPaused public{
           balances[msg.sender] -= value;
           balances[to] += value;
       }
    }

</code></pre>
<h2 id="exercise"><a class="header" href="#exercise">Exercise</a></h2>
<h3 id="goals-3"><a class="header" href="#goals-3">Goals</a></h3>
<p>Add asserts to ensure that after calling <code>transfer</code>:</p>
<ul>
<li><code>msg.sender</code> must have its initial balance or less.</li>
<li><code>to</code> must have its initial balance or more.</li>
</ul>
<p>Once Echidna finds the bug, fix the issue, and re-try your assertion with Echidna.</p>
<p>This exercise is similar to the <a href="program-analysis/echidna/exercises/Exercise-1.html">first one</a>, but using assertions instead of explicit properties.<br />
However, in this exercise, it is easier to modify the original token contract (<em><a href="program-analysis/echidna/exercises/./exercise4/token.sol">./exercise4/token.sol</a></em>).</p>
<h2 id="solution-3"><a class="header" href="#solution-3">Solution</a></h2>
<p>This solution can be found in <a href="program-analysis/echidna/exercises/./exercise4/solution.sol">./exercise4/solution.sol</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercise-5"><a class="header" href="#exercise-5">Exercise 5</a></h1>
<p><strong>Table of contents:</strong></p>
<ul>
<li><a href="program-analysis/echidna/exercises/Exercise-5.html#exercise-5">Exercise 5</a>
<ul>
<li><a href="program-analysis/echidna/exercises/Exercise-5.html#setup">Setup</a></li>
<li><a href="program-analysis/echidna/exercises/Exercise-5.html#context">Context</a></li>
<li><a href="program-analysis/echidna/exercises/Exercise-5.html#goals">Goals</a></li>
<li><a href="program-analysis/echidna/exercises/Exercise-5.html#hints">Hints</a></li>
<li><a href="program-analysis/echidna/exercises/Exercise-5.html#solution">Solution</a></li>
</ul>
</li>
</ul>
<p>Join the team on Slack at: https://empireslacking.herokuapp.com/ #ethereum</p>
<h2 id="setup"><a class="header" href="#setup">Setup</a></h2>
<ol>
<li>Clone the repo: <code>git clone https://github.com/crytic/damn-vulnerable-defi-echidna</code></li>
<li>install the dependencies via <code>yarn install</code>.</li>
</ol>
<h2 id="context"><a class="header" href="#context">Context</a></h2>
<p>The challenge is described here: https://www.damnvulnerabledefi.xyz/challenges/2.html, we assume that the reader is familiar with it.</p>
<h2 id="goals-4"><a class="header" href="#goals-4">Goals</a></h2>
<ul>
<li>Setup the testing environment with the right contracts and necessary balances.</li>
<li>Analyze the before function in test/naive-receiver/naive-receiver.challenge.js to identify what initial setup needs to be done.</li>
<li>Add a property to check whether the balance of the <code>FlashLoanReceiver</code> contract can change.</li>
<li>Create a <code>config.yaml</code> with the necessary configuration option(s).</li>
<li>Once Echidna finds the bug, fix the issue, and re-try your property with Echidna.</li>
</ul>
<p>Only the following contracts are relevant:</p>
<ul>
<li><code>contracts/naive-receiver/FlashLoanReceiver.sol</code></li>
<li><code>contracts/naive-receiver/NaiveReceiverLenderPool.sol</code></li>
</ul>
<h2 id="hints"><a class="header" href="#hints">Hints</a></h2>
<p>We recommend to first try without reading the following hints. The hints are in the <a href="https://github.com/crytic/damn-vulnerable-defi-echidna/tree/hints"><code>hints</code> branch</a>.</p>
<ul>
<li>Remember that sometimes you have to supply the test contract with Ether. Read more in <a href="https://github.com/crytic/echidna/wiki/Config">the Echidna wiki</a> and look at <a href="https://github.com/crytic/echidna/blob/master/tests/solidity/basic/default.yaml">the default config setup</a>.</li>
<li>The invariant that we are looking for is &quot;the balance of the receiver contract can not decrease&quot; </li>
<li>Read what is the <a href="program-analysis/echidna/exercises/../basic/common-testing-approaches.html#external-testing">multi abi option</a></li>
<li>A template is provided in <a href="https://github.com/crytic/damn-vulnerable-defi-echidna/blob/hints/contracts/naive-receiver/NaiveReceiverEchidna.sol">contracts/naive-receiver/NaiveReceiverEchidna.sol</a></li>
<li>A config file is provided in <a href="https://github.com/crytic/damn-vulnerable-defi-echidna/blob/hints/naivereceiver.yaml">naivereceiver.yaml</a></li>
</ul>
<h2 id="solution-4"><a class="header" href="#solution-4">Solution</a></h2>
<p>This solution can be found in <a href="https://github.com/crytic/damn-vulnerable-defi-echidna/blob/solutions/contracts/naive-receiver/NaiveReceiverEchidna.sol"><code>solutions</code> branch</a>.</p>
<details>
<summary>Solution Explained (spoilers ahead)</summary>
<p>The goal of the naive receiver challenge is to realize that an arbitrary user can call request a flash loan for <code>FlashLoanReceiver</code>.
In fact, this can be done even if the arbitrary user has no ether.</p>
<p>Echidna found this by simply calling <code>NaiveReceiverLenderPool.flashLoan()</code> with the address of <code>FlashLoanReceiver</code> and any arbitrary amount.</p>
<p>See example output below from Echidna:</p>
<pre><code class="language-bash">$ echidna-test . --contract NaiveReceiverEchidna --config naivereceiver.yaml
...

echidna_test_contract_balance: failed!💥  
  Call sequence:
    flashLoan(0x62d69f6867a0a084c6d313943dc22023bc263691,353073667)

...
</code></pre>
</details>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercise-6"><a class="header" href="#exercise-6">Exercise 6</a></h1>
<p><strong>Table of contents:</strong></p>
<ul>
<li><a href="program-analysis/echidna/exercises/Exercise-6.html#exercise-6">Exercise 6</a>
<ul>
<li><a href="program-analysis/echidna/exercises/Exercise-6.html#setup">Setup</a></li>
<li><a href="program-analysis/echidna/exercises/Exercise-6.html#context">Context</a></li>
<li><a href="program-analysis/echidna/exercises/Exercise-6.html#goals">Goals</a></li>
<li><a href="program-analysis/echidna/exercises/Exercise-6.html#hints">Hints</a></li>
<li><a href="program-analysis/echidna/exercises/Exercise-6.html#solution">Solution</a></li>
</ul>
</li>
</ul>
<p>Join the team on Slack at: https://empireslacking.herokuapp.com/ #ethereum</p>
<h2 id="setup-1"><a class="header" href="#setup-1">Setup</a></h2>
<ol>
<li>Clone the repo: <code>git clone https://github.com/crytic/damn-vulnerable-defi-echidna</code></li>
<li>install the dependencies via <code>yarn install</code>.</li>
</ol>
<h2 id="context-1"><a class="header" href="#context-1">Context</a></h2>
<p>The challenge is described here: https://www.damnvulnerabledefi.xyz/challenges/1.html, we assume that the reader is familiar with it.</p>
<h2 id="goals-5"><a class="header" href="#goals-5">Goals</a></h2>
<ul>
<li>Setup the testing environment with the right contracts and necessary balances.</li>
<li>Analyze the before function in test/unstoppable/unstoppable.challenge.js to identify what initial setup needs to be done.</li>
<li>Add a property to check whether <code>UnstoppableLender</code> can always provide flash loans.</li>
<li>Create a <code>config.yaml</code> with the necessary configuration option(s).</li>
<li>Once Echidna finds the bug, fix the issue, and re-try your property with Echidna.</li>
</ul>
<p>Only the following contracts are relevant:</p>
<ul>
<li><code>contracts/DamnValuableToken.sol</code></li>
<li><code>contracts/unstoppable/UnstoppableLender.sol</code></li>
<li><code>contracts/unstoppable/ReceiverUnstoppable.sol</code></li>
</ul>
<h2 id="hints-1"><a class="header" href="#hints-1">Hints</a></h2>
<p>We recommend to first try without reading the following hints. The hints are in the <a href="https://github.com/crytic/damn-vulnerable-defi-echidna/tree/hints"><code>hints</code> branch</a>.</p>
<ul>
<li>The invariant that we are looking for is &quot;Flash loan can always be made&quot;</li>
<li>Read what is the <a href="program-analysis/echidna/exercises/../basic/common-testing-approaches.html#external-testing">multi abi option</a></li>
<li>The <code>receiveTokens</code> callback function must be implemented</li>
<li>A template is provided in <a href="https://github.com/crytic/damn-vulnerable-defi-echidna/blob/hints/contracts/unstoppable/UnstoppableEchidna.sol">contracts/unstoppable/UnstoppableEchidna.sol</a></li>
<li>A config file is provided in <a href="https://github.com/crytic/damn-vulnerable-defi-echidna/blob/hints/unstoppable.yaml">unstoppable.yaml</a></li>
</ul>
<h2 id="solution-5"><a class="header" href="#solution-5">Solution</a></h2>
<p>This solution can be found in the <a href="https://github.com/crytic/damn-vulnerable-defi-echidna/blob/solutions/contracts/unstoppable/UnstoppableEchidna.sol"><code>solutions</code> branch</a>.</p>
<details>
<summary>Solution Explained (spoilers ahead)</summary>
<p>Note: Please make sure that you have placed <code>solution.sol</code> (or <code>UnstoppableEchidna.sol</code>) in <code>contracts/unstoppable</code>. </p>
<p>The goal of the unstoppable challenge is to realize that <code>UnstoppableLender</code> has two modes of tracking its balance: <code>poolBalance</code> and <code>damnValuableToken.balanceOf(address(this))</code>.</p>
<p><code>poolBalance</code> is added to when someone calls <code>depositTokens()</code>.</p>
<p>However, a user can call <code>damnValuableToken.transfer()</code> directly and increase the <code>balanceOf(address(this))</code> without increasing <code>poolBalance</code>.</p>
<p>Now, the two balance trackers are out-of-sync.</p>
<p>When Echidna calls <code>pool.flashLoan(10)</code>, the assertion <code>assert(poolBalance == balanceBefore)</code> in <code>UnstoppableLender</code> will break and the pool can no longer provide flash loans.</p>
<p>See example output below from Echidna:</p>
<pre><code class="language-bash">$ echidna-test . --contract UnstoppableEchidna --config unstoppable.yaml

...

echidna_testFlashLoan: failed!💥  
  Call sequence:
    transfer(0x62d69f6867a0a084c6d313943dc22023bc263691,1296000)

...
</code></pre>
</details>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercise-7"><a class="header" href="#exercise-7">Exercise 7</a></h1>
<p><strong>Table of contents:</strong></p>
<ul>
<li><a href="program-analysis/echidna/exercises/Exercise-7.html#exercise-7">Exercise 7</a>
<ul>
<li><a href="program-analysis/echidna/exercises/Exercise-7.html#setup">Setup</a></li>
<li><a href="program-analysis/echidna/exercises/Exercise-7.html#goals">Goals</a></li>
<li><a href="program-analysis/echidna/exercises/Exercise-7.html#solution">Solution</a></li>
</ul>
</li>
</ul>
<p>Join the team on Slack at: https://empireslacking.herokuapp.com/ #ethereum</p>
<h2 id="setup-2"><a class="header" href="#setup-2">Setup</a></h2>
<h2 id="setup-3"><a class="header" href="#setup-3">Setup</a></h2>
<ol>
<li>Clone the repo: <code>git clone https://github.com/crytic/damn-vulnerable-defi-echidna</code></li>
<li>install the dependencies via <code>yarn install</code>.</li>
<li>Analyze the <code>before</code> function in <code>test/side-entrance/side-entrance.challenge.js</code> to identify what initial setup needs to be done.</li>
<li>Create a contract to be used for the property testing by Echidna.</li>
</ol>
<p>No skeleton will be provided for this exercise.</p>
<h2 id="goals-6"><a class="header" href="#goals-6">Goals</a></h2>
<ul>
<li>Setup the testing environment with the right contracts and necessary balances.</li>
<li>Add a property to check whether the balance of the <code>SideEntranceLenderPool</code> contract has changed.</li>
<li>Create a <code>config.yaml</code> with the necessary configuration option(s).</li>
<li>Once Echidna finds the bug, fix the issue, and re-try your property with Echidna.</li>
</ul>
<p>Hint: It might help to start with doing a manual flashloan to get familiar with the workings of the target contract.</p>
<h2 id="solution-6"><a class="header" href="#solution-6">Solution</a></h2>
<p>This solution can be found in <a href="program-analysis/echidna/exercises/./exercise7/solution.sol">./exercise7/solution.sol</a></p>
<details>
<summary>Solution Explained (spoilers ahead)</summary>
<p>The goal of the side entrance challenge is to realize that the contract's accounting of its ETH balance is misconfigured. <code>balanceBefore</code> is used to track the balance of the contract before the flash loan BUT <code>address(this).balance</code> is used to track the balance of the contract after the flash loan. Thus, you can use the deposit function to repay your flash loan while still maintaining that the contract's total balance of ETH has not changed (i.e. <code>address(this).balance &gt;= balanceBefore</code>). Since the ETH that was deposited is now owned by you, you can now also withdraw it and drain all the funds from the contract.</p>
<p>In order for Echidna to be able to interact with the <code>SideEntranceLenderPool</code>, it has to be deployed first. However, deploying and funding it from the contract to be used by Echidna won't work, as the funding transaction's <code>msg.sender</code> is the contract itself. This means that the owner of the funds is the Echidna contract and therefore it can remove the funds by calling <code>withdraw()</code>, without the need for the exploit. </p>
<p>To prevent that issue, a simple factory contract has to be created to deploy the pool without setting the Echidna property testing contract as the owner of the funds. This factory has a public function that deploys a <code>SideEntranceLenderPool</code>, funds it with the given amount, and return its address. Now, since the Echidna testing contract is not the owner of the funds, it cannot call <code>withdraw()</code> to empty the pool.</p>
<p>Now that the challenge is set up as intended, we proceed to solve it by instructing Echidna to do a flashloan. Using the <code>setEnableWithdraw</code> and <code>setEnableDeposit</code> Echidna will search for function(s) to call inside the flashloan callback to try and break the <code>testPoolBalance</code> property.</p>
<p>At some point Echidna will identify that if (1) <code>deposit</code> is used to pay back the flash loan and (2) <code>withdraw</code> is called right after, the <code>testPoolBalance</code> property breaks.</p>
<p>Example Echidna output:</p>
<pre><code>$ echidna-test . --contract EchidnaSideEntranceLenderPool --config config.yaml
...
testPoolBalance(): failed!💥  
  Call sequence:
    execute() Value: 0x103
    setEnableDeposit(true,256)
    flashLoan(1)
    setEnableWithdraw(true)
    setEnableDeposit(false,0)
    execute()
    testPoolBalance()
...
</code></pre>
</details>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercise-8"><a class="header" href="#exercise-8">Exercise 8</a></h1>
<p><strong>Table of contents:</strong></p>
<ul>
<li><a href="program-analysis/echidna/exercises/Exercise-8.html#exercise-8">Exercise 8</a>
<ul>
<li><a href="program-analysis/echidna/exercises/Exercise-8.html#setup">Setup</a></li>
<li><a href="program-analysis/echidna/exercises/Exercise-8.html#context">Context</a></li>
<li><a href="program-analysis/echidna/exercises/Exercise-8.html#goals">Goals</a></li>
<li><a href="program-analysis/echidna/exercises/Exercise-8.html#hints">Hints</a></li>
<li><a href="program-analysis/echidna/exercises/Exercise-8.html#solution">Solution</a></li>
</ul>
</li>
</ul>
<p>Join the team on Slack at: https://empireslacking.herokuapp.com/ #ethereum</p>
<h2 id="setup-4"><a class="header" href="#setup-4">Setup</a></h2>
<ol>
<li>Clone the repo: <code>git clone https://github.com/crytic/damn-vulnerable-defi-echidna</code></li>
<li>install the dependencies via <code>yarn install</code>.</li>
</ol>
<h2 id="context-2"><a class="header" href="#context-2">Context</a></h2>
<p>The challenge is described here: https://www.damnvulnerabledefi.xyz/challenges/5.html, we assume that the reader is familiar with it.</p>
<h2 id="goals-7"><a class="header" href="#goals-7">Goals</a></h2>
<ul>
<li>Setup the testing environment with the right contracts and necessary balances.</li>
<li>Analyze the before function in <code>test/the-rewarder/the-rewarder.challenge.js</code> to identify what initial setup needs to be done.</li>
<li>Add a property to check whether the attacker can get almost whole reward (let us say more than 99 %) from the <code>TheRewarderPool</code> contract.</li>
<li>Create a <code>config.yaml</code> with the necessary configuration option(s).</li>
<li>Once Echidna finds the bug, .... well, this time to fix the issue would mean to apply completely different reward logic as in this particular solution is rather naive implementation.</li>
</ul>
<p>Only the following contracts are relevant:</p>
<ul>
<li><code>contracts/the-rewarder/TheRewarderPool.sol</code></li>
<li><code>contracts/the-rewarder/FlashLoanerPool.sol</code></li>
</ul>
<h2 id="hints-2"><a class="header" href="#hints-2">Hints</a></h2>
<p>We recommend to first try without reading the following hints. The hints are in the <a href="https://github.com/crytic/damn-vulnerable-defi-echidna/tree/hints"><code>hints</code> branch</a>.</p>
<ul>
<li>The invariant that we are looking for is &quot;an attacker cannot get almost whole amount of rewards&quot;</li>
<li>Read what is the <a href="program-analysis/echidna/exercises/../basic/common-testing-approaches.html#external-testing">multi abi option</a></li>
<li>A config file is provided in <a href="https://github.com/crytic/damn-vulnerable-defi-echidna/blob/solutions/the-rewarder.yaml">the-rewarder.yaml</a></li>
</ul>
<h2 id="solution-7"><a class="header" href="#solution-7">Solution</a></h2>
<p>This solution can be found in <a href="https://github.com/crytic/damn-vulnerable-defi-echidna/blob/solutions/contracts/the-rewarder/EchidnaRewarder.sol"><code>solutions</code> branch</a>.</p>
<details>
<summary>Solution Explained (spoilers ahead)</summary>
<p>The goal of the rewarder challenge is to realize that an arbitrary user can call request a flash loan from <code>FlashLoanerPool</code> and borrow the whole amount of Damn Valuable Tokens (DVT) available. Then this amount of DVT can deposit into <code>TheRewarderPool</code>. By doing this, the user affects total proportion of tokens deposited in the <code>TheRewarderPool</code> (and thus gets the most of the percentage of deposited asset in that particular time on his/her side). Furthermore, if the user schedules it in the right time (once the <code>REWARDS_ROUND_MIN_DURATION</code> is reached), snapshot of users deposits is taken, the user repay immediately the loan (i.e., in the same transaction) and gets almost whole reward in return.
In fact, this can be done even if the arbitrary user has no DVT.</p>
<p>Echidna reveals this vulnerability by finding the right order of two function, simply calling (1) <code>TheRewarderPool.deposit()</code> (with prior approval) and (2) <code>TheRewarderPool.withdraw()</code> with the max amount of DVT borrowed in flash loan in both functions mentioned.</p>
<p>See example output below from Echidna:</p>
<pre><code class="language-bash">$ echidna-test . --contract EchidnaRewarder --config ./the-rewarder.yaml
...

testRewards(): failed!💥
  Call sequence:
    *wait* Time delay: 441523 seconds Block delay: 9454
    setEnableDeposit(true) from: 0x0000000000000000000000000000000000030000
    setEnableWithdrawal(true) from: 0x0000000000000000000000000000000000030000
    flashLoan(39652220640884191256808) from: 0x0000000000000000000000000000000000030000
    testRewards() from: 0x0000000000000000000000000000000000030000

...
</code></pre>
</details>
<div style="break-before: page; page-break-before: always;"></div><h1 id="manticore-tutorial"><a class="header" href="#manticore-tutorial">Manticore Tutorial</a></h1>
<p>The aim of this tutorial is to show how to use Manticore to automatically find bugs in smart contracts.</p>
<p>The first part introduces a set of the basic features of Manticore: running under Manticore and manipulating smart contracts through API, getting throwing path, adding constraints.
The second part is exercise to solve.</p>
<p><strong>Table of contents:</strong></p>
<ul>
<li><a href="program-analysis/manticore/index.html#installation">Installation</a></li>
<li><a href="program-analysis/manticore/./symbolic-execution-introduction.html">Introduction to symbolic execution</a>: Brief introduction to symbolic execution</li>
<li><a href="program-analysis/manticore/./running-under-manticore.html">Running under Manticore</a>: How to use Manticore's API to run a contract</li>
<li><a href="program-analysis/manticore/./getting-throwing-paths.html">Getting throwing paths</a>: How to use Manticore's API to get specific paths</li>
<li><a href="program-analysis/manticore/./adding-constraints.html">Adding constraints</a>: How to use Manticore's API to add paths' constraints</li>
<li><a href="program-analysis/manticore/./exercises">Exercises</a></li>
</ul>
<p>Join the team on Slack at: https://empireslacking.herokuapp.com/ #ethereum, #manticore</p>
<h2 id="installation"><a class="header" href="#installation">Installation</a></h2>
<p>Manticore requires &gt;= python 3.6. It can be installed through pip or using docker.</p>
<h2 id="manticore-through-docker"><a class="header" href="#manticore-through-docker">Manticore through docker</a></h2>
<pre><code class="language-bash">docker pull trailofbits/eth-security-toolbox
docker run -it -v &quot;$PWD&quot;:/home/training trailofbits/eth-security-toolbox
</code></pre>
<p><em>The last command runs eth-security-toolbox in a docker that has access to your current directory. You can change the files from your host, and run the tools on the files from the docker</em></p>
<p>Inside docker, run:</p>
<pre><code class="language-bash">solc-select 0.5.11
cd /home/trufflecon/
</code></pre>
<h3 id="manticore-through-pip"><a class="header" href="#manticore-through-pip">Manticore through pip</a></h3>
<pre><code class="language-bash">pip3 install --user manticore
</code></pre>
<p>solc 0.5.11 is recommended.</p>
<h3 id="running-a-script"><a class="header" href="#running-a-script">Running a script</a></h3>
<p>To run a python script with python 3:</p>
<pre><code class="language-bash">python3 script.py
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-to-dynamic-symbolic-execution"><a class="header" href="#introduction-to-dynamic-symbolic-execution">Introduction to dynamic symbolic execution</a></h1>
<p><a href="program-analysis/manticore/">Manticore</a> is a dynamic symbolic execution tool, we described in our previous blogposts (<a href="https://blog.trailofbits.com/2017/04/27/manticore-symbolic-execution-for-humans/">1</a>, <a href="https://blog.trailofbits.com/2017/05/15/magic-with-manticore/">2</a>, <a href="https://blog.trailofbits.com/2017/05/15/magic-with-manticore/">3</a>, <a href="https://blog.trailofbits.com/2017/05/15/magic-with-manticore/">4</a>).</p>
<h2 id="dynamic-symbolic-execution-in-a-nutshell"><a class="header" href="#dynamic-symbolic-execution-in-a-nutshell">Dynamic Symbolic Execution in a Nutshell</a></h2>
<p>Dynamic symbolic execution (DSE) is a program analysis technique that explores a state space with a high degree of semantic awareness. This technique is based on the discovery of &quot;program paths&quot;, represented as mathematical formulas called <code>path predicates</code>. Conceptually,  this technique operates on path predicates in two steps: </p>
<ol>
<li>They are constructed using constraints on the program's input. </li>
<li>They are used to generate program inputs that will cause the associated paths to execute.</li>
</ol>
<p>This approach produces no false positives in the sense that all identified program states can be triggered during concrete execution. For example, if the analysis finds an integer overflow, it is guaranteed to be reproducible.</p>
<h3 id="path-predicate-example"><a class="header" href="#path-predicate-example">Path Predicate Example</a></h3>
<p>To get an insigh of how DSE works, consider the following example:</p>
<pre><code class="language-solidity">function f(uint a){
  
  if (a == 65) {
      // A bug is present
  }
  
}
</code></pre>
<p>As <code>f()</code> contains two paths, a DSE will construct two differents path predicates:</p>
<ul>
<li>Path 1: <code>a == 65</code></li>
<li>Path 2: <code>Not (a == 65)</code></li>
</ul>
<p>Each path predicate is a mathematical formula that can be given to a so-called <code>SMT solver</code>, which will try to solve the equation. For <code>Path 1</code>, the solver will say that the path can be explored with <code>a = 65</code>. For <code>Path 2</code>, the solver can give <code>a</code> any value other than 65, for example <code>a = 0</code>.</p>
<h3 id="verifying-properties"><a class="header" href="#verifying-properties">Verifying properties</a></h3>
<p>Manticore allows a full control over all the execution of each path. As a result, it allows to add arbirtray contraints to almost anything. This control allows for the creation of properties on the contract.</p>
<p>Consider the following example:</p>
<pre><code class="language-solidity">function unsafe_add(uint a, uint b) returns(uint c){
  c = a + b; // no overflow protection
  return c;
}
</code></pre>
<p>Here there is only one path to explore in the function:</p>
<ul>
<li>Path 1: <code>c = a + b</code></li>
</ul>
<p>Using Manticore, you can check for overflow, and add constraitns to the path predicate:</p>
<ul>
<li><code>c = a + b AND (c &lt; a OR c &lt; b)</code></li>
</ul>
<p>If it is possible to find a valuation of <code>a</code> and <code>b</code> for which the path predicate above is feasible, it means that you have found an overflow. For example the solver can generate the input <code>a = 10 , b = MAXUINT256</code>.</p>
<p>If you consider a fixed version:</p>
<pre><code class="language-solidity">function safe_add(uint a, uint b) returns(uint c){
  c = a + b; 
  require(c&gt;=a);
  require(c&gt;=b);
  return c;
}
</code></pre>
<p>The associated formula with overflow check would be:</p>
<ul>
<li><code>c = a + b AND (c &gt;= a) AND (c=&gt;b) AND (c &lt; a OR c &lt; b)</code></li>
</ul>
<p>This formula cannot be solved; in other words this is a <strong>proof</strong> that in <code>safe_add</code>, <code>c</code> will always increase.</p>
<p>DSE is thereby a powerful tool, that can verify arbitrary constraints on your code.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="running-under-manticore"><a class="header" href="#running-under-manticore">Running under Manticore</a></h1>
<p><strong>Table of contents:</strong></p>
<ul>
<li><a href="program-analysis/manticore/running-under-manticore.html#introduction">Introduction</a></li>
<li><a href="program-analysis/manticore/running-under-manticore.html#run-a-standalone-exploration">Run a standalone exploration</a></li>
<li><a href="program-analysis/manticore/running-under-manticore.html#manipulate-a-smart-contract-through-the-api">Manipulate a smart contract through the API</a></li>
<li><a href="program-analysis/manticore/running-under-manticore.html#summary-running-under-manticore">Summary: Running under Manticore</a></li>
</ul>
<h2 id="introduction-11"><a class="header" href="#introduction-11">Introduction</a></h2>
<p>We will see how to explore a smart contract with the Manticore API. The target is the following smart contract (<em><a href="program-analysis/manticore/./examples/example.sol">examples/example.sol</a></em>):</p>
<pre><code class="language-Solidity">pragma solidity &gt;=0.4.24 &lt;0.6.0;
contract Simple {
    function f(uint a) payable public{
        if (a == 65) {
            revert();
        }
    }
}
</code></pre>
<h2 id="run-a-standalone-exploration"><a class="header" href="#run-a-standalone-exploration">Run a standalone exploration</a></h2>
<p>You can run Manticore directly on the smart contract by the following command (<code>project</code> can be a Solidity File, or a project directory):</p>
<pre><code class="language-bash">$ manticore project
</code></pre>
<p>You will get the output of testcases like this one (the order may change):</p>
<pre><code>...
... m.c.manticore:INFO: Generated testcase No. 0 - STOP
... m.c.manticore:INFO: Generated testcase No. 1 - REVERT
... m.c.manticore:INFO: Generated testcase No. 2 - RETURN
... m.c.manticore:INFO: Generated testcase No. 3 - REVERT
... m.c.manticore:INFO: Generated testcase No. 4 - STOP
... m.c.manticore:INFO: Generated testcase No. 5 - REVERT
... m.c.manticore:INFO: Generated testcase No. 6 - REVERT
... m.c.manticore:INFO: Results in /home/ethsec/workshops/Automated Smart Contracts Audit - TruffleCon 2018/manticore/examples/mcore_t6vi6ij3
...
</code></pre>
<p>Without additional information, Manticore will explore the contract with new symbolic
transactions until it does not explore new paths on the contract. Manticore does not run new transactions after a failing one (e.g: after a revert).</p>
<p>Manticore will output the information in a <code>mcore_*</code> directory. Among other, you will find in this directory:</p>
<ul>
<li><code>global.summary</code>: coverage and compiler warnings</li>
<li><code>test_XXXXX.summary</code>: coverage, last instruction, account balances per test case</li>
<li><code>test_XXXXX.tx</code>: detailed list of transactions per test case</li>
</ul>
<p>Here Manticore founds 7 test cases, which correspond to (the filename order may change):</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center"></th><th style="text-align: center">Transaction 0</th><th style="text-align: center">Transaction 1</th><th>Transaction 2</th><th style="text-align: center">Result</th></tr></thead><tbody>
<tr><td style="text-align: center"><strong>test_00000000.tx</strong></td><td style="text-align: center">Contract  creation</td><td style="text-align: center">f(!=65)</td><td>f(!=65)</td><td style="text-align: center">STOP</td></tr>
<tr><td style="text-align: center"><strong>test_00000001.tx</strong></td><td style="text-align: center">Contract  creation</td><td style="text-align: center">fallback function</td><td></td><td style="text-align: center">REVERT</td></tr>
<tr><td style="text-align: center"><strong>test_00000002.tx</strong></td><td style="text-align: center">Contract  creation</td><td style="text-align: center"></td><td></td><td style="text-align: center">RETURN</td></tr>
<tr><td style="text-align: center"><strong>test_00000003.tx</strong></td><td style="text-align: center">Contract  creation</td><td style="text-align: center">f(65)</td><td></td><td style="text-align: center">REVERT</td></tr>
<tr><td style="text-align: center"><strong>test_00000004.tx</strong></td><td style="text-align: center">Contract  creation</td><td style="text-align: center">f(!=65)</td><td></td><td style="text-align: center">STOP</td></tr>
<tr><td style="text-align: center"><strong>test_00000005.tx</strong></td><td style="text-align: center">Contract  creation</td><td style="text-align: center">f(!=65)</td><td>f(65)</td><td style="text-align: center">REVERT</td></tr>
<tr><td style="text-align: center"><strong>test_00000006.tx</strong></td><td style="text-align: center">Contract  creation</td><td style="text-align: center">f(!=65)</td><td>fallback function</td><td style="text-align: center">REVERT</td></tr>
</tbody></table>
</div>
<p><em>Exploration summary f(!=65) denotes f called with any value different than 65.</em></p>
<p>As you can notice, Manticore generates an unique test case for every successful or reverted transaction.</p>
<p>Use the <code>--quick-mode</code> flag if you want fast code exploration (it disable bug detectors, gas computation, ...)</p>
<h2 id="manipulate-a-smart-contract-through-the-api"><a class="header" href="#manipulate-a-smart-contract-through-the-api">Manipulate a smart contract through the API</a></h2>
<p>This section describes details how to manipulate a smart contract through the Manticore Python API. You can create new file with python extension <code>*.py</code> and write the necessary code by adding the API commands (basics of which will be described below) into this file and then run it with the command <code>$ python3 *.py</code>. Also you can execute the commands below directly into the python console, to run the console use the command <code>$ python3</code>.</p>
<h3 id="creating-accounts"><a class="header" href="#creating-accounts">Creating Accounts</a></h3>
<p>The first thing you should do is to initiate a new blockchain with the following commands:</p>
<pre><code class="language-python3">from manticore.ethereum import ManticoreEVM

m = ManticoreEVM()
</code></pre>
<p>A non-contract account is created using <a href="https://manticore.readthedocs.io/en/latest/evm.html#manticore.ethereum.ManticoreEVM.create_account">m.create_account</a>:</p>
<pre><code class="language-python3">user_account = m.create_account(balance=1 * 10**18)
</code></pre>
<p>A Solidity contract can be deployed using <a href="https://manticore.readthedocs.io/en/latest/evm.html#manticore.ethereum.ManticoreEVM.solidity_create_contract">m.solidity_create_contract</a>:</p>
<pre><code class="language-python3">source_code = '''
pragma solidity &gt;=0.4.24 &lt;0.6.0;
contract Simple {
    function f(uint a) payable public{
        if (a == 65) {
            revert();
        }
    }
}
'''
# Initiate the contract
contract_account = m.solidity_create_contract(source_code, owner=user_account)
</code></pre>
<h4 id="summary"><a class="header" href="#summary">Summary</a></h4>
<ul>
<li>You can create user and contract accounts with <a href="https://manticore.readthedocs.io/en/latest/evm.html#manticore.ethereum.ManticoreEVM.create_account">m.create_account</a> and <a href="https://manticore.readthedocs.io/en/latest/evm.html#manticore.ethereum.ManticoreEVM.solidity_create_contract">m.solidity_create_contract</a>.</li>
</ul>
<h3 id="executing-transactions"><a class="header" href="#executing-transactions">Executing transactions</a></h3>
<p>Manticore supports two types of transaction:</p>
<ul>
<li>Raw transaction: all the functions are explored</li>
<li>Named transaction: only one function is explored</li>
</ul>
<h4 id="raw-transaction"><a class="header" href="#raw-transaction">Raw transaction</a></h4>
<p>A raw transaction is executed using <a href="https://manticore.readthedocs.io/en/latest/evm.html#manticore.ethereum.ManticoreEVM.transaction">m.transaction</a>:</p>
<pre><code class="language-python3">m.transaction(caller=user_account,
              address=contract_account,
              data=data,
              value=value)
</code></pre>
<p>The caller, the address, the data, or the value of the transaction can be either concrete or symbolic:</p>
<ul>
<li><a href="https://manticore.readthedocs.io/en/latest/evm.html#manticore.ethereum.ManticoreEVM.make_symbolic_value">m.make_symbolic_value</a> creates a symbolic value.</li>
<li><a href="https://manticore.readthedocs.io/en/latest/evm.html#manticore.ethereum.ManticoreEVM.make_symbolic_buffer">m.make_symbolic_buffer(size)</a> creates a symbolic byte array.</li>
</ul>
<p>For example:</p>
<pre><code class="language-python3">symbolic_value = m.make_symbolic_value()
symbolic_data = m.make_symbolic_buffer(320)
m.transaction(caller=user_account,
              address=contract_address,
              data=symbolic_data,
              value=symbolic_value)
</code></pre>
<p>If the data is symbolic, Manticore will explore all the functions of the contract during the transaction execution. It will be helpful to see the Fallback Function explanation in the <a href="https://blog.trailofbits.com/2017/11/06/hands-on-the-ethernaut-ctf/">Hands on the Ethernaut CTF</a> article for understanding how the function selection works.</p>
<h4 id="named-transaction"><a class="header" href="#named-transaction">Named transaction</a></h4>
<p>Functions can be executed through their name.
To execute <code>f(uint var)</code> with a symbolic value, from user_account, and with 0 ether, use:</p>
<pre><code class="language-python3">symbolic_var = m.make_symbolic_value()
contract_account.f(symbolic_var, caller=user_account, value=0)
</code></pre>
<p>If <code>value</code> of the transaction is not specified, it is 0 by default.</p>
<h4 id="summary-1"><a class="header" href="#summary-1">Summary</a></h4>
<ul>
<li>Arguments of a transaction can be concrete or symbolic</li>
<li>A raw transaction will explore all the functions</li>
<li>Function can be called by their name</li>
</ul>
<h3 id="workspace"><a class="header" href="#workspace">Workspace</a></h3>
<p><code>m.workspace</code> is the directory used as output directory for all the files generated:</p>
<pre><code class="language-python3">print(&quot;Results are in {}&quot;.format(m.workspace))
</code></pre>
<h3 id="terminate-the-exploration"><a class="header" href="#terminate-the-exploration">Terminate the Exploration</a></h3>
<p>To stop the exploration use <a href="https://manticore.readthedocs.io/en/latest/evm.html#manticore.ethereum.ManticoreEVM.finalize">m.finalize()</a>. No further transactions should be sent once this method is called and Manticore generates test cases for each of the path explored.</p>
<h2 id="summary-running-under-manticore"><a class="header" href="#summary-running-under-manticore">Summary: Running under Manticore</a></h2>
<p>Putting all the previous steps together, we obtain:</p>
<pre><code class="language-python3">from manticore.ethereum import ManticoreEVM

m = ManticoreEVM()

with open('example.sol') as f:
    source_code = f.read()

user_account = m.create_account(balance=1*10**18)
contract_account = m.solidity_create_contract(source_code, owner=user_account)

symbolic_var = m.make_symbolic_value()
contract_account.f(symbolic_var)

print(&quot;Results are in {}&quot;.format(m.workspace))
m.finalize() # stop the exploration
</code></pre>
<p>All the code above you can find into the <a href="program-analysis/manticore/./examples/example_run.py">examples/example_run.py</a></p>
<p>The next step is to <a href="program-analysis/manticore/./getting-throwing-paths.html">accessing the paths</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="getting-throwing-path"><a class="header" href="#getting-throwing-path">Getting Throwing Path</a></h1>
<p><strong>Table of contents:</strong></p>
<ul>
<li><a href="program-analysis/manticore/getting-throwing-paths.html#getting-throwing-path">Getting Throwing Path</a>
<ul>
<li><a href="program-analysis/manticore/getting-throwing-paths.html#introduction">Introduction</a></li>
<li><a href="program-analysis/manticore/getting-throwing-paths.html#using-state-information">Using state information</a></li>
<li><a href="program-analysis/manticore/getting-throwing-paths.html#how-to-generate-testcase">How to generate testcase</a></li>
<li><a href="program-analysis/manticore/getting-throwing-paths.html#summary">Summary</a></li>
<li><a href="program-analysis/manticore/getting-throwing-paths.html#summary-getting-throwing-path">Summary: Getting Throwing Path</a></li>
</ul>
</li>
</ul>
<h2 id="introduction-12"><a class="header" href="#introduction-12">Introduction</a></h2>
<p>We will now improve <a href="program-analysis/manticore/running-under-manticore.html">the previous example</a> and generate specific inputs for the paths raising an exception in <code>f()</code>. The target is still the following smart contract (<em><a href="program-analysis/manticore/./examples/example.sol">examples/example.sol</a></em>):</p>
<pre><code class="language-Solidity">pragma solidity &gt;=0.4.24 &lt;0.6.0;
contract Simple {
    function f(uint a) payable public{
        if (a == 65) {
            revert();
        }
    }
}
</code></pre>
<h2 id="using-state-information"><a class="header" href="#using-state-information">Using state information</a></h2>
<p>Each path executed has its state of the blockchain. A state is either ready or it is killed, meaning that it reaches a THROW or REVERT instruction:</p>
<ul>
<li><a href="https://manticore.readthedocs.io/en/latest/states.html#accessing">m.ready_states</a>: the list of states that are ready (they did not execute a REVERT/INVALID)</li>
<li><a href="https://manticore.readthedocs.io/en/latest/states.html#accessings">m.killed_states</a>: the list of states that are ready (they did not execute a REVERT/INVALID)</li>
<li><a href="https://manticore.readthedocs.io/en/latest/states.html#accessings">m.all_states</a>: all the states</li>
</ul>
<pre><code class="language-python3">for state in m.all_states:
    # do something with state
</code></pre>
<p>You can access state information. For example:</p>
<ul>
<li><code>state.platform.get_balance(account.address)</code>: the balance of the account</li>
<li><code>state.platform.transactions</code>: the list of transactions</li>
<li><code>state.platform.transactions[-1].return_data</code>: the data returned by the last transaction</li>
</ul>
<p>The data returned by the last transaction is an array, which can be converted to a value with ABI.deserialize, for example:</p>
<pre><code class="language-python">data = state.platform.transactions[0].return_data
data = ABI.deserialize(&quot;uint&quot;, data)
</code></pre>
<h2 id="how-to-generate-testcase"><a class="header" href="#how-to-generate-testcase">How to generate testcase</a></h2>
<p>Use <a href="https://github.com/trailofbits/manticore/blob/dc8c3c822bbd50adabe50cafef38457505c0bc7b/manticore/ethereum/manticore.py#L1572">m.generate_testcase(state, name)</a> to generate testcase:</p>
<pre><code class="language-python3">m.generate_testcase(state, 'BugFound')
</code></pre>
<h2 id="summary-2"><a class="header" href="#summary-2">Summary</a></h2>
<ul>
<li>You can iterate over the state with m.all_states</li>
<li><code>state.platform.get_balance(account.address)</code> returns the account’s balance</li>
<li><code>state.platform.transactions</code> returns the list of transactions</li>
<li><code>transaction.return_data</code> is the data returned</li>
<li><code>m.generate_testcase(state, name)</code> generate inputs for the state</li>
</ul>
<h2 id="summary-getting-throwing-path"><a class="header" href="#summary-getting-throwing-path">Summary: Getting Throwing Path</a></h2>
<pre><code class="language-python3">from manticore.ethereum import ManticoreEVM

m = ManticoreEVM()

with open('example.sol') as f:
    source_code = f.read()

user_account = m.create_account(balance=1*10**18)
contract_account = m.solidity_create_contract(source_code, owner=user_account)

symbolic_var = m.make_symbolic_value()
contract_account.f(symbolic_var)

## Check if an execution ends with a REVERT or INVALID
for state in m.terminated_states:
    last_tx = state.platform.transactions[-1]
    if last_tx.result in ['REVERT', 'INVALID']:
        print('Throw found {}'.format(m.workspace))
        m.generate_testcase(state, 'ThrowFound')
</code></pre>
<p>All the code above you can find into the <a href="program-analysis/manticore/./examples/example_throw.py">examples/example_throw.py</a></p>
<p>The next step is to <a href="program-analysis/manticore/./adding-constraints.html">add constraints</a> to the state.</p>
<p><em>Note we could have generated a much simpler script, as all the states returned by terminated_state have REVERT or INVALID in their result: this example was only meant to demonstrate how to manipulate the API.</em></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="adding-constraints"><a class="header" href="#adding-constraints">Adding Constraints</a></h1>
<p><strong>Table of contents:</strong></p>
<ul>
<li><a href="program-analysis/manticore/adding-constraints.html#adding-constraints">Adding Constraints</a>
<ul>
<li><a href="program-analysis/manticore/adding-constraints.html#introduction">Introduction</a></li>
<li><a href="program-analysis/manticore/adding-constraints.html#operators">Operators</a></li>
<li><a href="program-analysis/manticore/adding-constraints.html#constraints">Constraints</a>
<ul>
<li><a href="program-analysis/manticore/adding-constraints.html#global-constraint">Global constraint</a></li>
<li><a href="program-analysis/manticore/adding-constraints.html#state-constraint">State constraint</a></li>
</ul>
</li>
<li><a href="program-analysis/manticore/adding-constraints.html#checking-constraint">Checking Constraint</a></li>
<li><a href="program-analysis/manticore/adding-constraints.html#summary-adding-constraints">Summary: Adding Constraints</a></li>
</ul>
</li>
</ul>
<h2 id="introduction-13"><a class="header" href="#introduction-13">Introduction</a></h2>
<p>We will see how to constrain the exploration. We will make the assumption that the
documentation of <code>f()</code> states that the function is never called with <code>a == 65</code>, so any bug with <code>a == 65</code> is not a real bug. The target is still the following smart contract (<em><a href="program-analysis/manticore/./examples/example.sol">examples/example.sol</a></em>):</p>
<pre><code class="language-Solidity">pragma solidity &gt;=0.4.24 &lt;0.6.0;
contract Simple {
    function f(uint a) payable public{
        if (a == 65) {
            revert();
        }
    }
}
</code></pre>
<h2 id="operators"><a class="header" href="#operators">Operators</a></h2>
<p>The <a href="https://github.com/trailofbits/manticore/blob/master/manticore/core/smtlib/operators.py">Operators</a> module facilitates the manipulation of constraints, among other it provides:</p>
<ul>
<li>Operators.AND,</li>
<li>Operators.OR,</li>
<li>Operators.UGT (unsigned greater than),</li>
<li>Operators.UGE (unsigned greater than or equal to),</li>
<li>Operators.ULT (unsigned lower than),</li>
<li>Operators.ULE (unsigned lower than or equal to).</li>
</ul>
<p>To import the module use the following:</p>
<pre><code class="language-python3">from manticore.core.smtlib import Operators
</code></pre>
<p><code>Operators.CONCAT</code> is used to concatenate an array to a value. For example, the return_data of a transaction needs to be changed to a value to be checked against another value:</p>
<pre><code class="language-python3">last_return = Operators.CONCAT(256, *last_return)
</code></pre>
<h2 id="constraints"><a class="header" href="#constraints">Constraints</a></h2>
<p>You can use constraints globally or for a specific state.</p>
<h3 id="global-constraint"><a class="header" href="#global-constraint">Global constraint</a></h3>
<p>Use <code>m.constrain(constraint)</code> to add a global cosntraint.
For example, you can call a contract from a symbolic address, and restraint this address to be specific values:</p>
<pre><code class="language-python3">symbolic_address = m.make_symbolic_value()
m.constraint(Operators.OR(symbolic == 0x41, symbolic_address == 0x42))
m.transaction(caller=user_account,
              address=contract_account,
              data=m.make_symbolic_buffer(320),
              value=0)
</code></pre>
<h3 id="state-constraint"><a class="header" href="#state-constraint">State constraint</a></h3>
<p>Use <a href="https://manticore.readthedocs.io/en/latest/states.html?highlight=statebase#manticore.core.state.StateBase.constrain">state.constrain(constraint)</a> to add a constraint to a specific state
It can be used to constrain the state after its exploration to check some property on it.</p>
<h2 id="checking-constraint"><a class="header" href="#checking-constraint">Checking Constraint</a></h2>
<p>Use <code>solver.check(state.constraints)</code> to know if a constraint is still feasible. 
For example, the following will constraint  symbolic_value to be different from 65 and check if the state is still feasible:</p>
<pre><code class="language-python3">state.constrain(symbolic_var != 65)
if solver.check(state.constraints):
    # state is feasible
</code></pre>
<h2 id="summary-adding-constraints"><a class="header" href="#summary-adding-constraints">Summary: Adding Constraints</a></h2>
<p>Adding constraint to the previous code, we obtain:</p>
<pre><code class="language-python3">from manticore.ethereum import ManticoreEVM
from manticore.core.smtlib.solver import Z3Solver

solver = Z3Solver.instance()

m = ManticoreEVM()

with open(&quot;example.sol&quot;) as f:
    source_code = f.read()

user_account = m.create_account(balance=1*10**18)
contract_account = m.solidity_create_contract(source_code, owner=user_account)

symbolic_var = m.make_symbolic_value()
contract_account.f(symbolic_var)

no_bug_found = True

## Check if an execution ends with a REVERT or INVALID
for state in m.terminated_states:
    last_tx = state.platform.transactions[-1]
    if last_tx.result in ['REVERT', 'INVALID']:
        # we do not consider the path were a == 65
        condition = symbolic_var != 65
        if m.generate_testcase(state, name=&quot;BugFound&quot;, only_if=condition):
            print(f'Bug found, results are in {m.workspace}')
            no_bug_found = False

if no_bug_found:
    print(f'No bug found')
</code></pre>
<p>All the code above you can find into the <a href="program-analysis/manticore/./examples/example_constraint.py">examples/example_constraint.py</a></p>
<p>The next step is to follow the <a href="program-analysis/manticore/./exercises">exercises</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="manticore-exercises"><a class="header" href="#manticore-exercises">Manticore Exercises</a></h1>
<ul>
<li><a href="program-analysis/manticore/exercises/./example.html">Example</a>: Arithmetic overflow</li>
<li><a href="program-analysis/manticore/exercises/./exercise1.html">Exercise 1</a>: Arithmetic rounding</li>
<li><a href="program-analysis/manticore/exercises/./exercise2.html">Exercise 2</a>: Arithmetic overflow through multiple transactions</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="example-arithmetic-overflow"><a class="header" href="#example-arithmetic-overflow">Example: Arithmetic overflow</a></h1>
<p>This scenario is given as an example. You can follow its structure to solve the exercises.</p>
<p><a href="program-analysis/manticore/exercises/example/my_token.py"><code>my_token.py</code></a> uses manticore to find for an attacker to generate tokens during a transfer on Token (<a href="program-analysis/manticore/exercises/example/my_token.sol">my_token.sol</a>).</p>
<p>## Proposed scenario</p>
<p>We use the pattern initilization, exploration and property for our scripts.</p>
<h3 id="initialization"><a class="header" href="#initialization">Initialization</a></h3>
<ul>
<li>Create one user account</li>
<li>Create the contract account</li>
</ul>
<h3 id="exploration"><a class="header" href="#exploration">Exploration</a></h3>
<ul>
<li>Call balances on the user account</li>
<li>Call transfer with symbolic destination and value</li>
<li>Call balances on the user account</li>
</ul>
<h3 id="property"><a class="header" href="#property">Property</a></h3>
<ul>
<li>Check if the user can have more token after the transfer than before.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercice-1--arithmetic"><a class="header" href="#exercice-1--arithmetic">Exercice 1 : Arithmetic</a></h1>
<p>Use Manticore to find an input allowing an attacker to generate free tokens in <a href="program-analysis/manticore/exercises/./exercise1/token.sol">exercise1/token.sol</a>.
Propose a fix of the contract, and test your fix using your Manticore script.</p>
<h2 id="proposed-scenario"><a class="header" href="#proposed-scenario">Proposed scenario</a></h2>
<p>Follow the pattern initilization, exploration and property for the script.</p>
<h3 id="initialization-1"><a class="header" href="#initialization-1">Initialization</a></h3>
<ul>
<li>Create one account</li>
<li>Create the contract account</li>
</ul>
<h3 id="exploration-1"><a class="header" href="#exploration-1">Exploration</a></h3>
<ul>
<li>Call <code>is_valid_buy</code> with two symbolic values for tokens_amount and wei_amount</li>
</ul>
<h3 id="property-1"><a class="header" href="#property-1">Property</a></h3>
<ul>
<li>An attack is found if on a state alive <code>wei_amount == 0 and tokens_amount &gt;= 1</code></li>
</ul>
<h3 id="hints-3"><a class="header" href="#hints-3">Hints</a></h3>
<ul>
<li><code>m.ready_states</code> returns the list of state alive</li>
<li><code>Operators.AND(a, b)</code> allows to create and AND condition</li>
<li>You can use the template proposed in <a href="program-analysis/manticore/exercises/./exercise1/template.py">exercise1/template.py</a></li>
</ul>
<h3 id="solution-8"><a class="header" href="#solution-8">Solution</a></h3>
<p><a href="program-analysis/manticore/exercises/./exercise1/solution.py">exercise1/solution.py</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercice-2--arithmetic-on-multi-transactions"><a class="header" href="#exercice-2--arithmetic-on-multi-transactions">Exercice 2 : Arithmetic on multi transactions</a></h1>
<p>Use Manticore to find if an overflow is possible in Overflow.add. Propose a fix of the contract, and test your fix using your Manticore script.</p>
<h2 id="proposed-scenario-1"><a class="header" href="#proposed-scenario-1">Proposed scenario</a></h2>
<p>Follow the pattern initilization, exploration and property for the script.</p>
<h3 id="initialization-2"><a class="header" href="#initialization-2">Initialization</a></h3>
<ul>
<li>Create one user account</li>
<li>Create the contract account</li>
</ul>
<h2 id="exploration-2"><a class="header" href="#exploration-2">Exploration</a></h2>
<ul>
<li>Call two times <code>add</code> with two symbolic values</li>
<li>Call <code>sellerBalance()</code></li>
</ul>
<h2 id="property-2"><a class="header" href="#property-2">Property</a></h2>
<ul>
<li>Check if it is possible for the value returned by sellerBalance() to be lower than the first input.</li>
</ul>
<p>## Hints:</p>
<ul>
<li>The value returned by the last transaction can be accessed through:</li>
</ul>
<pre><code class="language-python">state.platform.transactions[-1].return_data
</code></pre>
<ul>
<li>The data returned needs to be deserialized:</li>
</ul>
<pre><code class="language-python">data = ABI.deserialize(&quot;uint&quot;, data)
</code></pre>
<ul>
<li>You can use the template proposed in <a href="program-analysis/manticore/exercises/./exercise2/template.py">exercise2/template.py</a></li>
</ul>
<h3 id="solution-9"><a class="header" href="#solution-9">Solution</a></h3>
<p><a href="program-analysis/manticore/exercises/./exercise2/solution.py">exercise2/solution.py</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="slither"><a class="header" href="#slither">Slither</a></h1>
<p>The aim of this tutorial is to show how to use Slither to automatically find bugs in smart contracts.</p>
<ul>
<li><a href="program-analysis/slither/index.html#installation">Installation</a></li>
<li><a href="program-analysis/slither/index.html#command-line">Command line usage</a></li>
<li><a href="program-analysis/slither/./static_analysis.html">Introduction to static analysis</a>: Brief introduction to static analysis</li>
<li><a href="program-analysis/slither/./api.html">API</a>: Python API description</li>
</ul>
<p>Once you feel you understand the material in this README, proceed to the exercises:</p>
<ul>
<li><a href="program-analysis/slither/./exercise1.html">Exercise 1</a>: Function override protection</li>
<li><a href="program-analysis/slither/./exercise2.html">Exercise 2</a>: Check for access controls</li>
</ul>
<p>Watch Slither's <a href="https://www.youtube.com/watch?v=EUl3UlYSluU">code walkthrough</a> to learn about its code structure.</p>
<h2 id="installation-1"><a class="header" href="#installation-1">Installation</a></h2>
<p>Slither requires Python &gt;= 3.8. It can be installed through pip or using docker.</p>
<p>Slither through pip:</p>
<pre><code class="language-bash">pip3 install --user slither-analyzer
</code></pre>
<h3 id="docker"><a class="header" href="#docker">Docker</a></h3>
<p>Slither through docker:</p>
<pre><code class="language-bash">docker pull trailofbits/eth-security-toolbox
docker run -it -v &quot;$PWD&quot;:/home/trufflecon trailofbits/eth-security-toolbox
</code></pre>
<p><em>The last command runs eth-security-toolbox in a docker that has access to your current directory. You can change the files from your host, and run the tools on the files from the docker</em></p>
<p>Inside docker, run:</p>
<pre><code class="language-bash">solc-select 0.5.11
cd /home/trufflecon/
</code></pre>
<h2 id="command-line"><a class="header" href="#command-line">Command line</a></h2>
<p><strong>Command line versus user-defined scripts.</strong> Slither comes with a set of predefined detectors that find many common bugs. Calling Slither from the command line will run all the detectors, no detailed knowledge of static analysis needed:</p>
<pre><code class="language-bash">slither project_paths
</code></pre>
<p>In addition to detectors, Slither has code review capabilities through its <a href="https://github.com/crytic/slither#printers">printers</a> and <a href="https://github.com/crytic/slither#tools">tools</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="static-analysis"><a class="header" href="#static-analysis">Static analysis</a></h2>
<p>The capabilities and design of the Slither static analysis framework has been described in blog posts (<a href="https://blog.trailofbits.com/2018/10/19/slither-a-solidity-static-analysis-framework/">1</a>, <a href="https://blog.trailofbits.com/2019/05/27/slither-the-leading-static-analyzer-for-smart-contracts/">2</a>) and an <a href="https://github.com/trailofbits/publications/blob/master/papers/wetseb19.pdf">academic paper</a>.</p>
<p>Static analysis exists in different flavors. You most likely realize that compilers like <a href="https://clang-analyzer.llvm.org/">clang</a> and <a href="https://lwn.net/Articles/806099/">gcc</a> depend on these research techniques, but it also underpins (<a href="https://fbinfer.com/">Infer</a>, <a href="https://codeclimate.com/">CodeClimate</a>, <a href="http://findbugs.sourceforge.net/">FindBugs</a> and tools based on formal methods like <a href="https://frama-c.com/">Frama-C</a> and <a href="https://www.mathworks.com/products/polyspace.html">Polyspace</a>.</p>
<p>We won't be exhaustively reviewing static analysis techniques and researcher here. Instead, we'll focus on what is needed to understand how Slither works so you can more effectively use it to find bugs and understand code.</p>
<ul>
<li><a href="program-analysis/slither/static_analysis.html#code-representation">Code representation</a></li>
<li><a href="program-analysis/slither/static_analysis.html#analysis">Code analysis</a></li>
<li><a href="program-analysis/slither/static_analysis.html#intermediate-representation">Intermediate representation</a></li>
</ul>
<h3 id="code-representation"><a class="header" href="#code-representation">Code representation</a></h3>
<p>In contrast to a dynamic analysis, which reasons about a single execution path, static analysis reasons about all the paths at once. To do so, it relies on a different code representation. The two most common ones are the abstract syntax tree (AST) and the control flow graph (CFG).</p>
<h3 id="abstract-syntax-trees-ast"><a class="header" href="#abstract-syntax-trees-ast">Abstract Syntax Trees (AST)</a></h3>
<p>AST are used every time the compiler parses code. It is probably the most basic structure upon which static analysis can be performed.</p>
<p>In a nutshell, an AST is a structured tree where, usually, each leaf contains a variable or a constant and internal nodes are operands or control flow operations. Consider the following code: </p>
<pre><code class="language-solidity">function safeAdd(uint a, uint b) pure internal returns(uint){
    if(a + b &lt;= a){
        revert();
    }
    return a + b;
}
</code></pre>
<p>The corresponding AST is shown in:</p>
<p><img src="program-analysis/slither/./images/ast.png" alt="AST" /></p>
<p>Slither uses the AST exported by solc.</p>
<p>While simple to build, the AST is a nested structure. At times, this is not the most straightforward to analyze. For example, to identify the operations used by the expression <code>a + b &lt;= a</code>, you must first analyze <code>&lt;=</code> and then <code>+</code>. A common approach is to use the so-called visitor pattern, which navigates through the tree recursively. Slither contains a generic visitor in <a href="https://github.com/crytic/slither/blob/master/slither/visitors/expression/expression.py"><code>ExpressionVisitor</code></a>.</p>
<p>The following code uses <code>ExpressionVisitor</code> to detect if the expression contains an addition:</p>
<pre><code class="language-python">from slither.visitors.expression.expression import ExpressionVisitor
from slither.core.expressions.binary_operation import BinaryOperationType

class HasAddition(ExpressionVisitor):

    def result(self):
        return self._result

    def _post_binary_operation(self, expression):
        if expression.type == BinaryOperationType.ADDITION:
            self._result = True

visitor = HasAddition(expression) # expression is the expression to be tested
print(f'The expression {expression} has a addition: {visitor.result()}')
</code></pre>
<h3 id="control-flow-graph-cfg"><a class="header" href="#control-flow-graph-cfg">Control Flow Graph (CFG)</a></h3>
<p>The second most common code representation is the control flow graph (CFG). As its name suggests, it is a graph-based representation which exposes all the execution paths. Each node contains one or multiple instructions. Edges in the graph represent the control flow operations (if/then/else, loop, etc). The CFG of our previous example is:</p>
<p><img src="program-analysis/slither/./images/cfg.png" alt="CFG" /></p>
<p>The CFG is the representation on top of which most of the analyses are built.</p>
<p>Many other code representations exist. Each representation has advantages and drawbacks according to the analysis you want to perform.</p>
<h3 id="analysis"><a class="header" href="#analysis">Analysis</a></h3>
<p>The simplest type of analyses you can perform with Slither are syntactic analyses. </p>
<h3 id="syntax-analysis"><a class="header" href="#syntax-analysis">Syntax analysis</a></h3>
<p>Slither can navigate through the different components of the code and their representation to find inconsistencies and flaws using a pattern matching-like approach.</p>
<p>For example the following detectors look for syntax-related issues:</p>
<ul>
<li>
<p><a href="https://github.com/crytic/slither/wiki/Detector-Documentation#state-variable-shadowing">State variable shadowing</a>: iterates over all the state variables and check if any shadow a variable from an inherited contract (<a href="https://github.com/crytic/slither/blob/0441338e055ab7151b30ca69258561a5a793f8ba/slither/detectors/shadowing/state.py#L51-L62">state.py#L51-L62</a>)</p>
</li>
<li>
<p><a href="https://github.com/crytic/slither/wiki/Detector-Documentation#incorrect-erc20-interface">Incorrect ERC20 interface</a>: look for incorrect ERC20 function signatures (<a href="https://github.com/crytic/slither/blob/0441338e055ab7151b30ca69258561a5a793f8ba/slither/detectors/erc/incorrect_erc20_interface.py#L34-L55">incorrect_erc20_interface.py#L34-L55</a>)</p>
</li>
</ul>
<h3 id="semantic-analysis"><a class="header" href="#semantic-analysis">Semantic analysis</a></h3>
<p>In contrast to syntax analysis, a semantic analysis will go deeper and analyze the “meaning” of the code. This family includes some broad types of analyses. They lead to more powerful and useful results, but are also more complex to write.</p>
<p>Semantic analyses are used for the most advanced vulnerability detections.</p>
<h4 id="data-dependency-analysis"><a class="header" href="#data-dependency-analysis">Data dependency analysis</a></h4>
<p>A variable <code>variable_a</code> is said to be data-dependent of <code>variable_b</code> if there is a path for which the value of <code>variable_a</code> is influenced by <code>variable_b</code>.</p>
<p>In the following code, <code>variable_a</code> is dependent of <code>variable_b</code>:</p>
<pre><code class="language-solidity">// ...
variable_a = variable_b + 1;
</code></pre>
<p>Slither comes with built-in <a href="https://github.com/crytic/slither/wiki/data-dependency">data dependency</a> capabilities, thanks to its intermediate representation (discussed in a later section).</p>
<p>An example of data dependency usage can be found in the <a href="https://github.com/crytic/slither/wiki/Detector-Documentation#dangerous-strict-equalities">dangerous strict equality detector</a>. Here Slither will look for strict equality comparison to a dangerous value (<a href="https://github.com/crytic/slither/blob/6d86220a53603476f9567c3358524ea4db07fb25/slither/detectors/statements/incorrect_strict_equality.py#L86-L87">incorrect_strict_equality.py#L86-L87</a>), and will inform the user that it should use <code>&gt;=</code> or <code>&lt;=</code> rather than <code>==</code>, to prevent an attacker to trap the contract. Among other, the detector will consider as dangerous the return value of a call to <code>balanceOf(address)</code> (<a href="https://github.com/crytic/slither/blob/6d86220a53603476f9567c3358524ea4db07fb25/slither/detectors/statements/incorrect_strict_equality.py#L63-L64">incorrect_strict_equality.py#L63-L64</a>), and will use the data dependency engine to track its usage.</p>
<h4 id="fixed-point-computation"><a class="header" href="#fixed-point-computation">Fixed-point computation</a></h4>
<p>If your analysis navigates through the CFG and follows the edges, you are likely to see already visited nodes. For example, if a loop is presented as shown below:</p>
<pre><code class="language-solidity">for(uint i; i &lt; range; ++){
    variable_a += 1
}
</code></pre>
<p>Your analysis will need to know when to stop. There are two main strategies here: (1) iterate on each node a finite number of times, (2) compute a so-called <em>fixpoint</em>. A fixpoint basically means that analyzing this node does not provide any meaningful information. </p>
<p>An example of fixpoint used can be found in the reentrancy detectors: Slither explores the nodes, and look for externals calls, write and read to storage. Once it has reached a fixpoint (<a href="https://github.com/crytic/slither/blob/master/slither/detectors/reentrancy/reentrancy.py#L125-L131">reentrancy.py#L125-L131</a>), it stops the exploration, and analyze the results to see if a reentrancy is present, through different reentrancy patterns (<a href="https://github.com/crytic/slither/blob/b275bcc824b1b932310cf03b6bfb1a1fef0ebae1/slither/detectors/reentrancy/reentrancy_benign.py">reentrancy_benign.py</a>, <a href="https://github.com/crytic/slither/blob/b275bcc824b1b932310cf03b6bfb1a1fef0ebae1/slither/detectors/reentrancy/reentrancy_read_before_write.py">reentrancy_read_before_write.py</a>, <a href="https://github.com/crytic/slither/blob/b275bcc824b1b932310cf03b6bfb1a1fef0ebae1/slither/detectors/reentrancy/reentrancy_eth.py">reentrancy_eth.py</a>).</p>
<p>Writing analyses using efficient fixed point computation requires a good understanding of how the analysis propagates its information.</p>
<h3 id="intermediate-representation"><a class="header" href="#intermediate-representation">Intermediate representation</a></h3>
<p>An intermediate representation (IR) is a language meant to be more amenable to static analysis than the original one. Slither translates Solidity to its own IR: <a href="https://github.com/crytic/slither/wiki/SlithIR">SlithIR</a>.</p>
<p>Understanding SlithIR is not necessary if you only want to write basic checks. However, it will come in handy if you plan to write advanced semantic analyses. The <a href="https://github.com/crytic/slither/wiki/Printer-documentation#slithir">SlithIR</a> and <a href="https://github.com/crytic/slither/wiki/Printer-documentation#slithir-ssa">SSA</a> printers will help you to understand how the code is translated.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="api-basics"><a class="header" href="#api-basics">API Basics</a></h2>
<p>Slither has an API that lets you explore basic attributes of the contract and its functions.</p>
<p>To load a codebase:</p>
<pre><code class="language-python">from slither import Slither
slither = Slither('/path/to/project')

</code></pre>
<h3 id="exploring-contracts-and-functions"><a class="header" href="#exploring-contracts-and-functions">Exploring contracts and functions</a></h3>
<p>A <code>Slither</code> object has:</p>
<ul>
<li><code>contracts (list(Contract)</code>: list of contracts</li>
<li><code>contracts_derived (list(Contract)</code>: list of contracts that are not inherited by another contract (subset of contracts)</li>
<li><code>get_contract_from_name (str)</code>: Return a list of contract matching the name</li>
</ul>
<p>A <code>Contract</code> object has:</p>
<ul>
<li><code>name (str)</code>: Name of the contract</li>
<li><code>functions (list(Function))</code>: List of functions</li>
<li><code>modifiers (list(Modifier))</code>: List of functions</li>
<li><code>all_functions_called (list(Function/Modifier))</code>: List of all the internal functions reachable by the contract</li>
<li><code>inheritance (list(Contract))</code>: List of inherited contracts</li>
<li><code>get_function_from_signature (str)</code>: Return a Function from its signature</li>
<li><code>get_modifier_from_signature (str)</code>: Return a Modifier from its signature</li>
<li><code>get_state_variable_from_name (str)</code>: Return a StateVariable from its name</li>
</ul>
<p>A <code>Function</code> or a <code>Modifier</code> object has:</p>
<ul>
<li><code>name (str)</code>: Name of the function</li>
<li><code>contract (contract)</code>: the contract where the function is declared</li>
<li><code>nodes (list(Node))</code>: List of the nodes composing the CFG of the function/modifier</li>
<li><code>entry_point (Node)</code>: Entry point of the CFG</li>
<li><code>variables_read (list(Variable))</code>: List of variables read</li>
<li><code>variables_written (list(Variable))</code>: List of variables written</li>
<li><code>state_variables_read (list(StateVariable))</code>: List of state variables read (subset of variables`read)</li>
<li><code>state_variables_written (list(StateVariable))</code>: List of state variables written (subset of variables`written)</li>
</ul>
<h3 id="example-print-basic-information"><a class="header" href="#example-print-basic-information">Example: Print Basic Information</a></h3>
<p><a href="program-analysis/slither/./examples/print_basic_information.py">print_basic_information.py</a> shows how to print basic information about a project.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercice-1--function-overridden-protection"><a class="header" href="#exercice-1--function-overridden-protection">Exercice 1 : Function overridden protection</a></h1>
<p>The goal is to create a script that fills a missing feature of Solidity: function overriding protection.</p>
<p><a href="program-analysis/slither/exercises/exercise1/coin.sol">exercises/exercise1/coin.sol</a> contains a function that must never be overridden:</p>
<pre><code class="language-solidity">_mint(address dst, uint val)
</code></pre>
<p>Use Slither to ensure that no contract that inherits Coin overrides this function.</p>
<h2 id="proposed-algorithm"><a class="header" href="#proposed-algorithm">Proposed algorithm</a></h2>
<pre><code>Get the coin contract
    For each contract of the project:
        If Coin is in the list of inherited contract:
            Get the mint function
            If the contract declaring the mint function is != Coin:
                A bug is found.
</code></pre>
<h2 id="hints-4"><a class="header" href="#hints-4">Hints</a></h2>
<ul>
<li>To get a specific contract, use <code>slither.get_contract_from_name</code> (note: it returns a list)</li>
<li>To get a specific function, use <code>contract.get_function_from_signature</code></li>
</ul>
<h2 id="solution-10"><a class="header" href="#solution-10">Solution</a></h2>
<p>See <a href="program-analysis/slither/exercises/exercise1/solution.py">exercises/exercise1/solution.py</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercice-2-access-control"><a class="header" href="#exercice-2-access-control">Exercice 2: Access control</a></h1>
<p><a href="program-analysis/slither/exercises/exercise2/coin.sol">exercises/exercise2/coin.sol</a> possess an access control with the <code>onlyOwner</code> modifier.
A frequent mistake is to forget to add the modifier to a critical function. We are going to see how to implement a conservative access control approach with Slither.</p>
<p>The goal is to create a script that will ensure that all the public and external function calls <code>onlyOwner</code>, except for the functions whitelisted.</p>
<h2 id="proposed-algorithm-1"><a class="header" href="#proposed-algorithm-1">Proposed algorithm</a></h2>
<pre><code>Create a whitelist of signatures
Explore all the functions
    If the function is in the whitelist of signatures:
        Skip
    If the function is public or external:
        If onlyOwner is not in the modifiers:
            A bug is found
</code></pre>
<h2 id="solution-11"><a class="header" href="#solution-11">Solution</a></h2>
<p>See <a href="program-analysis/slither/exercises/exercise2/solution.py">exercises/exercise2/solution.py</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="trail-of-bits-blogposts"><a class="header" href="#trail-of-bits-blogposts">Trail of Bits blogposts</a></h1>
<p>The following contains the blockchain related blogposts made by Trail of Bits.</p>
<ul>
<li><a href="resources/tob_blogposts.html#trail-of-bits-blogposts">Trail of Bits blogposts</a>
<ul>
<li><a href="resources/tob_blogposts.html#consensus-algorithms">Consensus algorithms</a></li>
<li><a href="resources/tob_blogposts.html#fuzzing-compilers">Fuzzing compilers</a></li>
<li><a href="resources/tob_blogposts.html#general">General</a></li>
<li><a href="resources/tob_blogposts.html#guidance">Guidance</a></li>
<li><a href="resources/tob_blogposts.html#presentations">Presentations</a></li>
<li><a href="resources/tob_blogposts.html#tooling">Tooling</a></li>
<li><a href="resources/tob_blogposts.html#upgradeability">Upgradeability</a></li>
<li><a href="resources/tob_blogposts.html#zero-knowledge">Zero-knowledge</a></li>
</ul>
</li>
</ul>
<h2 id="consensus-algorithms"><a class="header" href="#consensus-algorithms">Consensus algorithms</a></h2>
<p>Research in the distributes systems area</p>
<div class="table-wrapper"><table><thead><tr><th>Date</th><th>Title</th><th>Description</th></tr></thead><tbody>
<tr><td>2021/11/11</td><td><a href="https://blog.trailofbits.com/2021/11/11/motivating-global-stabilization/">Motivating global stabilization</a></td><td>Review of Fischer, Lynch, and Paterson’s classic impossibility result and global stabilization time assumption</td></tr>
<tr><td>2019/10/25</td><td><a href="https://blog.trailofbits.com/2019/10/25/formal-analysis-of-the-cbc-casper-consensus-algorithm-with-tla/">Formal Analysis of the CBC Casper Consensus Algorithm with TLA+</a></td><td>Verification of finality of the Correct By Construction (CBC) PoS consensus protocol</td></tr>
<tr><td>2019/07/12</td><td><a href="https://blog.trailofbits.com/2019/07/12/librabft/">On LibraBFT’s use of broadcasts</a></td><td>Liveness of LibraBFT and HotStuff algorithms</td></tr>
<tr><td>2019/07/02</td><td><a href="https://blog.trailofbits.com/2019/07/02/state/">State of the Art Proof-of-Work: RandomX</a></td><td>Summary of our audit of ASIC and GPU-resistant PoW algorithm</td></tr>
<tr><td>2018/10/12</td><td><a href="https://blog.trailofbits.com/2018/10/12/introduction-to-verifiable-delay-functions-vdfs/">Introduction to Verifiable Delay Functions (VDFs)</a></td><td>Basics of VDFs - a class of hard to compute, not paralelizable, but easily verifiable functions</td></tr>
</tbody></table>
</div>
<h2 id="fuzzing-compilers"><a class="header" href="#fuzzing-compilers">Fuzzing compilers</a></h2>
<p>Our work in the topic of fuzzing the <code>solc</code> compiler</p>
<div class="table-wrapper"><table><thead><tr><th>Date</th><th>Title</th><th>Description</th></tr></thead><tbody>
<tr><td>2021/03/23</td><td><a href="https://blog.trailofbits.com/2021/03/23/a-year-in-the-life-of-a-compiler-fuzzing-campaign/">A Year in the Life of a Compiler Fuzzing Campaign</a></td><td>Results and feature of fuzzing solc</td></tr>
<tr><td>2020/06/05</td><td><a href="https://blog.trailofbits.com/2020/06/05/breaking-the-solidity-compiler-with-a-fuzzer/">Breaking the Solidity Compiler with a Fuzzer</a></td><td>Our approach to fuzzing solc</td></tr>
</tbody></table>
</div>
<h2 id="general"><a class="header" href="#general">General</a></h2>
<p>Security research, analyses, announcements, and writeups</p>
<div class="table-wrapper"><table><thead><tr><th>Date</th><th>Title</th><th>Description</th></tr></thead><tbody>
<tr><td>2022/10/12</td><td><a href="https://blog.trailofbits.com/2022/10/12/solana-jit-compiler-ebpf-arm64/">Porting the Solana eBPF JIT compiler to ARM64</a></td><td>Low-level writeup of the work done to make Solana compiler work on ARM64</td></tr>
<tr><td>2022/06/24</td><td><a href="https://blog.trailofbits.com/2022/06/24/managing-risk-in-blockchain-deployments/">Managing risk in blockchain deployments</a></td><td>Summary of &quot;Do You Really Need a Blockchain? An Operational Risk Assessment&quot; report</td></tr>
<tr><td>2022/06/21</td><td><a href="https://blog.trailofbits.com/2022/06/21/are-blockchains-decentralized/">Are blockchains decentralized?</a></td><td>Summary of &quot;Are Blockchains Decentralize? Unintended Centralities in Distributed Ledgers&quot; report</td></tr>
<tr><td>2020/08/05</td><td><a href="https://blog.trailofbits.com/2020/08/05/accidentally-stepping-on-a-defi-lego/">Accidentally stepping on a DeFi lego</a></td><td>Writeup of a vulnerability in yVault project</td></tr>
<tr><td>2020/05/15</td><td><a href="https://blog.trailofbits.com/2020/05/15/bug-hunting-with-crytic/">Bug Hunting with Crytic</a></td><td>Description of 9 bugs found by Trail of Bits tools in public projects</td></tr>
<tr><td>2019/11/13</td><td><a href="https://blog.trailofbits.com/2019/11/13/announcing-the-crytic-10k-research-prize/">Announcing the Crytic $10k Research Prize</a></td><td>Academic research prize promoting open source work</td></tr>
<tr><td>2019/10/24</td><td><a href="https://blog.trailofbits.com/2019/10/24/watch-your-language-our-first-vyper-audit/">Watch Your Language: Our First Vyper Audit</a></td><td>Pros and cons of Vyper language and disclosure of vulnerability in the Vyper's compiler</td></tr>
<tr><td>2019/08/08</td><td><a href="https://blog.trailofbits.com/2019/08/08/246-findings-from-our-smart-contract-audits-an-executive-summary/">246 Findings From our Smart Contract Audits: An Executive Summary</a></td><td>Publication of data aggregated from our audits. Discussion about possibility of automatic and manual detection of vulnerabilities, and usefulness of unit tests</td></tr>
<tr><td>2018/11/19</td><td><a href="https://blog.trailofbits.com/2018/11/19/return-of-the-blockchain-security-empire-hacking/">Return of the Blockchain Security Empire Hacking</a></td><td></td></tr>
<tr><td>2018/02/09</td><td><a href="https://blog.trailofbits.com/2018/02/09/parity-technologies-engages-trail-of-bits/">Parity Technologies engages Trail of Bits</a></td><td></td></tr>
<tr><td>2017/11/06</td><td><a href="https://blog.trailofbits.com/2017/11/06/hands-on-the-ethernaut-ctf/">Hands on the Ethernaut CTF</a></td><td>First write-up on Ethernaut</td></tr>
</tbody></table>
</div>
<h2 id="guidance"><a class="header" href="#guidance">Guidance</a></h2>
<p>General guidance</p>
<div class="table-wrapper"><table><thead><tr><th>Date</th><th>Title</th><th>Description</th></tr></thead><tbody>
<tr><td>2021/02/05</td><td><a href="https://blog.trailofbits.com/2021/02/05/confessions-of-a-smart-contract-paper-reviewer/">Confessions of a smart contract paper reviewer</a></td><td>Six requirements for a good research paper</td></tr>
<tr><td>2018/11/27</td><td><a href="https://blog.trailofbits.com/2018/11/27/10-rules-for-the-secure-use-of-cryptocurrency-hardware-wallets/">10 Rules for the Secure Use of Cryptocurrency Hardware Wallets</a></td><td>Recommendations for the secure use of hardware wallets.</td></tr>
<tr><td>2018/10/04</td><td><a href="https://blog.trailofbits.com/2018/10/04/ethereum-security-guidance-for-all/">Ethereum security guidance for all</a></td><td>Announcement of office hours, Blockchain Security Contacts, and Awesome Ethereum Security</td></tr>
<tr><td>2018/04/06</td><td><a href="https://blog.trailofbits.com/2018/04/06/how-to-prepare-for-a-security-audit/">How to prepare for a security review</a></td><td>Checklist for before having a security audit</td></tr>
</tbody></table>
</div>
<h2 id="presentations"><a class="header" href="#presentations">Presentations</a></h2>
<p>Talks, videos, and slides</p>
<div class="table-wrapper"><table><thead><tr><th>Date</th><th>Title</th><th>Description</th></tr></thead><tbody>
<tr><td>2019/01/18</td><td><a href="https://blog.trailofbits.com/2019/01/18/empire-hacking-ethereum-edition-2/">Empire Hacking: Ethereum Edition 2</a></td><td>Talks include: <code>Anatomy of an unsafe smart contract programming language</code>, <code>Evaluating digital asset security fundamentals</code>, <code>Contract upgrade risks and recommendations</code>, <code>How to buidl an enterprise-grade mainnet Ethereum client</code>, <code>Failures in on-chain privacy</code>, <code>Secure micropayment protocols</code>, <code>Designing the Gemini dollar: a regulated, upgradeable, transparent stablecoin</code>, <code>Property testing with Echidna and Manticore for secure smart contracts</code>, <code>Simple is hard: Making your awesome security thing usable</code></td></tr>
<tr><td>2018/11/16</td><td><a href="https://blog.trailofbits.com/2018/11/16/trail-of-bits-devcon-iv-recap/">Trail of Bits @ Devcon IV Recap</a></td><td>Talks include: <code>Using Manticore and Symbolic Execution to Find Smart Contract Bugs</code>, <code>Blockchain Autopsies</code>, <code>Current State of Security</code></td></tr>
<tr><td>2017/12/22</td><td><a href="https://blog.trailofbits.com/2017/12/22/videos-from-ethereum-focused-empire-hacking/">Videos from Ethereum-focused Empire Hacking</a></td><td>Talks include: <code>A brief history of smart contract security</code>, <code>A CTF Field Guide for smart contracts</code>, <code>Automatic bug finding for the blockchain</code>, <code>Addressing infosec needs with blockchain technology</code></td></tr>
</tbody></table>
</div>
<h2 id="tooling"><a class="header" href="#tooling">Tooling</a></h2>
<p>Description of our tools and their use cases</p>
<div class="table-wrapper"><table><thead><tr><th>Date</th><th>Tool</th><th>Title</th><th>Description</th></tr></thead><tbody>
<tr><td>2022/08/17</td><td><img src='https://raw.githubusercontent.com/crytic/slither/master/logo.png' alt='slither' width=100px /></td><td><a href="https://blog.trailofbits.com/2022/08/17/using-mutants-to-improve-slither/">Using mutants to improve Slither</a></td><td>Inserting random bugs into smart contracts and detecting them with various static analysis tools - to improve Slither's detectors</td></tr>
<tr><td>2022/07/28</td><td><img src='https://raw.githubusercontent.com/crytic/slither/master/logo.png' alt='slither' width=100px /></td><td><a href="https://blog.trailofbits.com/2022/07/28/shedding-smart-contract-storage-with-slither/">Shedding smart contract storage with Slither</a></td><td>Announcement of the slither-read-storage tool</td></tr>
<tr><td>2022/04/20</td><td></td><td><a href="https://blog.trailofbits.com/2022/04/20/amarna-static-analysis-for-cairo-programs/">Amarna: Static analysis for Cairo programs</a></td><td>Overview of Cairo footguns and announcement of the new static analysis tool</td></tr>
<tr><td>2022/03/02</td><td><img src='https://raw.githubusercontent.com/crytic/echidna/master/echidna.png' alt='echidna' width=100px /></td><td><a href="https://blog.trailofbits.com/2022/03/02/optimizing-a-smart-contract-fuzzer/">Optimizing a smart contract fuzzer</a></td><td>Measuring and improving performance of Echidna (Haskell code)</td></tr>
<tr><td>2021/12/16</td><td><img src='https://raw.githubusercontent.com/crytic/slither/master/logo.png' alt='slither' width=100px /></td><td><a href="https://blog.trailofbits.com/2021/12/16/detecting-miso-and-opyns-msg-value-reuse-vulnerability-with-slither/">Detecting MISO and Opyn’s msg.value reuse vulnerability with Slither</a></td><td>Description of Slither's new detectors: delegatecall-loop and msg-value-loop</td></tr>
<tr><td>2021/04/02</td><td></td><td><a href="https://blog.trailofbits.com/2021/04/02/solar-context-free-interactive-analysis-for-solidity/">Solar: Context-free, interactive analysis for Solidity</a></td><td>Proof-of-concept static analysis framework</td></tr>
<tr><td>2020/10/23</td><td><img src='https://raw.githubusercontent.com/crytic/slither/master/logo.png' alt='slither' width=100px /></td><td><a href="https://blog.trailofbits.com/2020/10/23/efficient-audits-with-machine-learning-and-slither-simil/">Efficient audits with machine learning and Slither-simil</a></td><td>Detect similar Solidity functions with Slither and ML</td></tr>
<tr><td>2020/08/17</td><td><img src='https://raw.githubusercontent.com/crytic/echidna/master/echidna.png' alt='echidna' width=100px /></td><td><a href="https://blog.trailofbits.com/2020/08/17/using-echidna-to-test-a-smart-contract-library/">Using Echidna to test a smart contract library</a></td><td>Designing and testing properties with differential fuzzing</td></tr>
<tr><td>2020/07/12</td><td><img src='https://raw.githubusercontent.com/trailofbits/manticore/master/docs/images/manticore.png' alt='manticore' width=100px /></td><td><a href="https://blog.trailofbits.com/2020/07/12/new-manticore-verifier-for-smart-contracts/">Contract verification made easier</a></td><td>Re-use Echidna properties with Manticore with manticore-verifier</td></tr>
<tr><td>2020/06/12</td><td><img src='https://raw.githubusercontent.com/crytic/slither/master/logo.png' alt='slither' width=100px /></td><td><a href="https://blog.trailofbits.com/2020/06/12/upgradeable-contracts-made-safer-with-crytic/">Upgradeable contracts made safer with Crytic</a></td><td>17 new Slither detectors for upgradeable contracts</td></tr>
<tr><td>2020/03/30</td><td><img src='https://raw.githubusercontent.com/crytic/echidna/master/echidna.png' alt='echidna' width=100px /></td><td><a href="https://blog.trailofbits.com/2020/03/30/an-echidna-for-all-seasons/">An Echidna for all Seasons</a></td><td>Announcement of new features in Echidna</td></tr>
<tr><td>2020/03/03</td><td><img src='https://raw.githubusercontent.com/trailofbits/manticore/master/docs/images/manticore.png' alt='manticore' width=100px /></td><td><a href="https://blog.trailofbits.com/2020/03/03/manticore-discovers-the-ens-bug/">Manticore discovers the ENS bug</a></td><td>Using symbolic analysis to find vulnerability in Ethereum Name Service contract</td></tr>
<tr><td>2020/01/31</td><td><img src='https://raw.githubusercontent.com/trailofbits/manticore/master/docs/images/manticore.png' alt='manticore' width=100px /></td><td><a href="https://blog.trailofbits.com/2020/01/31/symbolically-executing-webassembly-in-manticore/">Symbolically Executing WebAssembly in Manticore</a></td><td>Using symbolic analysis on an artificial WASM binary</td></tr>
<tr><td>2019/08/02</td><td></td><td><a href="https://blog.trailofbits.com/2019/08/02/crytic-continuous-assurance-for-smart-contracts/">Crytic: Continuous Assurance for Smart Contracts</a></td><td>New product that integrates static analysis with GitHub pipeline</td></tr>
<tr><td>2019/07/03</td><td><img src='https://raw.githubusercontent.com/crytic/slither/master/logo.png' alt='slither' width=100px /></td><td><a href="https://blog.trailofbits.com/2019/07/03/avoiding-smart-contract-gridlock-with-slither/">Avoiding Smart Contract &quot;Gridlock&quot; with Slither</a></td><td>Description of a DoS vulnerability resulting from a strict equality check, and Slither's dangerous-strict-equality detector</td></tr>
<tr><td>2019/05/27</td><td><img src='https://raw.githubusercontent.com/crytic/slither/master/logo.png' alt='slither' width=100px /></td><td><a href="https://blog.trailofbits.com/2019/05/27/slither-the-leading-static-analyzer-for-smart-contracts/">Slither: The Leading Static Analyzer for Smart Contracts</a></td><td>Slither design and comparison with other static analysis tools</td></tr>
<tr><td>2018/10/19</td><td><img src='https://raw.githubusercontent.com/crytic/slither/master/logo.png' alt='slither' width=100px /></td><td><a href="https://blog.trailofbits.com/2018/10/19/slither-a-solidity-static-analysis-framework/">Slither – a Solidity static analysis framework</a></td><td>Introduction to Slither's API and printers</td></tr>
<tr><td>2018/09/06</td><td><img src='https://raw.githubusercontent.com/crytic/rattle/master/logo_s.png' alt='rattle' width=100px /></td><td><a href="https://blog.trailofbits.com/2018/09/06/rattle-an-ethereum-evm-binary-analysis-framework/">Rattle – an Ethereum EVM binary analysis framework</a></td><td>Turn EVM bytecode to infinite-register SSA form</td></tr>
<tr><td>2018/05/03</td><td><img src='https://raw.githubusercontent.com/crytic/echidna/master/echidna.png' alt='echidna' width=100px /></td><td><a href="https://blog.trailofbits.com/2018/05/03/state-machine-testing-with-echidna/">State Machine Testing with Echidna</a></td><td>Example use case of Echidna's Haskell API</td></tr>
<tr><td>2018/03/23</td><td></td><td><a href="https://blog.trailofbits.com/2018/03/23/use-our-suite-of-ethereum-security-tools/">Use our suite of Ethereum security tools</a></td><td>Overview of our tools and documents: Not So Smart Contracts, Slither, Echidna, Manticore, EVM Opcode Database, Ethersplay, IDA-EVM, Rattle</td></tr>
<tr><td>2018/03/09</td><td><img src='https://raw.githubusercontent.com/crytic/echidna/master/echidna.png' alt='echidna' width=100px /></td><td><a href="https://blog.trailofbits.com/2018/03/09/echidna-a-smart-fuzzer-for-ethereum/">Echidna, a smart fuzzer for Ethereum</a></td><td>First release and introduction to Echidna</td></tr>
<tr><td>2017/04/27</td><td><img src='https://raw.githubusercontent.com/trailofbits/manticore/master/docs/images/manticore.png' alt='manticore' width=100px /></td><td><a href="https://blog.trailofbits.com/2017/04/27/manticore-symbolic-execution-for-humans/">Manticore: Symbolic execution for humans</a></td><td>First release and introduction to Manticore (not adopted for EVM yet)</td></tr>
</tbody></table>
</div>
<h2 id="upgradeability-1"><a class="header" href="#upgradeability-1">Upgradeability</a></h2>
<p>Our work related to contracts upgradeability</p>
<div class="table-wrapper"><table><thead><tr><th>Date</th><th>Title</th><th>Description</th></tr></thead><tbody>
<tr><td>2020/12/16</td><td><a href="https://blog.trailofbits.com/2020/12/16/breaking-aave-upgradeability/">Breaking Aave Upgradeability</a></td><td>Description of Delegatecall Proxy vulnerability in formally-verified Aave contracts</td></tr>
<tr><td>2020/10/30</td><td><a href="https://blog.trailofbits.com/2020/10/30/good-idea-bad-design-how-the-diamond-standard-falls-short/">Good idea, bad design: How the Diamond standard falls short</a></td><td>Audit of Diamond standard's implementation</td></tr>
<tr><td>2018/10/29</td><td><a href="https://blog.trailofbits.com/2018/10/29/how-contract-migration-works/">How contract migration works</a></td><td>Alternative to upgradability mechanism - moving data to a new contract</td></tr>
<tr><td>2018/09/05</td><td><a href="https://blog.trailofbits.com/2018/09/05/contract-upgrade-anti-patterns/">Contract upgrade anti-patterns</a></td><td>Discussion of risks and recommendations for Data Separation and Delegatecall Proxy patterns. Disclosure of vulnerability in Zeppelin Proxy contract.</td></tr>
</tbody></table>
</div>
<h2 id="zero-knowledge"><a class="header" href="#zero-knowledge">Zero-knowledge</a></h2>
<p>Our work in Zero-Knowledge Proofs space</p>
<div class="table-wrapper"><table><thead><tr><th>Date</th><th>Title</th><th>Description</th></tr></thead><tbody>
<tr><td>2022/04/18</td><td><a href="https://blog.trailofbits.com/2022/04/18/the-frozen-heart-vulnerability-in-plonk/">The Frozen Heart vulnerability in PlonK</a></td><td></td></tr>
<tr><td>2022/04/15</td><td><a href="https://blog.trailofbits.com/2022/04/15/the-frozen-heart-vulnerability-in-bulletproofs/">The Frozen Heart vulnerability in Bulletproofs</a></td><td></td></tr>
<tr><td>2022/04/14</td><td><a href="https://blog.trailofbits.com/2022/04/14/the-frozen-heart-vulnerability-in-giraults-proof-of-knowledge/">The Frozen Heart vulnerability in Girault’s proof of knowledge</a></td><td></td></tr>
<tr><td>2022/04/13</td><td><a href="https://blog.trailofbits.com/2022/04/13/part-1-coordinated-disclosure-of-vulnerabilities-affecting-girault-bulletproofs-and-plonk/">Coordinated disclosure of vulnerabilities affecting Girault, Bulletproofs, and PlonK</a></td><td>Introducing new &quot;Frozen Heart&quot; class of vulnerabilities</td></tr>
<tr><td>2021/12/21</td><td><a href="https://blog.trailofbits.com/2021/12/21/disclosing-shamirs-secret-sharing-vulnerabilities-and-announcing-zkdocs/">Disclosing Shamir’s Secret Sharing vulnerabilities and announcing ZKDocs</a></td><td></td></tr>
<tr><td>2021/02/19</td><td><a href="https://blog.trailofbits.com/2021/02/19/serving-up-zero-knowledge-proofs/">Serving up zero-knowledge proofs</a></td><td>Fiat-Shamir transformation explained</td></tr>
<tr><td>2020/12/14</td><td><a href="https://blog.trailofbits.com/2020/12/14/reverie-an-optimized-zero-knowledge-proof-system/">Reverie: An optimized zero-knowledge proof system</a></td><td>Rust implementation of the MPC-in-the-head proof system</td></tr>
<tr><td>2020/05/21</td><td><a href="https://blog.trailofbits.com/2020/05/21/reinventing-vulnerability-disclosure-using-zero-knowledge-proofs/">Reinventing Vulnerability Disclosure using Zero-knowledge Proofs</a></td><td>Announcement of DARPA sponsored work on ZK proofs of exploitability</td></tr>
<tr><td>2019/10/04</td><td><a href="https://blog.trailofbits.com/2019/10/04/multi-party-computation-on-machine-learning/">Multi-Party Computation on Machine Learning</a></td><td>Implementation of 3-party computation protocol for perceptron and support vector machine (SVM) algorithms</td></tr>
</tbody></table>
</div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
