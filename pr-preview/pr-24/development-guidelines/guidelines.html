<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>High-level best practices - Building Secure Contracts</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="This repository, brought to you by Trail of Bits, outlines our guidelines and best practices to write secure smart contracts.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../static/custom.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <div class="sidebar-book-logo">
                    <img src="../static/TOB_Black.svg">
                </div>
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded "><a href="../development-guidelines/index.html">Development-guidelines</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../development-guidelines/guidelines.html" class="active">High-level best practices</a></li><li class="chapter-item "><a href="../development-guidelines/token_integration.html">Token integration checklist</a></li><li class="chapter-item "><a href="../development-guidelines/incident_response.html">Incident Response Recommendations</a></li><li class="chapter-item "><a href="../development-guidelines/workflow.html">Secure development workflow</a></li></ol></li><li class="chapter-item expanded "><a href="../learn_evm/index.html">Learn EVM</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../learn_evm/evm_opcodes.html">EVM Opcode Reference</a></li><li class="chapter-item "><a href="../learn_evm/tracing.html">Transaction Tracing</a></li><li class="chapter-item "><a href="../learn_evm/yellow-paper.html">Yellow Paper Guidance</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../learn_evm/eips_forks.html">Forks &lt;&gt; EIPs</a></li><li class="chapter-item "><a href="../learn_evm/cips_forks.html">Forks &lt;&gt; CIPs</a></li><li class="chapter-item "><a href="../learn_evm/tips_upgrades.html">Upgrades &lt;&gt; TIPs</a></li><li class="chapter-item "><a href="../learn_evm/beps_forks.html">Forks &lt;&gt; BEPs</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../not-so-smart-contracts/index.html">Not so smart contracts</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../not-so-smart-contracts/algorand/index.html">Algorand</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../not-so-smart-contracts/algorand/rekeying/index.html">Rekeying</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/algorand/unchecked_transaction_fee/index.html">Unchecked Transaction Fees</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/algorand/closing_account/index.html">Closing Account</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/algorand/closing_asset/index.html">Closing Asset</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/algorand/group_size_check/index.html">Group Size Check</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/algorand/time_based_replay_attack/index.html">Time-based Replay Attack</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/algorand/access_controls/index.html">Access Controls</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/algorand/asset_id_check/index.html">Asset Id Check</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/algorand/denial_of_service/index.html">Denial of Service</a></li></ol></li><li class="chapter-item "><a href="../not-so-smart-contracts/cairo/index.html">Cairo</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../not-so-smart-contracts/cairo/access_controls/index.html">Improper access controls</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/cairo/integer_division/index.html">Integer division errors</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/cairo/view_state/index.html">View state modifications</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/cairo/arithmetic_overflow/index.html">Arithmetic overflow</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/cairo/replay_protection/index.html">Signature replays</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/cairo/L1_to_L2_address_conversion/index.html">L1 to L2 Address Conversion</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/cairo/incorrect_felt_comparison/index.html">Incorrect Felt Comparison</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/cairo/namespace_storage_var_collision/index.html">Namespace Storage Var Collision</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/cairo/dangerous_public_imports_in_libraries/index.html">Dangerous Public Imports in Libraries</a></li></ol></li><li class="chapter-item "><a href="../not-so-smart-contracts/cosmos/index.html">Cosmos</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../not-so-smart-contracts/cosmos/incorrect_getsigners/index.html">Incorrect signers</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/cosmos/non_determinism/index.html">Non-determinism</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/cosmos/messages_priority/index.html">Not prioritized messages</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/cosmos/abci_fast/index.html">Slow ABCI methods</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/cosmos/abci_panic/index.html">ABCI methods panic</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/cosmos/broken_bookkeeping/index.html">Broken bookkeeping</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/cosmos/rounding_errors/index.html">Rounding errors</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/cosmos/unregistered_msg_handler/index.html">Unregistered message handler</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/cosmos/missing_error_handler/index.html">Missing error handler</a></li></ol></li><li class="chapter-item "><a href="../not-so-smart-contracts/solana/index.html">Solana</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../not-so-smart-contracts/solana/arbitrary_cpi/index.html">Arbitrary CPI</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/solana/improper_pda_validation/index.html">Improper PDA Validation</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/solana/ownership_check/index.html">Ownership Check</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/solana/signer_check/index.html">Signer Check</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/solana/sysvar_account_check/index.html">Sysvar Account Check</a></li></ol></li><li class="chapter-item "><a href="../not-so-smart-contracts/substrate/index.html">Substrate</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../not-so-smart-contracts/substrate/arithmetic_overflow/index.html">Arithmetic overflow</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/substrate/dont_panic/index.html">Don't panic!</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/substrate/weights_and_fees/index.html">Weights and fees</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/substrate/verify_first/index.html">Verify first</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/substrate/validate_unsigned/index.html">Unsigned transaction validation</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/substrate/randomness/index.html">Bad randomness</a></li><li class="chapter-item "><a href="../not-so-smart-contracts/substrate/origins/index.html">Bad origin</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../program-analysis/index.html">Program Analysis</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../program-analysis/echidna/index.html">Echidna</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../program-analysis/echidna/introduction/index.html">Introduction</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../program-analysis/echidna/introduction/fuzzing-introduction.html">Introduction to fuzzing</a></li><li class="chapter-item "><a href="../program-analysis/echidna/introduction/how-to-test-a-property.html">How to test a property</a></li></ol></li><li class="chapter-item "><a href="../program-analysis/echidna/basic/index.html">Basic</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../program-analysis/echidna/basic/testing-modes.html">How to select the most suitable testing mode</a></li><li class="chapter-item "><a href="../program-analysis/echidna/basic/common-testing-approaches.html">How to select the best testing approach</a></li><li class="chapter-item "><a href="../program-analysis/echidna/basic/filtering-functions.html">How to filter functions</a></li><li class="chapter-item "><a href="../program-analysis/echidna/basic/assertion-checking.html">How to test assertions</a></li><li class="chapter-item "><a href="../program-analysis/echidna/basic/property-creation.html">How to write good properties step by step</a></li></ol></li><li class="chapter-item "><a href="../program-analysis/echidna/advanced/index.html">Advanced</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../program-analysis/echidna/advanced/collecting-a-corpus.html">How to collect a corpus</a></li><li class="chapter-item "><a href="../program-analysis/echidna/advanced/optimization_mode.html">How to use optimization mode</a></li><li class="chapter-item "><a href="../program-analysis/echidna/advanced/finding-transactions-with-high-gas-consumption.html">How to detect high gas consumption</a></li><li class="chapter-item "><a href="../program-analysis/echidna/advanced/smart-contract-fuzzing-at-scale.html">How to perform smart contract fuzzing at a large scale</a></li><li class="chapter-item "><a href="../program-analysis/echidna/advanced/testing-bytecode.html">How to test bytecode-only contracts</a></li><li class="chapter-item "><a href="../program-analysis/echidna/advanced/hevm-cheats-to-test-permit.html">How to use hevm cheats to test permit</a></li><li class="chapter-item "><a href="../program-analysis/echidna/advanced/end-to-end-testing.html">How to seed Echidna with unit tests</a></li><li class="chapter-item "><a href="../program-analysis/echidna/advanced/using-multi-abi.html">Understanding and using multi-abi</a></li></ol></li><li class="chapter-item "><a href="../program-analysis/echidna/fuzzing_tips.html">Fuzzing tips</a></li><li class="chapter-item "><a href="../program-analysis/echidna/frequently_asked_questions.html">Frequently Asked Questions</a></li><li class="chapter-item "><a href="../program-analysis/echidna/exercises/index.html">Exercises</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../program-analysis/echidna/exercises/Exercise-1.html">Exercise 1</a></li><li class="chapter-item "><a href="../program-analysis/echidna/exercises/Exercise-2.html">Exercise 2</a></li><li class="chapter-item "><a href="../program-analysis/echidna/exercises/Exercise-3.html">Exercise 3</a></li><li class="chapter-item "><a href="../program-analysis/echidna/exercises/Exercise-4.html">Exercise 4</a></li><li class="chapter-item "><a href="../program-analysis/echidna/exercises/Exercise-5.html">Exercise 5</a></li><li class="chapter-item "><a href="../program-analysis/echidna/exercises/Exercise-6.html">Exercise 6</a></li><li class="chapter-item "><a href="../program-analysis/echidna/exercises/Exercise-7.html">Exercise 7</a></li><li class="chapter-item "><a href="../program-analysis/echidna/exercises/Exercise-8.html">Exercise 8</a></li></ol></li></ol></li><li class="chapter-item "><a href="../program-analysis/manticore/index.html">Manticore</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../program-analysis/manticore/symbolic-execution-introduction.html">Introduction to symbolic execution</a></li><li class="chapter-item "><a href="../program-analysis/manticore/running-under-manticore.html">Running under Manticore</a></li><li class="chapter-item "><a href="../program-analysis/manticore/getting-throwing-paths.html">Getting throwing paths</a></li><li class="chapter-item "><a href="../program-analysis/manticore/adding-constraints.html">Adding constraints</a></li><li class="chapter-item "><a href="../program-analysis/manticore/exercises/index.html">Exercises</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../program-analysis/manticore/exercises/example.html">Example</a></li><li class="chapter-item "><a href="../program-analysis/manticore/exercises/exercise1.html">Exercise 1</a></li><li class="chapter-item "><a href="../program-analysis/manticore/exercises/exercise2.html">Exercise 2</a></li></ol></li></ol></li><li class="chapter-item "><a href="../program-analysis/slither/index.html">Slither</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../program-analysis/slither/static_analysis.html">Static Analysis</a></li><li class="chapter-item "><a href="../program-analysis/slither/api.html">API</a></li><li class="chapter-item "><a href="../program-analysis/slither/exercise1.html">Exercise 1</a></li><li class="chapter-item "><a href="../program-analysis/slither/exercise2.html">Exercise 2</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../resources/tob_blogposts.html">Resources</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Building Secure Contracts</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/crytic/building-secure-contracts" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/crytic/building-secure-contracts/edit/master/./development-guidelines/guidelines.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="development-guidelines"><a class="header" href="#development-guidelines">Development Guidelines</a></h1>
<p>Follow these high-level recommendations to build more secure smart contracts.</p>
<ul>
<li><a href="#development-guidelines">Development Guidelines</a>
<ul>
<li><a href="#design-guidelines">Design guidelines</a>
<ul>
<li><a href="#documentation-and-specifications">Documentation and specifications</a></li>
<li><a href="#on-chain-vs-off-chain-computation">On-chain vs off-chain computation</a></li>
<li><a href="#upgradeability">Upgradeability</a>
<ul>
<li><a href="#delegatecall-proxy-pattern">Delegatecall Proxy</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#implementation-guidelines">Implementation guidelines</a>
<ul>
<li><a href="#function-composition">Function composition</a></li>
<li><a href="#inheritance">Inheritance</a></li>
<li><a href="#events">Events</a></li>
<li><a href="#avoid-known-pitfalls">Avoid known pitfalls</a></li>
<li><a href="#dependencies">Dependencies</a></li>
<li><a href="#testing-and-verification">Testing and verification</a></li>
<li><a href="#solidity">Solidity</a></li>
</ul>
</li>
<li><a href="#deployment-guidelines">Deployment guidelines</a></li>
</ul>
</li>
</ul>
<h2 id="design-guidelines"><a class="header" href="#design-guidelines">Design guidelines</a></h2>
<p>The design of the contract should be discussed ahead of time, prior writing any line of code.</p>
<h3 id="documentation-and-specifications"><a class="header" href="#documentation-and-specifications">Documentation and specifications</a></h3>
<p>Documentation can be written at different levels, and should be updated while implementing the contracts:</p>
<ul>
<li><strong>A plain English description of the system</strong>, describing what the contracts do and any assumptions on the codebase.</li>
<li><strong>Schema and architectural diagrams</strong>, including the contract interactions and the state machine of the system. <a href="https://github.com/crytic/slither/wiki/Printer-documentation">Slither printers</a> can help to generate these schemas.</li>
<li><strong>Thorough code documentation</strong>, the <a href="https://solidity.readthedocs.io/en/develop/natspec-format.html">Natspec format</a> can be used for Solidity.</li>
</ul>
<h3 id="on-chain-vs-off-chain-computation"><a class="header" href="#on-chain-vs-off-chain-computation">On-chain vs off-chain computation</a></h3>
<ul>
<li><strong>Keep as much code as you can off-chain.</strong> Keep the on-chain layer small. Pre-process data with code off-chain in such a way that verification on-chain is simple. Do you need an ordered list? Sort the list off-chain, then only check its order onchain.</li>
</ul>
<h3 id="upgradeability"><a class="header" href="#upgradeability">Upgradeability</a></h3>
<p>We discussed the different upgradeability solutions in <a href="https://blog.trailofbits.com/2018/09/05/contract-upgrade-anti-patterns/">our blog post</a>. In particular, if you are using delegatecall to achieve upgradability, carefully review all items of the above delegatecall proxy guidance. Make a deliberate choice to support upgradeability or not prior to writing any code. The decision will influence how you structure our code. In general, we recommend:</p>
<ul>
<li><strong>Favoring <a href="https://blog.trailofbits.com/2018/10/29/how-contract-migration-works/">contract migration</a> over upgradeability.</strong> Migration system have many of the same advantages than upgradeable, without their drawbacks.</li>
<li><strong>Using the data separation pattern over the delegatecall proxy one.</strong> If your project has a clear abstraction separation, upgradeability using data separation will necessitate only a few adjustments. The delegatecall proxy requires EVM expertise and is highly error-prone.</li>
<li><strong>Document the migration/upgrade procedure before the deployment.</strong> If you have to react under stress without any guidelines, you will make mistakes. Write the procedure to follow ahead of time. It should include:
<ul>
<li>The calls that initiate the new contracts</li>
<li>Where are stored the keys and how to access them</li>
<li>How to check the deployment! Develop and test a post-deployment script.</li>
</ul>
</li>
</ul>
<h4 id="delegatecall-proxy-pattern"><a class="header" href="#delegatecall-proxy-pattern">Delegatecall Proxy Pattern</a></h4>
<p>The delegatecall opcode is a very sharp tool that must be used carefully. Many high-profile exploits utilize little-known edge cases and counter-intuitive aspects of the delegatecall proxy pattern. This section aims to outline the most important risks to keep in mind while developing such smart contract systems. Trail of Bits developed the <a href="https://github.com/crytic/slither/wiki/Upgradeability-Checks">slither-check-upgradability</a> tool to aid in the development of secure delegatecall proxies, it performs safety checks relevant to both upgradable and immutable delegatecall proxies.</p>
<ul>
<li><strong>Storage layout</strong>: The storage layout of the proxy and implementation must be the same. Do not try to define the same state variables on each contract. Instead, both contracts should inherit all of their state variables from one shared base contract.</li>
<li><strong>Inheritance</strong>: If the base storage contract is split up, beware that the order of inheritance impacts the final storage layout. For example, <code>contract A is B,C</code> and <code>contract A is C,B</code> will not yield the same storage layout if both B and C define state variables.</li>
<li><strong>Initialization</strong>: Make sure that the implementation is immediately initialized. Well-known disasters (and near disasters) have featured an uninitialized implementation contract. A factory pattern can help ensure that contracts are deployed &amp; initialized correctly while also mitigating front-running risks that might otherwise open up between contract deployment &amp; initialization.</li>
<li><strong>Function shadowing</strong>: If the same method is defined on the proxy and the implementation, then the proxy’s function will not be called. Be aware of <code>setOwner</code> and other administration functions that commonly exist on proxies.</li>
<li><strong>Direct implementation usage</strong>: Consider configuring the implementation’s state variables with values that prevent it from being used directly, such as by setting a flag during construction that disables the implementation and causes all methods to revert. This is particularly important if the implementation also performs delegatecall operations because this opens up the possibility of unintended self destruction of the implementation.</li>
<li><strong>Immutable and constant variables</strong>: These are embedded into the bytecode and can therefore get out of sync between the proxy and implementation. If the implementation has an incorrect immutable variable, this value may still be used even if the same variables are correctly set in the proxy’s bytecode.</li>
<li><strong>Contract Existence Checks</strong>: All <a href="https://docs.soliditylang.org/en/latest/control-structures.html?highlight=existence#error-handling-assert-require-revert-and-exceptions">low-level calls</a>, not just delegatecall, will return true against an address with empty bytecode. This might cause callers to be misled to think that a call performed a meaningful operation when it did not or it might result in important safety checks being silently skipped. Be aware that while a contract’s constructor is running, its bytecode remains empty until the end of constructor execution. We recommend that you rigorously verify that all low-level calls are properly protected against nonexistent contracts, keeping in mind that most proxy libraries (such as the one written by Openzeppelin) do not perform contract existence checks automatically.</li>
</ul>
<p>For more information regarding delegatecall proxies in general, reference our blog posts and presentations:</p>
<ul>
<li><a href="https://blog.trailofbits.com/2018/09/05/contract-upgrade-anti-patterns/">Contract Upgradability Anti-Patterns</a>: Describes the difference between a downstream data contract and delegatecall proxies which use an upstream data contract and how these patterns impact upgradability.</li>
<li><a href="https://blog.trailofbits.com/2020/10/30/good-idea-bad-design-how-the-diamond-standard-falls-short/">How the Diamond standard falls short</a>: This post dives deep into delegatecall risks which apply to all contracts, not just those that follow the diamond standard.</li>
<li><a href="https://blog.trailofbits.com/2020/12/16/breaking-aave-upgradeability/">Breaking Aave Upgradeability</a>: A write-up describing a subtle problem that we discovered in Aave <code>AToken</code> contracts that resulted from the interplay between delegatecall proxies, contact existence checks, and unsafe initialization.</li>
<li><a href="https://youtu.be/mebA5Qz9zeQ?t=353">Contract Upgrade Risks and Recommendations</a>: A talk by Trail of Bits describing best-practices for developing upgradable delegatecall proxies. The section starting at 5:49 describes some general risks that also apply to non-upgradable proxies.</li>
</ul>
<h2 id="implementation-guidelines"><a class="header" href="#implementation-guidelines">Implementation guidelines</a></h2>
<p><strong>Strive for simplicity.</strong> Always use the simplest solution that fits your purpose. Any member of your team should be able to understand your solution.</p>
<h3 id="function-composition"><a class="header" href="#function-composition">Function composition</a></h3>
<p>The architecture of your codebase should make your code easy to review. Avoid architectural choices that decrease the ability to reason about its correctness.</p>
<ul>
<li><strong>Split the logic of your system</strong>, either through multiple contracts or by grouping similar functions together (for example, authentication, arithmetic, ...).</li>
<li><strong>Write small functions, with a clear purpose.</strong> This will facilitate easier review and allow the testing of individual components.</li>
</ul>
<h3 id="inheritance"><a class="header" href="#inheritance">Inheritance</a></h3>
<ul>
<li><strong>Keep the inheritance manageable.</strong> Inheritance should be used to divide the logic, however, your project should aim to minimize the depth and width of the inheritance tree.</li>
<li><strong>Use Slither’s <a href="https://github.com/crytic/slither/wiki/Printer-documentation#inheritance-graph">inheritance printer</a> to check the contracts’ hierarchy.</strong> The inheritance printer will help you review the size of the hierarchy.</li>
</ul>
<h3 id="events"><a class="header" href="#events">Events</a></h3>
<ul>
<li><strong>Log all crucial operations.</strong> Events will help to debug the contract during the development, and monitor it after deployment.</li>
</ul>
<h3 id="avoid-known-pitfalls"><a class="header" href="#avoid-known-pitfalls">Avoid known pitfalls</a></h3>
<ul>
<li><strong>Be aware of the most common security issues.</strong> There are many online resources to learn about common issues, such as <a href="https://ethernaut.openzeppelin.com/">Ethernaut CTF</a>, <a href="https://capturetheether.com/">Capture the Ether</a>, or <a href="https://github.com/crytic/not-so-smart-contracts/">Not so smart contracts</a>.</li>
<li><strong>Be aware of the warnings sections in the <a href="https://solidity.readthedocs.io/en/latest/">Solidity documentation</a>.</strong> The warnings sections will inform you about non-obvious behavior of the language.</li>
</ul>
<h3 id="dependencies"><a class="header" href="#dependencies">Dependencies</a></h3>
<ul>
<li><strong>Use well-tested libraries.</strong> Importing code from well-tested libraries will reduce the likelihood that you write buggy code. If you want to write an ERC20 contract, use <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/tree/master/contracts/token/ERC20">OpenZeppelin</a>.</li>
<li><strong>Use a dependency manager; avoid copy-pasting code.</strong> If you rely on an external source, then you must keep it up-to-date with the original source.</li>
</ul>
<h3 id="testing-and-verification"><a class="header" href="#testing-and-verification">Testing and verification</a></h3>
<ul>
<li><strong>Write thorough unit-tests.</strong> An extensive test suite is crucial to build high-quality software. </li>
<li><strong>Write <a href="https://github.com/crytic/slither">Slither</a> and <a href="https://github.com/crytic/echidna">Echidna</a> custom checks and properties.</strong> Automated tools will help ensure your contract is secure. Review the rest of this guide to learn how to write efficient checks and properties.</li>
</ul>
<h3 id="solidity"><a class="header" href="#solidity">Solidity</a></h3>
<ul>
<li><strong>Favor Solidity versions outlined in our <a href="https://github.com/crytic/slither/wiki/Detector-Documentation#incorrect-versions-of-solidity">Slither Recommendations</a></strong> In our opinion, older Solidity are more secure and have better built-in practices. Newer Solidity versions may be too young to be used in production and require additional time to mature.</li>
<li><strong>Use a stable release to compile; use the latest release to check for warnings.</strong> Check that your code has no reported issues with the latest compiler version. However, Solidity has a fast release cycle and has a history of compiler bugs, so we do not recommend the latest version for deployment (see Slither’s <a href="https://github.com/crytic/slither/wiki/Detector-Documentation#incorrect-versions-of-solidity">solc version recommendation</a>).</li>
<li><strong>Do not use inline assembly.</strong> Assembly requires EVM expertise. Do not write EVM code if you have not <em>mastered</em> the yellow paper.</li>
</ul>
<h2 id="deployment-guidelines"><a class="header" href="#deployment-guidelines">Deployment guidelines</a></h2>
<p>Once the contract has been developed and deployed:</p>
<ul>
<li><strong>Monitor your contracts.</strong> Watch the logs, and be ready to react in case of contract or wallet compromise.</li>
<li><strong>Add your contact info to <a href="https://github.com/crytic/blockchain-security-contacts">blockchain-security-contacts</a>.</strong> This list helps third-parties contact you if a security flaw is discovered.</li>
<li><strong>Secure the wallets of privileged users.</strong> Follow our <a href="https://blog.trailofbits.com/2018/11/27/10-rules-for-the-secure-use-of-cryptocurrency-hardware-wallets/">best practices</a> if you store keys in hardware wallets.</li>
<li><strong>Have a response to incident plan.</strong> Consider that your smart contracts can be compromised. Even if your contracts are free of bugs, an attacker may take control of the contract owner's keys.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../development-guidelines/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../development-guidelines/token_integration.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../development-guidelines/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../development-guidelines/token_integration.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
