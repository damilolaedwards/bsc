<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>How to write good properties step by step - Building Secure Contracts</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="This repository, brought to you by Trail of Bits, outlines our guidelines and best practices to write secure smart contracts.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../../static/custom.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <div class="sidebar-book-logo">
                    <img src="../../../static/TOB_Black.svg">
                </div>
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../../index.html">Introduction</a></li><li class="chapter-item expanded "><a href="../../../development-guidelines/index.html">Development-guidelines</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../development-guidelines/guidelines.html">High-level best practices</a></li><li class="chapter-item "><a href="../../../development-guidelines/token_integration.html">Token integration checklist</a></li><li class="chapter-item "><a href="../../../development-guidelines/incident_response.html">Incident Response Recommendations</a></li><li class="chapter-item "><a href="../../../development-guidelines/workflow.html">Secure development workflow</a></li></ol></li><li class="chapter-item expanded "><a href="../../../learn_evm/index.html">Learn EVM</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../learn_evm/evm_opcodes.html">EVM Opcode Reference</a></li><li class="chapter-item "><a href="../../../learn_evm/tracing.html">Transaction Tracing</a></li><li class="chapter-item "><a href="../../../learn_evm/yellow-paper.html">Yellow Paper Guidance</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../learn_evm/eips_forks.html">Forks &lt;&gt; EIPs</a></li><li class="chapter-item "><a href="../../../learn_evm/cips_forks.html">Forks &lt;&gt; CIPs</a></li><li class="chapter-item "><a href="../../../learn_evm/tips_upgrades.html">Upgrades &lt;&gt; TIPs</a></li><li class="chapter-item "><a href="../../../learn_evm/beps_forks.html">Forks &lt;&gt; BEPs</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../../not-so-smart-contracts/index.html">Not so smart contracts</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../not-so-smart-contracts/algorand/index.html">Algorand</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../not-so-smart-contracts/algorand/rekeying/index.html">Rekeying</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/algorand/unchecked_transaction_fee/index.html">Unchecked Transaction Fees</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/algorand/closing_account/index.html">Closing Account</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/algorand/closing_asset/index.html">Closing Asset</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/algorand/group_size_check/index.html">Group Size Check</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/algorand/time_based_replay_attack/index.html">Time-based Replay Attack</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/algorand/access_controls/index.html">Access Controls</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/algorand/asset_id_check/index.html">Asset Id Check</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/algorand/denial_of_service/index.html">Denial of Service</a></li></ol></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/cairo/index.html">Cairo</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../not-so-smart-contracts/cairo/access_controls/index.html">Improper access controls</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/cairo/integer_division/index.html">Integer division errors</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/cairo/view_state/index.html">View state modifications</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/cairo/arithmetic_overflow/index.html">Arithmetic overflow</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/cairo/replay_protection/index.html">Signature replays</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/cairo/L1_to_L2_address_conversion/index.html">L1 to L2 Address Conversion</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/cairo/incorrect_felt_comparison/index.html">Incorrect Felt Comparison</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/cairo/namespace_storage_var_collision/index.html">Namespace Storage Var Collision</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/cairo/dangerous_public_imports_in_libraries/index.html">Dangerous Public Imports in Libraries</a></li></ol></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/cosmos/index.html">Cosmos</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../not-so-smart-contracts/cosmos/incorrect_getsigners/index.html">Incorrect signers</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/cosmos/non_determinism/index.html">Non-determinism</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/cosmos/messages_priority/index.html">Not prioritized messages</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/cosmos/abci_fast/index.html">Slow ABCI methods</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/cosmos/abci_panic/index.html">ABCI methods panic</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/cosmos/broken_bookkeeping/index.html">Broken bookkeeping</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/cosmos/rounding_errors/index.html">Rounding errors</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/cosmos/unregistered_msg_handler/index.html">Unregistered message handler</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/cosmos/missing_error_handler/index.html">Missing error handler</a></li></ol></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/solana/index.html">Solana</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../not-so-smart-contracts/solana/arbitrary_cpi/index.html">Arbitrary CPI</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/solana/improper_pda_validation/index.html">Improper PDA Validation</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/solana/ownership_check/index.html">Ownership Check</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/solana/signer_check/index.html">Signer Check</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/solana/sysvar_account_check/index.html">Sysvar Account Check</a></li></ol></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/substrate/index.html">Substrate</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../not-so-smart-contracts/substrate/arithmetic_overflow/index.html">Arithmetic overflow</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/substrate/dont_panic/index.html">Don't panic!</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/substrate/weights_and_fees/index.html">Weights and fees</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/substrate/verify_first/index.html">Verify first</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/substrate/validate_unsigned/index.html">Unsigned transaction validation</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/substrate/randomness/index.html">Bad randomness</a></li><li class="chapter-item "><a href="../../../not-so-smart-contracts/substrate/origins/index.html">Bad origin</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../../program-analysis/index.html">Program Analysis</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../program-analysis/echidna/index.html">Echidna</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../program-analysis/echidna/introduction/index.html">Introduction</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../program-analysis/echidna/introduction/fuzzing-introduction.html">Introduction to fuzzing</a></li><li class="chapter-item "><a href="../../../program-analysis/echidna/introduction/how-to-test-a-property.html">How to test a property</a></li></ol></li><li class="chapter-item expanded "><a href="../../../program-analysis/echidna/basic/index.html">Basic</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../program-analysis/echidna/basic/testing-modes.html">How to select the most suitable testing mode</a></li><li class="chapter-item "><a href="../../../program-analysis/echidna/basic/common-testing-approaches.html">How to select the best testing approach</a></li><li class="chapter-item "><a href="../../../program-analysis/echidna/basic/filtering-functions.html">How to filter functions</a></li><li class="chapter-item "><a href="../../../program-analysis/echidna/basic/assertion-checking.html">How to test assertions</a></li><li class="chapter-item expanded "><a href="../../../program-analysis/echidna/basic/property-creation.html" class="active">How to write good properties step by step</a></li></ol></li><li class="chapter-item "><a href="../../../program-analysis/echidna/advanced/index.html">Advanced</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../program-analysis/echidna/advanced/collecting-a-corpus.html">How to collect a corpus</a></li><li class="chapter-item "><a href="../../../program-analysis/echidna/advanced/optimization_mode.html">How to use optimization mode</a></li><li class="chapter-item "><a href="../../../program-analysis/echidna/advanced/finding-transactions-with-high-gas-consumption.html">How to detect high gas consumption</a></li><li class="chapter-item "><a href="../../../program-analysis/echidna/advanced/smart-contract-fuzzing-at-scale.html">How to perform smart contract fuzzing at a large scale</a></li><li class="chapter-item "><a href="../../../program-analysis/echidna/advanced/testing-bytecode.html">How to test bytecode-only contracts</a></li><li class="chapter-item "><a href="../../../program-analysis/echidna/advanced/hevm-cheats-to-test-permit.html">How to use hevm cheats to test permit</a></li><li class="chapter-item "><a href="../../../program-analysis/echidna/advanced/end-to-end-testing.html">How to seed Echidna with unit tests</a></li><li class="chapter-item "><a href="../../../program-analysis/echidna/advanced/using-multi-abi.html">Understanding and using multi-abi</a></li></ol></li><li class="chapter-item "><a href="../../../program-analysis/echidna/fuzzing_tips.html">Fuzzing tips</a></li><li class="chapter-item "><a href="../../../program-analysis/echidna/frequently_asked_questions.html">Frequently Asked Questions</a></li><li class="chapter-item "><a href="../../../program-analysis/echidna/exercises/index.html">Exercises</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../program-analysis/echidna/exercises/Exercise-1.html">Exercise 1</a></li><li class="chapter-item "><a href="../../../program-analysis/echidna/exercises/Exercise-2.html">Exercise 2</a></li><li class="chapter-item "><a href="../../../program-analysis/echidna/exercises/Exercise-3.html">Exercise 3</a></li><li class="chapter-item "><a href="../../../program-analysis/echidna/exercises/Exercise-4.html">Exercise 4</a></li><li class="chapter-item "><a href="../../../program-analysis/echidna/exercises/Exercise-5.html">Exercise 5</a></li><li class="chapter-item "><a href="../../../program-analysis/echidna/exercises/Exercise-6.html">Exercise 6</a></li><li class="chapter-item "><a href="../../../program-analysis/echidna/exercises/Exercise-7.html">Exercise 7</a></li><li class="chapter-item "><a href="../../../program-analysis/echidna/exercises/Exercise-8.html">Exercise 8</a></li></ol></li></ol></li><li class="chapter-item "><a href="../../../program-analysis/manticore/index.html">Manticore</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../program-analysis/manticore/symbolic-execution-introduction.html">Introduction to symbolic execution</a></li><li class="chapter-item "><a href="../../../program-analysis/manticore/running-under-manticore.html">Running under Manticore</a></li><li class="chapter-item "><a href="../../../program-analysis/manticore/getting-throwing-paths.html">Getting throwing paths</a></li><li class="chapter-item "><a href="../../../program-analysis/manticore/adding-constraints.html">Adding constraints</a></li><li class="chapter-item "><a href="../../../program-analysis/manticore/exercises/index.html">Exercises</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../program-analysis/manticore/exercises/example.html">Example</a></li><li class="chapter-item "><a href="../../../program-analysis/manticore/exercises/exercise1.html">Exercise 1</a></li><li class="chapter-item "><a href="../../../program-analysis/manticore/exercises/exercise2.html">Exercise 2</a></li></ol></li></ol></li><li class="chapter-item "><a href="../../../program-analysis/slither/index.html">Slither</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../program-analysis/slither/static_analysis.html">Static Analysis</a></li><li class="chapter-item "><a href="../../../program-analysis/slither/api.html">API</a></li><li class="chapter-item "><a href="../../../program-analysis/slither/exercise1.html">Exercise 1</a></li><li class="chapter-item "><a href="../../../program-analysis/slither/exercise2.html">Exercise 2</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../../resources/tob_blogposts.html">Resources</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Building Secure Contracts</h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/crytic/building-secure-contracts" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/crytic/building-secure-contracts/edit/master/./program-analysis/echidna/basic/property-creation.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="how-to-write-good-properties-step-by-step"><a class="header" href="#how-to-write-good-properties-step-by-step">How to write good properties step by step</a></h1>
<p><strong>Table of contents:</strong></p>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#a-first-approach">A first approach</a></li>
<li><a href="#enhacing-postcondition-checks">Enhacing postcondition checks</a></li>
<li><a href="#combining-properties">Combining properties</a></li>
<li><a href="#summary-how-to-write-good-properties">Summary: How to write good properties</a></li>
</ul>
<h2 id="introduction"><a class="header" href="#introduction">Introduction</a></h2>
<p>In this short tutorial, we will detail some ideas to write interesting or useful properties using Echidna. At each step, we will iteratively improve our properties.</p>
<h2 id="a-first-approach"><a class="header" href="#a-first-approach">A first approach</a></h2>
<p>One of the simplest properties to write using Echidna is to throw an assertion when some function is expected to revert/return.</p>
<p>Let's suppose we have a contract interface like the one below: </p>
<pre><code class="language-solidity">interface DeFi {
  ERC20 t;
  function getShares(address user) external returns (uint256)
  function createShares(uint256 val) external returns (uint256)
  function depositShares(uint256 val) external
  function withdrawShares(uint256 val) external
  function transferShares(address to) external
  ...
</code></pre>
<p>In this example, users can deposit tokens using <code>depositShares</code>, mint shares using <code>createShares</code>, withdraw shares using <code>withdrawShares</code>, transfer all shares to another user using <code>transferShares</code>, and get the number of shares for any account using <code>getShares</code>. We will start with very basic properties:</p>
<pre><code class="language-solidity">contract Test {
  DeFi c;
  ERC20 token;

  constructor() {
    c = DeFi(..);
    token.mint(address(this), ...);
  }
  
  function getShares_never_reverts() public {
      (bool b,) = c.call(abi.encodeWithSignature(&quot;getShares(address)&quot;, address(this)));
      assert(b);
  }

  function depositShares_never_reverts(uint256 val) public {
    if (token.balanceOf(address(this)) &gt;= val) {
        (bool b,) = c.call(abi.encodeWithSignature(&quot;depositShares(uint256)&quot;, val));
        assert(b);
    }
  }
  
  function withdrawShares_never_reverts(uint256 val) public {
    if (c.getShares(address(this)) &gt;= val) {
        (bool b,) = c.call(abi.encodeWithSignature(&quot;withdrawShares(uint256)&quot;, val));
        assert(b);
    }
  }
  
  function depositShares_can_revert(uint256 val) public {
    if (token.balanceOf(address(this)) &lt; val) {
        (bool b,) = c.call(abi.encodeWithSignature(&quot;depositShares(uint256)&quot;, val));
        assert(!b);
    }
  }
  
  function withdrawShares_can_revert(uint256 val) public {
    if (c.getShares(address(this)) &lt; val) {
        (bool b,) = c.call(abi.encodeWithSignature(&quot;withdrawShares(uint256)&quot;, val));
        assert(!b);
    }
  }
  
}
</code></pre>
<p>After you have writen your first version of properties, run Echidna to make sure they work as expected. During this tutorial, we will improve them step by step. It is strongly recommended to run the fuzzer at each step to increase the probability of detecting any potential issues. </p>
<p>Perhaps you think these properties are too low level to be useful, particularly if the code has a good coverage in terms of unit tests.
But you will be surprised how often an unexpected revert/return uncovers a complex and severe issue. Moreover, we will see how these properties can be improved to cover more complex post-conditions.</p>
<p>Before we continue, we will improve these properties using <a href="https://docs.soliditylang.org/en/v0.6.0/control-structures.html#try-catch">try/catch</a>. The use of a low-level call forces us to manually encode the data, which can be error prone (an error will always cause calls to revert). Note, this will only work if the codebase is using solc 0.6.0 or later:</p>
<pre><code class="language-solidity">  ...
  function depositShares_never_reverts(uint256 val) public {
    if (token.balanceOf(address(this)) &gt;= val) {
        try c.depositShares(val) { /* not reverted */ } catch { assert(false); }
    }
  }
  
  function depositShares_can_revert(uint256 val) public {
    if (token.balanceOf(address(this)) &lt; val) {
        try c.depositShares(val) { assert(false); } catch { /* reverted */ }
    }
  }
  ...
  
}
</code></pre>
<h2 id="enhacing-postcondition-checks"><a class="header" href="#enhacing-postcondition-checks">Enhacing postcondition checks</a></h2>
<p>If the previous properties are passing, this means that the pre-conditions are good enough, however the post-conditions are not very precise. 
Avoiding reverts doesn't mean that the contract is in a valid state. Let's add some basic preconditions:</p>
<pre><code class="language-solidity">  ...
  function depositShares_never_reverts(uint256 val) public {
    if (token.balanceOf(address(this)) &gt;= val) {
        try c.depositShares(val) { /* not reverted */ } catch { assert(false); }
        assert(c.getShares(address(this)) &gt; 0);
    }
  }
  
  function withdrawShares_never_reverts(uint256 val) public {
    if (c.getShares(address(this)) &gt;= val) {
        try c.withdrawShares(val) { /* not reverted */ } catch { assert(false); }
        assert(token.balanceOf(address(this)) &gt; 0);
    }
  }
  ...
  
}
</code></pre>
<p>Uhm, it looks like it is not that easy to specify the value of shares/tokens obtained after each deposit/withdrawal. At least we can say that we must receive something, right?</p>
<h2 id="combining-properties"><a class="header" href="#combining-properties">Combining properties</a></h2>
<p>In this generic example, it is unclear if there is a way to calculate how many shares or tokens we should receive after executing the deposit/withdraw operations. Of course, if we have that information, we should use it. In any case, what we can do here is to combine these two properties into a single one to be able check more precisely it's preconditions. </p>
<pre><code class="language-solidity">  ...
  function deposit_withdraw_shares_never_reverts(uint256 val) public {
    uint256 original_balance = token.balanceOf(address(this)); 
    if (original_balance &gt;= val) {
        try c.depositShares(val) { /* not reverted */ } catch { assert(false); }
        uint256 shares = c.getShares(address(this);
        assert(shares &gt; 0);
        try c.withdrawShares(shares) { /* not reverted */ } catch { assert(false); }
        assert(token.balanceOf(address(this)) == original_balance);
    }
  }
  ...
  
}
</code></pre>
<p>The resulting property checks that calls to deposit/withdraw shares will never revert and once they execute, the original number of tokens remains the same. Keep in mind that this property should consider fees and any tolerated loss of precision (e.g. when the computation requires a division).</p>
<h2 id="final-considerations"><a class="header" href="#final-considerations">Final considerations</a></h2>
<p>Two important considerations for this example:</p>
<p>We want Echidna to spend most of the execution exploring the contract to test. So, in order to make the properties more efficient, we should avoid dead branches where there is nothing to do. That's why we can improve <code>depositShares_never_reverts</code> to use:</p>
<pre><code class="language-solidity">  function depositShares_never_reverts(uint256 val) public {
    if(token.balanceOf(address(this)) &gt; 0) {
      val = val % (token.balanceOf(address(this)) + 1);
      try c.depositShares(val) { /* not reverted */ } catch { assert(false); }
      assert(c.getShares(address(this)) &gt; 0);
    } else {
      ... // code to test depositing zero tokens
    }
  }
</code></pre>
<p>Additionally, combining properties does not mean that we will have to remove simpler ones. For instance, if we want to write <code>withdraw_deposit_shares_never_reverts</code>, in which we reverse the order of operations (withdraw and then deposit, instead of deposit and then withdraw), we will have to make sure <code>c.getShares(address(this))</code> can be positive. An easy way to do it is to keep <code>depositShares_never_reverts</code>, since this code allows Echidna to deposit tokens from <code>address(this)</code> (otherwise, this is impossible).</p>
<h2 id="summary-how-to-write-good-properties"><a class="header" href="#summary-how-to-write-good-properties">Summary: How to write good properties</a></h2>
<p>It is usually a good idea to start writing simple properties first and then improving them to make them more precise and easier to read. At each step you should run a short fuzzing campaign to make sure they work as expected and try to catch issues early during the development of your smart contracts. </p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../program-analysis/echidna/basic/assertion-checking.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../../program-analysis/echidna/advanced/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../program-analysis/echidna/basic/assertion-checking.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../../program-analysis/echidna/advanced/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
